(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const Se="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3c/svg%3e",Me="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23216e24'%20/%3e%3crect%20x='29'%20y='34'%20width='6'%20height='20'%20fill='%238b4513'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='16'%20fill='%232e8b57'%20/%3e%3c/svg%3e",Ae="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23d2b48c'%20/%3e%3cpolygon%20points='0,64%2020,32%2040,64'%20fill='%23c2a070'%20/%3e%3cpolygon%20points='24,64%2044,28%2064,64'%20fill='%23b09060'%20/%3e%3c/svg%3e",Pe="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%2366b3ff'%20/%3e%3ccircle%20cx='32'%20cy='32'%20r='20'%20fill='%231e90ff'%20/%3e%3c/svg%3e",Re="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3cpolygon%20points='16,48%2032,16%2048,48'%20fill='%23d2691e'%20/%3e%3crect%20x='24'%20y='32'%20width='16'%20height='16'%20fill='%23f4a460'%20/%3e%3c/svg%3e",Ie="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23c0c0c0'%20/%3e%3crect%20x='8'%20y='24'%20width='48'%20height='24'%20fill='%23808080'%20/%3e%3crect%20x='24'%20y='16'%20width='16'%20height='8'%20fill='%23606060'%20/%3e%3c/svg%3e",Te="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23e0e0e0'%20/%3e%3crect%20x='10'%20y='22'%20width='12'%20height='30'%20fill='%23a9a9a9'%20/%3e%3crect%20x='26'%20y='14'%20width='12'%20height='38'%20fill='%23808080'%20/%3e%3crect%20x='42'%20y='26'%20width='12'%20height='26'%20fill='%23a9a9a9'%20/%3e%3c/svg%3e",Le="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b4513'%20/%3e%3cpolygon%20points='32,10%2042,22%2022,22'%20fill='%23555'%20/%3e%3crect%20x='30'%20y='22'%20width='4'%20height='32'%20fill='%23ccc'%20/%3e%3c/svg%3e",qe="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%234682b4'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='12'%20fill='%23fff'%20/%3e%3crect%20x='28'%20y='36'%20width='8'%20height='16'%20fill='%23fff'%20/%3e%3c/svg%3e",De="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23556b2f'%20/%3e%3cline%20x1='16'%20y1='16'%20x2='48'%20y2='48'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cpolygon%20points='48,48%2044,36%2036,44'%20fill='%23fff'%20/%3e%3c/svg%3e",Be="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b0000'%20/%3e%3cline%20x1='18'%20y1='18'%20x2='46'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cline%20x1='46'%20y1='18'%20x2='18'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3c/svg%3e";class $e{listeners=new Map;on(e,t){const n=this.listeners.get(e)??[];n.push(t),this.listeners.set(e,n)}off(e,t){const n=this.listeners.get(e);if(!n)return;const i=n.indexOf(t);i!==-1&&(n.splice(i,1),n.length===0?this.listeners.delete(e):this.listeners.set(e,n))}emit(e,t){const n=this.listeners.get(e);if(n)for(const i of n)i(t)}}const h=new $e;class J{type="farm";cost=50;foodPerTick=1}class le{type="barracks";cost=100;trainingCapacity=1}const ce=Math.sqrt(3),Oe=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function $(s,e){return{x:e*ce*(s.q+s.r/2),y:e*(3/2)*s.r}}function Fe(s,e,t){const n=(ce/3*s-.3333333333333333*e)/t,i=2/3*e/t;return He({q:n,r:i})}function j(s){return Oe.map(e=>({q:s.q+e.q,r:s.r+e.r}))}function He(s){let e=s.q,t=s.r,n=-e-t,i=Math.round(e),o=Math.round(n),a=Math.round(t);const r=Math.abs(i-e),l=Math.abs(o-n),c=Math.abs(a-t);return r>l&&r>c?i=-o-a:l>c?o=-i-a:a=-i-o,{q:i,r:a}}const G=new Set;let H=32;function ze(s){return`${s.q},${s.r}`}function X(s,e){H=e,G.add(ze(s))}function Ge(s){if(G.size===0)return{center:{x:0,y:0},zoom:1};const e=H*Math.sqrt(3),t=H*2;let n=1/0,i=1/0,o=-1/0,a=-1/0;for(const u of G){const[w,k]=u.split(",").map(Number),{x:v,y:S}=$({q:w,r:k},H);n=Math.min(n,v),i=Math.min(i,S),o=Math.max(o,v+e),a=Math.max(a,S+t)}const r=o-n,l=a-i,c=96,d={x:n+r/2,y:i+l/2},p=s.width/(r+c*2),g=s.height/(l+c*2),y=Math.min(p,g);return{center:d,zoom:y}}const L={x:0,y:0,zoom:1};function Ne(s,e=300){const t=L.x,n=L.y,i=L.zoom,o=typeof performance<"u"?performance.now():Date.now(),a=r=>{const l=Math.min((r-o)/e,1);L.x=t+(s.center.x-t)*l,L.y=n+(s.center.y-n)*l,L.zoom=i+(s.zoom-i)*l,l<1&&(typeof requestAnimationFrame<"u"?requestAnimationFrame(a):setTimeout(()=>a(typeof performance<"u"?performance.now():Date.now()),16))};typeof requestAnimationFrame<"u"?requestAnimationFrame(a):setTimeout(()=>a(typeof performance<"u"?performance.now():Date.now()),0)}function Ue(){G.clear()}async function Qe(s){const e={},t={},n=[],i=Object.entries(s.images??{}).map(([a,r])=>new Promise(l=>{const c=new Image;c.onload=()=>{e[a]=c,l()},c.onerror=()=>{const d=`Failed to load image: ${r}`;console.error(d),n.push(d),l()},c.src=r})),o=Object.entries(s.sounds??{}).map(([a,r])=>new Promise(l=>{const c=new Audio;c.oncanplaythrough=()=>{t[a]=c,l()},c.onerror=()=>{const d=`Failed to load sound: ${r}`;console.error(d),n.push(d),l()},c.src=r,c.load()}));return await Promise.all([...i,...o]),{assets:{images:e,sounds:t},failures:n}}function _e(s){const e=localStorage.getItem(s);if(e)try{return JSON.parse(e)}catch(t){console.warn(`Failed to parse data for "${s}", clearing`,t),localStorage.removeItem(s);return}}function K(s){return`${s.q},${s.r}`}const de={farm:()=>new J,barracks:()=>new le};function We(s){return de[s]?.()}var P=(s=>(s.GOLD="gold",s))(P||{});const Ke={gold:1};class Ye{constructor(e,t="gameState"){this.tickInterval=e,this.storageKey=t}resources={gold:0};passiveGeneration={...Ke};lastSaved=Date.now();buildings={};buildingPlacements=new Map;policies=new Set;nightWorkSpeedMultiplier=1;tick(){Object.keys(this.passiveGeneration).forEach(e=>{this.addResource(e,this.passiveGeneration[e])})}save(){this.lastSaved=Date.now();const e={};this.buildingPlacements.forEach((n,i)=>{e[i]=n.type});const t={resources:this.resources,lastSaved:this.lastSaved,buildings:this.buildings,buildingPlacements:e};localStorage.setItem(this.storageKey,JSON.stringify(t))}load(e){const t=_e(this.storageKey);if(!t){this.lastSaved=Date.now();return}this.resources={...this.resources,...t.resources};const n={};Object.entries(t.buildings??{}).forEach(([a,r])=>{de[a]&&(n[a]=r)}),this.buildings=n,this.buildingPlacements.clear(),t.buildingPlacements&&Object.entries(t.buildingPlacements).forEach(([a,r])=>{const l=We(r);if(!l)return;this.buildingPlacements.set(a,l);const[c,d]=a.split(",").map(Number);if(e){const p=e.ensureTile(c,d);p.placeBuilding(l.type),p.reveal(),X({q:c,r:d},e.hexSize)}h.emit("buildingPlaced",{building:l,coord:{q:c,r:d},state:this})}),this.lastSaved=t.lastSaved??Date.now();const i=Date.now()-this.lastSaved,o=Math.floor(i/this.tickInterval);Object.keys(this.passiveGeneration).forEach(a=>{this.resources[a]+=o*this.passiveGeneration[a]})}getResource(e){return this.resources[e]}canAfford(e,t="gold"){return this.resources[t]>=e}spend(e,t="gold"){return this.canAfford(e,t)?(this.resources[t]-=e,h.emit("resourceChanged",{resource:t,amount:-e,total:this.resources[t]}),!0):!1}addResource(e,t){this.resources[e]+=t,h.emit("resourceChanged",{resource:e,amount:t,total:this.resources[e]})}modifyPassiveGeneration(e,t){this.passiveGeneration[e]=(this.passiveGeneration[e]??0)+t}construct(e,t,n="gold"){return this.spend(t,n)?(this.buildings[e]=(this.buildings[e]??0)+1,!0):!1}placeBuilding(e,t,n,i="gold"){const o=n.getTile(t.q,t.r);return!o||o.building||!this.construct(e.type,e.cost,i)?!1:(this.buildingPlacements.set(K(t),e),o.placeBuilding(e.type),h.emit("buildingPlaced",{building:e,coord:t,state:this}),!0)}getBuildingAt(e){return this.buildingPlacements.get(K(e))}removeBuilding(e,t){const n=K(e),i=this.buildingPlacements.get(n);return i?(this.buildingPlacements.delete(n),t.getTile(e.q,e.r)?.placeBuilding(null),this.buildings[i.type]!==void 0&&(this.buildings[i.type]-=1,this.buildings[i.type]<=0&&delete this.buildings[i.type]),h.emit("buildingRemoved",{building:i,coord:e,state:this}),!0):!1}upgrade(e,t,n="gold"){return this.construct(`upgrade:${e}`,t,n)}applyPolicy(e,t,n="gold"){return this.spend(t,n)?(this.policies.add(e),h.emit("policyApplied",{policy:e,state:this}),!0):!1}hasPolicy(e){return this.policies.has(e)}}class je{constructor(e,t){this.baseInterval=e,this.onTick=t}timer=null;speed=1;lastTick=0;accumulator=0;start(){this.stop(),this.lastTick=Date.now();const e=this.baseInterval/this.speed;this.timer=setInterval(()=>{const t=Date.now(),n=t-this.lastTick;this.lastTick=t,this.onTick(n)},e)}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null)}setSpeed(e){if(e<=0)throw new Error("Speed multiplier must be positive");this.speed=e,this.timer!==null&&this.start()}getSpeed(){return this.speed}getBaseInterval(){return this.baseInterval}tick(e){for(this.accumulator+=e*this.speed;this.accumulator>=this.baseInterval;)this.accumulator-=this.baseInterval,this.onTick(this.baseInterval)}}var N=(s=>(s[s.Plains=0]="Plains",s[s.Forest=1]="Forest",s[s.Hills=2]="Hills",s[s.Lake=3]="Lake",s))(N||{});function Xe(s,e,t){let n=s*374761393+e*668265263+t*0x14057b7ef7678100;return n=(n^n>>13)*1274126177,n^=n>>16,(n>>>0)/4294967295}function se(s,e,t=0){const n=Xe(s,e,t);return n<.1?3:n<.3?1:n<.5?2:0}class ie{constructor(e=N.Plains,t=null,n=!0){this.terrain=e,this.building=t,this.isFogged=n}reveal(){this.isFogged=!1}placeBuilding(e){this.building=e}setFogged(e){this.isFogged=e}}class Ve{constructor(e=10,t=10,n=32,i=0){this.hexSize=n,this.seed=i,this.minQ=0,this.minR=0,this.maxQ=e-1,this.maxR=t-1;for(let o=this.minR;o<=this.maxR;o++)for(let a=this.minQ;a<=this.maxQ;a++)this.tiles.set(this.key(a,o),new ie(se(a,o,i)))}tiles=new Map;minQ;maxQ;minR;maxR;get width(){return this.maxQ-this.minQ+1}get height(){return this.maxR-this.minR+1}key(e,t){return`${e},${t}`}ensureTile(e,t){const n=this.key(e,t);let i=this.tiles.get(n);return i||(i=new ie(se(e,t,this.seed)),this.tiles.set(n,i),this.minQ=Math.min(this.minQ,e),this.maxQ=Math.max(this.maxQ,e),this.minR=Math.min(this.minR,t),this.maxR=Math.max(this.maxR,t),i.isFogged||X({q:e,r:t},this.hexSize)),i}getTile(e,t){return this.ensureTile(e,t)}forEachTile(e){for(let t=this.minR;t<=this.maxR;t++)for(let n=this.minQ;n<=this.maxQ;n++){const i=this.ensureTile(n,t);e(i,{q:n,r:t})}}getNeighbors(e,t){return j({q:e,r:t}).map(n=>this.ensureTile(n.q,n.r))}revealAround(e,t){for(let o=-t;o<=t;o++){const a=Math.max(-t,-o-t),r=Math.min(t,-o+t);for(let l=a;l<=r;l++){const c={q:e.q+o,r:e.r+l};this.ensureTile(c.q,c.r).reveal(),X(c,this.hexSize)}}const n=typeof window<"u"?{width:window.innerWidth,height:window.innerHeight}:{width:0,height:0},i=Ge(n);Ne(i,300)}}const ue=({policy:s,state:e})=>{s==="eco"&&(e.modifyPassiveGeneration(P.GOLD,1),h.off("policyApplied",ue))},he=({policy:s,state:e})=>{s==="temperance"&&(e.nightWorkSpeedMultiplier*=1.05,h.off("policyApplied",he))};h.on("policyApplied",ue);h.on("policyApplied",he);const Je="modulepreload",Ze=function(s){return"/autobattles4xfinsauna/"+s},oe={},et=function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){let l=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");i=l(t.map(c=>{if(c=Ze(c),c in oe)return;oe[c]=!0;const d=c.endsWith(".css"),p=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${p}`))return;const g=document.createElement("link");if(g.rel=d?"stylesheet":Je,d||(g.as="script"),g.crossOrigin="",g.href=c,r&&g.setAttribute("nonce",r),document.head.appendChild(g),d)return new Promise((y,u)=>{g.addEventListener("load",y),g.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return i.then(a=>{for(const r of a||[])r.status==="rejected"&&o(r.reason);return e().catch(o)})},tt=({building:s,coord:e,state:t})=>{s instanceof J?t.modifyPassiveGeneration(P.GOLD,s.foodPerTick):s instanceof le&&et(async()=>{const{spawnUnit:n}=await import("./UnitFactory-CY1-HAZk.js");return{spawnUnit:n}},[]).then(({spawnUnit:n})=>{n(t,"soldier",`barracks-${e.q}-${e.r}`,e,"player")})},nt=({building:s,state:e})=>{s instanceof J&&e.modifyPassiveGeneration(P.GOLD,-s.foodPerTick)};h.on("buildingPlaced",tt);h.on("buildingRemoved",nt);function b(s){return`${s.q},${s.r}`}function st(s){const[e,t]=s.split(",").map(Number);return{q:e,r:t}}function ae(s,e){const t=-s.q-s.r,n=-e.q-e.r;return Math.max(Math.abs(s.q-e.q),Math.abs(s.r-e.r),Math.abs(t-n))}class it{constructor(e,t,n,i,o=[]){this.id=e,this.coord=t,this.faction=n,this.stats=i,this.priorityFactions=o,this.maxHealth=i.health}alive=!0;listeners={};maxHealth;healMarkerElapsed=0;onDeath(e){(this.listeners.death??=[]).push(e)}emitDeath(){for(const e of this.listeners.death??[])e()}isDead(){return!this.alive}getMaxHealth(){return this.maxHealth}distanceTo(e){return ae(this.coord,e)}attack(e){this.distanceTo(e.coord)<=this.stats.attackRange&&e.takeDamage(this.stats.attackDamage,this)}update(e,t){if(!(this.isDead()||!t))if(ae(this.coord,t.pos)<=t.auraRadius){const n=this.stats.health;this.stats.health=Math.min(this.stats.health+t.regenPerSec*e,this.maxHealth),this.stats.health>n&&(this.healMarkerElapsed+=e,this.healMarkerElapsed>=1&&(this.healMarkerElapsed=0,this.spawnHealMarker()))}else this.healMarkerElapsed=0}spawnHealMarker(){if(typeof document>"u")return;const e=document.getElementById("game-canvas");if(!e)return;const{x:t,y:n}=$(this.coord,32),i=document.createElement("div");i.textContent="+",i.className="heal-marker",i.style.position="absolute";const o=e.getBoundingClientRect();i.style.left=`${o.left+t}px`,i.style.top=`${o.top+n}px`,i.style.pointerEvents="none",document.body.appendChild(i),setTimeout(()=>i.remove(),1e3)}takeDamage(e,t){this.stats.health-=e,h.emit("unitDamaged",{attackerId:t?.id,targetId:this.id,amount:e,remainingHealth:this.stats.health}),this.stats.health<=0&&this.alive&&(this.stats.health=0,this.alive=!1,h.emit("unitDied",{unitId:this.id,attackerId:t?.id}),this.emitDeath())}moveTowards(e,t,n){const i=this.findPath(e,t,n);if(i.length<2)return[];let o=0;for(let r=1;r<i.length;r++){const l=b(i[r]);if(n.has(l))break;o=r}if(o===0)return[];const a=Math.min(this.stats.movementRange,o);return i.slice(0,a+1)}findPath(e,t,n){const i=this.coord,o=b(i),a=b(e),r=[i],l=new Map;for(l.set(o,null);r.length>0;){const p=r.shift(),g=b(p);if(g===a)break;for(const y of j(p)){const u=b(y);u!==a&&!this.isPassable(y,t,n)||l.has(u)||(r.push(y),l.set(u,g))}}if(!l.has(a))return[i];const c=[];let d=a;for(;d;)c.push(st(d)),d=l.get(d)??null;return c.reverse()}seekNearestEnemy(e,t,n){const i=new Map;for(const r of e)i.set(b(r.coord),r);const o=[this.coord],a=new Set([b(this.coord)]);for(;o.length>0;){const r=o.shift(),l=b(r),c=i.get(l);if(c)return c;for(const d of j(r)){const p=b(d),g=i.get(p);if(g)return g;this.isPassable(d,t,n)&&(a.has(p)||(a.add(p),o.push(d)))}}return null}isPassable(e,t,n){const i=t.getTile(e.q,e.r);return!i||n&&n.has(b(e))?!1:i.terrain!==N.Lake}}const ot={health:12,attackDamage:4,attackRange:1,movementRange:2};class at extends it{constructor(e,t,n){super(e,t,n,{...ot})}}let x=null;const B={};function fe(){if(x||typeof window>"u")return x;const s=window.AudioContext||window.webkitAudioContext;if(!s)return console.warn("Web Audio API not supported"),null;try{x=new s}catch(e){return console.warn("Unable to create AudioContext",e),null}if(B.click=rt(),B.spawn=lt(),B.error=ct(),B.sisu=dt(),x.state==="suspended"){const e=()=>{x?.resume()};window.addEventListener("pointerdown",e,{once:!0})}return x}function U(s,e){const t=x,n=t.createBuffer(1,s,t.sampleRate),i=n.getChannelData(0);for(let o=0;o<s;o++){const a=o/t.sampleRate;i[o]=e(a)}return n}function rt(){return U(Math.floor(x.sampleRate*.05),e=>Math.sin(2*Math.PI*1e3*e)*Math.exp(-40*e))}function lt(){return U(Math.floor(x.sampleRate*.2),e=>(Math.sin(2*Math.PI*440*e)+Math.sin(2*Math.PI*660*e))*.5*Math.exp(-6*e))}function ct(){return U(Math.floor(x.sampleRate*.3),e=>Math.sin(2*Math.PI*110*e)*Math.exp(-8*e))}function dt(){return U(Math.floor(x.sampleRate*.5),e=>Math.sin(2*Math.PI*880*e)*Math.exp(-2*e))}let Q=!1;typeof localStorage<"u"&&(Q=localStorage.getItem("sfx-muted")==="true");function re(){return Q}function ut(s){Q=s,typeof localStorage<"u"&&localStorage.setItem("sfx-muted",s?"true":"false")}function me(s){if(Q)return;const e=fe();if(!e)return;const t=B[s];if(!t)return;e.state==="suspended"&&e.resume();const n=e.createBufferSource();n.buffer=t,n.connect(e.destination),n.start()}typeof document<"u"&&document.addEventListener("click",s=>{s.target instanceof HTMLButtonElement&&me("click")});fe();function ht(s){return{id:"sauna",pos:s,spawnCooldown:30,timer:30,auraRadius:2,regenPerSec:1,rallyToFront:!1,update(e,t,n){if(this.timer-=e,this.timer>0)return;const i=[];for(let o=-2;o<=2;o++){const a=Math.max(-2,-o-2),r=Math.min(2,-o+2);for(let l=a;l<=r;l++){const c=Math.max(Math.abs(o),Math.abs(l),Math.abs(-o-l));if(c===0||c>2)continue;const d={q:this.pos.q+o,r:this.pos.r+l};t.some(g=>!g.isDead()&&g.coord.q===d.q&&g.coord.r===d.r)||i.push(d)}}if(i.length>0){const o=i[Math.floor(Math.random()*i.length)],a=`raider${t.length+1}`,r=new at(a,o,"player");n(r)}this.timer=this.spawnCooldown}}}function ft(s){const e=document.getElementById("ui-overlay");if(!e)return()=>{};const t=document.createElement("button");t.textContent="Sauna ♨️",e.appendChild(t);const n=document.createElement("div");n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.background="rgba(0,0,0,0.7)",n.style.color="#fff",n.style.padding="8px",n.style.display="none",n.style.minWidth="120px";const i=document.createElement("div");i.style.height="8px",i.style.background="#555";const o=document.createElement("div");o.style.height="100%",o.style.background="#0f0",o.style.width="0%",i.appendChild(o),n.appendChild(i);const a=document.createElement("label"),r=document.createElement("input");return r.type="checkbox",r.checked=s.rallyToFront,r.addEventListener("change",()=>{s.rallyToFront=r.checked}),a.appendChild(r),a.appendChild(document.createTextNode(" Rally to Front")),n.appendChild(a),e.appendChild(n),t.addEventListener("click",()=>{n.style.display=n.style.display==="none"?"block":"none"}),()=>{const l=1-s.timer/s.spawnCooldown;o.style.width=`${Math.max(0,Math.min(l,1))*100}%`,r.checked=s.rallyToFront}}function O(s,e){const t=document.createElement("div");if(t.classList.add("topbar-badge"),e){const r=document.createElement("img");r.src=e,r.alt=s,r.decoding="async",r.classList.add("topbar-badge-icon"),t.appendChild(r)}const n=document.createElement("div");n.classList.add("badge-text");const i=document.createElement("span");i.textContent=s,i.classList.add("badge-label"),n.appendChild(i);const o=document.createElement("span");o.textContent="0",o.classList.add("badge-value"),n.appendChild(o);const a=document.createElement("span");return a.classList.add("badge-delta"),a.style.opacity="0",a.style.transform="translateY(-6px)",a.style.transition="opacity 0.5s ease, transform 0.5s ease",t.append(n,a),{container:t,value:o,delta:a}}function mt(s,e={}){const t=document.getElementById("ui-overlay");if(!t)return()=>{};const n=document.createElement("div");n.id="topbar",t.appendChild(n);const i=O("Saunakunnia",e.saunakunnia);i.container.classList.add("badge-sauna");const o=O("SISU🔥",e.sisu);o.container.classList.add("badge-sisu"),o.container.style.display="none";const a=O("Gold",e.gold);a.container.classList.add("badge-gold");const r=O("Time");r.container.classList.add("badge-time"),r.delta.style.display="none",n.appendChild(i.container),n.appendChild(o.container),n.appendChild(a.container),n.appendChild(r.container);const l=document.createElement("button");l.type="button",l.textContent="SISU",l.classList.add("topbar-button","sisu-button"),l.addEventListener("click",()=>{h.emit("sisuPulse",{})}),n.appendChild(l);const c=document.createElement("button");c.type="button",c.title="Toggle sound",c.classList.add("topbar-button","sound-button");const d=document.createElement("span");if(d.textContent="Sound",e.sound){const u=document.createElement("img");u.src=e.sound,u.alt="",u.decoding="async",u.setAttribute("aria-hidden","true"),c.appendChild(u)}c.appendChild(d);function p(){const u=re();d.textContent=u?"Muted":"Sound",c.setAttribute("aria-pressed",u?"true":"false"),c.classList.toggle("is-muted",u)}c.addEventListener("click",()=>{ut(!re()),p()}),p(),n.appendChild(c),h.on("sisuPulseStart",({remaining:u})=>{l.disabled=!0,o.container.style.display="block",o.value.textContent=String(u)}),h.on("sisuPulseTick",({remaining:u})=>{o.value.textContent=String(u)}),h.on("sisuPulseEnd",()=>{o.container.style.display="none"}),h.on("sisuCooldownEnd",()=>{l.disabled=!1}),a.value.textContent=String(s.getResource(P.GOLD));const g={saunakunnia:i,sisu:o,gold:a};h.on("resourceChanged",({resource:u,amount:w,total:k})=>{const v=g[u];if(!v)return;v.value.textContent=String(k);const S=w>0?"+":"";v.delta.textContent=`${S}${w}`,v.delta.style.opacity="1",v.delta.style.transform="translateY(0)",setTimeout(()=>{v.delta.style.opacity="0",v.delta.style.transform="translateY(-6px)"},1e3)});let y=0;return u=>{y+=u;const w=Math.floor(y/1e3),k=Math.floor(w/60),v=w%60;r.value.textContent=`${k}:${v.toString().padStart(2,"0")}`}}let z=!1,Y=!1;function pt(){return z}function gt(s,e){if(z||Y)return;z=!0,Y=!0;let t=10;h.emit("sisuPulseStart",{remaining:t});const n=[];for(const o of e)o.faction!=="player"||o.isDead()||(n.push({unit:o,move:o.stats.movementRange,attack:o.stats.attackDamage}),o.stats.movementRange*=1.2,o.stats.attackDamage*=1.2,o.fearless=!0);const i=setInterval(()=>{if(t-=1,t>0){h.emit("sisuPulseTick",{remaining:t});return}clearInterval(i),z=!1;for(const o of n)o.unit.stats.movementRange=o.move,o.unit.stats.attackDamage=o.attack,delete o.unit.fearless;h.emit("sisuPulseEnd",{}),setTimeout(()=>{Y=!1,h.emit("sisuCooldownEnd",{})},12e4)},1e3)}function yt(s){const e=document.getElementById("ui-overlay");if(!e)return{log:()=>{},addEvent:()=>{}};const t=document.createElement("div");t.id="right-panel",t.style.position="absolute",t.style.top="0",t.style.right="0",t.style.width="240px",t.style.height="100%",t.style.display="flex",t.style.flexDirection="column",t.style.background="rgba(0,0,0,0.5)",t.style.color="#fff",e.appendChild(t);const n=document.createElement("div");n.style.display="flex",t.appendChild(n);const i=document.createElement("div");i.style.flex="1",i.style.overflowY="auto",t.appendChild(i);const o=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div");r.id="event-log",r.style.display="flex",r.style.flexDirection="column";const l={Policies:o,Events:a,Log:r};function c(f){for(const[m,R]of Object.entries(l))R.style.display=m===f?"block":"none";for(const m of n.children){const R=m;R.disabled=R.textContent===f}}for(const f of Object.keys(l)){const m=document.createElement("button");m.textContent=f,m.addEventListener("click",()=>c(f)),n.appendChild(m),i.appendChild(l[f])}const d=[{id:"eco",name:"Eco Policy",description:"Increase gold income by 1",cost:15,prerequisite:()=>!0},{id:"temperance",name:"Temperance",description:"+5% work speed at night",cost:25,prerequisite:()=>!0}],p={};function g(){o.innerHTML="";for(const f of d){const m=document.createElement("button");m.textContent=`${f.name} (${f.cost}g)`,m.title=f.description,m.disabled=!f.prerequisite(s)||s.hasPolicy(f.id),m.addEventListener("click",()=>{s.applyPolicy(f.id,f.cost)&&y()}),o.appendChild(m),o.appendChild(document.createElement("br")),p[f.id]=m}}function y(){for(const f of d){const m=p[f.id];m&&(m.disabled=!f.prerequisite(s)||s.hasPolicy(f.id))}}g(),h.on("resourceChanged",y),h.on("policyApplied",y);const u=[];function w(){a.innerHTML="";for(const f of u){const m=document.createElement("div"),R=document.createElement("h4");R.textContent=f.headline;const te=document.createElement("p");te.textContent=f.body;const W=document.createElement("button");W.textContent=f.buttonText??"Acknowledge",W.addEventListener("click",()=>{const ne=u.findIndex(Ce=>Ce.id===f.id);ne!==-1&&(u.splice(ne,1),w())}),m.appendChild(R),m.appendChild(te),m.appendChild(W),a.appendChild(m)}}function k(f){u.push(f),w()}const v=100,S=[];let _=!1;function Ee(){for(const f of S){const m=document.createElement("div");m.textContent=f,r.appendChild(m)}for(;r.childElementCount>v;)r.removeChild(r.firstChild);r.scrollTop=r.scrollHeight,S.length=0,_=!1}function ke(f){S.push(f),_||(_=!0,(typeof requestAnimationFrame=="function"?requestAnimationFrame:m=>setTimeout(m,16))(Ee))}return c("Policies"),{log:ke,addEvent:k}}function vt(s){const e=document.getElementById("ui-overlay");if(!e)return;const t=document.createElement("div");t.id="error-overlay",t.style.position="absolute",t.style.inset="0",t.style.background="rgba(0, 0, 0, 0.75)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.pointerEvents="auto",t.style.zIndex="1000";const n=document.createElement("div");n.className="card",n.style.background="rgba(20, 20, 20, 0.9)",n.style.color="white",n.style.maxWidth="80%",n.style.textAlign="center",n.style.padding="var(--gap-lg)";const i=document.createElement("h2");i.textContent="Asset load errors",n.appendChild(i);const o=document.createElement("ul");o.style.textAlign="left",o.style.margin="var(--gap-md) 0";for(const r of s){const l=document.createElement("li");l.textContent=r,o.appendChild(l)}n.appendChild(o);const a=document.createElement("button");a.textContent="Reload",a.className="btn",a.addEventListener("click",()=>{location.reload()}),n.appendChild(a),t.appendChild(n),e.appendChild(t)}const wt=Math.sqrt(3),xt=2;function pe(s){return{width:s*wt,height:s*xt}}class bt{constructor(e){this.mapRef=e}get hexSize(){return this.mapRef.hexSize}draw(e,t,n){const{width:i,height:o}=pe(this.hexSize),a=$({q:this.mapRef.minQ,r:this.mapRef.minR},this.hexSize);for(const[r,l]of this.mapRef.tiles){const[c,d]=r.split(",").map(Number),{x:p,y:g}=$({q:c,r:d},this.hexSize),y=p-a.x,u=g-a.y;if(e.save(),l.isFogged&&(e.globalAlpha*=.4),this.drawTerrain(e,t,l.terrain,y,u,i,o),l.building){const k=t[`building-${l.building}`]??t.placeholder;e.drawImage(k,y,u,i,o)}const w=n&&c===n.q&&d===n.r;this.strokeHex(e,y+this.hexSize,u+this.hexSize,this.hexSize,!!w),e.restore()}}drawToCanvas(e,t,n){const i=e.getContext("2d");if(!i)throw new Error("Canvas 2D context not available");this.draw(i,t,n)}drawTerrain(e,t,n,i,o,a,r){const l=`terrain-${N[n].toLowerCase()}`,c=t[l]??t.placeholder;e.drawImage(c,i,o,a,r)}strokeHex(e,t,n,i,o=!1){this.hexPath(e,t,n,i),e.strokeStyle=o?"#ff0000":"#000000",e.stroke()}hexPath(e,t,n,i){e.beginPath();for(let o=0;o<6;o++){const a=Math.PI/180*(60*o-30),r=t+i*Math.cos(a),l=n+i*Math.sin(a);o===0?e.moveTo(r,l):e.lineTo(r,l)}e.closePath()}}function Et(s,e,t,n,i){const o=window.devicePixelRatio||1;s.clearRect(0,0,s.canvas.width/o,s.canvas.height/o),e.draw(s,t,i??void 0),kt(s,e,t,n)}function kt(s,e,t,n){const{width:i,height:o}=pe(e.hexSize);for(const a of n){const{x:r,y:l}=$(a.coord,e.hexSize),c=t[`unit-${a.type}`]??t.placeholder,d=a.getMaxHealth();s.save(),a.stats.health/d<.5&&(s.filter="saturate(0)"),s.drawImage(c,r,l,i,o),pt()&&a.faction==="player"&&(s.strokeStyle="rgba(255,255,255,0.5)",s.lineWidth=2,s.strokeRect(r,l,i,o)),s.restore()}}const I="/autobattles4xfinsauna/",F={forest:`${I}assets/tiles/forest.svg`,water:`${I}assets/tiles/water.svg`,mountain:`${I}assets/tiles/mountain.svg`,plains:`${I}assets/tiles/plains.svg`},A={gold:`${I}assets/ui/gold.svg`,resource:`${I}assets/ui/resource.svg`,sound:`${I}assets/ui/sound.svg`};let ge,M,q=null;function Ct(s,e){ge=s,M=e,M.classList.add("resource-bar"),M.setAttribute("role","status"),M.setAttribute("aria-live","polite"),M.replaceChildren();const t=document.createElement("img");t.src=A.resource,t.alt="Resources",t.decoding="async",t.classList.add("resource-icon");const n=document.createElement("span");n.textContent="Resources",n.classList.add("resource-label"),q=document.createElement("span"),q.textContent="0",q.classList.add("resource-value"),M.append(t,n,q),ee(C.getResource(P.GOLD))}function St(s,e){ve=Fe(s-E.hexSize,e-E.hexSize,E.hexSize),D()}const Mt={images:{placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=","terrain-plains":Se,"terrain-forest":Me,"terrain-hills":Ae,"terrain-lake":Pe,"building-farm":Re,"building-barracks":Ie,"building-city":Te,"building-mine":Le,"unit-soldier":qe,"unit-archer":De,"unit-raider":Be,"tile-forest":F.forest,"tile-water":F.water,"tile-mountain":F.mountain,"tile-plains":F.plains,"icon-gold":A.gold,"icon-resource":A.resource,"icon-sound":A.sound}};let V;const E=new Ve(10,10,32),At=new bt(E);E.forEachTile(s=>s.setFogged(!0));Ue();const C=new Ye(1e3);C.load(E);const Pt=2,Rt=new je(1e3,()=>{C.tick(),C.save();for(const s of T)!s.isDead()&&s.faction==="player"&&E.revealAround(s.coord,Pt);D()}),T=[],Z=ht({q:Math.floor(E.width/2),r:Math.floor(E.height/2)});E.revealAround(Z.pos,3);const It=ft(Z),Tt=mt(C,{saunakunnia:A.resource,sisu:A.resource,gold:A.gold,sound:A.sound}),{log:ye,addEvent:Bt}=yt(C);h.on("sisuPulse",()=>gt(C,T));h.on("sisuPulseStart",()=>me("sisu"));C.addResource(P.GOLD,200);let ve=null;function D(){const s=ge.getContext("2d");!s||!V||Et(s,At,V.images,T,ve)}const we=({resource:s,total:e,amount:t})=>{ee(e);const n=t>0?"+":"";ye(`${s}: ${n}${t}`)};h.on("resourceChanged",we);const xe=({policy:s})=>{ye(`Policy applied: ${s}`)};h.on("policyApplied",xe);const be=({unitId:s})=>{const e=T.findIndex(t=>t.id===s);e!==-1&&(T.splice(e,1),D())};h.on("unitDied",be);function Lt(){h.off("resourceChanged",we),h.off("policyApplied",xe),h.off("unitDied",be)}async function qt(){const{assets:s,failures:e}=await Qe(Mt);V=s,e.length&&(console.warn("Failed to load assets",e),vt(e)),ee(C.getResource(P.GOLD)),D();let t=performance.now();function n(i){const o=i-t;t=i,Rt.tick(o),Z.update(o/1e3,T,a=>{T.push(a),D()}),It(),Tt(o),requestAnimationFrame(n)}requestAnimationFrame(n)}function ee(s){q?q.textContent=String(s):M&&(M.textContent=`Resources: ${s}`)}function Dt(){const s=document.getElementById("game-canvas"),e=document.getElementById("resource-bar");if(!s||!e)return;Ct(s,e);function t(){const n=window.devicePixelRatio||1;s.style.width=`${window.innerWidth}px`,s.style.height=`${window.innerHeight}px`,s.width=window.innerWidth*n,s.height=window.innerHeight*n;const i=s.getContext("2d");i&&(i.setTransform(1,0,0,1,0,0),i.scale(n,n)),D()}window.addEventListener("resize",t),s.addEventListener("click",n=>{const i=s.getBoundingClientRect();St(n.clientX-i.left,n.clientY-i.top)}),window.addEventListener("beforeunload",Lt),t(),import.meta.vitest||qt()}window.addEventListener("DOMContentLoaded",Dt);export{P as R,it as U,me as p};
