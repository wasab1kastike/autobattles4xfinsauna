const Ze="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3cpolygon%20points='16,48%2032,16%2048,48'%20fill='%23d2691e'%20/%3e%3crect%20x='24'%20y='32'%20width='16'%20height='16'%20fill='%23f4a460'%20/%3e%3c/svg%3e",Je="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23c0c0c0'%20/%3e%3crect%20x='8'%20y='24'%20width='48'%20height='24'%20fill='%23808080'%20/%3e%3crect%20x='24'%20y='16'%20width='16'%20height='8'%20fill='%23606060'%20/%3e%3c/svg%3e",et="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23e0e0e0'%20/%3e%3crect%20x='10'%20y='22'%20width='12'%20height='30'%20fill='%23a9a9a9'%20/%3e%3crect%20x='26'%20y='14'%20width='12'%20height='38'%20fill='%23808080'%20/%3e%3crect%20x='42'%20y='26'%20width='12'%20height='26'%20fill='%23a9a9a9'%20/%3e%3c/svg%3e",tt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b4513'%20/%3e%3cpolygon%20points='32,10%2042,22%2022,22'%20fill='%23555'%20/%3e%3crect%20x='30'%20y='22'%20width='4'%20height='32'%20fill='%23ccc'%20/%3e%3c/svg%3e",nt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%234682b4'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='12'%20fill='%23fff'%20/%3e%3crect%20x='28'%20y='36'%20width='8'%20height='16'%20fill='%23fff'%20/%3e%3c/svg%3e",it="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23556b2f'%20/%3e%3cline%20x1='16'%20y1='16'%20x2='48'%20y2='48'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cpolygon%20points='48,48%2044,36%2036,44'%20fill='%23fff'%20/%3e%3c/svg%3e",ot="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b0000'%20/%3e%3cline%20x1='18'%20y1='18'%20x2='46'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cline%20x1='46'%20y1='18'%20x2='18'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3c/svg%3e";class st{listeners=new Map;on(e,n){const i=this.listeners.get(e)??[];i.push(n),this.listeners.set(e,i)}off(e,n){const i=this.listeners.get(e);if(!i)return;const o=i.indexOf(n);o!==-1&&(i.splice(o,1),i.length===0?this.listeners.delete(e):this.listeners.set(e,i))}emit(e,n){const i=this.listeners.get(e);if(i)for(const o of i)o(n)}}const f=new st;class ce{type="farm";cost=50;foodPerTick=1}class De{type="barracks";cost=100;trainingCapacity=1}const Ye=Math.sqrt(3),rt=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function _(t,e){return{x:e*Ye*(t.q+t.r/2),y:e*(3/2)*t.r}}function at(t,e,n){const i=(Ye/3*t-.3333333333333333*e)/n,o=2/3*e/n;return lt({q:i,r:o})}function ie(t){return rt.map(e=>({q:t.q+e.q,r:t.r+e.r}))}function lt(t){let e=t.q,n=t.r,i=-e-n,o=Math.round(e),s=Math.round(i),r=Math.round(n);const a=Math.abs(o-e),l=Math.abs(s-i),c=Math.abs(r-n);return a>l&&a>c?o=-s-r:l>c?s=-o-r:r=-o-s,{q:o,r}}const K=new Set;let U=32;function ct(t){return`${t.q},${t.r}`}function oe(t,e){U=e,K.add(ct(t))}function dt(t){if(K.size===0)return{center:{x:0,y:0},zoom:1};const e=U*Math.sqrt(3),n=U*2;let i=1/0,o=1/0,s=-1/0,r=-1/0;for(const u of K){const[v,k]=u.split(",").map(Number),{x:E,y:I}=_({q:v,r:k},U);i=Math.min(i,E),o=Math.min(o,I),s=Math.max(s,E+e),r=Math.max(r,I+n)}const a=s-i,l=r-o,c=96,d={x:i+a/2,y:o+l/2},h=t.width/(a+c*2),m=t.height/(l+c*2),w=Math.min(h,m);return{center:d,zoom:w}}const b={x:0,y:0,zoom:1};function ut(t,e=300){const n=b.x,i=b.y,o=b.zoom,s=typeof performance<"u"?performance.now():Date.now(),r=a=>{const l=Math.min((a-s)/e,1);b.x=n+(t.center.x-n)*l,b.y=i+(t.center.y-i)*l,b.zoom=o+(t.zoom-o)*l,l<1&&(typeof requestAnimationFrame<"u"?requestAnimationFrame(r):setTimeout(()=>r(typeof performance<"u"?performance.now():Date.now()),16))};typeof requestAnimationFrame<"u"?requestAnimationFrame(r):setTimeout(()=>r(typeof performance<"u"?performance.now():Date.now()),0)}function ht(){K.clear()}async function ft(t){const e={},n={},i=[],o=Object.entries(t.images??{}).map(([r,a])=>new Promise(l=>{const c=new Image;c.onload=()=>{e[r]=c,l()},c.onerror=()=>{const d=`Failed to load image: ${a}`;console.error(d),i.push(d),l()},c.src=a})),s=Object.entries(t.sounds??{}).map(([r,a])=>new Promise(l=>{const c=new Audio;c.oncanplaythrough=()=>{n[r]=c,l()},c.onerror=()=>{const d=`Failed to load sound: ${a}`;console.error(d),i.push(d),l()},c.src=a,c.load()}));return await Promise.all([...o,...s]),{assets:{images:e,sounds:n},failures:i}}function pt(t){const e=localStorage.getItem(t);if(e)try{return JSON.parse(e)}catch(n){console.warn(`Failed to parse data for "${t}", clearing`,n),localStorage.removeItem(t);return}}function ee(t){return`${t.q},${t.r}`}const Ge={farm:()=>new ce,barracks:()=>new De};function mt(t){return Ge[t]?.()}var Y=(t=>(t.GOLD="gold",t))(Y||{});const gt={gold:1};class yt{constructor(e,n="gameState"){this.tickInterval=e,this.storageKey=n}resources={gold:0};passiveGeneration={...gt};lastSaved=Date.now();buildings={};buildingPlacements=new Map;policies=new Set;nightWorkSpeedMultiplier=1;tick(){Object.keys(this.passiveGeneration).forEach(e=>{this.addResource(e,this.passiveGeneration[e])})}save(){this.lastSaved=Date.now();const e={};this.buildingPlacements.forEach((i,o)=>{e[o]=i.type});const n={resources:this.resources,lastSaved:this.lastSaved,buildings:this.buildings,buildingPlacements:e};localStorage.setItem(this.storageKey,JSON.stringify(n))}load(e){const n=pt(this.storageKey);if(!n){this.lastSaved=Date.now();return}this.resources={...this.resources,...n.resources};const i={};Object.entries(n.buildings??{}).forEach(([r,a])=>{Ge[r]&&(i[r]=a)}),this.buildings=i,this.buildingPlacements.clear(),n.buildingPlacements&&Object.entries(n.buildingPlacements).forEach(([r,a])=>{const l=mt(a);if(!l)return;this.buildingPlacements.set(r,l);const[c,d]=r.split(",").map(Number);if(e){const h=e.ensureTile(c,d);h.placeBuilding(l.type),h.reveal(),oe({q:c,r:d},e.hexSize)}f.emit("buildingPlaced",{building:l,coord:{q:c,r:d},state:this})}),this.lastSaved=n.lastSaved??Date.now();const o=Date.now()-this.lastSaved,s=Math.floor(o/this.tickInterval);Object.keys(this.passiveGeneration).forEach(r=>{this.resources[r]+=s*this.passiveGeneration[r]})}getResource(e){return this.resources[e]}canAfford(e,n="gold"){return this.resources[n]>=e}spend(e,n="gold"){return this.canAfford(e,n)?(this.resources[n]-=e,f.emit("resourceChanged",{resource:n,amount:-e,total:this.resources[n]}),!0):!1}addResource(e,n){this.resources[e]+=n,f.emit("resourceChanged",{resource:e,amount:n,total:this.resources[e]})}modifyPassiveGeneration(e,n){this.passiveGeneration[e]=(this.passiveGeneration[e]??0)+n}construct(e,n,i="gold"){return this.spend(n,i)?(this.buildings[e]=(this.buildings[e]??0)+1,!0):!1}placeBuilding(e,n,i,o="gold"){const s=i.getTile(n.q,n.r);return!s||s.building||!this.construct(e.type,e.cost,o)?!1:(this.buildingPlacements.set(ee(n),e),s.placeBuilding(e.type),f.emit("buildingPlaced",{building:e,coord:n,state:this}),!0)}getBuildingAt(e){return this.buildingPlacements.get(ee(e))}removeBuilding(e,n){const i=ee(e),o=this.buildingPlacements.get(i);return o?(this.buildingPlacements.delete(i),n.getTile(e.q,e.r)?.placeBuilding(null),this.buildings[o.type]!==void 0&&(this.buildings[o.type]-=1,this.buildings[o.type]<=0&&delete this.buildings[o.type]),f.emit("buildingRemoved",{building:o,coord:e,state:this}),!0):!1}upgrade(e,n,i="gold"){return this.construct(`upgrade:${e}`,n,i)}applyPolicy(e,n,i="gold"){return this.spend(n,i)?(this.policies.add(e),f.emit("policyApplied",{policy:e,state:this}),!0):!1}hasPolicy(e){return this.policies.has(e)}}class wt{constructor(e,n){this.baseInterval=e,this.onTick=n}timer=null;speed=1;lastTick=0;accumulator=0;start(){this.stop(),this.lastTick=Date.now();const e=this.baseInterval/this.speed;this.timer=setInterval(()=>{const n=Date.now(),i=n-this.lastTick;this.lastTick=n,this.onTick(i)},e)}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null)}setSpeed(e){if(e<=0)throw new Error("Speed multiplier must be positive");this.speed=e,this.timer!==null&&this.start()}getSpeed(){return this.speed}getBaseInterval(){return this.baseInterval}tick(e){for(this.accumulator+=e*this.speed;this.accumulator>=this.baseInterval;)this.accumulator-=this.baseInterval,this.onTick(this.baseInterval)}}var L=(t=>(t[t.Plains=0]="Plains",t[t.Forest=1]="Forest",t[t.Hills=2]="Hills",t[t.Lake=3]="Lake",t))(L||{});function vt(t,e,n){let i=t*374761393+e*668265263+n*0x14057b7ef7678100;return i=(i^i>>13)*1274126177,i^=i>>16,(i>>>0)/4294967295}function me(t,e,n=0){const i=vt(t,e,n);return i<.1?3:i<.3?1:i<.5?2:0}class ge{constructor(e=L.Plains,n=null,i=!0){this.terrain=e,this.building=n,this.isFogged=i}reveal(){this.isFogged=!1}placeBuilding(e){this.building=e}setFogged(e){this.isFogged=e}}class bt{constructor(e=10,n=10,i=32,o=0){this.hexSize=i,this.seed=o,this.minQ=0,this.minR=0,this.maxQ=e-1,this.maxR=n-1;for(let s=this.minR;s<=this.maxR;s++)for(let r=this.minQ;r<=this.maxQ;r++)this.tiles.set(this.key(r,s),new ge(me(r,s,o)))}tiles=new Map;minQ;maxQ;minR;maxR;get width(){return this.maxQ-this.minQ+1}get height(){return this.maxR-this.minR+1}key(e,n){return`${e},${n}`}ensureTile(e,n){const i=this.key(e,n);let o=this.tiles.get(i);return o||(o=new ge(me(e,n,this.seed)),this.tiles.set(i,o),this.minQ=Math.min(this.minQ,e),this.maxQ=Math.max(this.maxQ,e),this.minR=Math.min(this.minR,n),this.maxR=Math.max(this.maxR,n),o.isFogged||oe({q:e,r:n},this.hexSize)),o}getTile(e,n){return this.ensureTile(e,n)}forEachTile(e){for(let n=this.minR;n<=this.maxR;n++)for(let i=this.minQ;i<=this.maxQ;i++){const o=this.ensureTile(i,n);e(o,{q:i,r:n})}}getNeighbors(e,n){return ie({q:e,r:n}).map(i=>this.ensureTile(i.q,i.r))}revealAround(e,n){for(let s=-n;s<=n;s++){const r=Math.max(-n,-s-n),a=Math.min(n,-s+n);for(let l=r;l<=a;l++){const c={q:e.q+s,r:e.r+l};this.ensureTile(c.q,c.r).reveal(),oe(c,this.hexSize)}}const i=typeof window<"u"?{width:window.innerWidth,height:window.innerHeight}:{width:0,height:0},o=dt(i);ut(o,300)}}const Be=({policy:t,state:e})=>{t==="eco"&&(e.modifyPassiveGeneration(Y.GOLD,1),f.off("policyApplied",Be))},Xe=({policy:t,state:e})=>{t==="temperance"&&(e.nightWorkSpeedMultiplier*=1.05,f.off("policyApplied",Xe))};f.on("policyApplied",Be);f.on("policyApplied",Xe);const xt="modulepreload",kt=function(t,e){return new URL(t,e).href},ye={},Et=function(e,n,i){let o=Promise.resolve();if(n&&n.length>0){let c=function(d){return Promise.all(d.map(h=>Promise.resolve(h).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};const r=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),l=a?.nonce||a?.getAttribute("nonce");o=c(n.map(d=>{if(d=kt(d,i),d in ye)return;ye[d]=!0;const h=d.endsWith(".css"),m=h?'[rel="stylesheet"]':"";if(!!i)for(let v=r.length-1;v>=0;v--){const k=r[v];if(k.href===d&&(!h||k.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${m}`))return;const u=document.createElement("link");if(u.rel=h?"stylesheet":xt,h||(u.as="script"),u.crossOrigin="",u.href=d,l&&u.setAttribute("nonce",l),document.head.appendChild(u),h)return new Promise((v,k)=>{u.addEventListener("load",v),u.addEventListener("error",()=>k(new Error(`Unable to preload CSS for ${d}`)))})}))}function s(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return o.then(r=>{for(const a of r||[])a.status==="rejected"&&s(a.reason);return e().catch(s)})},Ct=({building:t,coord:e,state:n})=>{t instanceof ce?n.modifyPassiveGeneration(Y.GOLD,t.foodPerTick):t instanceof De&&Et(async()=>{const{spawnUnit:i}=await import("./assets/UnitFactory.js");return{spawnUnit:i}},[],import.meta.url).then(({spawnUnit:i})=>{i(n,"soldier",`barracks-${e.q}-${e.r}`,e,"player")})},Mt=({building:t,state:e})=>{t instanceof ce&&e.modifyPassiveGeneration(Y.GOLD,-t.foodPerTick)};f.on("buildingPlaced",Ct);f.on("buildingRemoved",Mt);function S(t){return`${t.q},${t.r}`}function St(t){const[e,n]=t.split(",").map(Number);return{q:e,r:n}}function we(t,e){const n=-t.q-t.r,i=-e.q-e.r;return Math.max(Math.abs(t.q-e.q),Math.abs(t.r-e.r),Math.abs(n-i))}class At{constructor(e,n,i,o,s=[]){this.id=e,this.coord=n,this.faction=i,this.stats=o,this.priorityFactions=s,this.maxHealth=o.health}alive=!0;listeners={};maxHealth;healMarkerElapsed=0;onDeath(e){(this.listeners.death??=[]).push(e)}emitDeath(){for(const e of this.listeners.death??[])e()}isDead(){return!this.alive}getMaxHealth(){return this.maxHealth}distanceTo(e){return we(this.coord,e)}attack(e){this.distanceTo(e.coord)<=this.stats.attackRange&&e.takeDamage(this.stats.attackDamage,this)}update(e,n){if(!(this.isDead()||!n))if(we(this.coord,n.pos)<=n.auraRadius){const i=this.stats.health;this.stats.health=Math.min(this.stats.health+n.regenPerSec*e,this.maxHealth),this.stats.health>i&&(this.healMarkerElapsed+=e,this.healMarkerElapsed>=1&&(this.healMarkerElapsed=0,this.spawnHealMarker()))}else this.healMarkerElapsed=0}spawnHealMarker(){if(typeof document>"u")return;const e=document.getElementById("game-canvas");if(!e)return;const{x:n,y:i}=_(this.coord,32),o=document.createElement("div");o.textContent="+",o.className="heal-marker",o.style.position="absolute";const s=e.getBoundingClientRect();o.style.left=`${s.left+n}px`,o.style.top=`${s.top+i}px`,o.style.pointerEvents="none",document.body.appendChild(o),setTimeout(()=>o.remove(),1e3)}takeDamage(e,n){this.stats.health-=e,f.emit("unitDamaged",{attackerId:n?.id,targetId:this.id,amount:e,remainingHealth:this.stats.health}),this.stats.health<=0&&this.alive&&(this.stats.health=0,this.alive=!1,f.emit("unitDied",{unitId:this.id,attackerId:n?.id}),this.emitDeath())}moveTowards(e,n,i){const o=this.findPath(e,n,i);if(o.length<2)return[];let s=0;for(let a=1;a<o.length;a++){const l=S(o[a]);if(i.has(l))break;s=a}if(s===0)return[];const r=Math.min(this.stats.movementRange,s);return o.slice(0,r+1)}findPath(e,n,i){const o=this.coord,s=S(o),r=S(e),a=[o],l=new Map;for(l.set(s,null);a.length>0;){const h=a.shift(),m=S(h);if(m===r)break;for(const w of ie(h)){const u=S(w);u!==r&&!this.isPassable(w,n,i)||l.has(u)||(a.push(w),l.set(u,m))}}if(!l.has(r))return[o];const c=[];let d=r;for(;d;)c.push(St(d)),d=l.get(d)??null;return c.reverse()}seekNearestEnemy(e,n,i){const o=new Map;for(const a of e)o.set(S(a.coord),a);const s=[this.coord],r=new Set([S(this.coord)]);for(;s.length>0;){const a=s.shift(),l=S(a),c=o.get(l);if(c)return c;for(const d of ie(a)){const h=S(d),m=o.get(h);if(m)return m;this.isPassable(d,n,i)&&(r.has(h)||(r.add(h),s.push(d)))}}return null}isPassable(e,n,i){const o=n.getTile(e.q,e.r);return!o||i&&i.has(S(e))?!1:o.terrain!==L.Lake}}const Tt={health:12,attackDamage:4,attackRange:1,movementRange:2};class Pt extends At{constructor(e,n,i){super(e,n,i,{...Tt})}}let M=null;const F={};function qe(){if(M||typeof window>"u")return M;const t=window.AudioContext||window.webkitAudioContext;if(!t)return console.warn("Web Audio API not supported"),null;try{M=new t}catch(e){return console.warn("Unable to create AudioContext",e),null}if(F.click=It(),F.spawn=Rt(),F.error=Lt(),F.sisu=Dt(),M.state==="suspended"){const e=()=>{M?.resume()};window.addEventListener("pointerdown",e,{once:!0})}return M}function j(t,e){const n=M,i=n.createBuffer(1,t,n.sampleRate),o=i.getChannelData(0);for(let s=0;s<t;s++){const r=s/n.sampleRate;o[s]=e(r)}return i}function It(){return j(Math.floor(M.sampleRate*.05),e=>Math.sin(2*Math.PI*1e3*e)*Math.exp(-40*e))}function Rt(){return j(Math.floor(M.sampleRate*.2),e=>(Math.sin(2*Math.PI*440*e)+Math.sin(2*Math.PI*660*e))*.5*Math.exp(-6*e))}function Lt(){return j(Math.floor(M.sampleRate*.3),e=>Math.sin(2*Math.PI*110*e)*Math.exp(-8*e))}function Dt(){return j(Math.floor(M.sampleRate*.5),e=>Math.sin(2*Math.PI*880*e)*Math.exp(-2*e))}let V=!1;typeof localStorage<"u"&&(V=localStorage.getItem("sfx-muted")==="true");function ve(){return V}function Yt(t){V=t,typeof localStorage<"u"&&localStorage.setItem("sfx-muted",t?"true":"false")}function He(t){if(V)return;const e=qe();if(!e)return;const n=F[t];if(!n)return;e.state==="suspended"&&e.resume();const i=e.createBufferSource();i.buffer=n,i.connect(e.destination),i.start()}typeof document<"u"&&document.addEventListener("click",t=>{t.target instanceof HTMLButtonElement&&He("click")});qe();function Gt(t){return{id:"sauna",pos:t,spawnCooldown:30,timer:30,auraRadius:2,regenPerSec:1,rallyToFront:!1,update(e,n,i){if(this.timer-=e,this.timer>0)return;const o=[];for(let s=-2;s<=2;s++){const r=Math.max(-2,-s-2),a=Math.min(2,-s+2);for(let l=r;l<=a;l++){const c=Math.max(Math.abs(s),Math.abs(l),Math.abs(-s-l));if(c===0||c>2)continue;const d={q:this.pos.q+s,r:this.pos.r+l};n.some(m=>!m.isDead()&&m.coord.q===d.q&&m.coord.r===d.r)||o.push(d)}}if(o.length>0){const s=o[Math.floor(Math.random()*o.length)],r=`raider${n.length+1}`,a=new Pt(r,s,"player");i(a)}this.timer=this.spawnCooldown}}}function Bt(t){const e=document.getElementById("ui-overlay");if(!e)return()=>{};const n=document.createElement("button");n.textContent="Sauna â™¨ï¸",e.appendChild(n);const i=document.createElement("div");i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.background="rgba(0,0,0,0.7)",i.style.color="#fff",i.style.padding="8px",i.style.display="none",i.style.minWidth="120px";const o=document.createElement("div");o.style.height="8px",o.style.background="#555";const s=document.createElement("div");s.style.height="100%",s.style.background="#0f0",s.style.width="0%",o.appendChild(s),i.appendChild(o);const r=document.createElement("label"),a=document.createElement("input");return a.type="checkbox",a.checked=t.rallyToFront,a.addEventListener("change",()=>{t.rallyToFront=a.checked}),r.appendChild(a),r.appendChild(document.createTextNode(" Rally to Front")),i.appendChild(r),e.appendChild(i),n.addEventListener("click",()=>{i.style.display=i.style.display==="none"?"block":"none"}),()=>{const l=1-t.timer/t.spawnCooldown;s.style.width=`${Math.max(0,Math.min(l,1))*100}%`,a.checked=t.rallyToFront}}function N(t,e){const n=document.createElement("div");if(n.classList.add("topbar-badge"),e){const a=document.createElement("img");a.src=e,a.alt=t,a.decoding="async",a.classList.add("topbar-badge-icon"),n.appendChild(a)}const i=document.createElement("div");i.classList.add("badge-text");const o=document.createElement("span");o.textContent=t,o.classList.add("badge-label"),i.appendChild(o);const s=document.createElement("span");s.textContent="0",s.classList.add("badge-value"),i.appendChild(s);const r=document.createElement("span");return r.classList.add("badge-delta"),r.style.opacity="0",r.style.transform="translateY(-6px)",r.style.transition="opacity 0.5s ease, transform 0.5s ease",n.append(i,r),{container:n,value:s,delta:r}}function Xt(t,e={}){const n=document.getElementById("ui-overlay");if(!n)return()=>{};const i=document.createElement("div");i.id="topbar",n.appendChild(i);const o=N("Saunakunnia",e.saunakunnia);o.container.classList.add("badge-sauna");const s=N("SISUðŸ”¥",e.sisu);s.container.classList.add("badge-sisu"),s.container.style.display="none";const r=N("Gold",e.gold);r.container.classList.add("badge-gold");const a=N("Time");a.container.classList.add("badge-time"),a.delta.style.display="none",i.appendChild(o.container),i.appendChild(s.container),i.appendChild(r.container),i.appendChild(a.container);const l=document.createElement("button");l.type="button",l.textContent="SISU",l.classList.add("topbar-button","sisu-button"),l.addEventListener("click",()=>{f.emit("sisuPulse",{})}),i.appendChild(l);const c=document.createElement("button");c.type="button",c.title="Toggle sound",c.classList.add("topbar-button","sound-button");const d=document.createElement("span");if(d.textContent="Sound",e.sound){const u=document.createElement("img");u.src=e.sound,u.alt="",u.decoding="async",u.setAttribute("aria-hidden","true"),c.appendChild(u)}c.appendChild(d);function h(){const u=ve();d.textContent=u?"Muted":"Sound",c.setAttribute("aria-pressed",u?"true":"false"),c.classList.toggle("is-muted",u)}c.addEventListener("click",()=>{Yt(!ve()),h()}),h(),i.appendChild(c),f.on("sisuPulseStart",({remaining:u})=>{l.disabled=!0,s.container.style.display="block",s.value.textContent=String(u)}),f.on("sisuPulseTick",({remaining:u})=>{s.value.textContent=String(u)}),f.on("sisuPulseEnd",()=>{s.container.style.display="none"}),f.on("sisuCooldownEnd",()=>{l.disabled=!1}),r.value.textContent=String(t.getResource(Y.GOLD));const m={saunakunnia:o,sisu:s,gold:r};f.on("resourceChanged",({resource:u,amount:v,total:k})=>{const E=m[u];if(!E)return;E.value.textContent=String(k);const I=v>0?"+":"";E.delta.textContent=`${I}${v}`,E.delta.style.opacity="1",E.delta.style.transform="translateY(0)",setTimeout(()=>{E.delta.style.opacity="0",E.delta.style.transform="translateY(-6px)"},1e3)});let w=0;return u=>{w+=u;const v=Math.floor(w/1e3),k=Math.floor(v/60),E=v%60;a.value.textContent=`${k}:${E.toString().padStart(2,"0")}`}}let Q=!1,te=!1;function qt(){return Q}function Ht(t,e){if(Q||te)return;Q=!0,te=!0;let n=10;f.emit("sisuPulseStart",{remaining:n});const i=[];for(const s of e)s.faction!=="player"||s.isDead()||(i.push({unit:s,move:s.stats.movementRange,attack:s.stats.attackDamage}),s.stats.movementRange*=1.2,s.stats.attackDamage*=1.2,s.fearless=!0);const o=setInterval(()=>{if(n-=1,n>0){f.emit("sisuPulseTick",{remaining:n});return}clearInterval(o),Q=!1;for(const s of i)s.unit.stats.movementRange=s.move,s.unit.stats.attackDamage=s.attack,delete s.unit.fearless;f.emit("sisuPulseEnd",{}),setTimeout(()=>{te=!1,f.emit("sisuCooldownEnd",{})},12e4)},1e3)}function zt(t){const e=document.getElementById("ui-overlay");if(!e)return{log:()=>{},addEvent:()=>{}};const n=document.createElement("div");n.id="right-panel",n.style.position="absolute",n.style.top="0",n.style.right="0",n.style.width="240px",n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.background="rgba(0,0,0,0.5)",n.style.color="#fff",e.appendChild(n);const i=document.createElement("div");i.style.display="flex",n.appendChild(i);const o=document.createElement("div");o.style.flex="1",o.style.overflowY="auto",n.appendChild(o);const s=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div");a.id="event-log",a.style.display="flex",a.style.flexDirection="column";const l={Policies:s,Events:r,Log:a};function c(g){for(const[y,G]of Object.entries(l))G.style.display=y===g?"block":"none";for(const y of i.children){const G=y;G.disabled=G.textContent===g}}for(const g of Object.keys(l)){const y=document.createElement("button");y.textContent=g,y.addEventListener("click",()=>c(g)),i.appendChild(y),o.appendChild(l[g])}const d=[{id:"eco",name:"Eco Policy",description:"Increase gold income by 1",cost:15,prerequisite:()=>!0},{id:"temperance",name:"Temperance",description:"+5% work speed at night",cost:25,prerequisite:()=>!0}],h={};function m(){s.innerHTML="";for(const g of d){const y=document.createElement("button");y.textContent=`${g.name} (${g.cost}g)`,y.title=g.description,y.disabled=!g.prerequisite(t)||t.hasPolicy(g.id),y.addEventListener("click",()=>{t.applyPolicy(g.id,g.cost)&&w()}),s.appendChild(y),s.appendChild(document.createElement("br")),h[g.id]=y}}function w(){for(const g of d){const y=h[g.id];y&&(y.disabled=!g.prerequisite(t)||t.hasPolicy(g.id))}}m(),f.on("resourceChanged",w),f.on("policyApplied",w);const u=[];function v(){r.innerHTML="";for(const g of u){const y=document.createElement("div"),G=document.createElement("h4");G.textContent=g.headline;const fe=document.createElement("p");fe.textContent=g.body;const J=document.createElement("button");J.textContent=g.buttonText??"Acknowledge",J.addEventListener("click",()=>{const pe=u.findIndex(Ve=>Ve.id===g.id);pe!==-1&&(u.splice(pe,1),v())}),y.appendChild(G),y.appendChild(fe),y.appendChild(J),r.appendChild(y)}}function k(g){u.push(g),v()}const E=100,I=[];let Z=!1;function Ke(){for(const g of I){const y=document.createElement("div");y.textContent=g,a.appendChild(y)}for(;a.childElementCount>E;)a.removeChild(a.firstChild);a.scrollTop=a.scrollHeight,I.length=0,Z=!1}function je(g){I.push(g),Z||(Z=!0,(typeof requestAnimationFrame=="function"?requestAnimationFrame:y=>setTimeout(y,16))(Ke))}return c("Policies"),{log:je,addEvent:k}}function $t(t){const e=document.getElementById("ui-overlay");if(!e)return;const n=document.createElement("div");n.id="error-overlay",n.style.position="absolute",n.style.inset="0",n.style.background="rgba(0, 0, 0, 0.75)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.pointerEvents="auto",n.style.zIndex="1000";const i=document.createElement("div");i.className="card",i.style.background="rgba(20, 20, 20, 0.9)",i.style.color="white",i.style.maxWidth="80%",i.style.textAlign="center",i.style.padding="var(--gap-lg)";const o=document.createElement("h2");o.textContent="Asset load errors",i.appendChild(o);const s=document.createElement("ul");s.style.textAlign="left",s.style.margin="var(--gap-md) 0";for(const a of t){const l=document.createElement("li");l.textContent=a,s.appendChild(l)}i.appendChild(s);const r=document.createElement("button");r.textContent="Reload",r.className="btn",r.addEventListener("click",()=>{location.reload()}),i.appendChild(r),n.appendChild(i),e.appendChild(n)}const Ot=Math.sqrt(3),Ft=2;function ze(t){return{width:t*Ot,height:t*Ft}}const _t="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3ePlains%20Tile%3c/title%3e%3cdesc%20id='desc'%3eRolling%20plains%20with%20sunrise%20gradients%20and%20glowing%20grasses.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='plains-bg'%20cx='50%25'%20cy='50%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23111827'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='plains-field'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='0%25'%3e%3cstop%20offset='0%25'%20stop-color='%23facc15'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23eab308'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='plains-haze'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23fde68a'%20stop-opacity='0.8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23f59e0b'%20stop-opacity='0.2'%20/%3e%3c/linearGradient%3e%3cfilter%20id='plains-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='5'%20stdDeviation='6'%20flood-color='%23facc15'%20flood-opacity='0.35'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23plains-bg)'%20/%3e%3cg%20filter='url(%23plains-glow)'%3e%3cpath%20d='M16%2088c20-18%2036-22%2048-22s28%204%2048%2022'%20fill='url(%23plains-field)'%20stroke='%23fef9c3'%20stroke-width='2'%20stroke-linecap='round'%20/%3e%3cpath%20d='M24%20102c16-14%2032-18%2040-18s24%204%2040%2018'%20fill='none'%20stroke='%23fde68a'%20stroke-width='5'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M32%2070c12-10%2024-14%2032-14s20%204%2032%2014'%20fill='url(%23plains-haze)'%20opacity='0.7'%20/%3e%3cpath%20d='M52%2078l4%2012m8-12l4%2012m8-12l4%2012'%20stroke='%23fef3c7'%20stroke-width='3'%20stroke-linecap='round'%20opacity='0.8'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='36'%20r='8'%20fill='%23fef08a'%20opacity='0.7'%20/%3e%3c/svg%3e",Nt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eForest%20Tile%3c/title%3e%3cdesc%20id='desc'%3eStylised%20evergreen%20trees%20glowing%20against%20a%20deep%20night%20backdrop.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='forest-bg'%20cx='50%25'%20cy='40%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230b1120'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='forest-leaf'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%234ade80'%20/%3e%3cstop%20offset='100%25'%20stop-color='%2315803d'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='forest-trunk'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23a855f7'%20/%3e%3cstop%20offset='100%25'%20stop-color='%237c3aed'%20/%3e%3c/linearGradient%3e%3cfilter%20id='forest-glow'%20x='-40%25'%20y='-40%25'%20width='180%25'%20height='180%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%234ade80'%20flood-opacity='0.25'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23forest-bg)'%20/%3e%3cg%20filter='url(%23forest-glow)'%20stroke='%23bbf7d0'%20stroke-width='2'%3e%3cpath%20fill='url(%23forest-leaf)'%20d='M64%2026L32%2080h18l-12%2022h28l-10-22h16l-10%2022h28l-12-22h18z'%20/%3e%3crect%20x='58'%20y='74'%20width='12'%20height='18'%20rx='3'%20fill='url(%23forest-trunk)'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20stroke-opacity='0.5'%20d='M44%2086c6-4%2012-6%2020-6s14%202%2020%206'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='40'%20r='6'%20fill='%23fef3c7'%20opacity='0.6'%20/%3e%3ccircle%20cx='88'%20cy='32'%20r='4'%20fill='%23fef3c7'%20opacity='0.4'%20/%3e%3c/svg%3e",Wt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eMountain%20Tile%3c/title%3e%3cdesc%20id='desc'%3eJagged%20alpine%20peaks%20with%20luminous%20snowcaps.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='mountain-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%23111827'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='mountain-rock'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2364748b'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23334155'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='mountain-snow'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23f8fafc'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23cbd5f5'%20/%3e%3c/linearGradient%3e%3cfilter%20id='mountain-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%23f8fafc'%20flood-opacity='0.2'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23mountain-bg)'%20/%3e%3cg%20filter='url(%23mountain-glow)'%20stroke='%23cbd5f5'%20stroke-width='2'%20stroke-linejoin='round'%3e%3cpath%20fill='url(%23mountain-rock)'%20d='M24%20100l32-52%2014%2022%2012-18%2022%2048z'%20/%3e%3cpath%20fill='url(%23mountain-snow)'%20d='M56%2048l14%2022%2012-18%2010%2022H48z'%20opacity='0.85'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20opacity='0.6'%20d='M32%2094c10-6%2020-9%2032-9s22%203%2032%209'%20/%3e%3c/g%3e%3ccircle%20cx='92'%20cy='32'%20r='6'%20fill='%23f1f5f9'%20opacity='0.5'%20/%3e%3c/svg%3e",Ut="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eWater%20Tile%3c/title%3e%3cdesc%20id='desc'%3eGlowing%20waves%20surrounding%20a%20crystalline%20droplet.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='water-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230b1120'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='water-wave'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2338bdf8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230ea5e9'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='water-drop'%20x1='50%25'%20y1='0%25'%20x2='50%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23e0f2fe'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230284c7'%20/%3e%3c/linearGradient%3e%3cfilter%20id='water-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='4'%20stdDeviation='8'%20flood-color='%2338bdf8'%20flood-opacity='0.3'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23water-bg)'%20/%3e%3cg%20filter='url(%23water-glow)'%3e%3cpath%20d='M32%2076c12-10%2024-15%2032-15s20%205%2032%2015'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='8'%20stroke-linecap='round'%20/%3e%3cpath%20d='M28%2092c14-12%2030-18%2040-18s26%206%2040%2018'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='6'%20stroke-linecap='round'%20opacity='0.7'%20/%3e%3cpath%20d='M40%2060c10-8%2018-12%2024-12s14%204%2024%2012'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='4'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M64%2030c-12%2020-18%2032-18%2042%200%2011%208%2020%2018%2020s18-9%2018-20c0-10-6-22-18-42z'%20fill='url(%23water-drop)'%20stroke='%23e0f2fe'%20stroke-width='2'%20/%3e%3c/g%3e%3ccircle%20cx='94'%20cy='34'%20r='6'%20fill='%23f8fafc'%20opacity='0.45'%20/%3e%3c/svg%3e",be={[L.Plains]:{baseColor:"#d8b869",icon:_t},[L.Forest]:{baseColor:"#237a55",icon:Nt},[L.Hills]:{baseColor:"#b57c57",icon:Wt},[L.Lake]:{baseColor:"#3185d5",icon:Ut}},xe=new Map;function Qt(t){let e=xe.get(t);if(e||(e=new Image,e.decoding="async",e.src=t,xe.set(t,e)),e.complete&&e.naturalWidth>0&&e.naturalHeight>0)return e}const ke="rgba(56, 189, 248, 0.85)",Ee="rgba(56, 189, 248, 0.45)";let $=null,O=null;function Kt(){if($&&O)return{stroke:$,glow:O};if(typeof window<"u"){const t=getComputedStyle(document.documentElement),e=t.getPropertyValue("--tile-highlight-ring").trim(),n=t.getPropertyValue("--tile-highlight-glow").trim();$=e||ke,O=n||Ee}else $=ke,O=Ee;return{stroke:$,glow:O}}function jt(t){const e=t.replace("#",""),n=Number.parseInt(e,16),i=n>>16&255,o=n>>8&255,s=n&255;return[i,o,s]}function Ce([t,e,n],[i,o,s],r){const a=Math.min(1,Math.max(0,r)),l=(c,d)=>Math.round(c+(d-c)*a);return`rgb(${l(t,i)}, ${l(e,o)}, ${l(n,s)})`}function Me([t,e,n],i){return`rgba(${t}, ${e}, ${n}, ${i})`}class Vt{constructor(e){this.mapRef=e}get hexSize(){return this.mapRef.hexSize}getOrigin(){return _({q:this.mapRef.minQ,r:this.mapRef.minR},this.hexSize)}draw(e,n,i){const{width:o,height:s}=ze(this.hexSize),r=this.getOrigin();for(const[a,l]of this.mapRef.tiles){const[c,d]=a.split(",").map(Number),{x:h,y:m}=_({q:c,r:d},this.hexSize),w=h-r.x,u=m-r.y;if(e.save(),l.isFogged&&(e.globalAlpha*=.4),this.drawTerrain(e,l.terrain,w,u,o,s),l.building){const k=n[`building-${l.building}`]??n.placeholder;e.drawImage(k,w,u,o,s)}const v=i&&c===i.q&&d===i.r;this.strokeHex(e,w+this.hexSize,u+this.hexSize,this.hexSize,!!v),e.restore()}}drawToCanvas(e,n,i){const o=e.getContext("2d");if(!o)throw new Error("Canvas 2D context not available");this.draw(o,n,i)}drawTerrain(e,n,i,o,s,r){const a=be[n]??be[L.Plains],l=jt(a.baseColor),c=this.hexSize,d=i+c,h=o+c;e.save(),this.hexPath(e,i+this.hexSize,o+this.hexSize,c),e.clip();const m=e.createRadialGradient(d,h,c*.2,d,h,c*1.05);m.addColorStop(0,Ce(l,[255,255,255],.3)),m.addColorStop(.7,a.baseColor),m.addColorStop(1,Ce(l,[12,18,28],.4)),e.fillStyle=m,e.shadowColor=Me(l,.35),e.shadowBlur=c*.9,e.shadowOffsetX=0,e.shadowOffsetY=0,e.fillRect(i-c*.1,o-c*.1,s+c*.2,r+c*.2),e.globalCompositeOperation="lighter";const w=e.createRadialGradient(d,h,c*.85,d,h,c*1.18);w.addColorStop(0,"rgba(255, 255, 255, 0)"),w.addColorStop(1,Me(l,.18)),e.fillStyle=w,e.fillRect(i-c*.1,o-c*.1,s+c*.2,r+c*.2),e.globalCompositeOperation="source-over",e.restore();const u=Qt(a.icon);if(u){const v=Math.min(s,r)*.62,k=d-v/2,E=h-v/2;e.save(),e.globalAlpha*=.92,e.drawImage(u,k,E,v,v),e.restore()}}strokeHex(e,n,i,o,s=!1){const{stroke:r,glow:a}=Kt();this.hexPath(e,n,i,o),e.save(),e.lineJoin="round",e.lineCap="round",s?(e.shadowColor=a,e.shadowBlur=o*.65,e.lineWidth=Math.max(2,o*.08),e.strokeStyle=r,e.stroke()):(e.lineWidth=Math.max(1,o*.05),e.strokeStyle="rgba(12, 18, 28, 0.55)",e.stroke()),e.restore()}hexPath(e,n,i,o){e.beginPath();for(let s=0;s<6;s++){const r=Math.PI/180*(60*s-30),a=n+o*Math.cos(r),l=i+o*Math.sin(r);s===0?e.moveTo(a,l):e.lineTo(a,l)}e.closePath()}}function Zt(t,e,n,i,o){const s=window.devicePixelRatio||1,r=t.canvas.width,a=t.canvas.height;t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,r,a);const l=r/s,c=a/s;t.scale(s,s),t.translate(l/2,c/2),t.scale(b.zoom,b.zoom);const d=e.getOrigin();t.translate(-(b.x-d.x),-(b.y-d.y)),e.draw(t,n,o??void 0),Jt(t,e,n,i,d),t.restore()}function Jt(t,e,n,i,o){const{width:s,height:r}=ze(e.hexSize);for(const a of i){const{x:l,y:c}=_(a.coord,e.hexSize),d=l-o.x,h=c-o.y,m=n[`unit-${a.type}`]??n.placeholder,w=a.getMaxHealth();t.save(),a.stats.health/w<.5&&(t.filter="saturate(0)"),t.drawImage(m,d,h,s,r),qt()&&a.faction==="player"&&(t.strokeStyle="rgba(255,255,255,0.5)",t.lineWidth=2,t.strokeRect(d,h,s,r)),t.restore()}}const ne="./",D={gold:`${ne}assets/ui/gold.svg`,resource:`${ne}assets/ui/resource.svg`,sound:`${ne}assets/ui/sound.svg`};let $e,R,H=null;function en(t,e){$e=t,R=e,R.classList.add("resource-bar"),R.setAttribute("role","status"),R.setAttribute("aria-live","polite"),R.replaceChildren();const n=document.createElement("img");n.src=D.resource,n.alt="Resources",n.decoding="async",n.classList.add("resource-icon");const i=document.createElement("span");i.textContent="Resources",i.classList.add("resource-label"),H=document.createElement("span"),H.textContent="0",H.classList.add("resource-value"),R.append(n,i,H),ue(P.getResource(Y.GOLD))}function Oe(t,e){_e=at(t-A.hexSize,e-A.hexSize,A.hexSize),T()}const tn={images:{placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=","building-farm":Ze,"building-barracks":Je,"building-city":et,"building-mine":tt,"unit-soldier":nt,"unit-archer":it,"unit-raider":ot,"icon-gold":D.gold,"icon-resource":D.resource,"icon-sound":D.sound}};let se;const A=new bt(10,10,32),nn=new Vt(A);A.forEachTile(t=>t.setFogged(!0));ht();const P=new yt(1e3);P.load(A);const on=2,sn=new wt(1e3,()=>{P.tick(),P.save();for(const t of B)!t.isDead()&&t.faction==="player"&&A.revealAround(t.coord,on);T()}),B=[],de=Gt({q:Math.floor(A.width/2),r:Math.floor(A.height/2)});A.revealAround(de.pos,3);const rn=Bt(de),an=Xt(P,{saunakunnia:D.resource,sisu:D.resource,gold:D.gold,sound:D.sound}),{log:Fe,addEvent:Cn}=zt(P);f.on("sisuPulse",()=>Ht(P,B));f.on("sisuPulseStart",()=>He("sisu"));P.addResource(Y.GOLD,200);let _e=null;function T(){const t=$e.getContext("2d");!t||!se||Zt(t,nn,se.images,B,_e)}const Ne=({resource:t,total:e,amount:n})=>{ue(e);const i=n>0?"+":"";Fe(`${t}: ${i}${n}`)};f.on("resourceChanged",Ne);const We=({policy:t})=>{Fe(`Policy applied: ${t}`)};f.on("policyApplied",We);const Ue=({unitId:t})=>{const e=B.findIndex(n=>n.id===t);e!==-1&&(B.splice(e,1),T())};f.on("unitDied",Ue);function re(){f.off("resourceChanged",Ne),f.off("policyApplied",We),f.off("unitDied",Ue)}async function ln(){const{assets:t,failures:e}=await ft(tn);se=t,e.length&&(console.warn("Failed to load assets",e),$t(e)),ue(P.getResource(Y.GOLD)),T();let n=performance.now();function i(o){const s=o-n;n=o,sn.tick(s),de.update(s/1e3,B,r=>{B.push(r),T()}),rn(),an(s),T(),requestAnimationFrame(i)}requestAnimationFrame(i)}function ue(t){H?H.textContent=String(t):R&&(R.textContent=`Resources: ${t}`)}const cn=.5,dn=3.5,un=.0015,hn=10,fn=250,ae=[];let x=null,le=!1,p=null;const C={active:!1,pointerId:null,lastX:0,lastY:0};function pn(t){return Math.min(dn,Math.max(cn,t))}function z(t){ae.push(t)}function X(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}function mn(t){const e=window.devicePixelRatio||1,n=Math.max(window.innerWidth,1),i=Math.max(window.innerHeight,1);t.style.width=`${n}px`,t.style.height=`${i}px`,t.width=Math.round(n*e),t.height=Math.round(i*e);const o=t.getContext("2d");o&&o.setTransform(1,0,0,1,0,0),T()}function Se(t,e,n,i,o){const s=t.getBoundingClientRect(),r=e-s.left,a=n-s.top,l=s.width/2,c=s.height/2;return{x:o.x+(r-l)/i,y:o.y+(a-c)/i}}function Qe(t,e,n,i){const o=pn(i);if(o===b.zoom)return;const s={x:b.x,y:b.y},r=Se(t,e,n,b.zoom,s),a=Se(t,e,n,o,s);b.x+=r.x-a.x,b.y+=r.y-a.y,b.zoom=o,T()}function he(t,e){t===0&&e===0||(b.x-=t/b.zoom,b.y-=e/b.zoom,T())}function Ae(t){if(!x)return;t.preventDefault();const e=Math.exp(-t.deltaY*un),n=b.zoom*e;Qe(x,t.clientX,t.clientY,n)}function Te(t){x&&(t.pointerType!=="mouse"||t.button!==0||(C.active=!0,C.pointerId=t.pointerId,C.lastX=t.clientX,C.lastY=t.clientY,x.setPointerCapture?.(t.pointerId),x.style.cursor="grabbing"))}function Pe(t){if(!x||!C.active||C.pointerId!==t.pointerId)return;const e=t.clientX-C.lastX,n=t.clientY-C.lastY;C.lastX=t.clientX,C.lastY=t.clientY,he(e,n)}function q(t){x&&(!C.active||C.pointerId!==t.pointerId||(C.active=!1,C.pointerId=null,x.releasePointerCapture?.(t.pointerId),x.style.cursor=""))}function gn(t){return!x||t.mode!=="pan"||t.startX==null||t.startY==null||t.moved&&Math.hypot((t.lastX??t.startX)-t.startX,(t.lastY??t.startY)-t.startY)>hn?!1:X()-t.startTime<=fn}function yn(t){if(!x||t.startX==null||t.startY==null)return;const e=x.getBoundingClientRect(),n=t.startX-e.left,i=t.startY-e.top;Oe(n,i)}function wn(t){if(!p)return;const e=t.clientX-(p.lastX??t.clientX),n=t.clientY-(p.lastY??t.clientY);Math.hypot(e,n)>1&&(p.moved=!0),p.lastX=t.clientX,p.lastY=t.clientY,he(e,n)}function vn(t,e){if(!x)return;const n=(t.clientX+e.clientX)/2,i=(t.clientY+e.clientY)/2,o=Math.hypot(t.clientX-e.clientX,t.clientY-e.clientY);if(p?.lastDistance){const s=o/p.lastDistance,r=b.zoom*s;Qe(x,n,i,r)}if(p?.lastCenter){const s=n-p.lastCenter.x,r=i-p.lastCenter.y;he(s,r)}p?(p.mode="pinch",p.lastCenter={x:n,y:i},p.lastDistance=o,p.moved=!0):p={mode:"pinch",lastCenter:{x:n,y:i},lastDistance:o,startTime:X(),moved:!0}}function Ie(t){if(x){if(t.touches.length===1){const e=t.touches[0];p={mode:"pan",lastX:e.clientX,lastY:e.clientY,startX:e.clientX,startY:e.clientY,startTime:X(),moved:!1}}else if(t.touches.length>=2){const[e,n]=[t.touches[0],t.touches[1]];p={mode:"pinch",lastCenter:{x:(e.clientX+n.clientX)/2,y:(e.clientY+n.clientY)/2},lastDistance:Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY),startTime:X(),moved:!1}}}}function Re(t){if(!(!x||!p)&&t.touches.length!==0)if(t.preventDefault(),t.touches.length===1){const e=t.touches[0];if(p.mode!=="pan"){const n=p.mode==="pinch";p={mode:"pan",lastX:e.clientX,lastY:e.clientY,startX:e.clientX,startY:e.clientY,startTime:X(),moved:n}}wn(e)}else{const[e,n]=[t.touches[0],t.touches[1]];vn(e,n)}}function W(t){if(!(!x||!p)){if(t.touches.length===0){gn(p)&&yn(p),p=null;return}if(t.touches.length===1){const e=t.touches[0],n=p.mode==="pinch";p={mode:"pan",lastX:e.clientX,lastY:e.clientY,startX:e.clientX,startY:e.clientY,startTime:X(),moved:n}}else if(t.touches.length>=2){const[e,n]=[t.touches[0],t.touches[1]];p={mode:"pinch",lastCenter:{x:(e.clientX+n.clientX)/2,y:(e.clientY+n.clientY)/2},lastDistance:Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY),startTime:X(),moved:!0}}}}function Le(t){if(!x)return;const e=x.getBoundingClientRect();Oe(t.clientX-e.left,t.clientY-e.top)}function bn(t){t.addEventListener("click",Le),z(()=>t.removeEventListener("click",Le)),t.addEventListener("wheel",Ae,{passive:!1}),z(()=>t.removeEventListener("wheel",Ae)),t.addEventListener("pointerdown",Te),t.addEventListener("pointermove",Pe),t.addEventListener("pointerup",q),t.addEventListener("pointercancel",q),t.addEventListener("pointerleave",q),z(()=>{t.removeEventListener("pointerdown",Te),t.removeEventListener("pointermove",Pe),t.removeEventListener("pointerup",q),t.removeEventListener("pointercancel",q),t.removeEventListener("pointerleave",q)}),t.addEventListener("touchstart",Ie,{passive:!1}),t.addEventListener("touchmove",Re,{passive:!1}),t.addEventListener("touchend",W),t.addEventListener("touchcancel",W),z(()=>{t.removeEventListener("touchstart",Ie),t.removeEventListener("touchmove",Re),t.removeEventListener("touchend",W),t.removeEventListener("touchcancel",W)})}function xn(){for(;ae.length;){const t=ae.pop();try{t?.()}catch(e){console.error("Error during cleanup",e)}}}function kn(){xn(),C.active=!1,C.pointerId=null,x&&(x.style.cursor=""),p=null,x=null,le=!1,re()}function En(){const t=document.getElementById("game-canvas"),e=document.getElementById("resource-bar");if(!t||!e)return;le&&kn(),x=t,le=!0,en(t,e),bn(t);const n=()=>mn(t);window.addEventListener("resize",n),z(()=>window.removeEventListener("resize",n)),window.addEventListener("beforeunload",re),z(()=>window.removeEventListener("beforeunload",re)),n(),import.meta.vitest||ln()}import.meta.vitest||En();export{Y as R,At as U,He as p};
