(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const Jt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3cpolygon%20points='16,48%2032,16%2048,48'%20fill='%23d2691e'%20/%3e%3crect%20x='24'%20y='32'%20width='16'%20height='16'%20fill='%23f4a460'%20/%3e%3c/svg%3e",Zt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23c0c0c0'%20/%3e%3crect%20x='8'%20y='24'%20width='48'%20height='24'%20fill='%23808080'%20/%3e%3crect%20x='24'%20y='16'%20width='16'%20height='8'%20fill='%23606060'%20/%3e%3c/svg%3e",en="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23e0e0e0'%20/%3e%3crect%20x='10'%20y='22'%20width='12'%20height='30'%20fill='%23a9a9a9'%20/%3e%3crect%20x='26'%20y='14'%20width='12'%20height='38'%20fill='%23808080'%20/%3e%3crect%20x='42'%20y='26'%20width='12'%20height='26'%20fill='%23a9a9a9'%20/%3e%3c/svg%3e",tn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b4513'%20/%3e%3cpolygon%20points='32,10%2042,22%2022,22'%20fill='%23555'%20/%3e%3crect%20x='30'%20y='22'%20width='4'%20height='32'%20fill='%23ccc'%20/%3e%3c/svg%3e",nn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%234682b4'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='12'%20fill='%23fff'%20/%3e%3crect%20x='28'%20y='36'%20width='8'%20height='16'%20fill='%23fff'%20/%3e%3c/svg%3e",on="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23556b2f'%20/%3e%3cline%20x1='16'%20y1='16'%20x2='48'%20y2='48'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cpolygon%20points='48,48%2044,36%2036,44'%20fill='%23fff'%20/%3e%3c/svg%3e",sn="data:image/svg+xml,%3c?xml%20version='1.0'%20encoding='UTF-8'?%3e%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eAvanto%20Marauder%3c/title%3e%3cdesc%20id='desc'%3eFrost-clad%20marauder%20icon%20with%20jagged%20pauldrons,%20icy%20beard,%20and%20polar%20glow.%3c/desc%3e%3cdefs%3e%3clinearGradient%20id='bg'%20x1='0'%20y1='0'%20x2='0'%20y2='1'%3e%3cstop%20offset='0%25'%20stop-color='%23082f49'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230f172a'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='armor'%20x1='0'%20y1='0'%20x2='0'%20y2='1'%3e%3cstop%20offset='0%25'%20stop-color='%23e2e8f0'%20/%3e%3cstop%20offset='60%25'%20stop-color='%2394a3b8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%231f2937'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='beard'%20x1='0'%20y1='0'%20x2='0'%20y2='1'%3e%3cstop%20offset='0%25'%20stop-color='%23e0f2fe'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23bae6fd'%20/%3e%3c/linearGradient%3e%3cradialGradient%20id='glow'%20cx='50%25'%20cy='20%25'%20r='60%25'%3e%3cstop%20offset='0%25'%20stop-color='rgba(191,%20219,%20254,%200.85)'%20/%3e%3cstop%20offset='100%25'%20stop-color='rgba(14,%20116,%20144,%200)'%20/%3e%3c/radialGradient%3e%3c/defs%3e%3crect%20width='128'%20height='128'%20rx='20'%20fill='url(%23bg)'%20/%3e%3ccircle%20cx='64'%20cy='46'%20r='38'%20fill='url(%23glow)'%20opacity='0.85'%20/%3e%3cpath%20d='M64%2018c-14%200-26%208-32%2020l10%204c6-8%2014-12%2022-12s16%204%2022%2012l10-4C90%2026%2078%2018%2064%2018z'%20fill='%23cffafe'%20opacity='0.4'%20/%3e%3cpath%20d='M64%2036c-14%200-28%2010-28%2028v10l-12%2016%2018%2010%2022-10%2022%2010%2018-10-12-16V64c0-18-14-28-28-28z'%20fill='url(%23armor)'%20stroke='%230f172a'%20stroke-width='2'%20stroke-linejoin='round'%20/%3e%3cpath%20d='M48%2090l-12%206-10%2020%2020-8%2018%208%2018-8%2020%208-10-20-12-6'%20fill='%230f172a'%20opacity='0.85'%20/%3e%3cpath%20d='M64%2046c-10%200-18%208-18%2018v10c12-8%2024-8%2036%200V64c0-10-8-18-18-18z'%20fill='%230f172a'%20/%3e%3cpath%20d='M64%2050c-8%200-14%206-14%2014%206-4%2012-6%2014-6s8%202%2014%206c0-8-6-14-14-14z'%20fill='%23bae6fd'%20opacity='0.85'%20/%3e%3cpath%20d='M58%2084c-4%200-8%202-10%206%204%200%208%200%2010-2s4-2%206-2%204%200%206%202%206%202%2010%202c-2-4-6-6-10-6h-12z'%20fill='%23f8fafc'%20opacity='0.75'%20/%3e%3cpath%20d='M64%2086c-6%200-12%204-14%2010%204%202%2010%204%2014%204s10-2%2014-4c-2-6-8-10-14-10z'%20fill='url(%23beard)'%20stroke='%23bae6fd'%20stroke-width='1.4'%20stroke-linejoin='round'%20/%3e%3cpath%20d='M42%2064c-4-8-6-18-6-28-6%208-10%2018-10%2030%204-2%2010-2%2016-2z'%20fill='%230ea5e9'%20opacity='0.5'%20/%3e%3cpath%20d='M86%2064c4-8%206-18%206-28%206%208%2010%2018%2010%2030-4-2-10-2-16-2z'%20fill='%230ea5e9'%20opacity='0.5'%20/%3e%3cpath%20d='M34%2098c-6%202-12%206-14%2012%206%200%2012-2%2018-4'%20stroke='%23bae6fd'%20stroke-width='2'%20stroke-linecap='round'%20/%3e%3cpath%20d='M94%20106c6%202%2012%204%2018%204-2-6-8-10-14-12'%20stroke='%23bae6fd'%20stroke-width='2'%20stroke-linecap='round'%20/%3e%3c/svg%3e";class rn{listeners=new Map;on(t,n){const o=this.listeners.get(t)??[];o.push(n),this.listeners.set(t,o)}off(t,n){const o=this.listeners.get(t);if(!o)return;const s=o.indexOf(n);s!==-1&&(o.splice(s,1),o.length===0?this.listeners.delete(t):this.listeners.set(t,o))}emit(t,n){const o=this.listeners.get(t);if(o)for(const s of o)s(n)}}const v=new rn;class Ve{type="farm";cost=50;beerPerTick=1}class Mt{type="barracks";cost=100;trainingCapacity=1}const kt=Math.sqrt(3),Ct=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function V(e,t){return{x:t*kt*(e.q+e.r/2),y:t*(3/2)*e.r}}function an(e,t,n){const o=(kt/3*e-.3333333333333333*t)/n,s=2/3*t/n;return ln({q:o,r:s})}function Ge(e){return Ct.map(t=>({q:e.q+t.q,r:e.r+t.r}))}function ln(e){let t=e.q,n=e.r,o=-t-n,s=Math.round(t),r=Math.round(o),a=Math.round(n);const i=Math.abs(s-t),d=Math.abs(r-o),l=Math.abs(a-n);return i>d&&i>l?s=-r-a:d>l?r=-s-a:a=-s-r,{q:s,r:a}}const Ee=new Set;let Me=32;function cn(e){return`${e.q},${e.r}`}function Ye(e,t){Me=t,Ee.add(cn(e))}function dn(e){if(Ee.size===0)return{center:{x:0,y:0},zoom:1};const t=Me*Math.sqrt(3),n=Me*2;let o=1/0,s=1/0,r=-1/0,a=-1/0;for(const g of Ee){const[y,A]=g.split(",").map(Number),{x:b,y:C}=V({q:y,r:A},Me);o=Math.min(o,b),s=Math.min(s,C),r=Math.max(r,b+t),a=Math.max(a,C+n)}const i=r-o,d=a-s,l=96,c={x:o+i/2,y:s+d/2},u=e.width/(i+l*2),f=e.height/(d+l*2),m=Math.min(u,f);return{center:c,zoom:m}}const E={x:0,y:0,zoom:1};function un(e,t=300){const n=E.x,o=E.y,s=E.zoom,r=typeof performance<"u"?performance.now():Date.now(),a=i=>{const d=Math.min((i-r)/t,1);E.x=n+(e.center.x-n)*d,E.y=o+(e.center.y-o)*d,E.zoom=s+(e.zoom-s)*d,d<1&&(typeof requestAnimationFrame<"u"?requestAnimationFrame(a):setTimeout(()=>a(typeof performance<"u"?performance.now():Date.now()),16))};typeof requestAnimationFrame<"u"?requestAnimationFrame(a):setTimeout(()=>a(typeof performance<"u"?performance.now():Date.now()),0)}function fn(){Ee.clear()}async function hn(e){const t={},n={},o=[],s=Object.entries(e.images??{}).map(([a,i])=>new Promise(d=>{const l=new Image;l.onload=()=>{t[a]=l,d()},l.onerror=()=>{const c=`Failed to load image: ${i}`;console.error(c),o.push(c),d()},l.src=i})),r=Object.entries(e.sounds??{}).map(([a,i])=>new Promise(d=>{const l=new Audio;l.oncanplaythrough=()=>{n[a]=l,d()},l.onerror=()=>{const c=`Failed to load sound: ${i}`;console.error(c),o.push(c),d()},l.src=i,l.load()}));return await Promise.all([...s,...r]),{assets:{images:t,sounds:n},failures:o}}function pn(e){const t=localStorage.getItem(e);if(t)try{return JSON.parse(t)}catch(n){console.warn(`Failed to parse data for "${e}", clearing`,n),localStorage.removeItem(e);return}}function qe(e){return`${e.q},${e.r}`}const Et={farm:()=>new Ve,barracks:()=>new Mt};function mn(e){return Et[e]?.()}var S=(e=>(e.SAUNA_BEER="sauna-beer",e.SAUNAKUNNIA="saunakunnia",e))(S||{});const gn={"sauna-beer":1,saunakunnia:0};class bn{constructor(t,n="gameState"){this.tickInterval=t,this.storageKey=n}resources={"sauna-beer":0,saunakunnia:0};passiveGeneration={...gn};lastSaved=Date.now();buildings={};buildingPlacements=new Map;policies=new Set;nightWorkSpeedMultiplier=1;tick(){Object.keys(this.passiveGeneration).forEach(t=>{this.addResource(t,this.passiveGeneration[t])})}save(){this.lastSaved=Date.now();const t={};this.buildingPlacements.forEach((o,s)=>{t[s]=o.type});const n={resources:this.resources,lastSaved:this.lastSaved,buildings:this.buildings,buildingPlacements:t};localStorage.setItem(this.storageKey,JSON.stringify(n))}load(t){const n=pn(this.storageKey);if(!n){this.lastSaved=Date.now();return}this.resources={...this.resources,...n.resources},Object.keys(this.resources).forEach(a=>{Number.isFinite(this.resources[a])||(this.resources[a]=0)});const o={};Object.entries(n.buildings??{}).forEach(([a,i])=>{Et[a]&&(o[a]=i)}),this.buildings=o,this.buildingPlacements.clear(),n.buildingPlacements&&Object.entries(n.buildingPlacements).forEach(([a,i])=>{const d=mn(i);if(!d)return;this.buildingPlacements.set(a,d);const[l,c]=a.split(",").map(Number);if(t){const u=t.ensureTile(l,c);u.placeBuilding(d.type),u.reveal(),Ye({q:l,r:c},t.hexSize)}v.emit("buildingPlaced",{building:d,coord:{q:l,r:c},state:this})}),this.lastSaved=n.lastSaved??Date.now();const s=Date.now()-this.lastSaved,r=Math.floor(s/this.tickInterval);Object.keys(this.passiveGeneration).forEach(a=>{this.resources[a]+=r*this.passiveGeneration[a]})}getResource(t){return this.resources[t]}canAfford(t,n="sauna-beer"){return this.resources[n]>=t}spend(t,n="sauna-beer"){return this.canAfford(t,n)?(this.resources[n]-=t,v.emit("resourceChanged",{resource:n,amount:-t,total:this.resources[n]}),!0):!1}addResource(t,n){this.resources[t]+=n,v.emit("resourceChanged",{resource:t,amount:n,total:this.resources[t]})}modifyPassiveGeneration(t,n){this.passiveGeneration[t]=(this.passiveGeneration[t]??0)+n}construct(t,n,o="sauna-beer"){return this.spend(n,o)?(this.buildings[t]=(this.buildings[t]??0)+1,!0):!1}placeBuilding(t,n,o,s="sauna-beer"){const r=o.getTile(n.q,n.r);return!r||r.building||!this.construct(t.type,t.cost,s)?!1:(this.buildingPlacements.set(qe(n),t),r.placeBuilding(t.type),v.emit("buildingPlaced",{building:t,coord:n,state:this}),!0)}getBuildingAt(t){return this.buildingPlacements.get(qe(t))}removeBuilding(t,n){const o=qe(t),s=this.buildingPlacements.get(o);return s?(this.buildingPlacements.delete(o),n.getTile(t.q,t.r)?.placeBuilding(null),this.buildings[s.type]!==void 0&&(this.buildings[s.type]-=1,this.buildings[s.type]<=0&&delete this.buildings[s.type]),v.emit("buildingRemoved",{building:s,coord:t,state:this}),!0):!1}upgrade(t,n,o="sauna-beer"){return this.construct(`upgrade:${t}`,n,o)}applyPolicy(t,n,o="saunakunnia"){return this.spend(n,o)?(this.policies.add(t),v.emit("policyApplied",{policy:t,state:this}),!0):!1}hasPolicy(t){return this.policies.has(t)}}class yn{constructor(t,n){this.baseInterval=t,this.onTick=n}timer=null;speed=1;lastTick=0;accumulator=0;start(){this.stop(),this.lastTick=Date.now();const t=this.baseInterval/this.speed;this.timer=setInterval(()=>{const n=Date.now(),o=n-this.lastTick;this.lastTick=n,this.onTick(o)},t)}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null)}setSpeed(t){if(t<=0)throw new Error("Speed multiplier must be positive");this.speed=t,this.timer!==null&&this.start()}getSpeed(){return this.speed}getBaseInterval(){return this.baseInterval}tick(t){for(this.accumulator+=t*this.speed;this.accumulator>=this.baseInterval;)this.accumulator-=this.baseInterval,this.onTick(this.baseInterval)}}var F=(e=>(e[e.Plains=0]="Plains",e[e.Forest=1]="Forest",e[e.Hills=2]="Hills",e[e.Lake=3]="Lake",e))(F||{});function wn(e,t,n){let o=e*374761393+t*668265263+n*0x14057b7ef7678100;return o=(o^o>>13)*1274126177,o^=o>>16,(o>>>0)/4294967295}function tt(e,t,n=0){const o=wn(e,t,n);return o<.1?3:o<.3?1:o<.5?2:0}class nt{constructor(t=F.Plains,n=null,o=!0){this.terrain=t,this.building=n,this.isFogged=o}reveal(){this.isFogged=!1}placeBuilding(t){this.building=t}setFogged(t){this.isFogged=t}}class vn{constructor(t=10,n=10,o=32,s=0){this.hexSize=o,this.seed=s,this.minQ=0,this.minR=0,this.maxQ=t-1,this.maxR=n-1;for(let r=this.minR;r<=this.maxR;r++)for(let a=this.minQ;a<=this.maxQ;a++)this.tiles.set(this.key(a,r),new nt(tt(a,r,s)))}tiles=new Map;minQ;maxQ;minR;maxR;get width(){return this.maxQ-this.minQ+1}get height(){return this.maxR-this.minR+1}key(t,n){return`${t},${n}`}ensureTile(t,n){const o=this.key(t,n);let s=this.tiles.get(o);return s||(s=new nt(tt(t,n,this.seed)),this.tiles.set(o,s),this.minQ=Math.min(this.minQ,t),this.maxQ=Math.max(this.maxQ,t),this.minR=Math.min(this.minR,n),this.maxR=Math.max(this.maxR,n),s.isFogged||Ye({q:t,r:n},this.hexSize)),s}getTile(t,n){return this.ensureTile(t,n)}forEachTile(t){for(let n=this.minR;n<=this.maxR;n++)for(let o=this.minQ;o<=this.maxQ;o++){const s=this.ensureTile(o,n);t(s,{q:o,r:n})}}getNeighbors(t,n){return Ge({q:t,r:n}).map(o=>this.ensureTile(o.q,o.r))}revealAround(t,n){for(let r=-n;r<=n;r++){const a=Math.max(-n,-r-n),i=Math.min(n,-r+n);for(let d=a;d<=i;d++){const l={q:t.q+r,r:t.r+d};this.ensureTile(l.q,l.r).reveal(),Ye(l,this.hexSize)}}const o=typeof window<"u"?{width:window.innerWidth,height:window.innerHeight}:{width:0,height:0},s=dn(o);un(s,300)}}const Tt=({policy:e,state:t})=>{e==="eco"&&(t.modifyPassiveGeneration(S.SAUNA_BEER,1),v.off("policyApplied",Tt))},Pt=({policy:e,state:t})=>{e==="temperance"&&(t.nightWorkSpeedMultiplier*=1.05,v.off("policyApplied",Pt))},It=({policy:e,state:t})=>{e==="steam-diplomats"&&(t.modifyPassiveGeneration(S.SAUNA_BEER,2),v.off("policyApplied",It))};v.on("policyApplied",Tt);v.on("policyApplied",Pt);v.on("policyApplied",It);const Sn="modulepreload",An=function(e){return"/"+e},ot={},Mn=function(t,n,o){let s=Promise.resolve();if(n&&n.length>0){let d=function(l){return Promise.all(l.map(c=>Promise.resolve(c).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),i=a?.nonce||a?.getAttribute("nonce");s=d(n.map(l=>{if(l=An(l),l in ot)return;ot[l]=!0;const c=l.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const f=document.createElement("link");if(f.rel=c?"stylesheet":Sn,c||(f.as="script"),f.crossOrigin="",f.href=l,i&&f.setAttribute("nonce",i),document.head.appendChild(f),c)return new Promise((m,g)=>{f.addEventListener("load",m),f.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return s.then(a=>{for(const i of a||[])i.status==="rejected"&&r(i.reason);return t().catch(r)})},kn=({building:e,coord:t,state:n})=>{e instanceof Ve?n.modifyPassiveGeneration(S.SAUNA_BEER,e.beerPerTick):e instanceof Mt&&Mn(async()=>{const{spawnUnit:o}=await import("./UnitFactory-DdSTQSBR.js");return{spawnUnit:o}},[]).then(({spawnUnit:o})=>{o(n,"soldier",`barracks-${t.q}-${t.r}`,t,"player")})},Cn=({building:e,state:t})=>{e instanceof Ve&&t.modifyPassiveGeneration(S.SAUNA_BEER,-e.beerPerTick)};v.on("buildingPlaced",kn);v.on("buildingRemoved",Cn);function X(e){return`${e.q},${e.r}`}function En(e){const[t,n]=e.split(",").map(Number);return{q:t,r:n}}function st(e,t){const n=-e.q-e.r,o=-t.q-t.r;return Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r),Math.abs(n-o))}class Tn{constructor(t,n,o,s,r=[]){this.id=t,this.coord=n,this.faction=o,this.stats=s,this.priorityFactions=r,this.maxHealth=s.health}alive=!0;listeners={};maxHealth;healMarkerElapsed=0;onDeath(t){(this.listeners.death??=[]).push(t)}emitDeath(){for(const t of this.listeners.death??[])t()}isDead(){return!this.alive}getMaxHealth(){return this.maxHealth}distanceTo(t){return st(this.coord,t)}attack(t){this.distanceTo(t.coord)<=this.stats.attackRange&&t.takeDamage(this.stats.attackDamage,this)}update(t,n){if(!(this.isDead()||!n))if(st(this.coord,n.pos)<=n.auraRadius){const o=this.stats.health;this.stats.health=Math.min(this.stats.health+n.regenPerSec*t,this.maxHealth),this.stats.health>o&&(this.healMarkerElapsed+=t,this.healMarkerElapsed>=1&&(this.healMarkerElapsed=0,this.spawnHealMarker()))}else this.healMarkerElapsed=0}spawnHealMarker(){if(typeof document>"u")return;const t=document.getElementById("game-canvas");if(!t)return;const{x:n,y:o}=V(this.coord,32),s=document.createElement("div");s.textContent="+",s.className="heal-marker",s.style.position="absolute";const r=t.getBoundingClientRect();s.style.left=`${r.left+n}px`,s.style.top=`${r.top+o}px`,s.style.pointerEvents="none",document.body.appendChild(s),setTimeout(()=>s.remove(),1e3)}takeDamage(t,n){this.stats.health-=t,v.emit("unitDamaged",{attackerId:n?.id,targetId:this.id,amount:t,remainingHealth:this.stats.health}),this.stats.health<=0&&this.alive&&(this.stats.health=0,this.alive=!1,v.emit("unitDied",{unitId:this.id,attackerId:n?.id,unitFaction:this.faction,attackerFaction:n?.faction}),this.emitDeath())}moveTowards(t,n,o){const s=this.findPath(t,n,o);if(s.length<2)return[];let r=0;for(let i=1;i<s.length;i++){const d=X(s[i]);if(o.has(d))break;r=i}if(r===0)return[];const a=Math.min(this.stats.movementRange,r);return s.slice(0,a+1)}findPath(t,n,o){const s=this.coord,r=X(s),a=X(t),i=[s],d=new Map;for(d.set(r,null);i.length>0;){const u=i.shift(),f=X(u);if(f===a)break;for(const m of Ge(u)){const g=X(m);g!==a&&!this.isPassable(m,n,o)||d.has(g)||(i.push(m),d.set(g,f))}}if(!d.has(a))return[s];const l=[];let c=a;for(;c;)l.push(En(c)),c=d.get(c)??null;return l.reverse()}seekNearestEnemy(t,n,o){const s=new Map;for(const i of t)s.set(X(i.coord),i);const r=[this.coord],a=new Set([X(this.coord)]);for(;r.length>0;){const i=r.shift(),d=X(i),l=s.get(d);if(l)return l;for(const c of Ge(i)){const u=X(c),f=s.get(u);if(f)return f;this.isPassable(c,n,o)&&(a.has(u)||(a.add(u),r.push(c)))}}return null}isPassable(t,n,o){const s=n.getTile(t.q,t.r);return!s||o&&o.has(X(t))?!1:s.terrain!==F.Lake}}class Pn{static selectTarget(t,n){let o=n.filter(r=>r.faction!==t.faction&&!r.isDead());if(o.length===0)return null;if(t.priorityFactions.length>0){const r=o.filter(a=>t.priorityFactions.includes(a.faction));r.length>0&&(o=r)}const s=o.filter(r=>t.distanceTo(r.coord)<=t.stats.attackRange);return s.length>0?(s.sort((r,a)=>r.stats.health-a.stats.health),s[0]):(o.sort((r,a)=>t.distanceTo(r.coord)-t.distanceTo(a.coord)),o[0]??null)}}function ye(e){return`${e.q},${e.r}`}class In{constructor(t){this.map=t}tick(t){const n=new Set;for(const o of t)o.isDead()||n.add(ye(o.coord));for(const o of t){const s=ye(o.coord);if(n.delete(s),o.isDead())continue;const r=Pn.selectTarget(o,t);if(!r){n.add(s);continue}if(o.distanceTo(r.coord)>o.stats.attackRange){const a=o.moveTowards(r.coord,this.map,n);a.length>0&&(o.coord=a[a.length-1])}o.distanceTo(r.coord)<=o.stats.attackRange&&!r.isDead()&&(o.attack(r),r.isDead()&&n.delete(ye(r.coord))),n.add(ye(o.coord))}}}const Nn={health:12,attackDamage:4,attackRange:1,movementRange:2};class Rn extends Tn{constructor(t,n,o){super(t,n,o,{...Nn})}}let O=null;const ue={};function Nt(){if(O||typeof window>"u")return O;const e=window.AudioContext||window.webkitAudioContext;if(!e)return console.warn("Web Audio API not supported"),null;try{O=new e}catch(t){return console.warn("Unable to create AudioContext",t),null}if(ue.click=Ln(),ue.spawn=xn(),ue.error=Un(),ue.sisu=Bn(),O.state==="suspended"){const t=()=>{O?.resume()};window.addEventListener("pointerdown",t,{once:!0})}return O}function Le(e,t){const n=O,o=n.createBuffer(1,e,n.sampleRate),s=o.getChannelData(0);for(let r=0;r<e;r++){const a=r/n.sampleRate;s[r]=t(a)}return o}function Ln(){return Le(Math.floor(O.sampleRate*.05),t=>Math.sin(2*Math.PI*1e3*t)*Math.exp(-40*t))}function xn(){return Le(Math.floor(O.sampleRate*.2),t=>(Math.sin(2*Math.PI*440*t)+Math.sin(2*Math.PI*660*t))*.5*Math.exp(-6*t))}function Un(){return Le(Math.floor(O.sampleRate*.3),t=>Math.sin(2*Math.PI*110*t)*Math.exp(-8*t))}function Bn(){return Le(Math.floor(O.sampleRate*.5),t=>Math.sin(2*Math.PI*880*t)*Math.exp(-2*t))}let xe=!1;typeof localStorage<"u"&&(xe=localStorage.getItem("sfx-muted")==="true");function rt(){return xe}function $n(e){xe=e,typeof localStorage<"u"&&localStorage.setItem("sfx-muted",e?"true":"false")}function Rt(e){if(xe)return;const t=Nt();if(!t)return;const n=ue[e];if(!n)return;t.state==="suspended"&&t.resume();const o=t.createBufferSource();o.buffer=n,o.connect(t.destination),o.start()}typeof document<"u"&&document.addEventListener("click",e=>{e.target instanceof HTMLButtonElement&&Rt("click")});Nt();const _n={q:0,r:0},qn="Saunoja",at=18,it=0,Dn=0,Fn=10,lt=1;function De(e,t,n){return Math.min(Math.max(e,t),n)}function Qe(e){const{id:t,name:n=qn,coord:o=_n,maxHp:s=at,hp:r=s,steam:a=0,traits:i=[],upkeep:d=lt,xp:l=0,lastHitAt:c=it,selected:u=!1}=e,f=Number.isFinite(s)?Math.max(1,s):at,m=Number.isFinite(r)?r:f,g=De(m,0,f),y=Number.isFinite(a)?a:0,A=De(y,0,1),C=(Array.isArray(i)?i:[]).filter(x=>typeof x=="string").map(x=>x.trim()).filter(x=>x.length>0),R=Number.isFinite(d)?d:lt,T=De(R,Dn,Fn),P=Number.isFinite(l)?l:0,I=Math.max(0,P),L=Number.isFinite(c)?c:it,U=Math.max(0,L);return{id:t,name:n,coord:{q:o.q,r:o.r},maxHp:f,hp:g,steam:A,traits:[...C],upkeep:T,xp:I,lastHitAt:U,selected:u}}const ie=32;function fe(e,t,n,o){e.beginPath();for(let s=0;s<6;s++){const r=Math.PI/3*s,a=t+o*Math.cos(r),i=n+o*Math.sin(r);s===0?e.moveTo(a,i):e.lineTo(a,i)}e.closePath()}function Je(e,t,n){return Math.min(Math.max(e,t),n)}function Hn(e,{centerX:t,centerY:n,hp:o,maxHp:s,radius:r=ie*.55}){const a=Number.isFinite(s)?Math.max(1,s):1,i=Number.isFinite(o)?o:a,d=Je(i/a,0,1);if(e.save(),fe(e,t,n,r),e.fillStyle="rgba(7, 11, 18, 0.72)",e.fill(),e.restore(),d>0){e.save(),fe(e,t,n,r),e.clip();const l=e.createLinearGradient(t,n+r,t,n-r);l.addColorStop(0,"rgba(46, 160, 98, 0.35)"),l.addColorStop(1,"rgba(218, 255, 239, 0.95)"),e.fillStyle=l;const c=r*2*d,u=n+r-c;e.fillRect(t-r,u,r*2,c),e.restore()}e.save(),fe(e,t,n,r),e.lineWidth=Math.max(1,r*.12),e.strokeStyle="rgba(255, 255, 255, 0.28)",e.stroke(),e.restore()}function On(e,{centerX:t,centerY:n,radius:o=ie,progress:s=0}){const r=Je(s,0,1);if(r<=0)return;const a=Number.isFinite(o)&&o>0?o:ie;e.save(),e.globalCompositeOperation="lighter",e.globalAlpha=r;const i=e.createRadialGradient(t,n,Math.max(1,a*.1),t,n,a);i.addColorStop(0,"rgba(255, 255, 255, 0.92)"),i.addColorStop(.45,"rgba(255, 255, 255, 0.68)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=i,e.beginPath(),e.arc(t,n,a,0,Math.PI*2),e.fill(),e.restore()}function Gn(e,{centerX:t,centerY:n,radius:o=ie*.85,intensity:s=1}){const r=Je(s,0,1);if(r<=0)return;e.save(),fe(e,t,n,o),e.clip();const a=e.createLinearGradient(t,n+o,t,n-o);a.addColorStop(0,"rgba(255, 255, 255, 0)"),a.addColorStop(.55,`rgba(255, 255, 255, ${.12*r})`),a.addColorStop(1,`rgba(255, 255, 255, ${.35*r})`),e.globalCompositeOperation="lighter",e.fillStyle=a,e.fillRect(t-o,n-o,o*2,o*2),e.restore(),e.save(),e.globalCompositeOperation="lighter",e.lineCap="round",e.strokeStyle=`rgba(255, 255, 255, ${.25*r})`,e.lineWidth=Math.max(1,o*.08);const i=o*.75,d=o*.35;for(let l=0;l<3;l++){const c=n-o*.5+l*d;e.beginPath(),e.moveTo(t-i,c),e.bezierCurveTo(t-i*.4,c-o*.4,t+i*.4,c+o*.2,t+i,c-o*.45),e.stroke()}e.restore()}function Yn(e){return{id:"sauna",pos:e,spawnCooldown:30,timer:30,auraRadius:2,regenPerSec:1,rallyToFront:!1,heat:0,heatPerTick:50/30,spawnThreshold:50,update(t,n,o){if(this.heat+=this.heatPerTick*t,this.spawnCooldown=this.spawnThreshold/this.heatPerTick,this.heat<this.spawnThreshold){this.timer=Math.max((this.spawnThreshold-this.heat)/this.heatPerTick,0);return}const s=[];for(let c=-2;c<=2;c++){const u=Math.max(-2,-c-2),f=Math.min(2,-c+2);for(let m=u;m<=f;m++){const g=Math.max(Math.abs(c),Math.abs(m),Math.abs(-c-m));if(g===0||g>2)continue;const y={q:this.pos.q+c,r:this.pos.r+m};n.some(b=>!b.isDead()&&b.coord.q===y.q&&b.coord.r===y.r)||s.push(y)}}if(s.length===0){this.timer=0;return}const r=s[Math.floor(Math.random()*s.length)],a=`avantoMarauder${n.length+1}`,i="enemy",d=new Rn(a,r,i);o(d);const l=this.spawnThreshold;this.heat=Math.max(0,this.heat-l),this.spawnThreshold=l*1.05,this.spawnCooldown=this.spawnThreshold/this.heatPerTick,this.timer=Math.max((this.spawnThreshold-this.heat)/this.heatPerTick,0)}}}function Ze(e){let t=e.querySelector(".hud-top-row");t||(t=document.createElement("div"),t.className="hud-top-row",e.prepend(t));let n=t.querySelector(".hud-actions");n||(n=document.createElement("div"),n.className="hud-actions",t.appendChild(n));let o=t.querySelector(".hud-right-column");if(!o){o=document.createElement("div"),o.className="hud-right-column",t.appendChild(o);const r=e.querySelector("#resource-bar");r&&o.prepend(r)}const s=e.querySelector("#build-menu");return s&&s.parentElement!==n&&n.appendChild(s),{container:t,actions:n,side:o}}function jn(e){const t=document.getElementById("ui-overlay");if(!t)return()=>{};const n=document.createElement("div");n.classList.add("sauna-control");const o=document.createElement("button");o.type="button",o.textContent="Sauna ♨️",o.classList.add("topbar-button","sauna-toggle"),o.setAttribute("aria-expanded","false"),n.appendChild(o);const s=document.createElement("div");s.classList.add("sauna-card","hud-card"),s.hidden=!0;const r=document.createElement("div");r.classList.add("sauna-progress");const a=document.createElement("div");a.classList.add("sauna-progress__fill"),r.appendChild(a),s.appendChild(r);const i=document.createElement("label");i.classList.add("sauna-option");const d=document.createElement("input");d.type="checkbox",d.classList.add("sauna-option__input"),d.checked=e.rallyToFront,d.addEventListener("change",()=>{e.rallyToFront=d.checked}),i.appendChild(d);const l=document.createElement("span");l.textContent="Rally to Front",l.classList.add("sauna-option__label"),i.appendChild(l),s.appendChild(i),n.appendChild(s);const{actions:c}=Ze(t),u=()=>{n.parentElement!==c&&c.appendChild(n);const f=c.querySelector("#topbar");return f&&f.parentElement===c?(f.nextSibling!==n&&c.insertBefore(n,f.nextSibling),!0):!1};if(!u()){const f=new MutationObserver(()=>{u()&&f.disconnect()});f.observe(c,{childList:!0})}return o.addEventListener("click",()=>{const f=!s.hidden;s.hidden=f,o.setAttribute("aria-expanded",String(!f))}),()=>{const f=1-e.timer/e.spawnCooldown;a.style.width=`${Math.max(0,Math.min(f,1))*100}%`,d.checked=e.rallyToFront}}function we(e,t={}){const{iconSrc:n,description:o,srLabel:s}=t,r=document.createElement("div");if(r.classList.add("topbar-badge"),r.setAttribute("role","status"),r.setAttribute("aria-live","polite"),r.setAttribute("aria-atomic","true"),n){const u=document.createElement("img");u.src=n,u.alt=e,u.decoding="async",u.classList.add("topbar-badge-icon"),r.appendChild(u)}const a=document.createElement("div");a.classList.add("badge-text");const i=document.createElement("span");i.textContent=e,i.classList.add("badge-label"),a.appendChild(i);const d=document.createElement("span");d.textContent="0",d.classList.add("badge-value"),d.setAttribute("aria-hidden","true"),a.appendChild(d);const l=document.createElement("span");l.classList.add("badge-delta"),l.style.opacity="0",l.style.transform="translateY(-6px)",l.style.transition="opacity 0.5s ease, transform 0.5s ease",l.setAttribute("aria-hidden","true"),r.append(a,l),o&&(r.title=o);const c=s??e;return r.dataset.label=c,r.setAttribute("aria-label",`${c}: 0`),{container:r,value:d,delta:l,label:c}}function Xn(e,t={}){const n=document.getElementById("ui-overlay");if(!n)return()=>{};const{actions:o}=Ze(n),s=document.createElement("div");s.id="topbar",o.prepend(s);const r={[S.SAUNA_BEER]:"Sauna beer bottles chilled for construction crews and eager recruits.",[S.SAUNAKUNNIA]:"Saunakunnia—prestige earned from sauna rituals and triumphant battles."},a=we("Saunakunnia",{iconSrc:t.saunakunnia,description:r[S.SAUNAKUNNIA],srLabel:"Saunakunnia honor"});a.container.classList.add("badge-sauna");const i=we("SISU🔥",{iconSrc:t.sisu,srLabel:"Sisu pulse timer"});i.container.classList.add("badge-sisu"),i.container.style.display="none";const d=we("Sauna Beer",{iconSrc:t.saunaBeer,description:r[S.SAUNA_BEER],srLabel:"Sauna beer reserves"});d.container.classList.add("badge-sauna-beer");const l=we("Time");l.container.classList.add("badge-time"),l.delta.style.display="none",s.appendChild(a.container),s.appendChild(i.container),s.appendChild(d.container),s.appendChild(l.container);const c=document.createElement("button");c.type="button",c.textContent="SISU",c.classList.add("topbar-button","sisu-button"),c.addEventListener("click",()=>{v.emit("sisuPulse",{})}),s.appendChild(c);const u=document.createElement("button");u.type="button",u.title="Toggle sound",u.classList.add("topbar-button","sound-button");const f=document.createElement("span");if(f.textContent="Sound",t.sound){const h=document.createElement("img");h.src=t.sound,h.alt="",h.decoding="async",h.setAttribute("aria-hidden","true"),u.appendChild(h)}u.appendChild(f);function m(){const h=rt();f.textContent=h?"Muted":"Sound",u.setAttribute("aria-pressed",h?"true":"false"),u.classList.toggle("is-muted",h)}u.addEventListener("click",()=>{$n(!rt()),m()}),m(),s.appendChild(u),v.on("sisuPulseStart",({remaining:h})=>{c.disabled=!0,i.container.style.display="block",i.value.textContent=String(h)}),v.on("sisuPulseTick",({remaining:h})=>{i.value.textContent=String(h)}),v.on("sisuPulseEnd",()=>{i.container.style.display="none"}),v.on("sisuCooldownEnd",()=>{c.disabled=!1});const g=new Intl.NumberFormat("en-US"),y=new Intl.NumberFormat("en-US",{signDisplay:"exceptZero"}),A={[S.SAUNA_BEER]:"Sauna Beer",[S.SAUNAKUNNIA]:"Saunakunnia"},b={[S.SAUNA_BEER]:{singular:"bottle",plural:"bottles"},[S.SAUNAKUNNIA]:{singular:"honor",plural:"honor"}},C={[S.SAUNA_BEER]:"🍺",[S.SAUNAKUNNIA]:"⚜️"},R={[S.SAUNA_BEER]:d,[S.SAUNAKUNNIA]:a},T={};function P(h,p){const w=Number.isFinite(p)?p:0;return h===S.SAUNA_BEER?g.format(Math.max(0,Math.floor(w))):g.format(Math.max(0,Math.round(w)))}function I(h,p){return p===0?"":`${y.format(p)} ${C[h]}`}function L(h,p){if(p===0)return"";const w=p>0?"gained":"spent",k=g.format(Math.abs(p)),$=b[h];if($){const q=Math.abs(p)===1?$.singular:$.plural;return`${w} ${k} ${A[h]} ${q}`.trim()}return`${w} ${k} ${A[h]}`}function U(h,p,w=0){const k=R[h];if(!k)return;const $=P(h,p);if(k.value.textContent=$,w!==0){k.delta.textContent=I(h,w),k.delta.style.opacity="1",k.delta.style.transform="translateY(0)";const z=T[h];z&&clearTimeout(z),T[h]=setTimeout(()=>{k.delta.style.opacity="0",k.delta.style.transform="translateY(-6px)",delete T[h]},1e3)}else k.delta.textContent="",k.delta.style.opacity="0",k.delta.style.transform="translateY(-6px)";const q=L(h,w),W=[`${k.label} ${$}`,q].filter(Boolean);k.container.setAttribute("aria-label",W.join(" — "))}U(S.SAUNA_BEER,e.getResource(S.SAUNA_BEER)),U(S.SAUNAKUNNIA,e.getResource(S.SAUNAKUNNIA)),v.on("resourceChanged",({resource:h,amount:p,total:w})=>{const k=h;R[k]&&U(k,w,p)});let x=0;return h=>{x+=h;const p=Math.floor(x/1e3),w=Math.floor(p/60),k=p%60;l.value.textContent=`${w}:${k.toString().padStart(2,"0")}`}}let ke=!1,Fe=!1;function Wn(){return ke}function zn(e,t){if(ke||Fe)return;ke=!0,Fe=!0;let n=10;v.emit("sisuPulseStart",{remaining:n});const o=[];for(const r of t)r.faction!=="player"||r.isDead()||(o.push({unit:r,move:r.stats.movementRange,attack:r.stats.attackDamage}),r.stats.movementRange*=1.2,r.stats.attackDamage*=1.2,r.fearless=!0);const s=setInterval(()=>{if(n-=1,n>0){v.emit("sisuPulseTick",{remaining:n});return}clearInterval(s),ke=!1;for(const r of o)r.unit.stats.movementRange=r.move,r.unit.stats.attackDamage=r.attack,delete r.unit.fearless;v.emit("sisuPulseEnd",{}),setTimeout(()=>{Fe=!1,v.emit("sisuCooldownEnd",{})},12e4)},1e3)}function Kn(e){const t=document.getElementById("ui-overlay");if(!t)return{log:()=>{},addEvent:()=>{}};const{side:n}=Ze(t),o=t.querySelector("#right-panel");o&&o.remove();const s=document.createElement("div");s.id="right-panel",s.classList.add("hud-card"),s.setAttribute("role","complementary"),s.setAttribute("aria-label","Policies and events");const r=document.createElement("div");r.classList.add("panel-tabs"),s.appendChild(r);const a=document.createElement("div");a.classList.add("panel-content"),s.appendChild(a);const i=document.createElement("div");i.id="right-panel-policies";const d=document.createElement("div");d.id="right-panel-events";const l=document.createElement("div");l.id="event-log",l.setAttribute("role","log"),l.setAttribute("aria-live","polite");const c={Policies:i,Events:d,Log:l};for(const[h,p]of Object.entries(c))p.classList.add("panel-section","panel-section--scroll"),p.dataset.tab=h,p.hidden=!0;l.classList.add("panel-section--log");function u(h){for(const[p,w]of Object.entries(c))w.hidden=p!==h;for(const p of Array.from(r.children)){const w=p,k=w.textContent===h;w.disabled=k,w.setAttribute("aria-pressed",k?"true":"false")}}for(const h of Object.keys(c)){const p=document.createElement("button");p.type="button",p.textContent=h;const w=c[h];w?.id&&p.setAttribute("aria-controls",w.id),p.setAttribute("aria-pressed","false"),p.addEventListener("click",()=>u(h)),r.appendChild(p),a.appendChild(c[h])}n.appendChild(s);const f=new Intl.NumberFormat("en-US"),m={[S.SAUNA_BEER]:"Sauna Beer Bottles",[S.SAUNAKUNNIA]:"Saunakunnia Honors"},g=[{id:"eco",name:"Eco Policy",description:"Increase passive sauna beer brewing by 1 bottle per tick",cost:15,resource:S.SAUNAKUNNIA,prerequisite:()=>!0},{id:"temperance",name:"Temperance",description:"+5% work speed at night",cost:25,resource:S.SAUNAKUNNIA,prerequisite:()=>!0},{id:"steam-diplomats",name:"Steam Diplomats",description:"Import +2 sauna beer bottles per tick through diplomatic envoys",cost:8,resource:S.SAUNAKUNNIA,prerequisite:()=>!0}],y={};function A(){i.innerHTML="";for(const h of g){const p=document.createElement("button"),w=h.resource;p.textContent=`${h.name} (${f.format(h.cost)} ${m[w]})`,p.title=`${h.description}. Costs ${f.format(h.cost)} ${m[w]}.`,p.classList.add("panel-action"),p.disabled=!h.prerequisite(e)||e.hasPolicy(h.id)||!e.canAfford(h.cost,w),p.addEventListener("click",()=>{e.applyPolicy(h.id,h.cost,w)&&b()}),i.appendChild(p),y[h.id]=p}}function b(){for(const h of g){const p=y[h.id];if(p){const w=h.resource;p.disabled=!h.prerequisite(e)||e.hasPolicy(h.id)||!e.canAfford(h.cost,w)}}}A(),v.on("resourceChanged",b),v.on("policyApplied",b);const C=[];function R(){d.innerHTML="";for(const h of C){const p=document.createElement("div");p.classList.add("panel-event");const w=document.createElement("h4");w.textContent=h.headline;const k=document.createElement("p");k.textContent=h.body;const $=document.createElement("button");$.textContent=h.buttonText??"Acknowledge",$.classList.add("panel-action"),$.addEventListener("click",()=>{const q=C.findIndex(W=>W.id===h.id);q!==-1&&(C.splice(q,1),R())}),p.appendChild(w),p.appendChild(k),p.appendChild($),d.appendChild(p)}}function T(h){C.push(h),R(),x(`Event • ${h.headline}`)}const P=100,I=[];let L=!1;function U(){for(const h of I){const p=document.createElement("div");p.textContent=h,p.classList.add("panel-log-entry"),l.appendChild(p)}for(;l.childElementCount>P;)l.removeChild(l.firstChild);l.scrollTop=l.scrollHeight,I.length=0,L=!1}function x(h){I.push(h),L||(L=!0,(typeof requestAnimationFrame=="function"?requestAnimationFrame:p=>setTimeout(p,16))(U))}return u("Policies"),{log:x,addEvent:T}}const Vn=Math.sqrt(3),Qn=2;function Lt(e){return{width:e*Vn,height:e*Qn}}function xt(e){return Math.min(1,Math.max(0,e))}function Ue(e){let t=e.trim();if(t.startsWith("#")&&(t=t.slice(1)),t.length===3){const n=Number.parseInt(t[0]+t[0],16),o=Number.parseInt(t[1]+t[1],16),s=Number.parseInt(t[2]+t[2],16);return[n,o,s]}if(t.length===6){const n=Number.parseInt(t,16),o=n>>16&255,s=n>>8&255,r=n&255;return[o,s,r]}return[0,0,0]}function Jn(e,t,n){const o=xt(n),s=(r,a)=>Math.round(r+(a-r)*o);return[s(e[0],t[0]),s(e[1],t[1]),s(e[2],t[2])]}function Zn([e,t,n],o){return`rgba(${e}, ${t}, ${n}, ${xt(o)})`}function ee(e,t,n,o){return Zn(Jn(e,t,n),o)}function eo(e){const{ctx:t,x:n,y:o,width:s,height:r,radius:a,baseColor:i}=e,d=Ue(i);t.save(),t.lineCap="round",t.lineJoin="round";const l=ee(d,[255,255,255],.35,.24);t.strokeStyle=l,t.lineWidth=Math.max(1,a*.06);const c=3,u=6,f=n+s*.12,m=n+s*.88;for(let b=0;b<c;b++){const C=b/Math.max(1,c-1),R=o+r*.28+C*r*.32,T=a*(.18-C*.05);t.beginPath();for(let P=0;P<=u;P++){const I=P/u,L=f+(m-f)*I,U=Math.sin(I*Math.PI*1.6+b*.8)*T,x=R-Math.abs(U)*.55;P===0?t.moveTo(L,x):t.lineTo(L,x)}t.stroke()}const g=ee(d,[18,54,32],.4,.2);t.strokeStyle=g,t.lineWidth=Math.max(.75,a*.035);const y=5,A=a*.22;for(let b=0;b<y;b++){const C=n+s*(.2+b/Math.max(1,y-1)*.6),R=o+r*.55-Math.cos(b*.9)*a*.08;t.beginPath(),t.arc(C,R,A,Math.PI*.2,Math.PI*.85),t.stroke(),t.beginPath(),t.arc(C+A*.35,R-A*.1,A*.55,Math.PI*.15,Math.PI*.95),t.stroke()}t.restore()}function to(e){const{ctx:t,centerX:n,centerY:o,radius:s,baseColor:r}=e,a=Ue(r);t.save(),t.lineCap="round";const i=ee(a,[255,235,214],.45,.22);t.strokeStyle=i,t.lineWidth=Math.max(1,s*.05);const d=4;for(let u=0;u<d;u++){const f=u/Math.max(1,d-1),m=s*(1.25-f*.45),g=s*(.72-f*.18),y=o+s*.18*(f-.5);t.beginPath(),t.ellipse(n,y,m,g,0,Math.PI*.12,Math.PI*.88),t.stroke()}const l=ee(a,[60,36,20],.35,.18);t.strokeStyle=l,t.lineWidth=Math.max(.85,s*.032),t.setLineDash([s*.22,s*.18]);const c=3;for(let u=0;u<c;u++){const f=s*(.75-u*.1),m=o+s*.28+u*s*.08;t.beginPath(),t.arc(n+s*.08,m,f,Math.PI*.28,Math.PI*.76),t.stroke()}t.setLineDash([]),t.restore()}function no(e){const{ctx:t,x:n,y:o,width:s,height:r,radius:a,baseColor:i}=e,d=Ue(i);t.save(),t.lineCap="round",t.lineJoin="round";const l=ee(d,[255,255,255],.55,.28);t.strokeStyle=l,t.lineWidth=Math.max(1,a*.045);const c=4,u=7,f=n+s*.12,m=n+s*.88,g=a*.16;for(let b=0;b<c;b++){const C=b/Math.max(1,c-1),R=o+r*.3+C*r*.4;t.beginPath();for(let T=0;T<=u;T++){const P=T/u,I=f+(m-f)*P,L=Math.sin(P*Math.PI*2+b*.6)*g*(.75-C*.2),U=R+L;T===0?t.moveTo(I,U):t.lineTo(I,U)}t.stroke()}const y=ee(d,[12,52,94],.4,.2);t.strokeStyle=y,t.lineWidth=Math.max(.8,a*.03);const A=3;for(let b=0;b<A;b++){const C=b/Math.max(1,A-1),R=o+r*.35+C*r*.35;t.beginPath();for(let T=0;T<=u;T++){const P=T/u,I=f+(m-f)*P,L=Math.sin(P*Math.PI*2+b)*g*.35,U=R+L;T===0?t.moveTo(I,U):t.lineTo(I,U)}t.stroke()}t.restore()}function Ut(e){const{ctx:t,x:n,y:o,width:s,height:r,radius:a,baseColor:i}=e,d=Ue(i);t.save(),t.lineCap="round";const l=ee(d,[255,255,255],.42,.18);t.strokeStyle=l,t.lineWidth=Math.max(.85,a*.03);const c=a*.55;for(let m=-1;m<=2;m++){const g=c*m;t.beginPath(),t.moveTo(n+g,o+r*.25),t.lineTo(n+g+s*.75,o+r*.85),t.stroke()}const u=ee(d,[112,82,32],.3,.16);t.strokeStyle=u,t.lineWidth=Math.max(.7,a*.025),t.setLineDash([a*.24,a*.34]);const f=a*.48;for(let m=0;m<3;m++){const g=f*m;t.beginPath(),t.moveTo(n+s*.18+g,o+r*.78),t.lineTo(n+s*.7+g,o+r*.38),t.stroke()}t.setLineDash([]),t.restore()}const oo="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3ePlains%20Tile%3c/title%3e%3cdesc%20id='desc'%3eRolling%20plains%20with%20sunrise%20gradients%20and%20glowing%20grasses.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='plains-bg'%20cx='50%25'%20cy='50%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23111827'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='plains-field'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='0%25'%3e%3cstop%20offset='0%25'%20stop-color='%23facc15'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23eab308'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='plains-haze'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23fde68a'%20stop-opacity='0.8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23f59e0b'%20stop-opacity='0.2'%20/%3e%3c/linearGradient%3e%3cfilter%20id='plains-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='5'%20stdDeviation='6'%20flood-color='%23facc15'%20flood-opacity='0.35'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23plains-bg)'%20/%3e%3cg%20filter='url(%23plains-glow)'%3e%3cpath%20d='M16%2088c20-18%2036-22%2048-22s28%204%2048%2022'%20fill='url(%23plains-field)'%20stroke='%23fef9c3'%20stroke-width='2'%20stroke-linecap='round'%20/%3e%3cpath%20d='M24%20102c16-14%2032-18%2040-18s24%204%2040%2018'%20fill='none'%20stroke='%23fde68a'%20stroke-width='5'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M32%2070c12-10%2024-14%2032-14s20%204%2032%2014'%20fill='url(%23plains-haze)'%20opacity='0.7'%20/%3e%3cpath%20d='M52%2078l4%2012m8-12l4%2012m8-12l4%2012'%20stroke='%23fef3c7'%20stroke-width='3'%20stroke-linecap='round'%20opacity='0.8'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='36'%20r='8'%20fill='%23fef08a'%20opacity='0.7'%20/%3e%3c/svg%3e",so="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eForest%20Tile%3c/title%3e%3cdesc%20id='desc'%3eStylised%20evergreen%20trees%20glowing%20against%20a%20deep%20night%20backdrop.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='forest-bg'%20cx='50%25'%20cy='40%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230b1120'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='forest-leaf'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%234ade80'%20/%3e%3cstop%20offset='100%25'%20stop-color='%2315803d'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='forest-trunk'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23a855f7'%20/%3e%3cstop%20offset='100%25'%20stop-color='%237c3aed'%20/%3e%3c/linearGradient%3e%3cfilter%20id='forest-glow'%20x='-40%25'%20y='-40%25'%20width='180%25'%20height='180%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%234ade80'%20flood-opacity='0.25'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23forest-bg)'%20/%3e%3cg%20filter='url(%23forest-glow)'%20stroke='%23bbf7d0'%20stroke-width='2'%3e%3cpath%20fill='url(%23forest-leaf)'%20d='M64%2026L32%2080h18l-12%2022h28l-10-22h16l-10%2022h28l-12-22h18z'%20/%3e%3crect%20x='58'%20y='74'%20width='12'%20height='18'%20rx='3'%20fill='url(%23forest-trunk)'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20stroke-opacity='0.5'%20d='M44%2086c6-4%2012-6%2020-6s14%202%2020%206'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='40'%20r='6'%20fill='%23fef3c7'%20opacity='0.6'%20/%3e%3ccircle%20cx='88'%20cy='32'%20r='4'%20fill='%23fef3c7'%20opacity='0.4'%20/%3e%3c/svg%3e",ro="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eMountain%20Tile%3c/title%3e%3cdesc%20id='desc'%3eJagged%20alpine%20peaks%20with%20luminous%20snowcaps.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='mountain-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%23111827'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='mountain-rock'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2364748b'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23334155'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='mountain-snow'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23f8fafc'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23cbd5f5'%20/%3e%3c/linearGradient%3e%3cfilter%20id='mountain-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%23f8fafc'%20flood-opacity='0.2'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23mountain-bg)'%20/%3e%3cg%20filter='url(%23mountain-glow)'%20stroke='%23cbd5f5'%20stroke-width='2'%20stroke-linejoin='round'%3e%3cpath%20fill='url(%23mountain-rock)'%20d='M24%20100l32-52%2014%2022%2012-18%2022%2048z'%20/%3e%3cpath%20fill='url(%23mountain-snow)'%20d='M56%2048l14%2022%2012-18%2010%2022H48z'%20opacity='0.85'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20opacity='0.6'%20d='M32%2094c10-6%2020-9%2032-9s22%203%2032%209'%20/%3e%3c/g%3e%3ccircle%20cx='92'%20cy='32'%20r='6'%20fill='%23f1f5f9'%20opacity='0.5'%20/%3e%3c/svg%3e",ao="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eWater%20Tile%3c/title%3e%3cdesc%20id='desc'%3eGlowing%20waves%20surrounding%20a%20crystalline%20droplet.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='water-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230b1120'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='water-wave'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2338bdf8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230ea5e9'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='water-drop'%20x1='50%25'%20y1='0%25'%20x2='50%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23e0f2fe'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230284c7'%20/%3e%3c/linearGradient%3e%3cfilter%20id='water-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='4'%20stdDeviation='8'%20flood-color='%2338bdf8'%20flood-opacity='0.3'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23water-bg)'%20/%3e%3cg%20filter='url(%23water-glow)'%3e%3cpath%20d='M32%2076c12-10%2024-15%2032-15s20%205%2032%2015'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='8'%20stroke-linecap='round'%20/%3e%3cpath%20d='M28%2092c14-12%2030-18%2040-18s26%206%2040%2018'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='6'%20stroke-linecap='round'%20opacity='0.7'%20/%3e%3cpath%20d='M40%2060c10-8%2018-12%2024-12s14%204%2024%2012'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='4'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M64%2030c-12%2020-18%2032-18%2042%200%2011%208%2020%2018%2020s18-9%2018-20c0-10-6-22-18-42z'%20fill='url(%23water-drop)'%20stroke='%23e0f2fe'%20stroke-width='2'%20/%3e%3c/g%3e%3ccircle%20cx='94'%20cy='34'%20r='6'%20fill='%23f8fafc'%20opacity='0.45'%20/%3e%3c/svg%3e",ct={[F.Plains]:{baseColor:"#d8b869",icon:oo},[F.Forest]:{baseColor:"#237a55",icon:so},[F.Hills]:{baseColor:"#b57c57",icon:ro},[F.Lake]:{baseColor:"#3185d5",icon:ao}},dt=new Map;let te=null;function io(){if(te)return te;const e="/";if(/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(e))return te=e,te;const n=e.startsWith("/")?e:`/${e}`;return typeof window<"u"&&typeof window.location?.origin=="string"?te=`${window.location.origin}${n}`:te=`http://localhost${n}`,te}function lo(e){let t=dt.get(e);if(!t){t=new Image,t.decoding="async";const n=new URL(e,io()).href;t.src=n,dt.set(e,t)}if(t.complete&&t.naturalWidth>0&&t.naturalHeight>0)return t}const ut="rgba(56, 189, 248, 0.85)",ft="rgba(56, 189, 248, 0.45)";let le=null,ce=null;const co={[F.Plains]:Ut,[F.Forest]:eo,[F.Hills]:to,[F.Lake]:no};function uo(){if(le&&ce)return{stroke:le,glow:ce};if(typeof window<"u"){const e=getComputedStyle(document.documentElement),t=e.getPropertyValue("--tile-highlight-ring").trim(),n=e.getPropertyValue("--tile-highlight-glow").trim();le=t||ut,ce=n||ft}else le=ut,ce=ft;return{stroke:le,glow:ce}}function fo(e){const t=e.replace("#",""),n=Number.parseInt(t,16),o=n>>16&255,s=n>>8&255,r=n&255;return[o,s,r]}function ht([e,t,n],[o,s,r],a){const i=Math.min(1,Math.max(0,a)),d=(l,c)=>Math.round(l+(c-l)*i);return`rgb(${d(e,o)}, ${d(t,s)}, ${d(n,r)})`}function pt([e,t,n],o){return`rgba(${e}, ${t}, ${n}, ${o})`}class ho{constructor(t){this.mapRef=t}get hexSize(){return this.mapRef.hexSize}getOrigin(){return V({q:this.mapRef.minQ,r:this.mapRef.minR},this.hexSize)}draw(t,n,o){const{width:s,height:r}=Lt(this.hexSize),a=this.getOrigin();for(const[i,d]of this.mapRef.tiles){const[l,c]=i.split(",").map(Number),{x:u,y:f}=V({q:l,r:c},this.hexSize),m=u-a.x,g=f-a.y;if(t.save(),d.isFogged&&(t.globalAlpha=.4),this.drawTerrain(t,d.terrain,m,g,s,r),d.building){const A=n[`building-${d.building}`]??n.placeholder;t.drawImage(A,m,g,s,r)}const y=o&&l===o.q&&c===o.r;this.strokeHex(t,m+this.hexSize,g+this.hexSize,this.hexSize,!!y),t.restore()}}drawToCanvas(t,n,o){const s=t.getContext("2d");if(!s)throw new Error("Canvas 2D context not available");this.draw(s,n,o)}drawTerrain(t,n,o,s,r,a){const i=ct[n]??ct[F.Plains],d=fo(i.baseColor),l=this.hexSize,c=o+l,u=s+l;t.save(),this.hexPath(t,o+this.hexSize,s+this.hexSize,l),t.clip();const f=t.createRadialGradient(c,u,l*.2,c,u,l*1.05);f.addColorStop(0,ht(d,[255,255,255],.3)),f.addColorStop(.7,i.baseColor),f.addColorStop(1,ht(d,[12,18,28],.4)),t.fillStyle=f,t.shadowColor=pt(d,.35),t.shadowBlur=l*.9,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillRect(o-l*.1,s-l*.1,r+l*.2,a+l*.2);const m={ctx:t,x:o,y:s,width:r,height:a,radius:l,centerX:c,centerY:u,baseColor:i.baseColor};(co[n]??Ut)(m),t.globalCompositeOperation="lighter";const y=t.createRadialGradient(c,u,l*.85,c,u,l*1.18);y.addColorStop(0,"rgba(255, 255, 255, 0)"),y.addColorStop(1,pt(d,.18)),t.fillStyle=y,t.fillRect(o-l*.1,s-l*.1,r+l*.2,a+l*.2),t.globalCompositeOperation="source-over",t.restore();const A=lo(i.icon);if(A){const b=Math.min(r,a)*.62,C=c-b/2,R=u-b/2;t.save(),t.globalAlpha*=.92,t.drawImage(A,C,R,b,b),t.restore()}}strokeHex(t,n,o,s,r=!1){const{stroke:a,glow:i}=uo();this.hexPath(t,n,o,s),t.save(),t.lineJoin="round",t.lineCap="round",r?(t.shadowColor=i,t.shadowBlur=s*.65,t.lineWidth=Math.max(2,s*.08),t.strokeStyle=a,t.stroke()):(t.lineWidth=Math.max(1,s*.05),t.strokeStyle="rgba(12, 18, 28, 0.55)",t.stroke()),t.restore()}hexPath(t,n,o,s){t.beginPath();for(let r=0;r<6;r++){const a=Math.PI/180*(60*r-30),i=n+s*Math.cos(a),d=o+s*Math.sin(a);r===0?t.moveTo(i,d):t.lineTo(i,d)}t.closePath()}}const J={accent:"#38bdf8",accentSoft:"rgba(56, 189, 248, 0.2)",warm:"#fbbf24",surface:"rgba(15, 23, 42, 0.92)",border:"rgba(148, 163, 184, 0.34)",text:"#e2e8f0"};let Z=null;function oe(e,t){const n=e.trim();return n.length>0?n:t}function po(){if(Z)return Z;if(typeof window>"u"||typeof document>"u")return Z=J,Z;try{const e=getComputedStyle(document.documentElement);return Z={accent:oe(e.getPropertyValue("--color-accent"),J.accent),accentSoft:oe(e.getPropertyValue("--color-accent-soft"),J.accentSoft),warm:oe(e.getPropertyValue("--color-warning"),J.warm),surface:oe(e.getPropertyValue("--color-surface-strong"),J.surface),border:oe(e.getPropertyValue("--hud-border-strong"),J.border),text:oe(e.getPropertyValue("--color-foreground"),J.text)},Z}catch(e){return console.warn("Failed to read sauna palette tokens from computed styles",e),Z=J,Z}}function mo(e,t){const n=Math.max(0,e.auraRadius),o=V(e.pos,t),s=o.x+t,r=o.y+t;let a=t;if(n<=0)return t*1.6;for(const i of Ct){const d=V({q:e.pos.q+i.q*n,r:e.pos.r+i.r*n},t),l=d.x+t,c=d.y+t,u=Math.hypot(l-s,c-r);u>a&&(a=u)}return a+t*.65}function go(e,t,n,o,s,r){const a=Math.max(0,Math.min(r,Math.min(o,s)/2));e.moveTo(t+a,n),e.lineTo(t+o-a,n),e.quadraticCurveTo(t+o,n,t+o,n+a),e.lineTo(t+o,n+s-a),e.quadraticCurveTo(t+o,n+s,t+o-a,n+s),e.lineTo(t+a,n+s),e.quadraticCurveTo(t,n+s,t,n+s-a),e.lineTo(t,n+a),e.quadraticCurveTo(t,n,t+a,n),e.closePath()}function bo(e,t,{origin:n,hexSize:o,timestamp:s}){if(!t)return;const r=po(),a=Number.isFinite(s)?s:typeof performance<"u"?performance.now():Date.now(),i=.5+.5*Math.sin(a*.0035),d=V(t.pos,o),l=d.x-n.x+o,c=d.y-n.y+o,u=mo(t,o);e.save(),e.globalCompositeOperation="screen";const f=u+o*(.4+i*.3),m=Math.max(o*.6,u*.58),g=e.createRadialGradient(l,c,m,l,c,f);g.addColorStop(0,r.accentSoft),g.addColorStop(.55,`rgba(56, 189, 248, ${.18+i*.12})`),g.addColorStop(1,"rgba(2, 6, 23, 0)"),e.fillStyle=g,e.beginPath(),e.arc(l,c,f,0,Math.PI*2),e.fill(),e.restore(),e.save(),e.globalCompositeOperation="lighter",e.lineWidth=Math.max(o*.28,6),e.strokeStyle=`rgba(56, 189, 248, ${(.35+i*.2).toFixed(3)})`,e.shadowColor=`rgba(56, 189, 248, ${.45+i*.1})`,e.shadowBlur=o*(.9+i*.45),e.beginPath(),e.arc(l,c,u+o*.12,0,Math.PI*2),e.stroke(),e.restore();const y=o*.9;e.save(),e.beginPath(),e.arc(l,c,y,0,Math.PI*2),e.fillStyle=r.surface,e.globalAlpha*=.96,e.fill(),e.lineWidth=Math.max(1.5,o*.06),e.strokeStyle=r.border,e.shadowColor="rgba(8, 25, 53, 0.6)",e.shadowBlur=o*.45,e.stroke(),e.restore();const A=y*.78,b=Math.max(o*.22,5);e.save(),e.lineWidth=b,e.strokeStyle="rgba(148, 163, 184, 0.24)",e.beginPath(),e.arc(l,c,A,0,Math.PI*2),e.stroke(),e.restore();const C=t.spawnCooldown>0?t.spawnCooldown:1,T=1-Math.min(1,Math.max(0,t.timer/C)),P=-Math.PI/2,I=P+Math.PI*2*T;if(T>0){e.save(),e.lineWidth=b,e.lineCap="round";const _e=e.createLinearGradient(l,c-A,l,c+A);_e.addColorStop(0,r.accent),_e.addColorStop(1,r.warm),e.strokeStyle=_e,e.shadowColor=`rgba(56, 189, 248, ${.42+i*.18})`,e.shadowBlur=o*(.65+i*.35),e.beginPath(),e.arc(l,c,A,P,I,!1),e.stroke(),e.restore()}const L=Math.max(0,t.timer),U=Math.ceil(L);e.save(),e.font=`600 ${Math.max(12,o*.9)}px "Inter", "Manrope", "Segoe UI", sans-serif`,e.fillStyle=r.text,e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(2, 6, 23, 0.6)",e.shadowBlur=o*.35,e.fillText(String(U),l,c),e.restore(),e.save(),e.font=`500 ${Math.max(10,o*.36)}px "Inter", "Manrope", "Segoe UI", sans-serif`,e.fillStyle="rgba(148, 163, 184, 0.78)",e.textAlign="center",e.textBaseline="top",e.fillText("sec",l,c+A*.45),e.restore();const x="Sauna ♨️",h=Math.max(12,o*.58);e.save(),e.font=`600 ${h}px "Inter", "Manrope", "Segoe UI", sans-serif`;const p=e.measureText(x),w=o*.58,k=o*.32,$=p.width+w*2,q=h+k*2,W=l-$/2,z=c-u-q-o*.35,Qt=q/2;e.beginPath(),go(e,W,z,$,q,Qt);const be=e.createLinearGradient(W,z,W,z+q);be.addColorStop(0,"rgba(15, 23, 42, 0.94)"),be.addColorStop(.55,"rgba(15, 23, 42, 0.86)"),be.addColorStop(1,"rgba(30, 41, 59, 0.9)"),e.fillStyle=be,e.shadowColor="rgba(8, 25, 53, 0.6)",e.shadowBlur=o*.4,e.fill(),e.lineWidth=Math.max(1.5,o*.06);const $e=e.createLinearGradient(W,z,W+$,z);$e.addColorStop(0,`${r.accent}`),$e.addColorStop(1,`${r.warm}`),e.strokeStyle=$e,e.stroke(),e.fillStyle=r.text,e.shadowColor="rgba(8, 25, 53, 0.65)",e.shadowBlur=o*.3,e.textAlign="center",e.textBaseline="middle",e.fillText(x,l,z+q/2+h*.05),e.restore()}function yo(e,t,n,o,s,r){const a=window.devicePixelRatio||1,i=e.canvas.width,d=e.canvas.height;e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,i,d);const l=i/a,c=d/a;e.scale(a,a),e.translate(l/2,c/2),e.scale(E.zoom,E.zoom);const u=t.getOrigin();e.translate(-(E.x-u.x),-(E.y-u.y)),t.draw(e,n,s??void 0);const f=r?.saunojas;f&&Array.isArray(f.units)&&f.units.length>0&&f.draw(e,f.units,{originX:u.x,originY:u.y,hexRadius:t.hexSize}),wo(e,t,n,o,u),r?.sauna&&bo(e,r.sauna,{origin:u,hexSize:t.hexSize}),e.restore()}function wo(e,t,n,o,s){const{width:r,height:a}=Lt(t.hexSize);for(const i of o){const{x:d,y:l}=V(i.coord,t.hexSize),c=d-s.x,u=l-s.y,f=n[`unit-${i.type}`]??n.placeholder,m=i.getMaxHealth();e.save(),i.stats.health/m<.5&&(e.filter="saturate(0)"),e.drawImage(f,c,u,r,a),Wn()&&i.faction==="player"&&(e.strokeStyle="rgba(255,255,255,0.5)",e.lineWidth=2,e.strokeRect(c,u,r,a)),e.restore()}}function vo(){return`${"/".endsWith("/")?"/":"//"}${"assets/units/saunoja.svg".replace(/^\/+/,"")}`}const mt=vo();let re=null,de=null;function je(e){return!!(e&&e.complete&&e.naturalWidth>0&&e.naturalHeight>0)}function So(e,t){if(!t)return e;try{t(e)}catch(n){console.error("Saunoja icon onLoad callback failed",n)}return e}function Bt(e){const t=o=>e?o.then(s=>So(s,e)):o;if(je(re))return t(Promise.resolve(re));if(de)return t(de);if(typeof Image>"u")return Promise.reject(new Error("Image constructor is not available in this environment."));const n=new Image;return n.decoding="async",re=n,de=new Promise((o,s)=>{const r=()=>{n.onload=null,n.onerror=null},a=()=>{r(),o(n)};n.onload=a,n.onerror=i=>{r(),re=null,de=null;const d=new Error(`Failed to load saunoja icon from ${mt}`);console.warn(d.message,i),s(d)},n.src=mt,je(n)&&a()}),t(de)}function Ao(e,t,{originX:n=0,originY:o=0,hexRadius:s=ie}={}){if(!e||!Array.isArray(t)||t.length===0)return;const r=je(re)?re:null;if(!r)return;const a=Number.isFinite(s)&&s>0?s:ie,i=a*.98,d=[...t].sort((l,c)=>l.coord.r!==c.coord.r?l.coord.r-c.coord.r:l.coord.q!==c.coord.q?l.coord.q-c.coord.q:l.id.localeCompare(c.id));for(const l of d){const{x:c,y:u}=V(l.coord,a),f=c-n,m=u-o,g=f+a,y=m+a;e.save(),fe(e,g,y,i),e.clip();const A=a*2.15/Math.max(r.naturalWidth,r.naturalHeight||1),b=r.naturalWidth*A,C=r.naturalHeight*A,R=g-b/2,T=y-C*.72;e.save(),e.filter="grayscale(100%) contrast(112%)",e.globalAlpha*=.96,e.drawImage(r,R,T,b,C),e.restore(),e.save(),e.globalCompositeOperation="multiply";const P=e.createRadialGradient(g,y+i*.38,i*.2,g,y+i*.38,i*1.05);P.addColorStop(0,"rgba(15, 23, 42, 0.55)"),P.addColorStop(1,"rgba(15, 23, 42, 0)"),e.fillStyle=P,e.fillRect(g-i,y-i,i*2,i*2),e.restore(),e.save(),e.globalCompositeOperation="soft-light";const I=e.createLinearGradient(g,y-i,g,y+i);I.addColorStop(0,"rgba(255, 232, 210, 0.18)"),I.addColorStop(.52,"rgba(255, 183, 124, 0.32)"),I.addColorStop(1,"rgba(212, 97, 54, 0.5)"),e.fillStyle=I,e.fillRect(g-i,y-i,i*2,i*2),e.restore(),e.save(),e.globalCompositeOperation="screen",e.globalAlpha=.75;const L=e.createRadialGradient(g,y-i*.68,i*.1,g,y,i*1.12);L.addColorStop(0,"rgba(255, 255, 255, 0.85)"),L.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=L,e.fillRect(g-i,y-i,i*2,i*2),e.restore();const x=performance.now()-l.lastHitAt,h=120;if(x<h){const k=1-x/h;On(e,{centerX:g,centerY:y,radius:i,progress:k})}e.restore(),Gn(e,{centerX:g,centerY:y-a*.18,radius:a*.94,intensity:l.steam});const p=a*.42,w=y+a*.34;Hn(e,{centerX:g,centerY:w,hp:l.hp,maxHp:l.maxHp,radius:p})}}const ve="/",K={saunaBeer:`${ve}assets/ui/sauna-beer.svg`,saunojaRoster:`${ve}assets/ui/saunoja-roster.svg`,resource:`${ve}assets/ui/resource.svg`,sound:`${ve}assets/ui/sound.svg`},$t=200,_t=3,Mo=2,qt={[S.SAUNA_BEER]:"Sauna Beer",[S.SAUNAKUNNIA]:"Saunakunnia"};let Te=null,D,ae=null,_=[];const he=new Map,pe=new Map;let Pe=null;const Dt="autobattles:saunojas",ko=new Intl.NumberFormat("en-US",{maximumFractionDigits:0});function Ft(){try{return globalThis.localStorage??null}catch{return null}}function Co(){const e=Ft();if(!e)return[];try{const t=e.getItem(Dt);if(!t)return[];const n=JSON.parse(t);if(!Array.isArray(n))return[];const o=[];for(const s of n){if(!s||typeof s!="object")continue;const r=s,a=r.id;if(typeof a!="string"||a.length===0)continue;const i=r.coord,d=i&&typeof i=="object"&&typeof i.q=="number"&&Number.isFinite(i.q)&&typeof i.r=="number"&&Number.isFinite(i.r)?{q:i.q,r:i.r}:void 0,l=r.traits,c=Array.isArray(l)?l.filter(m=>typeof m=="string"):void 0,u=typeof r.upkeep=="number"?r.upkeep:void 0,f=typeof r.xp=="number"?r.xp:void 0;o.push(Qe({id:a,name:typeof r.name=="string"?r.name:void 0,coord:d,maxHp:typeof r.maxHp=="number"?r.maxHp:void 0,hp:typeof r.hp=="number"?r.hp:void 0,steam:typeof r.steam=="number"?r.steam:void 0,traits:c,upkeep:u,xp:f,selected:!!r.selected}))}return o}catch(t){return console.warn("Failed to load Saunoja units from storage",t),[]}}function Ie(){const e=Ft();if(e)try{const t=_.map(n=>({id:n.id,name:n.name,coord:{q:n.coord.q,r:n.coord.r},maxHp:n.maxHp,hp:n.hp,steam:n.steam,traits:[...n.traits],upkeep:n.upkeep,xp:n.xp,selected:n.selected}));e.setItem(Dt,JSON.stringify(t))}catch(t){console.warn("Failed to persist Saunoja units",t)}}function Eo(e,t){Te=e,D=t,D.classList.add("sauna-roster"),D.setAttribute("role","status"),D.setAttribute("aria-live","polite"),D.setAttribute("title","Active sauna battalion on the field"),D.replaceChildren();const n=document.createElement("img");n.src=K.saunojaRoster,n.alt="Saunoja roster crest",n.decoding="async",n.classList.add("sauna-roster__icon");const o=document.createElement("span");o.classList.add("sauna-roster__text");const s=document.createElement("span");s.textContent="Saunoja Roster",s.classList.add("sauna-roster__label"),ae=document.createElement("span"),ae.textContent="0",ae.classList.add("sauna-roster__value"),o.append(s,ae),D.append(n,o),Be()}const To={images:{placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=","building-farm":Jt,"building-barracks":Zt,"building-city":en,"building-mine":tn,"unit-soldier":nn,"unit-archer":on,"unit-avanto-marauder":sn,"icon-sauna-beer":K.saunaBeer,"icon-saunoja-roster":K.saunojaRoster,"icon-resource":K.resource,"icon-sound":K.sound}};let Ne=null;function Po(e){Ne=e}const j=new vn(10,10,32),Io=new In(j),No=new ho(j);j.forEachTile(e=>e.setFogged(!0));fn();const H=[];function Ro(e){const t=he.get(e);t&&(he.delete(e),pe.get(t.id)===e&&pe.delete(t.id))}function Lo(e){const t=he.get(e.id);if(t)return{saunoja:t,created:!1};let n=_.find(r=>r.id===e.id);n||(n=_.find(r=>!pe.has(r.id)));let o=!1;n||(n=Qe({id:`saunoja-${_.length+1}`,coord:{q:e.coord.q,r:e.coord.r}}),_.push(n),o=!0);const s=pe.get(n.id);return s&&s!==e.id&&he.delete(s),he.set(e.id,n),pe.set(n.id,e.id),{saunoja:n,created:o}}function Ht(){let e=!1;for(const t of H){if(t.faction!=="player"||t.isDead())continue;const{saunoja:n,created:o}=Lo(t);o&&(e=!0);const{q:s,r}=t.coord;(n.coord.q!==s||n.coord.r!==r)&&(n.coord={q:s,r},e=!0,n.selected&&Ce(n.coord))}return e&&Ie(),e}function Ot(e){return`${(e.constructor?.name??"Unit").replace(/([a-z])([A-Z])/g,"$1 $2").toLowerCase()} ${e.id}`.trim()}function Gt(e){if(H.some(n=>n.id===e.id))return;H.push(e),e.faction==="player"&&Ht(),Te&&Y();const t=e.faction==="player"?"Our":"A rival";ge(`${t} ${Ot(e)} emerges from the steam.`),e.faction==="player"&&Be()}const Yt=({unit:e})=>{Gt(e)};v.on("unitSpawned",Yt);const Q=new bn(1e3);Q.load(j);const xo=2,Uo=new yn(1e3,()=>{Q.tick(),Io.tick(H),Ht(),Q.save();for(const e of H)!e.isDead()&&e.faction==="player"&&j.revealAround(e.coord,xo);Y()}),me=Yn({q:Math.floor(j.width/2),r:Math.floor(j.height/2)});j.revealAround(me.pos,3);_=Co();if(_.length===0)_.push(Qe({id:"saunoja-1",coord:me.pos,selected:!0})),Ie();else{let e=!1,t=!1;for(const n of _)n.selected&&(e?(n.selected=!1,t=!0):e=!0);t&&Ie()}const Bo=jn(me),$o=Xn(Q,{saunakunnia:K.resource,sisu:K.resource,saunaBeer:K.saunaBeer,sound:K.sound}),{log:ge,addEvent:cs}=Kn(Q);v.on("sisuPulse",()=>zn(Q,H));v.on("sisuPulseStart",()=>Rt("sisu"));Q.addResource(S.SAUNA_BEER,$t);ge(`Quartermaster stocks ${$t} bottles of ${qt[S.SAUNA_BEER]} to launch your campaign.`);Q.addResource(S.SAUNAKUNNIA,_t);ge(`Sauna elders honor your leadership with ${_t} ${qt[S.SAUNAKUNNIA]} to celebrate your arrival.`);const He=_.find(e=>e.selected);He&&(Pe={q:He.coord.q,r:He.coord.r});function _o(e,t){return!e||!t?e===t:e.q===t.q&&e.r===t.r}function Ce(e){return _o(Pe,e)?!1:(Pe=e?{q:e.q,r:e.r}:null,!0)}function Oe(e){let t=!1;for(const n of _)e&&n===e||n.selected&&(n.selected=!1,t=!0);return t}function jt(e){const t=an(e.x-j.hexSize,e.y-j.hexSize,j.hexSize),n=_.find(s=>s.coord.q===t.q&&s.coord.r===t.r);let o=!1;if(!n)Oe()&&(o=!0),Ce(null)&&(o=!0);else{const s=!n.selected;n.selected!==s&&(n.selected=s,o=!0),s?(Oe(n)&&(o=!0),Ce(n.coord)&&(o=!0)):(Oe()&&(o=!0),Ce(null)&&(o=!0))}o&&(Ie(),Y())}function Y(){if(!Te)return;const e=Te.getContext("2d");!e||!Ne||yo(e,No,Ne.images,H,Pe,{saunojas:{units:_,draw:Ao},sauna:me})}const Xt=({policy:e})=>{ge(`Sauna council toasts a fresh keg for policy: ${e}.`)};v.on("policyApplied",Xt);const Wt=({unitId:e,attackerFaction:t,unitFaction:n})=>{const o=H.findIndex(i=>i.id===e),s=o!==-1?H[o]:null;o!==-1&&(H.splice(o,1),Ro(e),Y()),n==="player"&&Be(),t==="player"&&n&&n!=="player"&&Q.addResource(S.SAUNAKUNNIA,Mo);const r=n==="player"?"our":"a rival",a=s?Ot(s):`unit ${e}`;ge(`The steam hushes as ${r} ${a} grows still.`)};v.on("unitDied",Wt);function Xe(){v.off("policyApplied",Xt),v.off("unitDied",Wt),v.off("unitSpawned",Yt)}async function qo(){if(!Ne){console.error("Cannot start game without loaded assets.");return}Be(),Y();try{await Bt(()=>{Y()}).then(()=>{Y()})}catch(n){console.warn("Failed to preload Saunoja icon before starting the game",n)}let e=performance.now();function t(n){const o=n-e;e=n,Uo.tick(o),me.update(o/1e3,H,s=>{Gt(s)}),Bo(),$o(o),Y(),requestAnimationFrame(t)}requestAnimationFrame(t)}function Do(){const e=new Set;for(const t of H)t.faction==="player"&&!t.isDead()&&e.add(t.id);for(const t of _)t.hp>0&&e.add(t.id);return e.size}function Be(){const e=Math.max(0,Math.floor(Do())),t=ko.format(e);ae?ae.textContent=t:D&&(D.textContent=`Saunoja roster: ${t}`),D&&(D.setAttribute("aria-label",`Saunoja roster: ${t} active attendants`),D.setAttribute("title",`Saunoja roster • ${t} active attendants`))}async function Fo(e){const t=Object.entries(e),n=await Promise.allSettled(t.map(([a,i])=>i.load().then(d=>({key:a,descriptor:i,value:d})))),o={},s=[],r=[];return n.forEach((a,i)=>{const[d,l]=t[i],c=l.label??String(d);if(a.status==="fulfilled"){const{value:f}=a.value;if(o[d]=f.value,f.warnings?.length)for(const m of f.warnings)s.push(c?`${c}: ${m}`:m);if(f.errors?.length)for(const m of f.errors)r.push(c?`${c}: ${m}`:m);return}const u=Ho(a.reason);r.push(c?`${c}: ${u}`:u)}),{resources:o,warnings:s,errors:r}}function Ho(e){if(e instanceof Error)return e.message;if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}const Oo=.5,Go=3.5,Yo=.0015,jo=10,Xo=250;function Wo(){if(typeof document>"u")return;const e=document.querySelector("[data-build-commit]");if(!e)return;const t="ed0cce5".trim(),n=t.length>0&&t!=="unknown",o=n?`#${t}`:"DEV BUILD";e.textContent=o,e.dataset.state=n?"commit":"dev";const s=e.closest("#build-id");if(s){const r=n?`Build commit ${t}`:"Development build";s.setAttribute("aria-label",r),s.title=n?`Autobattles build ${t}`:"Unversioned development build",s.dataset.buildState=n?"release":"development"}}Wo();const We=[];let Re=0,N=null,ze=!1,M=null;const B={active:!1,pointerId:null,lastX:0,lastY:0};function zo(e){return Math.min(Go,Math.max(Oo,e))}function G(e){We.push(e)}function ne(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}function Ko(e){const t=window.devicePixelRatio||1,n=Math.max(window.innerWidth,1),o=Math.max(window.innerHeight,1);e.style.width=`${n}px`,e.style.height=`${o}px`,e.width=Math.round(n*t),e.height=Math.round(o*t);const s=e.getContext("2d");s&&s.setTransform(1,0,0,1,0,0),Y()}function Ke(e,t,n,o,s){const r=e.getBoundingClientRect(),a=t-r.left,i=n-r.top,d=r.width/2,l=r.height/2;return{x:s.x+(a-d)/o,y:s.y+(i-l)/o}}function zt(e,t,n,o=E.zoom,s=E){return Ke(e,t,n,o,s)}function Kt(e,t,n,o){const s=zo(o);if(s===E.zoom)return;const r={x:E.x,y:E.y},a=Ke(e,t,n,E.zoom,r),i=Ke(e,t,n,s,r);E.x+=a.x-i.x,E.y+=a.y-i.y,E.zoom=s,Y()}function et(e,t){e===0&&t===0||(E.x-=e/E.zoom,E.y-=t/E.zoom,Y())}function gt(e){if(!N)return;e.preventDefault();const t=Math.exp(-e.deltaY*Yo),n=E.zoom*t;Kt(N,e.clientX,e.clientY,n)}function bt(e){N&&(e.pointerType!=="mouse"||e.button!==0||(B.active=!0,B.pointerId=e.pointerId,B.lastX=e.clientX,B.lastY=e.clientY,N.setPointerCapture?.(e.pointerId),N.style.cursor="grabbing"))}function yt(e){if(!N||!B.active||B.pointerId!==e.pointerId)return;const t=e.clientX-B.lastX,n=e.clientY-B.lastY;B.lastX=e.clientX,B.lastY=e.clientY,et(t,n)}function se(e){N&&(!B.active||B.pointerId!==e.pointerId||(B.active=!1,B.pointerId=null,N.releasePointerCapture?.(e.pointerId),N.style.cursor=""))}function Vo(e){return!N||e.mode!=="pan"||e.startX==null||e.startY==null||e.moved&&Math.hypot((e.lastX??e.startX)-e.startX,(e.lastY??e.startY)-e.startY)>jo?!1:ne()-e.startTime<=Xo}function Qo(e){if(!N||e.startX==null||e.startY==null)return;const t=zt(N,e.startX,e.startY);jt(t)}function Jo(e){if(!M)return;const t=e.clientX-(M.lastX??e.clientX),n=e.clientY-(M.lastY??e.clientY);Math.hypot(t,n)>1&&(M.moved=!0),M.lastX=e.clientX,M.lastY=e.clientY,et(t,n)}function Zo(e,t){if(!N)return;const n=(e.clientX+t.clientX)/2,o=(e.clientY+t.clientY)/2,s=Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY);if(M?.lastDistance){const r=s/M.lastDistance,a=E.zoom*r;Kt(N,n,o,a)}if(M?.lastCenter){const r=n-M.lastCenter.x,a=o-M.lastCenter.y;et(r,a)}M?(M.mode="pinch",M.lastCenter={x:n,y:o},M.lastDistance=s,M.moved=!0):M={mode:"pinch",lastCenter:{x:n,y:o},lastDistance:s,startTime:ne(),moved:!0}}function wt(e){if(N){if(e.touches.length===1){const t=e.touches[0];M={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:ne(),moved:!1}}else if(e.touches.length>=2){const[t,n]=[e.touches[0],e.touches[1]];M={mode:"pinch",lastCenter:{x:(t.clientX+n.clientX)/2,y:(t.clientY+n.clientY)/2},lastDistance:Math.hypot(t.clientX-n.clientX,t.clientY-n.clientY),startTime:ne(),moved:!1}}}}function vt(e){if(!(!N||!M)&&e.touches.length!==0)if(e.preventDefault(),e.touches.length===1){const t=e.touches[0];if(M.mode!=="pan"){const n=M.mode==="pinch";M={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:ne(),moved:n}}Jo(t)}else{const[t,n]=[e.touches[0],e.touches[1]];Zo(t,n)}}function Se(e){if(!(!N||!M)){if(e.touches.length===0){Vo(M)&&Qo(M),M=null;return}if(e.touches.length===1){const t=e.touches[0],n=M.mode==="pinch";M={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:ne(),moved:n}}else if(e.touches.length>=2){const[t,n]=[e.touches[0],e.touches[1]];M={mode:"pinch",lastCenter:{x:(t.clientX+n.clientX)/2,y:(t.clientY+n.clientY)/2},lastDistance:Math.hypot(t.clientX-n.clientX,t.clientY-n.clientY),startTime:ne(),moved:!0}}}}function St(e){if(!N)return;const t=zt(N,e.clientX,e.clientY);jt(t)}function es(e){e.addEventListener("click",St),G(()=>e.removeEventListener("click",St)),e.addEventListener("wheel",gt,{passive:!1}),G(()=>e.removeEventListener("wheel",gt)),e.addEventListener("pointerdown",bt),e.addEventListener("pointermove",yt),e.addEventListener("pointerup",se),e.addEventListener("pointercancel",se),e.addEventListener("pointerleave",se),G(()=>{e.removeEventListener("pointerdown",bt),e.removeEventListener("pointermove",yt),e.removeEventListener("pointerup",se),e.removeEventListener("pointercancel",se),e.removeEventListener("pointerleave",se)}),e.addEventListener("touchstart",wt,{passive:!1}),e.addEventListener("touchmove",vt,{passive:!1}),e.addEventListener("touchend",Se),e.addEventListener("touchcancel",Se),G(()=>{e.removeEventListener("touchstart",wt),e.removeEventListener("touchmove",vt),e.removeEventListener("touchend",Se),e.removeEventListener("touchcancel",Se)})}function ts(){for(;We.length;){const e=We.pop();try{e?.()}catch(t){console.error("Error during cleanup",t)}}}function ns(){Re+=1,ts(),B.active=!1,B.pointerId=null,N&&(N.style.cursor=""),M=null,N=null,ze=!1,os(),Xe()}function os(){document.querySelectorAll(".hud-loader").forEach(e=>{e.remove()}),document.querySelectorAll(".hud-banner-stack").forEach(e=>{e.remove()})}function ss(e="Heating the sauna stones…"){const t=document.getElementById("ui-overlay");if(!t)return{update:()=>{},clear:()=>{},dispose:()=>{}};const n=document.createElement("div");n.className="hud-loader",n.setAttribute("role","status"),n.setAttribute("aria-live","polite");const o=document.createElement("div");o.className="hud-loader__card";const s=document.createElement("div");s.className="hud-loader__spinner",s.setAttribute("aria-hidden","true");const r=document.createElement("p");r.className="hud-loader__message",r.textContent=e,o.append(s,r),n.append(o),t.append(n);let a=!1;return{update(i){r.textContent=i},clear(){a||Vt(n,"hud-loader--hidden",()=>{a=!0,n.remove()})},dispose(){a||(a=!0,n.remove())}}}function Ae(e,t){const n=rs();if(!n)return null;const o=document.createElement("section");o.className=`hud-banner hud-banner--${e}`,o.setAttribute("role",e==="error"?"alert":"status"),o.setAttribute("aria-live",e==="error"?"assertive":"polite");const s=document.createElement("header");s.className="hud-banner__header";const r=document.createElement("p");r.className="hud-banner__title",r.textContent=t.title??(e==="error"?"Attention required":e==="warning"?"Heads up":"Status update"),s.append(r);const a=document.createElement("ul");a.className="hud-banner__list";for(const c of t.messages){const u=document.createElement("li");u.textContent=c,a.append(u)}if(o.append(s),t.messages.length&&o.append(a),t.actions?.length){const c=document.createElement("div");c.className="hud-banner__actions";for(const u of t.actions){const f=document.createElement("button");f.type="button",f.className=u.variant==="secondary"?"hud-banner__button hud-banner__button--secondary":"hud-banner__button",f.textContent=u.label,f.addEventListener("click",()=>{u.onClick()}),c.append(f)}o.append(c)}let i,d=!1;const l=()=>{d||(d=!0,i&&window.clearTimeout(i),Vt(o,"hud-banner--hide",()=>{o.remove(),n.hasChildNodes()||n.remove()}))};if(t.dismissible!==!1){const c=document.createElement("button");c.type="button",c.className="hud-banner__close",c.setAttribute("aria-label","Dismiss notification"),c.textContent="×",c.addEventListener("click",()=>{l()}),s.append(c)}return n.append(o),t.autoCloseMs&&t.autoCloseMs>0&&(i=window.setTimeout(()=>l(),t.autoCloseMs)),{element:o,dismiss:l}}function rs(){const e=document.getElementById("ui-overlay");if(!e)return null;let t=e.querySelector(".hud-banner-stack");return t||(t=document.createElement("div"),t.className="hud-banner-stack",e.append(t)),t}function Vt(e,t,n){let o=!1;const s=()=>{o||(o=!0,e.removeEventListener("transitionend",s),n())};e.addEventListener("transitionend",s),requestAnimationFrame(()=>{e.classList.add(t)}),window.setTimeout(s,400)}function At(e){if(e instanceof Error&&e.message)return e.message;if(typeof e=="string"&&e.trim().length>0)return e;try{return JSON.stringify(e)}catch{return String(e)}}async function as(e){const t=ss("Heating the sauna stones…");G(()=>t.dispose());try{const{resources:n,warnings:o,errors:s}=await Fo({assets:{label:"Core assets",load:async()=>{const a=await hn(To);return{value:a.assets,errors:a.failures}}},saunojaIcon:{label:"Saunoja icon",load:async()=>{try{return{value:await Bt()}}catch(a){return{value:null,warnings:[`Unable to preload Saunoja icon (${At(a)})`]}}}}});if(e!==Re){t.dispose();return}t.update("Polishing sauna ambience…"),t.clear();const r=n.assets;if(!r){const a=s.length?[...s]:["Critical assets were unavailable. Please refresh to try again."];console.error("Critical assets failed to load",a);const i=Ae("error",{title:"Unable to start the sauna battle",messages:a,actions:[{label:"Reload",onClick:()=>window.location.reload(),variant:"primary"}],dismissible:!1});i&&G(()=>i.dismiss());return}if(s.length){console.error("Resource loader errors",s);const a=Ae("error",{title:"Some resources failed to load",messages:s,actions:[{label:"Reload",onClick:()=>window.location.reload(),variant:"primary"}]});a&&G(()=>a.dismiss())}if(o.length){console.warn("Resource loader warnings",o);const a=Ae("warning",{title:"Heads up",messages:o,autoCloseMs:12e3});a&&G(()=>a.dismiss())}Po(r),qo()}catch(n){if(e!==Re){t.dispose();return}console.error("Failed to initialize resources",n),t.clear();const o=Ae("error",{title:"Failed to initialize",messages:[At(n)],actions:[{label:"Reload",onClick:()=>window.location.reload(),variant:"primary"}]});o&&G(()=>o.dismiss())}}function is(){const e=document.getElementById("game-canvas"),t=document.getElementById("resource-bar");if(!e||!t){console.error("Autobattles4xFinsauna shell is missing the required canvas or resource bar elements.",{hasCanvas:!!e,hasResourceBar:!!t});return}ze&&ns();const n=++Re;N=e,ze=!0,Eo(e,t),es(e);const o=()=>Ko(e);window.addEventListener("resize",o),G(()=>window.removeEventListener("resize",o)),window.addEventListener("beforeunload",Xe),G(()=>window.removeEventListener("beforeunload",Xe)),o(),import.meta.vitest||as(n)}function ls(){if(typeof document>"u")return;const e=()=>{document.removeEventListener("DOMContentLoaded",e),is()};if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",e);return}e()}import.meta.vitest||ls();export{S as R,Tn as U,v as e,Rt as p};
