(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const Ft="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3cpolygon%20points='16,48%2032,16%2048,48'%20fill='%23d2691e'%20/%3e%3crect%20x='24'%20y='32'%20width='16'%20height='16'%20fill='%23f4a460'%20/%3e%3c/svg%3e",Nt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23c0c0c0'%20/%3e%3crect%20x='8'%20y='24'%20width='48'%20height='24'%20fill='%23808080'%20/%3e%3crect%20x='24'%20y='16'%20width='16'%20height='8'%20fill='%23606060'%20/%3e%3c/svg%3e",Yt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23e0e0e0'%20/%3e%3crect%20x='10'%20y='22'%20width='12'%20height='30'%20fill='%23a9a9a9'%20/%3e%3crect%20x='26'%20y='14'%20width='12'%20height='38'%20fill='%23808080'%20/%3e%3crect%20x='42'%20y='26'%20width='12'%20height='26'%20fill='%23a9a9a9'%20/%3e%3c/svg%3e",Xt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b4513'%20/%3e%3cpolygon%20points='32,10%2042,22%2022,22'%20fill='%23555'%20/%3e%3crect%20x='30'%20y='22'%20width='4'%20height='32'%20fill='%23ccc'%20/%3e%3c/svg%3e",Wt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%234682b4'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='12'%20fill='%23fff'%20/%3e%3crect%20x='28'%20y='36'%20width='8'%20height='16'%20fill='%23fff'%20/%3e%3c/svg%3e",Ut="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23556b2f'%20/%3e%3cline%20x1='16'%20y1='16'%20x2='48'%20y2='48'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cpolygon%20points='48,48%2044,36%2036,44'%20fill='%23fff'%20/%3e%3c/svg%3e",jt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b0000'%20/%3e%3cline%20x1='18'%20y1='18'%20x2='46'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cline%20x1='46'%20y1='18'%20x2='18'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3c/svg%3e";class zt{listeners=new Map;on(t,n){const o=this.listeners.get(t)??[];o.push(n),this.listeners.set(t,o)}off(t,n){const o=this.listeners.get(t);if(!o)return;const s=o.indexOf(n);s!==-1&&(o.splice(s,1),o.length===0?this.listeners.delete(t):this.listeners.set(t,o))}emit(t,n){const o=this.listeners.get(t);if(o)for(const s of o)s(n)}}const v=new zt;class Ye{type="farm";cost=50;foodPerTick=1}class gt{type="barracks";cost=100;trainingCapacity=1}const bt=Math.sqrt(3),yt=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function _(e,t){return{x:t*bt*(e.q+e.r/2),y:t*(3/2)*e.r}}function Vt(e,t,n){const o=(bt/3*e-.3333333333333333*t)/n,s=2/3*t/n;return Qt({q:o,r:s})}function He(e){return yt.map(t=>({q:e.q+t.q,r:e.r+t.r}))}function Qt(e){let t=e.q,n=e.r,o=-t-n,s=Math.round(t),r=Math.round(o),i=Math.round(n);const a=Math.abs(s-t),d=Math.abs(r-o),l=Math.abs(i-n);return a>d&&a>l?s=-r-i:d>l?r=-s-i:i=-s-r,{q:s,r:i}}const ve=new Set;let ye=32;function Kt(e){return`${e.q},${e.r}`}function Be(e,t){ye=t,ve.add(Kt(e))}function Jt(e){if(ve.size===0)return{center:{x:0,y:0},zoom:1};const t=ye*Math.sqrt(3),n=ye*2;let o=1/0,s=1/0,r=-1/0,i=-1/0;for(const p of ve){const[h,w]=p.split(",").map(Number),{x:y,y:C}=_({q:h,r:w},ye);o=Math.min(o,y),s=Math.min(s,C),r=Math.max(r,y+t),i=Math.max(i,C+n)}const a=r-o,d=i-s,l=96,c={x:o+a/2,y:s+d/2},u=e.width/(a+l*2),f=e.height/(d+l*2),m=Math.min(u,f);return{center:c,zoom:m}}const M={x:0,y:0,zoom:1};function Zt(e,t=300){const n=M.x,o=M.y,s=M.zoom,r=typeof performance<"u"?performance.now():Date.now(),i=a=>{const d=Math.min((a-r)/t,1);M.x=n+(e.center.x-n)*d,M.y=o+(e.center.y-o)*d,M.zoom=s+(e.zoom-s)*d,d<1&&(typeof requestAnimationFrame<"u"?requestAnimationFrame(i):setTimeout(()=>i(typeof performance<"u"?performance.now():Date.now()),16))};typeof requestAnimationFrame<"u"?requestAnimationFrame(i):setTimeout(()=>i(typeof performance<"u"?performance.now():Date.now()),0)}function en(){ve.clear()}async function tn(e){const t={},n={},o=[],s=Object.entries(e.images??{}).map(([i,a])=>new Promise(d=>{const l=new Image;l.onload=()=>{t[i]=l,d()},l.onerror=()=>{const c=`Failed to load image: ${a}`;console.error(c),o.push(c),d()},l.src=a})),r=Object.entries(e.sounds??{}).map(([i,a])=>new Promise(d=>{const l=new Audio;l.oncanplaythrough=()=>{n[i]=l,d()},l.onerror=()=>{const c=`Failed to load sound: ${a}`;console.error(c),o.push(c),d()},l.src=a,l.load()}));return await Promise.all([...s,...r]),{assets:{images:t,sounds:n},failures:o}}function nn(e){const t=localStorage.getItem(e);if(t)try{return JSON.parse(t)}catch(n){console.warn(`Failed to parse data for "${e}", clearing`,n),localStorage.removeItem(e);return}}function Ie(e){return`${e.q},${e.r}`}const wt={farm:()=>new Ye,barracks:()=>new gt};function on(e){return wt[e]?.()}var z=(e=>(e.GOLD="gold",e))(z||{});const sn={gold:1};class rn{constructor(t,n="gameState"){this.tickInterval=t,this.storageKey=n}resources={gold:0};passiveGeneration={...sn};lastSaved=Date.now();buildings={};buildingPlacements=new Map;policies=new Set;nightWorkSpeedMultiplier=1;tick(){Object.keys(this.passiveGeneration).forEach(t=>{this.addResource(t,this.passiveGeneration[t])})}save(){this.lastSaved=Date.now();const t={};this.buildingPlacements.forEach((o,s)=>{t[s]=o.type});const n={resources:this.resources,lastSaved:this.lastSaved,buildings:this.buildings,buildingPlacements:t};localStorage.setItem(this.storageKey,JSON.stringify(n))}load(t){const n=nn(this.storageKey);if(!n){this.lastSaved=Date.now();return}this.resources={...this.resources,...n.resources};const o={};Object.entries(n.buildings??{}).forEach(([i,a])=>{wt[i]&&(o[i]=a)}),this.buildings=o,this.buildingPlacements.clear(),n.buildingPlacements&&Object.entries(n.buildingPlacements).forEach(([i,a])=>{const d=on(a);if(!d)return;this.buildingPlacements.set(i,d);const[l,c]=i.split(",").map(Number);if(t){const u=t.ensureTile(l,c);u.placeBuilding(d.type),u.reveal(),Be({q:l,r:c},t.hexSize)}v.emit("buildingPlaced",{building:d,coord:{q:l,r:c},state:this})}),this.lastSaved=n.lastSaved??Date.now();const s=Date.now()-this.lastSaved,r=Math.floor(s/this.tickInterval);Object.keys(this.passiveGeneration).forEach(i=>{this.resources[i]+=r*this.passiveGeneration[i]})}getResource(t){return this.resources[t]}canAfford(t,n="gold"){return this.resources[n]>=t}spend(t,n="gold"){return this.canAfford(t,n)?(this.resources[n]-=t,v.emit("resourceChanged",{resource:n,amount:-t,total:this.resources[n]}),!0):!1}addResource(t,n){this.resources[t]+=n,v.emit("resourceChanged",{resource:t,amount:n,total:this.resources[t]})}modifyPassiveGeneration(t,n){this.passiveGeneration[t]=(this.passiveGeneration[t]??0)+n}construct(t,n,o="gold"){return this.spend(n,o)?(this.buildings[t]=(this.buildings[t]??0)+1,!0):!1}placeBuilding(t,n,o,s="gold"){const r=o.getTile(n.q,n.r);return!r||r.building||!this.construct(t.type,t.cost,s)?!1:(this.buildingPlacements.set(Ie(n),t),r.placeBuilding(t.type),v.emit("buildingPlaced",{building:t,coord:n,state:this}),!0)}getBuildingAt(t){return this.buildingPlacements.get(Ie(t))}removeBuilding(t,n){const o=Ie(t),s=this.buildingPlacements.get(o);return s?(this.buildingPlacements.delete(o),n.getTile(t.q,t.r)?.placeBuilding(null),this.buildings[s.type]!==void 0&&(this.buildings[s.type]-=1,this.buildings[s.type]<=0&&delete this.buildings[s.type]),v.emit("buildingRemoved",{building:s,coord:t,state:this}),!0):!1}upgrade(t,n,o="gold"){return this.construct(`upgrade:${t}`,n,o)}applyPolicy(t,n,o="gold"){return this.spend(n,o)?(this.policies.add(t),v.emit("policyApplied",{policy:t,state:this}),!0):!1}hasPolicy(t){return this.policies.has(t)}}class an{constructor(t,n){this.baseInterval=t,this.onTick=n}timer=null;speed=1;lastTick=0;accumulator=0;start(){this.stop(),this.lastTick=Date.now();const t=this.baseInterval/this.speed;this.timer=setInterval(()=>{const n=Date.now(),o=n-this.lastTick;this.lastTick=n,this.onTick(o)},t)}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null)}setSpeed(t){if(t<=0)throw new Error("Speed multiplier must be positive");this.speed=t,this.timer!==null&&this.start()}getSpeed(){return this.speed}getBaseInterval(){return this.baseInterval}tick(t){for(this.accumulator+=t*this.speed;this.accumulator>=this.baseInterval;)this.accumulator-=this.baseInterval,this.onTick(this.baseInterval)}}var x=(e=>(e[e.Plains=0]="Plains",e[e.Forest=1]="Forest",e[e.Hills=2]="Hills",e[e.Lake=3]="Lake",e))(x||{});function ln(e,t,n){let o=e*374761393+t*668265263+n*0x14057b7ef7678100;return o=(o^o>>13)*1274126177,o^=o>>16,(o>>>0)/4294967295}function ze(e,t,n=0){const o=ln(e,t,n);return o<.1?3:o<.3?1:o<.5?2:0}class Ve{constructor(t=x.Plains,n=null,o=!0){this.terrain=t,this.building=n,this.isFogged=o}reveal(){this.isFogged=!1}placeBuilding(t){this.building=t}setFogged(t){this.isFogged=t}}class cn{constructor(t=10,n=10,o=32,s=0){this.hexSize=o,this.seed=s,this.minQ=0,this.minR=0,this.maxQ=t-1,this.maxR=n-1;for(let r=this.minR;r<=this.maxR;r++)for(let i=this.minQ;i<=this.maxQ;i++)this.tiles.set(this.key(i,r),new Ve(ze(i,r,s)))}tiles=new Map;minQ;maxQ;minR;maxR;get width(){return this.maxQ-this.minQ+1}get height(){return this.maxR-this.minR+1}key(t,n){return`${t},${n}`}ensureTile(t,n){const o=this.key(t,n);let s=this.tiles.get(o);return s||(s=new Ve(ze(t,n,this.seed)),this.tiles.set(o,s),this.minQ=Math.min(this.minQ,t),this.maxQ=Math.max(this.maxQ,t),this.minR=Math.min(this.minR,n),this.maxR=Math.max(this.maxR,n),s.isFogged||Be({q:t,r:n},this.hexSize)),s}getTile(t,n){return this.ensureTile(t,n)}forEachTile(t){for(let n=this.minR;n<=this.maxR;n++)for(let o=this.minQ;o<=this.maxQ;o++){const s=this.ensureTile(o,n);t(s,{q:o,r:n})}}getNeighbors(t,n){return He({q:t,r:n}).map(o=>this.ensureTile(o.q,o.r))}revealAround(t,n){for(let r=-n;r<=n;r++){const i=Math.max(-n,-r-n),a=Math.min(n,-r+n);for(let d=i;d<=a;d++){const l={q:t.q+r,r:t.r+d};this.ensureTile(l.q,l.r).reveal(),Be(l,this.hexSize)}}const o=typeof window<"u"?{width:window.innerWidth,height:window.innerHeight}:{width:0,height:0},s=Jt(o);Zt(s,300)}}const vt=({policy:e,state:t})=>{e==="eco"&&(t.modifyPassiveGeneration(z.GOLD,1),v.off("policyApplied",vt))},Ct=({policy:e,state:t})=>{e==="temperance"&&(t.nightWorkSpeedMultiplier*=1.05,v.off("policyApplied",Ct))};v.on("policyApplied",vt);v.on("policyApplied",Ct);const dn="modulepreload",un=function(e){return"/"+e},Qe={},fn=function(t,n,o){let s=Promise.resolve();if(n&&n.length>0){let d=function(l){return Promise.all(l.map(c=>Promise.resolve(c).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),a=i?.nonce||i?.getAttribute("nonce");s=d(n.map(l=>{if(l=un(l),l in Qe)return;Qe[l]=!0;const c=l.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const f=document.createElement("link");if(f.rel=c?"stylesheet":dn,c||(f.as="script"),f.crossOrigin="",f.href=l,a&&f.setAttribute("nonce",a),document.head.appendChild(f),c)return new Promise((m,p)=>{f.addEventListener("load",m),f.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return s.then(i=>{for(const a of i||[])a.status==="rejected"&&r(a.reason);return t().catch(r)})},hn=({building:e,coord:t,state:n})=>{e instanceof Ye?n.modifyPassiveGeneration(z.GOLD,e.foodPerTick):e instanceof gt&&fn(async()=>{const{spawnUnit:o}=await import("./UnitFactory-Bvsv7arp.js");return{spawnUnit:o}},[]).then(({spawnUnit:o})=>{o(n,"soldier",`barracks-${t.q}-${t.r}`,t,"player")})},pn=({building:e,state:t})=>{e instanceof Ye&&t.modifyPassiveGeneration(z.GOLD,-e.foodPerTick)};v.on("buildingPlaced",hn);v.on("buildingRemoved",pn);function B(e){return`${e.q},${e.r}`}function mn(e){const[t,n]=e.split(",").map(Number);return{q:t,r:n}}function Ke(e,t){const n=-e.q-e.r,o=-t.q-t.r;return Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r),Math.abs(n-o))}class gn{constructor(t,n,o,s,r=[]){this.id=t,this.coord=n,this.faction=o,this.stats=s,this.priorityFactions=r,this.maxHealth=s.health}alive=!0;listeners={};maxHealth;healMarkerElapsed=0;onDeath(t){(this.listeners.death??=[]).push(t)}emitDeath(){for(const t of this.listeners.death??[])t()}isDead(){return!this.alive}getMaxHealth(){return this.maxHealth}distanceTo(t){return Ke(this.coord,t)}attack(t){this.distanceTo(t.coord)<=this.stats.attackRange&&t.takeDamage(this.stats.attackDamage,this)}update(t,n){if(!(this.isDead()||!n))if(Ke(this.coord,n.pos)<=n.auraRadius){const o=this.stats.health;this.stats.health=Math.min(this.stats.health+n.regenPerSec*t,this.maxHealth),this.stats.health>o&&(this.healMarkerElapsed+=t,this.healMarkerElapsed>=1&&(this.healMarkerElapsed=0,this.spawnHealMarker()))}else this.healMarkerElapsed=0}spawnHealMarker(){if(typeof document>"u")return;const t=document.getElementById("game-canvas");if(!t)return;const{x:n,y:o}=_(this.coord,32),s=document.createElement("div");s.textContent="+",s.className="heal-marker",s.style.position="absolute";const r=t.getBoundingClientRect();s.style.left=`${r.left+n}px`,s.style.top=`${r.top+o}px`,s.style.pointerEvents="none",document.body.appendChild(s),setTimeout(()=>s.remove(),1e3)}takeDamage(t,n){this.stats.health-=t,v.emit("unitDamaged",{attackerId:n?.id,targetId:this.id,amount:t,remainingHealth:this.stats.health}),this.stats.health<=0&&this.alive&&(this.stats.health=0,this.alive=!1,v.emit("unitDied",{unitId:this.id,attackerId:n?.id}),this.emitDeath())}moveTowards(t,n,o){const s=this.findPath(t,n,o);if(s.length<2)return[];let r=0;for(let a=1;a<s.length;a++){const d=B(s[a]);if(o.has(d))break;r=a}if(r===0)return[];const i=Math.min(this.stats.movementRange,r);return s.slice(0,i+1)}findPath(t,n,o){const s=this.coord,r=B(s),i=B(t),a=[s],d=new Map;for(d.set(r,null);a.length>0;){const u=a.shift(),f=B(u);if(f===i)break;for(const m of He(u)){const p=B(m);p!==i&&!this.isPassable(m,n,o)||d.has(p)||(a.push(m),d.set(p,f))}}if(!d.has(i))return[s];const l=[];let c=i;for(;c;)l.push(mn(c)),c=d.get(c)??null;return l.reverse()}seekNearestEnemy(t,n,o){const s=new Map;for(const a of t)s.set(B(a.coord),a);const r=[this.coord],i=new Set([B(this.coord)]);for(;r.length>0;){const a=r.shift(),d=B(a),l=s.get(d);if(l)return l;for(const c of He(a)){const u=B(c),f=s.get(u);if(f)return f;this.isPassable(c,n,o)&&(i.has(u)||(i.add(u),r.push(c)))}}return null}isPassable(t,n,o){const s=n.getTile(t.q,t.r);return!s||o&&o.has(B(t))?!1:s.terrain!==x.Lake}}const bn={health:12,attackDamage:4,attackRange:1,movementRange:2};class yn extends gn{constructor(t,n,o){super(t,n,o,{...bn})}}let q=null;const ue={};function St(){if(q||typeof window>"u")return q;const e=window.AudioContext||window.webkitAudioContext;if(!e)return console.warn("Web Audio API not supported"),null;try{q=new e}catch(t){return console.warn("Unable to create AudioContext",t),null}if(ue.click=wn(),ue.spawn=vn(),ue.error=Cn(),ue.sisu=Sn(),q.state==="suspended"){const t=()=>{q?.resume()};window.addEventListener("pointerdown",t,{once:!0})}return q}function ke(e,t){const n=q,o=n.createBuffer(1,e,n.sampleRate),s=o.getChannelData(0);for(let r=0;r<e;r++){const i=r/n.sampleRate;s[r]=t(i)}return o}function wn(){return ke(Math.floor(q.sampleRate*.05),t=>Math.sin(2*Math.PI*1e3*t)*Math.exp(-40*t))}function vn(){return ke(Math.floor(q.sampleRate*.2),t=>(Math.sin(2*Math.PI*440*t)+Math.sin(2*Math.PI*660*t))*.5*Math.exp(-6*t))}function Cn(){return ke(Math.floor(q.sampleRate*.3),t=>Math.sin(2*Math.PI*110*t)*Math.exp(-8*t))}function Sn(){return ke(Math.floor(q.sampleRate*.5),t=>Math.sin(2*Math.PI*880*t)*Math.exp(-2*t))}let Ee=!1;typeof localStorage<"u"&&(Ee=localStorage.getItem("sfx-muted")==="true");function Je(){return Ee}function Mn(e){Ee=e,typeof localStorage<"u"&&localStorage.setItem("sfx-muted",e?"true":"false")}function Mt(e){if(Ee)return;const t=St();if(!t)return;const n=ue[e];if(!n)return;t.state==="suspended"&&t.resume();const o=t.createBufferSource();o.buffer=n,o.connect(t.destination),o.start()}typeof document<"u"&&document.addEventListener("click",e=>{e.target instanceof HTMLButtonElement&&Mt("click")});St();const kn={q:0,r:0},En="Saunoja",Ze=18,et=0;function tt(e,t,n){return Math.min(Math.max(e,t),n)}function kt(e){const{id:t,name:n=En,coord:o=kn,maxHp:s=Ze,hp:r=s,steam:i=0,lastHitAt:a=et,selected:d=!1}=e,l=Number.isFinite(s)?Math.max(1,s):Ze,c=Number.isFinite(r)?r:l,u=tt(c,0,l),f=Number.isFinite(i)?i:0,m=tt(f,0,1),p=Number.isFinite(a)?a:et,h=Math.max(0,p);return{id:t,name:n,coord:{q:o.q,r:o.r},maxHp:l,hp:u,steam:m,lastHitAt:h,selected:d}}const se=32;function fe(e,t,n,o){e.beginPath();for(let s=0;s<6;s++){const r=Math.PI/3*s,i=t+o*Math.cos(r),a=n+o*Math.sin(r);s===0?e.moveTo(i,a):e.lineTo(i,a)}e.closePath()}function Xe(e,t,n){return Math.min(Math.max(e,t),n)}function Pn(e,{centerX:t,centerY:n,hp:o,maxHp:s,radius:r=se*.55}){const i=Number.isFinite(s)?Math.max(1,s):1,a=Number.isFinite(o)?o:i,d=Xe(a/i,0,1);if(e.save(),fe(e,t,n,r),e.fillStyle="rgba(7, 11, 18, 0.72)",e.fill(),e.restore(),d>0){e.save(),fe(e,t,n,r),e.clip();const l=e.createLinearGradient(t,n+r,t,n-r);l.addColorStop(0,"rgba(46, 160, 98, 0.35)"),l.addColorStop(1,"rgba(218, 255, 239, 0.95)"),e.fillStyle=l;const c=r*2*d,u=n+r-c;e.fillRect(t-r,u,r*2,c),e.restore()}e.save(),fe(e,t,n,r),e.lineWidth=Math.max(1,r*.12),e.strokeStyle="rgba(255, 255, 255, 0.28)",e.stroke(),e.restore()}function An(e,{centerX:t,centerY:n,radius:o=se,progress:s=0}){const r=Xe(s,0,1);if(r<=0)return;const i=Number.isFinite(o)&&o>0?o:se;e.save(),e.globalCompositeOperation="lighter",e.globalAlpha=r;const a=e.createRadialGradient(t,n,Math.max(1,i*.1),t,n,i);a.addColorStop(0,"rgba(255, 255, 255, 0.92)"),a.addColorStop(.45,"rgba(255, 255, 255, 0.68)"),a.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=a,e.beginPath(),e.arc(t,n,i,0,Math.PI*2),e.fill(),e.restore()}function Tn(e,{centerX:t,centerY:n,radius:o=se*.85,intensity:s=1}){const r=Xe(s,0,1);if(r<=0)return;e.save(),fe(e,t,n,o),e.clip();const i=e.createLinearGradient(t,n+o,t,n-o);i.addColorStop(0,"rgba(255, 255, 255, 0)"),i.addColorStop(.55,`rgba(255, 255, 255, ${.12*r})`),i.addColorStop(1,`rgba(255, 255, 255, ${.35*r})`),e.globalCompositeOperation="lighter",e.fillStyle=i,e.fillRect(t-o,n-o,o*2,o*2),e.restore(),e.save(),e.globalCompositeOperation="lighter",e.lineCap="round",e.strokeStyle=`rgba(255, 255, 255, ${.25*r})`,e.lineWidth=Math.max(1,o*.08);const a=o*.75,d=o*.35;for(let l=0;l<3;l++){const c=n-o*.5+l*d;e.beginPath(),e.moveTo(t-a,c),e.bezierCurveTo(t-a*.4,c-o*.4,t+a*.4,c+o*.2,t+a,c-o*.45),e.stroke()}e.restore()}function In(e){return{id:"sauna",pos:e,spawnCooldown:30,timer:30,auraRadius:2,regenPerSec:1,rallyToFront:!1,update(t,n,o){if(this.timer-=t,this.timer>0)return;const s=[];for(let r=-2;r<=2;r++){const i=Math.max(-2,-r-2),a=Math.min(2,-r+2);for(let d=i;d<=a;d++){const l=Math.max(Math.abs(r),Math.abs(d),Math.abs(-r-d));if(l===0||l>2)continue;const c={q:this.pos.q+r,r:this.pos.r+d};n.some(f=>!f.isDead()&&f.coord.q===c.q&&f.coord.r===c.r)||s.push(c)}}if(s.length>0){const r=s[Math.floor(Math.random()*s.length)],i=`raider${n.length+1}`,a=new yn(i,r,"player");o(a)}this.timer=this.spawnCooldown}}}function We(e){let t=e.querySelector(".hud-top-row");t||(t=document.createElement("div"),t.className="hud-top-row",e.prepend(t));let n=t.querySelector(".hud-actions");n||(n=document.createElement("div"),n.className="hud-actions",t.appendChild(n));let o=t.querySelector(".hud-right-column");if(!o){o=document.createElement("div"),o.className="hud-right-column",t.appendChild(o);const r=e.querySelector("#resource-bar");r&&o.prepend(r)}const s=e.querySelector("#build-menu");return s&&s.parentElement!==n&&n.appendChild(s),{container:t,actions:n,side:o}}function Ln(e){const t=document.getElementById("ui-overlay");if(!t)return()=>{};const n=document.createElement("div");n.classList.add("sauna-control");const o=document.createElement("button");o.type="button",o.textContent="Sauna ♨️",o.classList.add("topbar-button","sauna-toggle"),o.setAttribute("aria-expanded","false"),n.appendChild(o);const s=document.createElement("div");s.classList.add("sauna-card","hud-card"),s.hidden=!0;const r=document.createElement("div");r.classList.add("sauna-progress");const i=document.createElement("div");i.classList.add("sauna-progress__fill"),r.appendChild(i),s.appendChild(r);const a=document.createElement("label");a.classList.add("sauna-option");const d=document.createElement("input");d.type="checkbox",d.classList.add("sauna-option__input"),d.checked=e.rallyToFront,d.addEventListener("change",()=>{e.rallyToFront=d.checked}),a.appendChild(d);const l=document.createElement("span");l.textContent="Rally to Front",l.classList.add("sauna-option__label"),a.appendChild(l),s.appendChild(a),n.appendChild(s);const{actions:c}=We(t),u=()=>{n.parentElement!==c&&c.appendChild(n);const f=c.querySelector("#topbar");return f&&f.parentElement===c?(f.nextSibling!==n&&c.insertBefore(n,f.nextSibling),!0):!1};if(!u()){const f=new MutationObserver(()=>{u()&&f.disconnect()});f.observe(c,{childList:!0})}return o.addEventListener("click",()=>{const f=!s.hidden;s.hidden=f,o.setAttribute("aria-expanded",String(!f))}),()=>{const f=1-e.timer/e.spawnCooldown;i.style.width=`${Math.max(0,Math.min(f,1))*100}%`,d.checked=e.rallyToFront}}function me(e,t){const n=document.createElement("div");if(n.classList.add("topbar-badge"),t){const a=document.createElement("img");a.src=t,a.alt=e,a.decoding="async",a.classList.add("topbar-badge-icon"),n.appendChild(a)}const o=document.createElement("div");o.classList.add("badge-text");const s=document.createElement("span");s.textContent=e,s.classList.add("badge-label"),o.appendChild(s);const r=document.createElement("span");r.textContent="0",r.classList.add("badge-value"),o.appendChild(r);const i=document.createElement("span");return i.classList.add("badge-delta"),i.style.opacity="0",i.style.transform="translateY(-6px)",i.style.transition="opacity 0.5s ease, transform 0.5s ease",n.append(o,i),{container:n,value:r,delta:i}}function Rn(e,t={}){const n=document.getElementById("ui-overlay");if(!n)return()=>{};const{actions:o}=We(n),s=document.createElement("div");s.id="topbar",o.prepend(s);const r=me("Saunakunnia",t.saunakunnia);r.container.classList.add("badge-sauna");const i=me("SISU🔥",t.sisu);i.container.classList.add("badge-sisu"),i.container.style.display="none";const a=me("Gold",t.gold);a.container.classList.add("badge-gold");const d=me("Time");d.container.classList.add("badge-time"),d.delta.style.display="none",s.appendChild(r.container),s.appendChild(i.container),s.appendChild(a.container),s.appendChild(d.container);const l=document.createElement("button");l.type="button",l.textContent="SISU",l.classList.add("topbar-button","sisu-button"),l.addEventListener("click",()=>{v.emit("sisuPulse",{})}),s.appendChild(l);const c=document.createElement("button");c.type="button",c.title="Toggle sound",c.classList.add("topbar-button","sound-button");const u=document.createElement("span");if(u.textContent="Sound",t.sound){const h=document.createElement("img");h.src=t.sound,h.alt="",h.decoding="async",h.setAttribute("aria-hidden","true"),c.appendChild(h)}c.appendChild(u);function f(){const h=Je();u.textContent=h?"Muted":"Sound",c.setAttribute("aria-pressed",h?"true":"false"),c.classList.toggle("is-muted",h)}c.addEventListener("click",()=>{Mn(!Je()),f()}),f(),s.appendChild(c),v.on("sisuPulseStart",({remaining:h})=>{l.disabled=!0,i.container.style.display="block",i.value.textContent=String(h)}),v.on("sisuPulseTick",({remaining:h})=>{i.value.textContent=String(h)}),v.on("sisuPulseEnd",()=>{i.container.style.display="none"}),v.on("sisuCooldownEnd",()=>{l.disabled=!1}),a.value.textContent=String(e.getResource(z.GOLD));const m={saunakunnia:r,sisu:i,gold:a};v.on("resourceChanged",({resource:h,amount:w,total:y})=>{const C=m[h];if(!C)return;C.value.textContent=String(y);const T=w>0?"+":"";C.delta.textContent=`${T}${w}`,C.delta.style.opacity="1",C.delta.style.transform="translateY(0)",setTimeout(()=>{C.delta.style.opacity="0",C.delta.style.transform="translateY(-6px)"},1e3)});let p=0;return h=>{p+=h;const w=Math.floor(p/1e3),y=Math.floor(w/60),C=w%60;d.value.textContent=`${y}:${C.toString().padStart(2,"0")}`}}let we=!1,Le=!1;function xn(){return we}function qn(e,t){if(we||Le)return;we=!0,Le=!0;let n=10;v.emit("sisuPulseStart",{remaining:n});const o=[];for(const r of t)r.faction!=="player"||r.isDead()||(o.push({unit:r,move:r.stats.movementRange,attack:r.stats.attackDamage}),r.stats.movementRange*=1.2,r.stats.attackDamage*=1.2,r.fearless=!0);const s=setInterval(()=>{if(n-=1,n>0){v.emit("sisuPulseTick",{remaining:n});return}clearInterval(s),we=!1;for(const r of o)r.unit.stats.movementRange=r.move,r.unit.stats.attackDamage=r.attack,delete r.unit.fearless;v.emit("sisuPulseEnd",{}),setTimeout(()=>{Le=!1,v.emit("sisuCooldownEnd",{})},12e4)},1e3)}function Dn(e){const t=document.getElementById("ui-overlay");if(!t)return{log:()=>{},addEvent:()=>{}};const{side:n}=We(t),o=t.querySelector("#right-panel");o&&o.remove();const s=document.createElement("div");s.id="right-panel",s.classList.add("hud-card"),s.setAttribute("role","complementary"),s.setAttribute("aria-label","Policies and events");const r=document.createElement("div");r.classList.add("panel-tabs"),s.appendChild(r);const i=document.createElement("div");i.classList.add("panel-content"),s.appendChild(i);const a=document.createElement("div");a.id="right-panel-policies";const d=document.createElement("div");d.id="right-panel-events";const l=document.createElement("div");l.id="event-log",l.setAttribute("role","log"),l.setAttribute("aria-live","polite");const c={Policies:a,Events:d,Log:l};for(const[b,g]of Object.entries(c))g.classList.add("panel-section","panel-section--scroll"),g.dataset.tab=b,g.hidden=!0;l.classList.add("panel-section--log");function u(b){for(const[g,A]of Object.entries(c))A.hidden=g!==b;for(const g of Array.from(r.children)){const A=g,O=A.textContent===b;A.disabled=O,A.setAttribute("aria-pressed",O?"true":"false")}}for(const b of Object.keys(c)){const g=document.createElement("button");g.type="button",g.textContent=b;const A=c[b];A?.id&&g.setAttribute("aria-controls",A.id),g.setAttribute("aria-pressed","false"),g.addEventListener("click",()=>u(b)),r.appendChild(g),i.appendChild(c[b])}n.appendChild(s);const f=[{id:"eco",name:"Eco Policy",description:"Increase gold income by 1",cost:15,prerequisite:()=>!0},{id:"temperance",name:"Temperance",description:"+5% work speed at night",cost:25,prerequisite:()=>!0}],m={};function p(){a.innerHTML="";for(const b of f){const g=document.createElement("button");g.textContent=`${b.name} (${b.cost}g)`,g.title=b.description,g.classList.add("panel-action"),g.disabled=!b.prerequisite(e)||e.hasPolicy(b.id),g.addEventListener("click",()=>{e.applyPolicy(b.id,b.cost)&&h()}),a.appendChild(g),m[b.id]=g}}function h(){for(const b of f){const g=m[b.id];g&&(g.disabled=!b.prerequisite(e)||e.hasPolicy(b.id))}}p(),v.on("resourceChanged",h),v.on("policyApplied",h);const w=[];function y(){d.innerHTML="";for(const b of w){const g=document.createElement("div");g.classList.add("panel-event");const A=document.createElement("h4");A.textContent=b.headline;const O=document.createElement("p");O.textContent=b.body;const N=document.createElement("button");N.textContent=b.buttonText??"Acknowledge",N.classList.add("panel-action"),N.addEventListener("click",()=>{const J=w.findIndex(re=>re.id===b.id);J!==-1&&(w.splice(J,1),y())}),g.appendChild(A),g.appendChild(O),g.appendChild(N),d.appendChild(g)}}function C(b){w.push(b),y()}const T=100,P=[];let E=!1;function I(){for(const b of P){const g=document.createElement("div");g.textContent=b,g.classList.add("panel-log-entry"),l.appendChild(g)}for(;l.childElementCount>T;)l.removeChild(l.firstChild);l.scrollTop=l.scrollHeight,P.length=0,E=!1}function R(b){P.push(b),E||(E=!0,(typeof requestAnimationFrame=="function"?requestAnimationFrame:g=>setTimeout(g,16))(I))}return u("Policies"),{log:R,addEvent:C}}const Hn=Math.sqrt(3),Bn=2;function Et(e){return{width:e*Hn,height:e*Bn}}function Pt(e){return Math.min(1,Math.max(0,e))}function Pe(e){let t=e.trim();if(t.startsWith("#")&&(t=t.slice(1)),t.length===3){const n=Number.parseInt(t[0]+t[0],16),o=Number.parseInt(t[1]+t[1],16),s=Number.parseInt(t[2]+t[2],16);return[n,o,s]}if(t.length===6){const n=Number.parseInt(t,16),o=n>>16&255,s=n>>8&255,r=n&255;return[o,s,r]}return[0,0,0]}function $n(e,t,n){const o=Pt(n),s=(r,i)=>Math.round(r+(i-r)*o);return[s(e[0],t[0]),s(e[1],t[1]),s(e[2],t[2])]}function On([e,t,n],o){return`rgba(${e}, ${t}, ${n}, ${Pt(o)})`}function j(e,t,n,o){return On($n(e,t,n),o)}function Gn(e){const{ctx:t,x:n,y:o,width:s,height:r,radius:i,baseColor:a}=e,d=Pe(a);t.save(),t.lineCap="round",t.lineJoin="round";const l=j(d,[255,255,255],.35,.24);t.strokeStyle=l,t.lineWidth=Math.max(1,i*.06);const c=3,u=6,f=n+s*.12,m=n+s*.88;for(let y=0;y<c;y++){const C=y/Math.max(1,c-1),T=o+r*.28+C*r*.32,P=i*(.18-C*.05);t.beginPath();for(let E=0;E<=u;E++){const I=E/u,R=f+(m-f)*I,b=Math.sin(I*Math.PI*1.6+y*.8)*P,g=T-Math.abs(b)*.55;E===0?t.moveTo(R,g):t.lineTo(R,g)}t.stroke()}const p=j(d,[18,54,32],.4,.2);t.strokeStyle=p,t.lineWidth=Math.max(.75,i*.035);const h=5,w=i*.22;for(let y=0;y<h;y++){const C=n+s*(.2+y/Math.max(1,h-1)*.6),T=o+r*.55-Math.cos(y*.9)*i*.08;t.beginPath(),t.arc(C,T,w,Math.PI*.2,Math.PI*.85),t.stroke(),t.beginPath(),t.arc(C+w*.35,T-w*.1,w*.55,Math.PI*.15,Math.PI*.95),t.stroke()}t.restore()}function _n(e){const{ctx:t,centerX:n,centerY:o,radius:s,baseColor:r}=e,i=Pe(r);t.save(),t.lineCap="round";const a=j(i,[255,235,214],.45,.22);t.strokeStyle=a,t.lineWidth=Math.max(1,s*.05);const d=4;for(let u=0;u<d;u++){const f=u/Math.max(1,d-1),m=s*(1.25-f*.45),p=s*(.72-f*.18),h=o+s*.18*(f-.5);t.beginPath(),t.ellipse(n,h,m,p,0,Math.PI*.12,Math.PI*.88),t.stroke()}const l=j(i,[60,36,20],.35,.18);t.strokeStyle=l,t.lineWidth=Math.max(.85,s*.032),t.setLineDash([s*.22,s*.18]);const c=3;for(let u=0;u<c;u++){const f=s*(.75-u*.1),m=o+s*.28+u*s*.08;t.beginPath(),t.arc(n+s*.08,m,f,Math.PI*.28,Math.PI*.76),t.stroke()}t.setLineDash([]),t.restore()}function Fn(e){const{ctx:t,x:n,y:o,width:s,height:r,radius:i,baseColor:a}=e,d=Pe(a);t.save(),t.lineCap="round",t.lineJoin="round";const l=j(d,[255,255,255],.55,.28);t.strokeStyle=l,t.lineWidth=Math.max(1,i*.045);const c=4,u=7,f=n+s*.12,m=n+s*.88,p=i*.16;for(let y=0;y<c;y++){const C=y/Math.max(1,c-1),T=o+r*.3+C*r*.4;t.beginPath();for(let P=0;P<=u;P++){const E=P/u,I=f+(m-f)*E,R=Math.sin(E*Math.PI*2+y*.6)*p*(.75-C*.2),b=T+R;P===0?t.moveTo(I,b):t.lineTo(I,b)}t.stroke()}const h=j(d,[12,52,94],.4,.2);t.strokeStyle=h,t.lineWidth=Math.max(.8,i*.03);const w=3;for(let y=0;y<w;y++){const C=y/Math.max(1,w-1),T=o+r*.35+C*r*.35;t.beginPath();for(let P=0;P<=u;P++){const E=P/u,I=f+(m-f)*E,R=Math.sin(E*Math.PI*2+y)*p*.35,b=T+R;P===0?t.moveTo(I,b):t.lineTo(I,b)}t.stroke()}t.restore()}function At(e){const{ctx:t,x:n,y:o,width:s,height:r,radius:i,baseColor:a}=e,d=Pe(a);t.save(),t.lineCap="round";const l=j(d,[255,255,255],.42,.18);t.strokeStyle=l,t.lineWidth=Math.max(.85,i*.03);const c=i*.55;for(let m=-1;m<=2;m++){const p=c*m;t.beginPath(),t.moveTo(n+p,o+r*.25),t.lineTo(n+p+s*.75,o+r*.85),t.stroke()}const u=j(d,[112,82,32],.3,.16);t.strokeStyle=u,t.lineWidth=Math.max(.7,i*.025),t.setLineDash([i*.24,i*.34]);const f=i*.48;for(let m=0;m<3;m++){const p=f*m;t.beginPath(),t.moveTo(n+s*.18+p,o+r*.78),t.lineTo(n+s*.7+p,o+r*.38),t.stroke()}t.setLineDash([]),t.restore()}const Nn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3ePlains%20Tile%3c/title%3e%3cdesc%20id='desc'%3eRolling%20plains%20with%20sunrise%20gradients%20and%20glowing%20grasses.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='plains-bg'%20cx='50%25'%20cy='50%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23111827'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='plains-field'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='0%25'%3e%3cstop%20offset='0%25'%20stop-color='%23facc15'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23eab308'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='plains-haze'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23fde68a'%20stop-opacity='0.8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23f59e0b'%20stop-opacity='0.2'%20/%3e%3c/linearGradient%3e%3cfilter%20id='plains-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='5'%20stdDeviation='6'%20flood-color='%23facc15'%20flood-opacity='0.35'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23plains-bg)'%20/%3e%3cg%20filter='url(%23plains-glow)'%3e%3cpath%20d='M16%2088c20-18%2036-22%2048-22s28%204%2048%2022'%20fill='url(%23plains-field)'%20stroke='%23fef9c3'%20stroke-width='2'%20stroke-linecap='round'%20/%3e%3cpath%20d='M24%20102c16-14%2032-18%2040-18s24%204%2040%2018'%20fill='none'%20stroke='%23fde68a'%20stroke-width='5'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M32%2070c12-10%2024-14%2032-14s20%204%2032%2014'%20fill='url(%23plains-haze)'%20opacity='0.7'%20/%3e%3cpath%20d='M52%2078l4%2012m8-12l4%2012m8-12l4%2012'%20stroke='%23fef3c7'%20stroke-width='3'%20stroke-linecap='round'%20opacity='0.8'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='36'%20r='8'%20fill='%23fef08a'%20opacity='0.7'%20/%3e%3c/svg%3e",Yn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eForest%20Tile%3c/title%3e%3cdesc%20id='desc'%3eStylised%20evergreen%20trees%20glowing%20against%20a%20deep%20night%20backdrop.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='forest-bg'%20cx='50%25'%20cy='40%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230b1120'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='forest-leaf'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%234ade80'%20/%3e%3cstop%20offset='100%25'%20stop-color='%2315803d'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='forest-trunk'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23a855f7'%20/%3e%3cstop%20offset='100%25'%20stop-color='%237c3aed'%20/%3e%3c/linearGradient%3e%3cfilter%20id='forest-glow'%20x='-40%25'%20y='-40%25'%20width='180%25'%20height='180%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%234ade80'%20flood-opacity='0.25'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23forest-bg)'%20/%3e%3cg%20filter='url(%23forest-glow)'%20stroke='%23bbf7d0'%20stroke-width='2'%3e%3cpath%20fill='url(%23forest-leaf)'%20d='M64%2026L32%2080h18l-12%2022h28l-10-22h16l-10%2022h28l-12-22h18z'%20/%3e%3crect%20x='58'%20y='74'%20width='12'%20height='18'%20rx='3'%20fill='url(%23forest-trunk)'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20stroke-opacity='0.5'%20d='M44%2086c6-4%2012-6%2020-6s14%202%2020%206'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='40'%20r='6'%20fill='%23fef3c7'%20opacity='0.6'%20/%3e%3ccircle%20cx='88'%20cy='32'%20r='4'%20fill='%23fef3c7'%20opacity='0.4'%20/%3e%3c/svg%3e",Xn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eMountain%20Tile%3c/title%3e%3cdesc%20id='desc'%3eJagged%20alpine%20peaks%20with%20luminous%20snowcaps.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='mountain-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%23111827'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='mountain-rock'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2364748b'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23334155'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='mountain-snow'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23f8fafc'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23cbd5f5'%20/%3e%3c/linearGradient%3e%3cfilter%20id='mountain-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%23f8fafc'%20flood-opacity='0.2'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23mountain-bg)'%20/%3e%3cg%20filter='url(%23mountain-glow)'%20stroke='%23cbd5f5'%20stroke-width='2'%20stroke-linejoin='round'%3e%3cpath%20fill='url(%23mountain-rock)'%20d='M24%20100l32-52%2014%2022%2012-18%2022%2048z'%20/%3e%3cpath%20fill='url(%23mountain-snow)'%20d='M56%2048l14%2022%2012-18%2010%2022H48z'%20opacity='0.85'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20opacity='0.6'%20d='M32%2094c10-6%2020-9%2032-9s22%203%2032%209'%20/%3e%3c/g%3e%3ccircle%20cx='92'%20cy='32'%20r='6'%20fill='%23f1f5f9'%20opacity='0.5'%20/%3e%3c/svg%3e",Wn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eWater%20Tile%3c/title%3e%3cdesc%20id='desc'%3eGlowing%20waves%20surrounding%20a%20crystalline%20droplet.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='water-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230b1120'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='water-wave'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2338bdf8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230ea5e9'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='water-drop'%20x1='50%25'%20y1='0%25'%20x2='50%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23e0f2fe'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230284c7'%20/%3e%3c/linearGradient%3e%3cfilter%20id='water-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='4'%20stdDeviation='8'%20flood-color='%2338bdf8'%20flood-opacity='0.3'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23water-bg)'%20/%3e%3cg%20filter='url(%23water-glow)'%3e%3cpath%20d='M32%2076c12-10%2024-15%2032-15s20%205%2032%2015'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='8'%20stroke-linecap='round'%20/%3e%3cpath%20d='M28%2092c14-12%2030-18%2040-18s26%206%2040%2018'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='6'%20stroke-linecap='round'%20opacity='0.7'%20/%3e%3cpath%20d='M40%2060c10-8%2018-12%2024-12s14%204%2024%2012'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='4'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M64%2030c-12%2020-18%2032-18%2042%200%2011%208%2020%2018%2020s18-9%2018-20c0-10-6-22-18-42z'%20fill='url(%23water-drop)'%20stroke='%23e0f2fe'%20stroke-width='2'%20/%3e%3c/g%3e%3ccircle%20cx='94'%20cy='34'%20r='6'%20fill='%23f8fafc'%20opacity='0.45'%20/%3e%3c/svg%3e",nt={[x.Plains]:{baseColor:"#d8b869",icon:Nn},[x.Forest]:{baseColor:"#237a55",icon:Yn},[x.Hills]:{baseColor:"#b57c57",icon:Xn},[x.Lake]:{baseColor:"#3185d5",icon:Wn}},ot=new Map;let V=null;function Un(){if(V)return V;const e="/";if(/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(e))return V=e,V;const n=e.startsWith("/")?e:`/${e}`;return typeof window<"u"&&typeof window.location?.origin=="string"?V=`${window.location.origin}${n}`:V=`http://localhost${n}`,V}function jn(e){let t=ot.get(e);if(!t){t=new Image,t.decoding="async";const n=new URL(e,Un()).href;t.src=n,ot.set(e,t)}if(t.complete&&t.naturalWidth>0&&t.naturalHeight>0)return t}const st="rgba(56, 189, 248, 0.85)",rt="rgba(56, 189, 248, 0.45)";let le=null,ce=null;const zn={[x.Plains]:At,[x.Forest]:Gn,[x.Hills]:_n,[x.Lake]:Fn};function Vn(){if(le&&ce)return{stroke:le,glow:ce};if(typeof window<"u"){const e=getComputedStyle(document.documentElement),t=e.getPropertyValue("--tile-highlight-ring").trim(),n=e.getPropertyValue("--tile-highlight-glow").trim();le=t||st,ce=n||rt}else le=st,ce=rt;return{stroke:le,glow:ce}}function Qn(e){const t=e.replace("#",""),n=Number.parseInt(t,16),o=n>>16&255,s=n>>8&255,r=n&255;return[o,s,r]}function it([e,t,n],[o,s,r],i){const a=Math.min(1,Math.max(0,i)),d=(l,c)=>Math.round(l+(c-l)*a);return`rgb(${d(e,o)}, ${d(t,s)}, ${d(n,r)})`}function at([e,t,n],o){return`rgba(${e}, ${t}, ${n}, ${o})`}class Kn{constructor(t){this.mapRef=t}get hexSize(){return this.mapRef.hexSize}getOrigin(){return _({q:this.mapRef.minQ,r:this.mapRef.minR},this.hexSize)}draw(t,n,o){const{width:s,height:r}=Et(this.hexSize),i=this.getOrigin();for(const[a,d]of this.mapRef.tiles){const[l,c]=a.split(",").map(Number),{x:u,y:f}=_({q:l,r:c},this.hexSize),m=u-i.x,p=f-i.y;if(t.save(),d.isFogged&&(t.globalAlpha=.4),this.drawTerrain(t,d.terrain,m,p,s,r),d.building){const w=n[`building-${d.building}`]??n.placeholder;t.drawImage(w,m,p,s,r)}const h=o&&l===o.q&&c===o.r;this.strokeHex(t,m+this.hexSize,p+this.hexSize,this.hexSize,!!h),t.restore()}}drawToCanvas(t,n,o){const s=t.getContext("2d");if(!s)throw new Error("Canvas 2D context not available");this.draw(s,n,o)}drawTerrain(t,n,o,s,r,i){const a=nt[n]??nt[x.Plains],d=Qn(a.baseColor),l=this.hexSize,c=o+l,u=s+l;t.save(),this.hexPath(t,o+this.hexSize,s+this.hexSize,l),t.clip();const f=t.createRadialGradient(c,u,l*.2,c,u,l*1.05);f.addColorStop(0,it(d,[255,255,255],.3)),f.addColorStop(.7,a.baseColor),f.addColorStop(1,it(d,[12,18,28],.4)),t.fillStyle=f,t.shadowColor=at(d,.35),t.shadowBlur=l*.9,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillRect(o-l*.1,s-l*.1,r+l*.2,i+l*.2);const m={ctx:t,x:o,y:s,width:r,height:i,radius:l,centerX:c,centerY:u,baseColor:a.baseColor};(zn[n]??At)(m),t.globalCompositeOperation="lighter";const h=t.createRadialGradient(c,u,l*.85,c,u,l*1.18);h.addColorStop(0,"rgba(255, 255, 255, 0)"),h.addColorStop(1,at(d,.18)),t.fillStyle=h,t.fillRect(o-l*.1,s-l*.1,r+l*.2,i+l*.2),t.globalCompositeOperation="source-over",t.restore();const w=jn(a.icon);if(w){const y=Math.min(r,i)*.62,C=c-y/2,T=u-y/2;t.save(),t.globalAlpha*=.92,t.drawImage(w,C,T,y,y),t.restore()}}strokeHex(t,n,o,s,r=!1){const{stroke:i,glow:a}=Vn();this.hexPath(t,n,o,s),t.save(),t.lineJoin="round",t.lineCap="round",r?(t.shadowColor=a,t.shadowBlur=s*.65,t.lineWidth=Math.max(2,s*.08),t.strokeStyle=i,t.stroke()):(t.lineWidth=Math.max(1,s*.05),t.strokeStyle="rgba(12, 18, 28, 0.55)",t.stroke()),t.restore()}hexPath(t,n,o,s){t.beginPath();for(let r=0;r<6;r++){const i=Math.PI/180*(60*r-30),a=n+s*Math.cos(i),d=o+s*Math.sin(i);r===0?t.moveTo(a,d):t.lineTo(a,d)}t.closePath()}}const Y={accent:"#38bdf8",accentSoft:"rgba(56, 189, 248, 0.2)",warm:"#fbbf24",surface:"rgba(15, 23, 42, 0.92)",border:"rgba(148, 163, 184, 0.34)",text:"#e2e8f0"};let X=null;function ee(e,t){const n=e.trim();return n.length>0?n:t}function Jn(){if(X)return X;if(typeof window>"u"||typeof document>"u")return X=Y,X;try{const e=getComputedStyle(document.documentElement);return X={accent:ee(e.getPropertyValue("--color-accent"),Y.accent),accentSoft:ee(e.getPropertyValue("--color-accent-soft"),Y.accentSoft),warm:ee(e.getPropertyValue("--color-warning"),Y.warm),surface:ee(e.getPropertyValue("--color-surface-strong"),Y.surface),border:ee(e.getPropertyValue("--hud-border-strong"),Y.border),text:ee(e.getPropertyValue("--color-foreground"),Y.text)},X}catch(e){return console.warn("Failed to read sauna palette tokens from computed styles",e),X=Y,X}}function Zn(e,t){const n=Math.max(0,e.auraRadius),o=_(e.pos,t),s=o.x+t,r=o.y+t;let i=t;if(n<=0)return t*1.6;for(const a of yt){const d=_({q:e.pos.q+a.q*n,r:e.pos.r+a.r*n},t),l=d.x+t,c=d.y+t,u=Math.hypot(l-s,c-r);u>i&&(i=u)}return i+t*.65}function eo(e,t,n,o,s,r){const i=Math.max(0,Math.min(r,Math.min(o,s)/2));e.moveTo(t+i,n),e.lineTo(t+o-i,n),e.quadraticCurveTo(t+o,n,t+o,n+i),e.lineTo(t+o,n+s-i),e.quadraticCurveTo(t+o,n+s,t+o-i,n+s),e.lineTo(t+i,n+s),e.quadraticCurveTo(t,n+s,t,n+s-i),e.lineTo(t,n+i),e.quadraticCurveTo(t,n,t+i,n),e.closePath()}function to(e,t,{origin:n,hexSize:o,timestamp:s}){if(!t)return;const r=Jn(),i=Number.isFinite(s)?s:typeof performance<"u"?performance.now():Date.now(),a=.5+.5*Math.sin(i*.0035),d=_(t.pos,o),l=d.x-n.x+o,c=d.y-n.y+o,u=Zn(t,o);e.save(),e.globalCompositeOperation="screen";const f=u+o*(.4+a*.3),m=Math.max(o*.6,u*.58),p=e.createRadialGradient(l,c,m,l,c,f);p.addColorStop(0,r.accentSoft),p.addColorStop(.55,`rgba(56, 189, 248, ${.18+a*.12})`),p.addColorStop(1,"rgba(2, 6, 23, 0)"),e.fillStyle=p,e.beginPath(),e.arc(l,c,f,0,Math.PI*2),e.fill(),e.restore(),e.save(),e.globalCompositeOperation="lighter",e.lineWidth=Math.max(o*.28,6),e.strokeStyle=`rgba(56, 189, 248, ${(.35+a*.2).toFixed(3)})`,e.shadowColor=`rgba(56, 189, 248, ${.45+a*.1})`,e.shadowBlur=o*(.9+a*.45),e.beginPath(),e.arc(l,c,u+o*.12,0,Math.PI*2),e.stroke(),e.restore();const h=o*.9;e.save(),e.beginPath(),e.arc(l,c,h,0,Math.PI*2),e.fillStyle=r.surface,e.globalAlpha*=.96,e.fill(),e.lineWidth=Math.max(1.5,o*.06),e.strokeStyle=r.border,e.shadowColor="rgba(8, 25, 53, 0.6)",e.shadowBlur=o*.45,e.stroke(),e.restore();const w=h*.78,y=Math.max(o*.22,5);e.save(),e.lineWidth=y,e.strokeStyle="rgba(148, 163, 184, 0.24)",e.beginPath(),e.arc(l,c,w,0,Math.PI*2),e.stroke(),e.restore();const C=t.spawnCooldown>0?t.spawnCooldown:1,P=1-Math.min(1,Math.max(0,t.timer/C)),E=-Math.PI/2,I=E+Math.PI*2*P;if(P>0){e.save(),e.lineWidth=y,e.lineCap="round";const Te=e.createLinearGradient(l,c-w,l,c+w);Te.addColorStop(0,r.accent),Te.addColorStop(1,r.warm),e.strokeStyle=Te,e.shadowColor=`rgba(56, 189, 248, ${.42+a*.18})`,e.shadowBlur=o*(.65+a*.35),e.beginPath(),e.arc(l,c,w,E,I,!1),e.stroke(),e.restore()}const R=Math.max(0,t.timer),b=Math.ceil(R);e.save(),e.font=`600 ${Math.max(12,o*.9)}px "Inter", "Manrope", "Segoe UI", sans-serif`,e.fillStyle=r.text,e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(2, 6, 23, 0.6)",e.shadowBlur=o*.35,e.fillText(String(b),l,c),e.restore(),e.save(),e.font=`500 ${Math.max(10,o*.36)}px "Inter", "Manrope", "Segoe UI", sans-serif`,e.fillStyle="rgba(148, 163, 184, 0.78)",e.textAlign="center",e.textBaseline="top",e.fillText("sec",l,c+w*.45),e.restore();const g="Sauna ♨️",A=Math.max(12,o*.58);e.save(),e.font=`600 ${A}px "Inter", "Manrope", "Segoe UI", sans-serif`;const O=e.measureText(g),N=o*.58,J=o*.32,re=O.width+N*2,ie=A+J*2,ae=l-re/2,Z=c-u-ie-o*.35,_t=ie/2;e.beginPath(),eo(e,ae,Z,re,ie,_t);const pe=e.createLinearGradient(ae,Z,ae,Z+ie);pe.addColorStop(0,"rgba(15, 23, 42, 0.94)"),pe.addColorStop(.55,"rgba(15, 23, 42, 0.86)"),pe.addColorStop(1,"rgba(30, 41, 59, 0.9)"),e.fillStyle=pe,e.shadowColor="rgba(8, 25, 53, 0.6)",e.shadowBlur=o*.4,e.fill(),e.lineWidth=Math.max(1.5,o*.06);const Ae=e.createLinearGradient(ae,Z,ae+re,Z);Ae.addColorStop(0,`${r.accent}`),Ae.addColorStop(1,`${r.warm}`),e.strokeStyle=Ae,e.stroke(),e.fillStyle=r.text,e.shadowColor="rgba(8, 25, 53, 0.65)",e.shadowBlur=o*.3,e.textAlign="center",e.textBaseline="middle",e.fillText(g,l,Z+ie/2+A*.05),e.restore()}function no(e,t,n,o,s,r){const i=window.devicePixelRatio||1,a=e.canvas.width,d=e.canvas.height;e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,a,d);const l=a/i,c=d/i;e.scale(i,i),e.translate(l/2,c/2),e.scale(M.zoom,M.zoom);const u=t.getOrigin();e.translate(-(M.x-u.x),-(M.y-u.y)),t.draw(e,n,s??void 0);const f=r?.saunojas;f&&Array.isArray(f.units)&&f.units.length>0&&f.draw(e,f.units,{originX:u.x,originY:u.y,hexRadius:t.hexSize}),oo(e,t,n,o,u),r?.sauna&&to(e,r.sauna,{origin:u,hexSize:t.hexSize}),e.restore()}function oo(e,t,n,o,s){const{width:r,height:i}=Et(t.hexSize);for(const a of o){const{x:d,y:l}=_(a.coord,t.hexSize),c=d-s.x,u=l-s.y,f=n[`unit-${a.type}`]??n.placeholder,m=a.getMaxHealth();e.save(),a.stats.health/m<.5&&(e.filter="saturate(0)"),e.drawImage(f,c,u,r,i),xn()&&a.faction==="player"&&(e.strokeStyle="rgba(255,255,255,0.5)",e.lineWidth=2,e.strokeRect(c,u,r,i)),e.restore()}}function so(){return`${"/".endsWith("/")?"/":"//"}${"assets/units/saunoja.svg".replace(/^\/+/,"")}`}const lt=so();let ne=null,de=null;function $e(e){return!!(e&&e.complete&&e.naturalWidth>0&&e.naturalHeight>0)}function ro(e,t){if(!t)return e;try{t(e)}catch(n){console.error("Saunoja icon onLoad callback failed",n)}return e}function Tt(e){const t=o=>e?o.then(s=>ro(s,e)):o;if($e(ne))return t(Promise.resolve(ne));if(de)return t(de);if(typeof Image>"u")return Promise.reject(new Error("Image constructor is not available in this environment."));const n=new Image;return n.decoding="async",ne=n,de=new Promise((o,s)=>{const r=()=>{n.onload=null,n.onerror=null},i=()=>{r(),o(n)};n.onload=i,n.onerror=a=>{r(),ne=null,de=null;const d=new Error(`Failed to load saunoja icon from ${lt}`);console.warn(d.message,a),s(d)},n.src=lt,$e(n)&&i()}),t(de)}function io(e,t,{originX:n=0,originY:o=0,hexRadius:s=se}={}){if(!e||!Array.isArray(t)||t.length===0)return;const r=$e(ne)?ne:null;if(!r)return;const i=Number.isFinite(s)&&s>0?s:se,a=i*.98,d=[...t].sort((l,c)=>l.coord.r!==c.coord.r?l.coord.r-c.coord.r:l.coord.q!==c.coord.q?l.coord.q-c.coord.q:l.id.localeCompare(c.id));for(const l of d){const{x:c,y:u}=_(l.coord,i),f=c-n,m=u-o,p=f+i,h=m+i;e.save(),fe(e,p,h,a),e.clip();const w=i*2.15/Math.max(r.naturalWidth,r.naturalHeight||1),y=r.naturalWidth*w,C=r.naturalHeight*w,T=p-y/2,P=h-C*.72;e.save(),e.filter="grayscale(100%) contrast(112%)",e.globalAlpha*=.96,e.drawImage(r,T,P,y,C),e.restore(),e.save(),e.globalCompositeOperation="multiply";const E=e.createRadialGradient(p,h+a*.38,a*.2,p,h+a*.38,a*1.05);E.addColorStop(0,"rgba(15, 23, 42, 0.55)"),E.addColorStop(1,"rgba(15, 23, 42, 0)"),e.fillStyle=E,e.fillRect(p-a,h-a,a*2,a*2),e.restore(),e.save(),e.globalCompositeOperation="soft-light";const I=e.createLinearGradient(p,h-a,p,h+a);I.addColorStop(0,"rgba(255, 232, 210, 0.18)"),I.addColorStop(.52,"rgba(255, 183, 124, 0.32)"),I.addColorStop(1,"rgba(212, 97, 54, 0.5)"),e.fillStyle=I,e.fillRect(p-a,h-a,a*2,a*2),e.restore(),e.save(),e.globalCompositeOperation="screen",e.globalAlpha=.75;const R=e.createRadialGradient(p,h-a*.68,a*.1,p,h,a*1.12);R.addColorStop(0,"rgba(255, 255, 255, 0.85)"),R.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=R,e.fillRect(p-a,h-a,a*2,a*2),e.restore();const g=performance.now()-l.lastHitAt,A=120;if(g<A){const J=1-g/A;An(e,{centerX:p,centerY:h,radius:a,progress:J})}e.restore(),Tn(e,{centerX:p,centerY:h-i*.18,radius:i*.94,intensity:l.steam});const O=i*.42,N=h+i*.34;Pn(e,{centerX:p,centerY:N,hp:l.hp,maxHp:l.maxHp,radius:O})}}const Re="/",U={gold:`${Re}assets/ui/gold.svg`,resource:`${Re}assets/ui/resource.svg`,sound:`${Re}assets/ui/sound.svg`};let It,W,oe=null,G=[];const Lt="autobattles:saunojas";function Rt(){try{return globalThis.localStorage??null}catch{return null}}function ao(){const e=Rt();if(!e)return[];try{const t=e.getItem(Lt);if(!t)return[];const n=JSON.parse(t);if(!Array.isArray(n))return[];const o=[];for(const s of n){if(!s||typeof s!="object")continue;const r=s,i=r.id;if(typeof i!="string"||i.length===0)continue;const a=r.coord,d=a&&typeof a=="object"&&typeof a.q=="number"&&Number.isFinite(a.q)&&typeof a.r=="number"&&Number.isFinite(a.r)?{q:a.q,r:a.r}:void 0;o.push(kt({id:i,name:typeof r.name=="string"?r.name:void 0,coord:d,maxHp:typeof r.maxHp=="number"?r.maxHp:void 0,hp:typeof r.hp=="number"?r.hp:void 0,steam:typeof r.steam=="number"?r.steam:void 0,selected:!!r.selected}))}return o}catch(t){return console.warn("Failed to load Saunoja units from storage",t),[]}}function Oe(){const e=Rt();if(e)try{const t=G.map(n=>({id:n.id,name:n.name,coord:{q:n.coord.q,r:n.coord.r},maxHp:n.maxHp,hp:n.hp,steam:n.steam,selected:n.selected}));e.setItem(Lt,JSON.stringify(t))}catch(t){console.warn("Failed to persist Saunoja units",t)}}function lo(e,t){It=e,W=t,W.classList.add("resource-bar"),W.setAttribute("role","status"),W.setAttribute("aria-live","polite"),W.replaceChildren();const n=document.createElement("img");n.src=U.resource,n.alt="Resources",n.decoding="async",n.classList.add("resource-icon");const o=document.createElement("span");o.textContent="Resources",o.classList.add("resource-label"),oe=document.createElement("span"),oe.textContent="0",oe.classList.add("resource-value"),W.append(n,o,oe),Ue(F.getResource(z.GOLD))}const co={images:{placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=","building-farm":Ft,"building-barracks":Nt,"building-city":Yt,"building-mine":Xt,"unit-soldier":Wt,"unit-archer":Ut,"unit-raider":jt,"icon-gold":U.gold,"icon-resource":U.resource,"icon-sound":U.sound}};let Ce=null;function uo(e){Ce=e}const $=new cn(10,10,32),fo=new Kn($);$.forEachTile(e=>e.setFogged(!0));en();const F=new rn(1e3);F.load($);const ho=2,po=new an(1e3,()=>{F.tick(),F.save();for(const e of Q)!e.isDead()&&e.faction==="player"&&$.revealAround(e.coord,ho);D()}),Q=[],he=In({q:Math.floor($.width/2),r:Math.floor($.height/2)});$.revealAround(he.pos,3);G=ao();if(G.length===0)G.push(kt({id:"saunoja-1",coord:he.pos,selected:!0})),Oe();else{let e=!1,t=!1;for(const n of G)n.selected&&(e?(n.selected=!1,t=!0):e=!0);t&&Oe()}const mo=Ln(he),go=Rn(F,{saunakunnia:U.resource,sisu:U.resource,gold:U.gold,sound:U.sound}),{log:xt,addEvent:No}=Dn(F);v.on("sisuPulse",()=>qn(F,Q));v.on("sisuPulseStart",()=>Mt("sisu"));F.addResource(z.GOLD,200);let Se=null;const xe=G.find(e=>e.selected);xe&&(Se={q:xe.coord.q,r:xe.coord.r});function bo(e,t){return!e||!t?e===t:e.q===t.q&&e.r===t.r}function qe(e){return bo(Se,e)?!1:(Se=e?{q:e.q,r:e.r}:null,!0)}function De(e){let t=!1;for(const n of G)e&&n===e||n.selected&&(n.selected=!1,t=!0);return t}function qt(e){const t=Vt(e.x-$.hexSize,e.y-$.hexSize,$.hexSize),n=G.find(s=>s.coord.q===t.q&&s.coord.r===t.r);let o=!1;if(!n)De()&&(o=!0),qe(null)&&(o=!0);else{const s=!n.selected;n.selected!==s&&(n.selected=s,o=!0),s?(De(n)&&(o=!0),qe(n.coord)&&(o=!0)):(De()&&(o=!0),qe(null)&&(o=!0))}o&&(Oe(),D())}function D(){const e=It.getContext("2d");!e||!Ce||no(e,fo,Ce.images,Q,Se,{saunojas:{units:G,draw:io},sauna:he})}const Dt=({resource:e,total:t,amount:n})=>{Ue(t);const o=n>0?"+":"";xt(`${e}: ${o}${n}`)};v.on("resourceChanged",Dt);const Ht=({policy:e})=>{xt(`Policy applied: ${e}`)};v.on("policyApplied",Ht);const Bt=({unitId:e})=>{const t=Q.findIndex(n=>n.id===e);t!==-1&&(Q.splice(t,1),D())};v.on("unitDied",Bt);function Ge(){v.off("resourceChanged",Dt),v.off("policyApplied",Ht),v.off("unitDied",Bt)}async function yo(){if(!Ce){console.error("Cannot start game without loaded assets.");return}Ue(F.getResource(z.GOLD)),D();try{await Tt(()=>{D()}).then(()=>{D()})}catch(n){console.warn("Failed to preload Saunoja icon before starting the game",n)}let e=performance.now();function t(n){const o=n-e;e=n,po.tick(o),he.update(o/1e3,Q,s=>{Q.push(s),D()}),mo(),go(o),D(),requestAnimationFrame(t)}requestAnimationFrame(t)}function Ue(e){oe?oe.textContent=String(e):W&&(W.textContent=`Resources: ${e}`)}async function wo(e){const t=Object.entries(e),n=await Promise.allSettled(t.map(([i,a])=>a.load().then(d=>({key:i,descriptor:a,value:d})))),o={},s=[],r=[];return n.forEach((i,a)=>{const[d,l]=t[a],c=l.label??String(d);if(i.status==="fulfilled"){const{value:f}=i.value;if(o[d]=f.value,f.warnings?.length)for(const m of f.warnings)s.push(c?`${c}: ${m}`:m);if(f.errors?.length)for(const m of f.errors)r.push(c?`${c}: ${m}`:m);return}const u=vo(i.reason);r.push(c?`${c}: ${u}`:u)}),{resources:o,warnings:s,errors:r}}function vo(e){if(e instanceof Error)return e.message;if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}const Co=.5,So=3.5,Mo=.0015,ko=10,Eo=250;function Po(){if(typeof document>"u")return;const e=document.querySelector("[data-build-commit]");if(!e)return;const t="67306c0".trim(),n=t.length>0&&t!=="unknown",o=n?`#${t}`:"DEV BUILD";e.textContent=o,e.dataset.state=n?"commit":"dev";const s=e.closest("#build-id");if(s){const r=n?`Build commit ${t}`:"Development build";s.setAttribute("aria-label",r),s.title=n?`Autobattles build ${t}`:"Unversioned development build",s.dataset.buildState=n?"release":"development"}}Po();const _e=[];let Me=0,k=null,Fe=!1,S=null;const L={active:!1,pointerId:null,lastX:0,lastY:0};function Ao(e){return Math.min(So,Math.max(Co,e))}function H(e){_e.push(e)}function K(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}function To(e){const t=window.devicePixelRatio||1,n=Math.max(window.innerWidth,1),o=Math.max(window.innerHeight,1);e.style.width=`${n}px`,e.style.height=`${o}px`,e.width=Math.round(n*t),e.height=Math.round(o*t);const s=e.getContext("2d");s&&s.setTransform(1,0,0,1,0,0),D()}function Ne(e,t,n,o,s){const r=e.getBoundingClientRect(),i=t-r.left,a=n-r.top,d=r.width/2,l=r.height/2;return{x:s.x+(i-d)/o,y:s.y+(a-l)/o}}function $t(e,t,n,o=M.zoom,s=M){return Ne(e,t,n,o,s)}function Ot(e,t,n,o){const s=Ao(o);if(s===M.zoom)return;const r={x:M.x,y:M.y},i=Ne(e,t,n,M.zoom,r),a=Ne(e,t,n,s,r);M.x+=i.x-a.x,M.y+=i.y-a.y,M.zoom=s,D()}function je(e,t){e===0&&t===0||(M.x-=e/M.zoom,M.y-=t/M.zoom,D())}function ct(e){if(!k)return;e.preventDefault();const t=Math.exp(-e.deltaY*Mo),n=M.zoom*t;Ot(k,e.clientX,e.clientY,n)}function dt(e){k&&(e.pointerType!=="mouse"||e.button!==0||(L.active=!0,L.pointerId=e.pointerId,L.lastX=e.clientX,L.lastY=e.clientY,k.setPointerCapture?.(e.pointerId),k.style.cursor="grabbing"))}function ut(e){if(!k||!L.active||L.pointerId!==e.pointerId)return;const t=e.clientX-L.lastX,n=e.clientY-L.lastY;L.lastX=e.clientX,L.lastY=e.clientY,je(t,n)}function te(e){k&&(!L.active||L.pointerId!==e.pointerId||(L.active=!1,L.pointerId=null,k.releasePointerCapture?.(e.pointerId),k.style.cursor=""))}function Io(e){return!k||e.mode!=="pan"||e.startX==null||e.startY==null||e.moved&&Math.hypot((e.lastX??e.startX)-e.startX,(e.lastY??e.startY)-e.startY)>ko?!1:K()-e.startTime<=Eo}function Lo(e){if(!k||e.startX==null||e.startY==null)return;const t=$t(k,e.startX,e.startY);qt(t)}function Ro(e){if(!S)return;const t=e.clientX-(S.lastX??e.clientX),n=e.clientY-(S.lastY??e.clientY);Math.hypot(t,n)>1&&(S.moved=!0),S.lastX=e.clientX,S.lastY=e.clientY,je(t,n)}function xo(e,t){if(!k)return;const n=(e.clientX+t.clientX)/2,o=(e.clientY+t.clientY)/2,s=Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY);if(S?.lastDistance){const r=s/S.lastDistance,i=M.zoom*r;Ot(k,n,o,i)}if(S?.lastCenter){const r=n-S.lastCenter.x,i=o-S.lastCenter.y;je(r,i)}S?(S.mode="pinch",S.lastCenter={x:n,y:o},S.lastDistance=s,S.moved=!0):S={mode:"pinch",lastCenter:{x:n,y:o},lastDistance:s,startTime:K(),moved:!0}}function ft(e){if(k){if(e.touches.length===1){const t=e.touches[0];S={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:K(),moved:!1}}else if(e.touches.length>=2){const[t,n]=[e.touches[0],e.touches[1]];S={mode:"pinch",lastCenter:{x:(t.clientX+n.clientX)/2,y:(t.clientY+n.clientY)/2},lastDistance:Math.hypot(t.clientX-n.clientX,t.clientY-n.clientY),startTime:K(),moved:!1}}}}function ht(e){if(!(!k||!S)&&e.touches.length!==0)if(e.preventDefault(),e.touches.length===1){const t=e.touches[0];if(S.mode!=="pan"){const n=S.mode==="pinch";S={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:K(),moved:n}}Ro(t)}else{const[t,n]=[e.touches[0],e.touches[1]];xo(t,n)}}function ge(e){if(!(!k||!S)){if(e.touches.length===0){Io(S)&&Lo(S),S=null;return}if(e.touches.length===1){const t=e.touches[0],n=S.mode==="pinch";S={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:K(),moved:n}}else if(e.touches.length>=2){const[t,n]=[e.touches[0],e.touches[1]];S={mode:"pinch",lastCenter:{x:(t.clientX+n.clientX)/2,y:(t.clientY+n.clientY)/2},lastDistance:Math.hypot(t.clientX-n.clientX,t.clientY-n.clientY),startTime:K(),moved:!0}}}}function pt(e){if(!k)return;const t=$t(k,e.clientX,e.clientY);qt(t)}function qo(e){e.addEventListener("click",pt),H(()=>e.removeEventListener("click",pt)),e.addEventListener("wheel",ct,{passive:!1}),H(()=>e.removeEventListener("wheel",ct)),e.addEventListener("pointerdown",dt),e.addEventListener("pointermove",ut),e.addEventListener("pointerup",te),e.addEventListener("pointercancel",te),e.addEventListener("pointerleave",te),H(()=>{e.removeEventListener("pointerdown",dt),e.removeEventListener("pointermove",ut),e.removeEventListener("pointerup",te),e.removeEventListener("pointercancel",te),e.removeEventListener("pointerleave",te)}),e.addEventListener("touchstart",ft,{passive:!1}),e.addEventListener("touchmove",ht,{passive:!1}),e.addEventListener("touchend",ge),e.addEventListener("touchcancel",ge),H(()=>{e.removeEventListener("touchstart",ft),e.removeEventListener("touchmove",ht),e.removeEventListener("touchend",ge),e.removeEventListener("touchcancel",ge)})}function Do(){for(;_e.length;){const e=_e.pop();try{e?.()}catch(t){console.error("Error during cleanup",t)}}}function Ho(){Me+=1,Do(),L.active=!1,L.pointerId=null,k&&(k.style.cursor=""),S=null,k=null,Fe=!1,Bo(),Ge()}function Bo(){document.querySelectorAll(".hud-loader").forEach(e=>{e.remove()}),document.querySelectorAll(".hud-banner-stack").forEach(e=>{e.remove()})}function $o(e="Heating the sauna stones…"){const t=document.getElementById("ui-overlay");if(!t)return{update:()=>{},clear:()=>{},dispose:()=>{}};const n=document.createElement("div");n.className="hud-loader",n.setAttribute("role","status"),n.setAttribute("aria-live","polite");const o=document.createElement("div");o.className="hud-loader__card";const s=document.createElement("div");s.className="hud-loader__spinner",s.setAttribute("aria-hidden","true");const r=document.createElement("p");r.className="hud-loader__message",r.textContent=e,o.append(s,r),n.append(o),t.append(n);let i=!1;return{update(a){r.textContent=a},clear(){i||Gt(n,"hud-loader--hidden",()=>{i=!0,n.remove()})},dispose(){i||(i=!0,n.remove())}}}function be(e,t){const n=Oo();if(!n)return null;const o=document.createElement("section");o.className=`hud-banner hud-banner--${e}`,o.setAttribute("role",e==="error"?"alert":"status"),o.setAttribute("aria-live",e==="error"?"assertive":"polite");const s=document.createElement("header");s.className="hud-banner__header";const r=document.createElement("p");r.className="hud-banner__title",r.textContent=t.title??(e==="error"?"Attention required":e==="warning"?"Heads up":"Status update"),s.append(r);const i=document.createElement("ul");i.className="hud-banner__list";for(const c of t.messages){const u=document.createElement("li");u.textContent=c,i.append(u)}if(o.append(s),t.messages.length&&o.append(i),t.actions?.length){const c=document.createElement("div");c.className="hud-banner__actions";for(const u of t.actions){const f=document.createElement("button");f.type="button",f.className=u.variant==="secondary"?"hud-banner__button hud-banner__button--secondary":"hud-banner__button",f.textContent=u.label,f.addEventListener("click",()=>{u.onClick()}),c.append(f)}o.append(c)}let a,d=!1;const l=()=>{d||(d=!0,a&&window.clearTimeout(a),Gt(o,"hud-banner--hide",()=>{o.remove(),n.hasChildNodes()||n.remove()}))};if(t.dismissible!==!1){const c=document.createElement("button");c.type="button",c.className="hud-banner__close",c.setAttribute("aria-label","Dismiss notification"),c.textContent="×",c.addEventListener("click",()=>{l()}),s.append(c)}return n.append(o),t.autoCloseMs&&t.autoCloseMs>0&&(a=window.setTimeout(()=>l(),t.autoCloseMs)),{element:o,dismiss:l}}function Oo(){const e=document.getElementById("ui-overlay");if(!e)return null;let t=e.querySelector(".hud-banner-stack");return t||(t=document.createElement("div"),t.className="hud-banner-stack",e.append(t)),t}function Gt(e,t,n){let o=!1;const s=()=>{o||(o=!0,e.removeEventListener("transitionend",s),n())};e.addEventListener("transitionend",s),requestAnimationFrame(()=>{e.classList.add(t)}),window.setTimeout(s,400)}function mt(e){if(e instanceof Error&&e.message)return e.message;if(typeof e=="string"&&e.trim().length>0)return e;try{return JSON.stringify(e)}catch{return String(e)}}async function Go(e){const t=$o("Heating the sauna stones…");H(()=>t.dispose());try{const{resources:n,warnings:o,errors:s}=await wo({assets:{label:"Core assets",load:async()=>{const i=await tn(co);return{value:i.assets,errors:i.failures}}},saunojaIcon:{label:"Saunoja icon",load:async()=>{try{return{value:await Tt()}}catch(i){return{value:null,warnings:[`Unable to preload Saunoja icon (${mt(i)})`]}}}}});if(e!==Me){t.dispose();return}t.update("Polishing sauna ambience…"),t.clear();const r=n.assets;if(!r){const i=s.length?[...s]:["Critical assets were unavailable. Please refresh to try again."];console.error("Critical assets failed to load",i);const a=be("error",{title:"Unable to start the sauna battle",messages:i,actions:[{label:"Reload",onClick:()=>window.location.reload(),variant:"primary"}],dismissible:!1});a&&H(()=>a.dismiss());return}if(s.length){console.error("Resource loader errors",s);const i=be("error",{title:"Some resources failed to load",messages:s,actions:[{label:"Reload",onClick:()=>window.location.reload(),variant:"primary"}]});i&&H(()=>i.dismiss())}if(o.length){console.warn("Resource loader warnings",o);const i=be("warning",{title:"Heads up",messages:o,autoCloseMs:12e3});i&&H(()=>i.dismiss())}uo(r),yo()}catch(n){if(e!==Me){t.dispose();return}console.error("Failed to initialize resources",n),t.clear();const o=be("error",{title:"Failed to initialize",messages:[mt(n)],actions:[{label:"Reload",onClick:()=>window.location.reload(),variant:"primary"}]});o&&H(()=>o.dismiss())}}function _o(){const e=document.getElementById("game-canvas"),t=document.getElementById("resource-bar");if(!e||!t){console.error("Autobattles4xFinsauna shell is missing the required canvas or resource bar elements.",{hasCanvas:!!e,hasResourceBar:!!t});return}Fe&&Ho();const n=++Me;k=e,Fe=!0,lo(e,t),qo(e);const o=()=>To(e);window.addEventListener("resize",o),H(()=>window.removeEventListener("resize",o)),window.addEventListener("beforeunload",Ge),H(()=>window.removeEventListener("beforeunload",Ge)),o(),import.meta.vitest||Go(n)}function Fo(){if(typeof document>"u")return;const e=()=>{document.removeEventListener("DOMContentLoaded",e),_o()};if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",e);return}e()}import.meta.vitest||Fo();export{z as R,gn as U,Mt as p};
