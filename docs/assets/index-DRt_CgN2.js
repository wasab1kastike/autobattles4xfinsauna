(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const gt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3cpolygon%20points='16,48%2032,16%2048,48'%20fill='%23d2691e'%20/%3e%3crect%20x='24'%20y='32'%20width='16'%20height='16'%20fill='%23f4a460'%20/%3e%3c/svg%3e",yt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23c0c0c0'%20/%3e%3crect%20x='8'%20y='24'%20width='48'%20height='24'%20fill='%23808080'%20/%3e%3crect%20x='24'%20y='16'%20width='16'%20height='8'%20fill='%23606060'%20/%3e%3c/svg%3e",wt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23e0e0e0'%20/%3e%3crect%20x='10'%20y='22'%20width='12'%20height='30'%20fill='%23a9a9a9'%20/%3e%3crect%20x='26'%20y='14'%20width='12'%20height='38'%20fill='%23808080'%20/%3e%3crect%20x='42'%20y='26'%20width='12'%20height='26'%20fill='%23a9a9a9'%20/%3e%3c/svg%3e",vt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b4513'%20/%3e%3cpolygon%20points='32,10%2042,22%2022,22'%20fill='%23555'%20/%3e%3crect%20x='30'%20y='22'%20width='4'%20height='32'%20fill='%23ccc'%20/%3e%3c/svg%3e",bt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%234682b4'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='12'%20fill='%23fff'%20/%3e%3crect%20x='28'%20y='36'%20width='8'%20height='16'%20fill='%23fff'%20/%3e%3c/svg%3e",xt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23556b2f'%20/%3e%3cline%20x1='16'%20y1='16'%20x2='48'%20y2='48'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cpolygon%20points='48,48%2044,36%2036,44'%20fill='%23fff'%20/%3e%3c/svg%3e",St="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b0000'%20/%3e%3cline%20x1='18'%20y1='18'%20x2='46'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cline%20x1='46'%20y1='18'%20x2='18'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3c/svg%3e";class Ct{listeners=new Map;on(t,n){const o=this.listeners.get(t)??[];o.push(n),this.listeners.set(t,o)}off(t,n){const o=this.listeners.get(t);if(!o)return;const i=o.indexOf(n);i!==-1&&(o.splice(i,1),o.length===0?this.listeners.delete(t):this.listeners.set(t,o))}emit(t,n){const o=this.listeners.get(t);if(o)for(const i of o)i(n)}}const m=new Ct;class ke{type="farm";cost=50;foodPerTick=1}class Qe{type="barracks";cost=100;trainingCapacity=1}const Ke=Math.sqrt(3),Et=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function $(e,t){return{x:t*Ke*(e.q+e.r/2),y:t*(3/2)*e.r}}function kt(e,t,n){const o=(Ke/3*e-.3333333333333333*t)/n,i=2/3*t/n;return Mt({q:o,r:i})}function ge(e){return Et.map(t=>({q:e.q+t.q,r:e.r+t.r}))}function Mt(e){let t=e.q,n=e.r,o=-t-n,i=Math.round(t),s=Math.round(o),a=Math.round(n);const r=Math.abs(i-t),c=Math.abs(s-o),l=Math.abs(a-n);return r>c&&r>l?i=-s-a:c>l?s=-i-a:a=-i-s,{q:i,r:a}}const ne=new Set;let ee=32;function At(e){return`${e.q},${e.r}`}function ye(e,t){ee=t,ne.add(At(e))}function Pt(e){if(ne.size===0)return{center:{x:0,y:0},zoom:1};const t=ee*Math.sqrt(3),n=ee*2;let o=1/0,i=1/0,s=-1/0,a=-1/0;for(const u of ne){const[g,E]=u.split(",").map(Number),{x:S,y:k}=$({q:g,r:E},ee);o=Math.min(o,S),i=Math.min(i,k),s=Math.max(s,S+t),a=Math.max(a,k+n)}const r=s-o,c=a-i,l=96,d={x:o+r/2,y:i+c/2},f=e.width/(r+l*2),h=e.height/(c+l*2),v=Math.min(f,h);return{center:d,zoom:v}}const b={x:0,y:0,zoom:1};function Tt(e,t=300){const n=b.x,o=b.y,i=b.zoom,s=typeof performance<"u"?performance.now():Date.now(),a=r=>{const c=Math.min((r-s)/t,1);b.x=n+(e.center.x-n)*c,b.y=o+(e.center.y-o)*c,b.zoom=i+(e.zoom-i)*c,c<1&&(typeof requestAnimationFrame<"u"?requestAnimationFrame(a):setTimeout(()=>a(typeof performance<"u"?performance.now():Date.now()),16))};typeof requestAnimationFrame<"u"?requestAnimationFrame(a):setTimeout(()=>a(typeof performance<"u"?performance.now():Date.now()),0)}function It(){ne.clear()}async function Rt(e){const t={},n={},o=[],i=Object.entries(e.images??{}).map(([a,r])=>new Promise(c=>{const l=new Image;l.onload=()=>{t[a]=l,c()},l.onerror=()=>{const d=`Failed to load image: ${r}`;console.error(d),o.push(d),c()},l.src=r})),s=Object.entries(e.sounds??{}).map(([a,r])=>new Promise(c=>{const l=new Audio;l.oncanplaythrough=()=>{n[a]=l,c()},l.onerror=()=>{const d=`Failed to load sound: ${r}`;console.error(d),o.push(d),c()},l.src=r,l.load()}));return await Promise.all([...i,...s]),{assets:{images:t,sounds:n},failures:o}}function Lt(e){const t=localStorage.getItem(e);if(t)try{return JSON.parse(t)}catch(n){console.warn(`Failed to parse data for "${e}", clearing`,n),localStorage.removeItem(e);return}}function de(e){return`${e.q},${e.r}`}const Ve={farm:()=>new ke,barracks:()=>new Qe};function Dt(e){return Ve[e]?.()}var G=(e=>(e.GOLD="gold",e))(G||{});const qt={gold:1};class Ht{constructor(t,n="gameState"){this.tickInterval=t,this.storageKey=n}resources={gold:0};passiveGeneration={...qt};lastSaved=Date.now();buildings={};buildingPlacements=new Map;policies=new Set;nightWorkSpeedMultiplier=1;tick(){Object.keys(this.passiveGeneration).forEach(t=>{this.addResource(t,this.passiveGeneration[t])})}save(){this.lastSaved=Date.now();const t={};this.buildingPlacements.forEach((o,i)=>{t[i]=o.type});const n={resources:this.resources,lastSaved:this.lastSaved,buildings:this.buildings,buildingPlacements:t};localStorage.setItem(this.storageKey,JSON.stringify(n))}load(t){const n=Lt(this.storageKey);if(!n){this.lastSaved=Date.now();return}this.resources={...this.resources,...n.resources};const o={};Object.entries(n.buildings??{}).forEach(([a,r])=>{Ve[a]&&(o[a]=r)}),this.buildings=o,this.buildingPlacements.clear(),n.buildingPlacements&&Object.entries(n.buildingPlacements).forEach(([a,r])=>{const c=Dt(r);if(!c)return;this.buildingPlacements.set(a,c);const[l,d]=a.split(",").map(Number);if(t){const f=t.ensureTile(l,d);f.placeBuilding(c.type),f.reveal(),ye({q:l,r:d},t.hexSize)}m.emit("buildingPlaced",{building:c,coord:{q:l,r:d},state:this})}),this.lastSaved=n.lastSaved??Date.now();const i=Date.now()-this.lastSaved,s=Math.floor(i/this.tickInterval);Object.keys(this.passiveGeneration).forEach(a=>{this.resources[a]+=s*this.passiveGeneration[a]})}getResource(t){return this.resources[t]}canAfford(t,n="gold"){return this.resources[n]>=t}spend(t,n="gold"){return this.canAfford(t,n)?(this.resources[n]-=t,m.emit("resourceChanged",{resource:n,amount:-t,total:this.resources[n]}),!0):!1}addResource(t,n){this.resources[t]+=n,m.emit("resourceChanged",{resource:t,amount:n,total:this.resources[t]})}modifyPassiveGeneration(t,n){this.passiveGeneration[t]=(this.passiveGeneration[t]??0)+n}construct(t,n,o="gold"){return this.spend(n,o)?(this.buildings[t]=(this.buildings[t]??0)+1,!0):!1}placeBuilding(t,n,o,i="gold"){const s=o.getTile(n.q,n.r);return!s||s.building||!this.construct(t.type,t.cost,i)?!1:(this.buildingPlacements.set(de(n),t),s.placeBuilding(t.type),m.emit("buildingPlaced",{building:t,coord:n,state:this}),!0)}getBuildingAt(t){return this.buildingPlacements.get(de(t))}removeBuilding(t,n){const o=de(t),i=this.buildingPlacements.get(o);return i?(this.buildingPlacements.delete(o),n.getTile(t.q,t.r)?.placeBuilding(null),this.buildings[i.type]!==void 0&&(this.buildings[i.type]-=1,this.buildings[i.type]<=0&&delete this.buildings[i.type]),m.emit("buildingRemoved",{building:i,coord:t,state:this}),!0):!1}upgrade(t,n,o="gold"){return this.construct(`upgrade:${t}`,n,o)}applyPolicy(t,n,o="gold"){return this.spend(n,o)?(this.policies.add(t),m.emit("policyApplied",{policy:t,state:this}),!0):!1}hasPolicy(t){return this.policies.has(t)}}class Gt{constructor(t,n){this.baseInterval=t,this.onTick=n}timer=null;speed=1;lastTick=0;accumulator=0;start(){this.stop(),this.lastTick=Date.now();const t=this.baseInterval/this.speed;this.timer=setInterval(()=>{const n=Date.now(),o=n-this.lastTick;this.lastTick=n,this.onTick(o)},t)}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null)}setSpeed(t){if(t<=0)throw new Error("Speed multiplier must be positive");this.speed=t,this.timer!==null&&this.start()}getSpeed(){return this.speed}getBaseInterval(){return this.baseInterval}tick(t){for(this.accumulator+=t*this.speed;this.accumulator>=this.baseInterval;)this.accumulator-=this.baseInterval,this.onTick(this.baseInterval)}}var q=(e=>(e[e.Plains=0]="Plains",e[e.Forest=1]="Forest",e[e.Hills=2]="Hills",e[e.Lake=3]="Lake",e))(q||{});function Ot(e,t,n){let o=e*374761393+t*668265263+n*0x14057b7ef7678100;return o=(o^o>>13)*1274126177,o^=o>>16,(o>>>0)/4294967295}function Te(e,t,n=0){const o=Ot(e,t,n);return o<.1?3:o<.3?1:o<.5?2:0}class Ie{constructor(t=q.Plains,n=null,o=!0){this.terrain=t,this.building=n,this.isFogged=o}reveal(){this.isFogged=!1}placeBuilding(t){this.building=t}setFogged(t){this.isFogged=t}}class Yt{constructor(t=10,n=10,o=32,i=0){this.hexSize=o,this.seed=i,this.minQ=0,this.minR=0,this.maxQ=t-1,this.maxR=n-1;for(let s=this.minR;s<=this.maxR;s++)for(let a=this.minQ;a<=this.maxQ;a++)this.tiles.set(this.key(a,s),new Ie(Te(a,s,i)))}tiles=new Map;minQ;maxQ;minR;maxR;get width(){return this.maxQ-this.minQ+1}get height(){return this.maxR-this.minR+1}key(t,n){return`${t},${n}`}ensureTile(t,n){const o=this.key(t,n);let i=this.tiles.get(o);return i||(i=new Ie(Te(t,n,this.seed)),this.tiles.set(o,i),this.minQ=Math.min(this.minQ,t),this.maxQ=Math.max(this.maxQ,t),this.minR=Math.min(this.minR,n),this.maxR=Math.max(this.maxR,n),i.isFogged||ye({q:t,r:n},this.hexSize)),i}getTile(t,n){return this.ensureTile(t,n)}forEachTile(t){for(let n=this.minR;n<=this.maxR;n++)for(let o=this.minQ;o<=this.maxQ;o++){const i=this.ensureTile(o,n);t(i,{q:o,r:n})}}getNeighbors(t,n){return ge({q:t,r:n}).map(o=>this.ensureTile(o.q,o.r))}revealAround(t,n){for(let s=-n;s<=n;s++){const a=Math.max(-n,-s-n),r=Math.min(n,-s+n);for(let c=a;c<=r;c++){const l={q:t.q+s,r:t.r+c};this.ensureTile(l.q,l.r).reveal(),ye(l,this.hexSize)}}const o=typeof window<"u"?{width:window.innerWidth,height:window.innerHeight}:{width:0,height:0},i=Pt(o);Tt(i,300)}}const Je=({policy:e,state:t})=>{e==="eco"&&(t.modifyPassiveGeneration(G.GOLD,1),m.off("policyApplied",Je))},Ze=({policy:e,state:t})=>{e==="temperance"&&(t.nightWorkSpeedMultiplier*=1.05,m.off("policyApplied",Ze))};m.on("policyApplied",Je);m.on("policyApplied",Ze);const Bt="modulepreload",Ft=function(e){return"/autobattles4xfinsauna/"+e},Re={},zt=function(t,n,o){let i=Promise.resolve();if(n&&n.length>0){let c=function(l){return Promise.all(l.map(d=>Promise.resolve(d).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");i=c(n.map(l=>{if(l=Ft(l),l in Re)return;Re[l]=!0;const d=l.endsWith(".css"),f=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${f}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":Bt,d||(h.as="script"),h.crossOrigin="",h.href=l,r&&h.setAttribute("nonce",r),document.head.appendChild(h),d)return new Promise((v,u)=>{h.addEventListener("load",v),h.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return i.then(a=>{for(const r of a||[])r.status==="rejected"&&s(r.reason);return t().catch(s)})},Xt=({building:e,coord:t,state:n})=>{e instanceof ke?n.modifyPassiveGeneration(G.GOLD,e.foodPerTick):e instanceof Qe&&zt(async()=>{const{spawnUnit:o}=await import("./UnitFactory-Br7kJ3Sx.js");return{spawnUnit:o}},[]).then(({spawnUnit:o})=>{o(n,"soldier",`barracks-${t.q}-${t.r}`,t,"player")})},$t=({building:e,state:t})=>{e instanceof ke&&t.modifyPassiveGeneration(G.GOLD,-e.foodPerTick)};m.on("buildingPlaced",Xt);m.on("buildingRemoved",$t);function A(e){return`${e.q},${e.r}`}function Nt(e){const[t,n]=e.split(",").map(Number);return{q:t,r:n}}function Le(e,t){const n=-e.q-e.r,o=-t.q-t.r;return Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r),Math.abs(n-o))}class _t{constructor(t,n,o,i,s=[]){this.id=t,this.coord=n,this.faction=o,this.stats=i,this.priorityFactions=s,this.maxHealth=i.health}alive=!0;listeners={};maxHealth;healMarkerElapsed=0;onDeath(t){(this.listeners.death??=[]).push(t)}emitDeath(){for(const t of this.listeners.death??[])t()}isDead(){return!this.alive}getMaxHealth(){return this.maxHealth}distanceTo(t){return Le(this.coord,t)}attack(t){this.distanceTo(t.coord)<=this.stats.attackRange&&t.takeDamage(this.stats.attackDamage,this)}update(t,n){if(!(this.isDead()||!n))if(Le(this.coord,n.pos)<=n.auraRadius){const o=this.stats.health;this.stats.health=Math.min(this.stats.health+n.regenPerSec*t,this.maxHealth),this.stats.health>o&&(this.healMarkerElapsed+=t,this.healMarkerElapsed>=1&&(this.healMarkerElapsed=0,this.spawnHealMarker()))}else this.healMarkerElapsed=0}spawnHealMarker(){if(typeof document>"u")return;const t=document.getElementById("game-canvas");if(!t)return;const{x:n,y:o}=$(this.coord,32),i=document.createElement("div");i.textContent="+",i.className="heal-marker",i.style.position="absolute";const s=t.getBoundingClientRect();i.style.left=`${s.left+n}px`,i.style.top=`${s.top+o}px`,i.style.pointerEvents="none",document.body.appendChild(i),setTimeout(()=>i.remove(),1e3)}takeDamage(t,n){this.stats.health-=t,m.emit("unitDamaged",{attackerId:n?.id,targetId:this.id,amount:t,remainingHealth:this.stats.health}),this.stats.health<=0&&this.alive&&(this.stats.health=0,this.alive=!1,m.emit("unitDied",{unitId:this.id,attackerId:n?.id}),this.emitDeath())}moveTowards(t,n,o){const i=this.findPath(t,n,o);if(i.length<2)return[];let s=0;for(let r=1;r<i.length;r++){const c=A(i[r]);if(o.has(c))break;s=r}if(s===0)return[];const a=Math.min(this.stats.movementRange,s);return i.slice(0,a+1)}findPath(t,n,o){const i=this.coord,s=A(i),a=A(t),r=[i],c=new Map;for(c.set(s,null);r.length>0;){const f=r.shift(),h=A(f);if(h===a)break;for(const v of ge(f)){const u=A(v);u!==a&&!this.isPassable(v,n,o)||c.has(u)||(r.push(v),c.set(u,h))}}if(!c.has(a))return[i];const l=[];let d=a;for(;d;)l.push(Nt(d)),d=c.get(d)??null;return l.reverse()}seekNearestEnemy(t,n,o){const i=new Map;for(const r of t)i.set(A(r.coord),r);const s=[this.coord],a=new Set([A(this.coord)]);for(;s.length>0;){const r=s.shift(),c=A(r),l=i.get(c);if(l)return l;for(const d of ge(r)){const f=A(d),h=i.get(f);if(h)return h;this.isPassable(d,n,o)&&(a.has(f)||(a.add(f),s.push(d)))}}return null}isPassable(t,n,o){const i=n.getTile(t.q,t.r);return!i||o&&o.has(A(t))?!1:i.terrain!==q.Lake}}const Wt={health:12,attackDamage:4,attackRange:1,movementRange:2};class Ut extends _t{constructor(t,n,o){super(t,n,o,{...Wt})}}let M=null;const Q={};function et(){if(M||typeof window>"u")return M;const e=window.AudioContext||window.webkitAudioContext;if(!e)return console.warn("Web Audio API not supported"),null;try{M=new e}catch(t){return console.warn("Unable to create AudioContext",t),null}if(Q.click=jt(),Q.spawn=Qt(),Q.error=Kt(),Q.sisu=Vt(),M.state==="suspended"){const t=()=>{M?.resume()};window.addEventListener("pointerdown",t,{once:!0})}return M}function se(e,t){const n=M,o=n.createBuffer(1,e,n.sampleRate),i=o.getChannelData(0);for(let s=0;s<e;s++){const a=s/n.sampleRate;i[s]=t(a)}return o}function jt(){return se(Math.floor(M.sampleRate*.05),t=>Math.sin(2*Math.PI*1e3*t)*Math.exp(-40*t))}function Qt(){return se(Math.floor(M.sampleRate*.2),t=>(Math.sin(2*Math.PI*440*t)+Math.sin(2*Math.PI*660*t))*.5*Math.exp(-6*t))}function Kt(){return se(Math.floor(M.sampleRate*.3),t=>Math.sin(2*Math.PI*110*t)*Math.exp(-8*t))}function Vt(){return se(Math.floor(M.sampleRate*.5),t=>Math.sin(2*Math.PI*880*t)*Math.exp(-2*t))}let re=!1;typeof localStorage<"u"&&(re=localStorage.getItem("sfx-muted")==="true");function De(){return re}function Jt(e){re=e,typeof localStorage<"u"&&localStorage.setItem("sfx-muted",e?"true":"false")}function tt(e){if(re)return;const t=et();if(!t)return;const n=Q[e];if(!n)return;t.state==="suspended"&&t.resume();const o=t.createBufferSource();o.buffer=n,o.connect(t.destination),o.start()}typeof document<"u"&&document.addEventListener("click",e=>{e.target instanceof HTMLButtonElement&&tt("click")});et();const Zt={q:0,r:0},en="Saunoja",qe=18;function He(e,t,n){return Math.min(Math.max(e,t),n)}function nt(e){const{id:t,name:n=en,coord:o=Zt,maxHp:i=qe,hp:s=i,steam:a=0,selected:r=!1}=e,c=Number.isFinite(i)?Math.max(1,i):qe,l=Number.isFinite(s)?s:c,d=He(l,0,c),f=Number.isFinite(a)?a:0,h=He(f,0,1);return{id:t,name:n,coord:{q:o.q,r:o.r},maxHp:c,hp:d,steam:h,selected:r}}const oe=32;function K(e,t,n,o){e.beginPath();for(let i=0;i<6;i++){const s=Math.PI/3*i,a=t+o*Math.cos(s),r=n+o*Math.sin(s);i===0?e.moveTo(a,r):e.lineTo(a,r)}e.closePath()}function ot(e,t,n){return Math.min(Math.max(e,t),n)}function tn(e,{centerX:t,centerY:n,hp:o,maxHp:i,radius:s=oe*.55}){const a=Number.isFinite(i)?Math.max(1,i):1,r=Number.isFinite(o)?o:a,c=ot(r/a,0,1);if(e.save(),K(e,t,n,s),e.fillStyle="rgba(7, 11, 18, 0.72)",e.fill(),e.restore(),c>0){e.save(),K(e,t,n,s),e.clip();const l=e.createLinearGradient(t,n+s,t,n-s);l.addColorStop(0,"rgba(46, 160, 98, 0.35)"),l.addColorStop(1,"rgba(218, 255, 239, 0.95)"),e.fillStyle=l;const d=s*2*c,f=n+s-d;e.fillRect(t-s,f,s*2,d),e.restore()}e.save(),K(e,t,n,s),e.lineWidth=Math.max(1,s*.12),e.strokeStyle="rgba(255, 255, 255, 0.28)",e.stroke(),e.restore()}function nn(e,{centerX:t,centerY:n,radius:o=oe*.85,intensity:i=1}){const s=ot(i,0,1);if(s<=0)return;e.save(),K(e,t,n,o),e.clip();const a=e.createLinearGradient(t,n+o,t,n-o);a.addColorStop(0,"rgba(255, 255, 255, 0)"),a.addColorStop(.55,`rgba(255, 255, 255, ${.12*s})`),a.addColorStop(1,`rgba(255, 255, 255, ${.35*s})`),e.globalCompositeOperation="lighter",e.fillStyle=a,e.fillRect(t-o,n-o,o*2,o*2),e.restore(),e.save(),e.globalCompositeOperation="lighter",e.lineCap="round",e.strokeStyle=`rgba(255, 255, 255, ${.25*s})`,e.lineWidth=Math.max(1,o*.08);const r=o*.75,c=o*.35;for(let l=0;l<3;l++){const d=n-o*.5+l*c;e.beginPath(),e.moveTo(t-r,d),e.bezierCurveTo(t-r*.4,d-o*.4,t+r*.4,d+o*.2,t+r,d-o*.45),e.stroke()}e.restore()}function on(e){return{id:"sauna",pos:e,spawnCooldown:30,timer:30,auraRadius:2,regenPerSec:1,rallyToFront:!1,update(t,n,o){if(this.timer-=t,this.timer>0)return;const i=[];for(let s=-2;s<=2;s++){const a=Math.max(-2,-s-2),r=Math.min(2,-s+2);for(let c=a;c<=r;c++){const l=Math.max(Math.abs(s),Math.abs(c),Math.abs(-s-c));if(l===0||l>2)continue;const d={q:this.pos.q+s,r:this.pos.r+c};n.some(h=>!h.isDead()&&h.coord.q===d.q&&h.coord.r===d.r)||i.push(d)}}if(i.length>0){const s=i[Math.floor(Math.random()*i.length)],a=`raider${n.length+1}`,r=new Ut(a,s,"player");o(r)}this.timer=this.spawnCooldown}}}function sn(e){const t=document.getElementById("ui-overlay");if(!t)return()=>{};const n=document.createElement("button");n.textContent="Sauna ♨️",t.appendChild(n);const o=document.createElement("div");o.style.position="absolute",o.style.left="0",o.style.top="0",o.style.background="rgba(0,0,0,0.7)",o.style.color="#fff",o.style.padding="8px",o.style.display="none",o.style.minWidth="120px";const i=document.createElement("div");i.style.height="8px",i.style.background="#555";const s=document.createElement("div");s.style.height="100%",s.style.background="#0f0",s.style.width="0%",i.appendChild(s),o.appendChild(i);const a=document.createElement("label"),r=document.createElement("input");return r.type="checkbox",r.checked=e.rallyToFront,r.addEventListener("change",()=>{e.rallyToFront=r.checked}),a.appendChild(r),a.appendChild(document.createTextNode(" Rally to Front")),o.appendChild(a),t.appendChild(o),n.addEventListener("click",()=>{o.style.display=o.style.display==="none"?"block":"none"}),()=>{const c=1-e.timer/e.spawnCooldown;s.style.width=`${Math.max(0,Math.min(c,1))*100}%`,r.checked=e.rallyToFront}}function J(e,t){const n=document.createElement("div");if(n.classList.add("topbar-badge"),t){const r=document.createElement("img");r.src=t,r.alt=e,r.decoding="async",r.classList.add("topbar-badge-icon"),n.appendChild(r)}const o=document.createElement("div");o.classList.add("badge-text");const i=document.createElement("span");i.textContent=e,i.classList.add("badge-label"),o.appendChild(i);const s=document.createElement("span");s.textContent="0",s.classList.add("badge-value"),o.appendChild(s);const a=document.createElement("span");return a.classList.add("badge-delta"),a.style.opacity="0",a.style.transform="translateY(-6px)",a.style.transition="opacity 0.5s ease, transform 0.5s ease",n.append(o,a),{container:n,value:s,delta:a}}function rn(e,t={}){const n=document.getElementById("ui-overlay");if(!n)return()=>{};const o=document.createElement("div");o.id="topbar",n.appendChild(o);const i=J("Saunakunnia",t.saunakunnia);i.container.classList.add("badge-sauna");const s=J("SISU🔥",t.sisu);s.container.classList.add("badge-sisu"),s.container.style.display="none";const a=J("Gold",t.gold);a.container.classList.add("badge-gold");const r=J("Time");r.container.classList.add("badge-time"),r.delta.style.display="none",o.appendChild(i.container),o.appendChild(s.container),o.appendChild(a.container),o.appendChild(r.container);const c=document.createElement("button");c.type="button",c.textContent="SISU",c.classList.add("topbar-button","sisu-button"),c.addEventListener("click",()=>{m.emit("sisuPulse",{})}),o.appendChild(c);const l=document.createElement("button");l.type="button",l.title="Toggle sound",l.classList.add("topbar-button","sound-button");const d=document.createElement("span");if(d.textContent="Sound",t.sound){const u=document.createElement("img");u.src=t.sound,u.alt="",u.decoding="async",u.setAttribute("aria-hidden","true"),l.appendChild(u)}l.appendChild(d);function f(){const u=De();d.textContent=u?"Muted":"Sound",l.setAttribute("aria-pressed",u?"true":"false"),l.classList.toggle("is-muted",u)}l.addEventListener("click",()=>{Jt(!De()),f()}),f(),o.appendChild(l),m.on("sisuPulseStart",({remaining:u})=>{c.disabled=!0,s.container.style.display="block",s.value.textContent=String(u)}),m.on("sisuPulseTick",({remaining:u})=>{s.value.textContent=String(u)}),m.on("sisuPulseEnd",()=>{s.container.style.display="none"}),m.on("sisuCooldownEnd",()=>{c.disabled=!1}),a.value.textContent=String(e.getResource(G.GOLD));const h={saunakunnia:i,sisu:s,gold:a};m.on("resourceChanged",({resource:u,amount:g,total:E})=>{const S=h[u];if(!S)return;S.value.textContent=String(E);const k=g>0?"+":"";S.delta.textContent=`${k}${g}`,S.delta.style.opacity="1",S.delta.style.transform="translateY(0)",setTimeout(()=>{S.delta.style.opacity="0",S.delta.style.transform="translateY(-6px)"},1e3)});let v=0;return u=>{v+=u;const g=Math.floor(v/1e3),E=Math.floor(g/60),S=g%60;r.value.textContent=`${E}:${S.toString().padStart(2,"0")}`}}let te=!1,ue=!1;function an(){return te}function ln(e,t){if(te||ue)return;te=!0,ue=!0;let n=10;m.emit("sisuPulseStart",{remaining:n});const o=[];for(const s of t)s.faction!=="player"||s.isDead()||(o.push({unit:s,move:s.stats.movementRange,attack:s.stats.attackDamage}),s.stats.movementRange*=1.2,s.stats.attackDamage*=1.2,s.fearless=!0);const i=setInterval(()=>{if(n-=1,n>0){m.emit("sisuPulseTick",{remaining:n});return}clearInterval(i),te=!1;for(const s of o)s.unit.stats.movementRange=s.move,s.unit.stats.attackDamage=s.attack,delete s.unit.fearless;m.emit("sisuPulseEnd",{}),setTimeout(()=>{ue=!1,m.emit("sisuCooldownEnd",{})},12e4)},1e3)}function cn(e){const t=document.getElementById("ui-overlay");if(!t)return{log:()=>{},addEvent:()=>{}};const n=document.createElement("div");n.id="right-panel",n.style.position="absolute",n.style.top="0",n.style.right="0",n.style.width="240px",n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.background="rgba(0,0,0,0.5)",n.style.color="#fff",t.appendChild(n);const o=document.createElement("div");o.style.display="flex",n.appendChild(o);const i=document.createElement("div");i.style.flex="1",i.style.overflowY="auto",n.appendChild(i);const s=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div");r.id="event-log",r.style.display="flex",r.style.flexDirection="column";const c={Policies:s,Events:a,Log:r};function l(p){for(const[y,T]of Object.entries(c))T.style.display=y===p?"block":"none";for(const y of o.children){const T=y;T.disabled=T.textContent===p}}for(const p of Object.keys(c)){const y=document.createElement("button");y.textContent=p,y.addEventListener("click",()=>l(p)),o.appendChild(y),i.appendChild(c[p])}const d=[{id:"eco",name:"Eco Policy",description:"Increase gold income by 1",cost:15,prerequisite:()=>!0},{id:"temperance",name:"Temperance",description:"+5% work speed at night",cost:25,prerequisite:()=>!0}],f={};function h(){s.innerHTML="";for(const p of d){const y=document.createElement("button");y.textContent=`${p.name} (${p.cost}g)`,y.title=p.description,y.disabled=!p.prerequisite(e)||e.hasPolicy(p.id),y.addEventListener("click",()=>{e.applyPolicy(p.id,p.cost)&&v()}),s.appendChild(y),s.appendChild(document.createElement("br")),f[p.id]=y}}function v(){for(const p of d){const y=f[p.id];y&&(y.disabled=!p.prerequisite(e)||e.hasPolicy(p.id))}}h(),m.on("resourceChanged",v),m.on("policyApplied",v);const u=[];function g(){a.innerHTML="";for(const p of u){const y=document.createElement("div"),T=document.createElement("h4");T.textContent=p.headline;const V=document.createElement("p");V.textContent=p.body;const ce=document.createElement("button");ce.textContent=p.buttonText??"Acknowledge",ce.addEventListener("click",()=>{const Pe=u.findIndex(mt=>mt.id===p.id);Pe!==-1&&(u.splice(Pe,1),g())}),y.appendChild(T),y.appendChild(V),y.appendChild(ce),a.appendChild(y)}}function E(p){u.push(p),g()}const S=100,k=[];let N=!1;function le(){for(const p of k){const y=document.createElement("div");y.textContent=p,r.appendChild(y)}for(;r.childElementCount>S;)r.removeChild(r.firstChild);r.scrollTop=r.scrollHeight,k.length=0,N=!1}function _(p){k.push(p),N||(N=!0,(typeof requestAnimationFrame=="function"?requestAnimationFrame:y=>setTimeout(y,16))(le))}return l("Policies"),{log:_,addEvent:E}}function dn(e){const t=document.getElementById("ui-overlay");if(!t)return;const n=document.createElement("div");n.id="error-overlay",n.style.position="absolute",n.style.inset="0",n.style.background="rgba(0, 0, 0, 0.75)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.pointerEvents="auto",n.style.zIndex="1000";const o=document.createElement("div");o.className="card",o.style.background="rgba(20, 20, 20, 0.9)",o.style.color="white",o.style.maxWidth="80%",o.style.textAlign="center",o.style.padding="var(--gap-lg)";const i=document.createElement("h2");i.textContent="Asset load errors",o.appendChild(i);const s=document.createElement("ul");s.style.textAlign="left",s.style.margin="var(--gap-md) 0";for(const r of e){const c=document.createElement("li");c.textContent=r,s.appendChild(c)}o.appendChild(s);const a=document.createElement("button");a.textContent="Reload",a.className="btn",a.addEventListener("click",()=>{location.reload()}),o.appendChild(a),n.appendChild(o),t.appendChild(n)}const un=Math.sqrt(3),fn=2;function it(e){return{width:e*un,height:e*fn}}const hn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3ePlains%20Tile%3c/title%3e%3cdesc%20id='desc'%3eRolling%20plains%20with%20sunrise%20gradients%20and%20glowing%20grasses.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='plains-bg'%20cx='50%25'%20cy='50%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23111827'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='plains-field'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='0%25'%3e%3cstop%20offset='0%25'%20stop-color='%23facc15'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23eab308'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='plains-haze'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23fde68a'%20stop-opacity='0.8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23f59e0b'%20stop-opacity='0.2'%20/%3e%3c/linearGradient%3e%3cfilter%20id='plains-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='5'%20stdDeviation='6'%20flood-color='%23facc15'%20flood-opacity='0.35'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23plains-bg)'%20/%3e%3cg%20filter='url(%23plains-glow)'%3e%3cpath%20d='M16%2088c20-18%2036-22%2048-22s28%204%2048%2022'%20fill='url(%23plains-field)'%20stroke='%23fef9c3'%20stroke-width='2'%20stroke-linecap='round'%20/%3e%3cpath%20d='M24%20102c16-14%2032-18%2040-18s24%204%2040%2018'%20fill='none'%20stroke='%23fde68a'%20stroke-width='5'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M32%2070c12-10%2024-14%2032-14s20%204%2032%2014'%20fill='url(%23plains-haze)'%20opacity='0.7'%20/%3e%3cpath%20d='M52%2078l4%2012m8-12l4%2012m8-12l4%2012'%20stroke='%23fef3c7'%20stroke-width='3'%20stroke-linecap='round'%20opacity='0.8'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='36'%20r='8'%20fill='%23fef08a'%20opacity='0.7'%20/%3e%3c/svg%3e",pn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eForest%20Tile%3c/title%3e%3cdesc%20id='desc'%3eStylised%20evergreen%20trees%20glowing%20against%20a%20deep%20night%20backdrop.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='forest-bg'%20cx='50%25'%20cy='40%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230b1120'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='forest-leaf'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%234ade80'%20/%3e%3cstop%20offset='100%25'%20stop-color='%2315803d'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='forest-trunk'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23a855f7'%20/%3e%3cstop%20offset='100%25'%20stop-color='%237c3aed'%20/%3e%3c/linearGradient%3e%3cfilter%20id='forest-glow'%20x='-40%25'%20y='-40%25'%20width='180%25'%20height='180%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%234ade80'%20flood-opacity='0.25'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23forest-bg)'%20/%3e%3cg%20filter='url(%23forest-glow)'%20stroke='%23bbf7d0'%20stroke-width='2'%3e%3cpath%20fill='url(%23forest-leaf)'%20d='M64%2026L32%2080h18l-12%2022h28l-10-22h16l-10%2022h28l-12-22h18z'%20/%3e%3crect%20x='58'%20y='74'%20width='12'%20height='18'%20rx='3'%20fill='url(%23forest-trunk)'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20stroke-opacity='0.5'%20d='M44%2086c6-4%2012-6%2020-6s14%202%2020%206'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='40'%20r='6'%20fill='%23fef3c7'%20opacity='0.6'%20/%3e%3ccircle%20cx='88'%20cy='32'%20r='4'%20fill='%23fef3c7'%20opacity='0.4'%20/%3e%3c/svg%3e",mn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eMountain%20Tile%3c/title%3e%3cdesc%20id='desc'%3eJagged%20alpine%20peaks%20with%20luminous%20snowcaps.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='mountain-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%23111827'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='mountain-rock'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2364748b'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23334155'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='mountain-snow'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23f8fafc'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23cbd5f5'%20/%3e%3c/linearGradient%3e%3cfilter%20id='mountain-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%23f8fafc'%20flood-opacity='0.2'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23mountain-bg)'%20/%3e%3cg%20filter='url(%23mountain-glow)'%20stroke='%23cbd5f5'%20stroke-width='2'%20stroke-linejoin='round'%3e%3cpath%20fill='url(%23mountain-rock)'%20d='M24%20100l32-52%2014%2022%2012-18%2022%2048z'%20/%3e%3cpath%20fill='url(%23mountain-snow)'%20d='M56%2048l14%2022%2012-18%2010%2022H48z'%20opacity='0.85'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20opacity='0.6'%20d='M32%2094c10-6%2020-9%2032-9s22%203%2032%209'%20/%3e%3c/g%3e%3ccircle%20cx='92'%20cy='32'%20r='6'%20fill='%23f1f5f9'%20opacity='0.5'%20/%3e%3c/svg%3e",gn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eWater%20Tile%3c/title%3e%3cdesc%20id='desc'%3eGlowing%20waves%20surrounding%20a%20crystalline%20droplet.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='water-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230b1120'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='water-wave'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2338bdf8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230ea5e9'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='water-drop'%20x1='50%25'%20y1='0%25'%20x2='50%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23e0f2fe'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230284c7'%20/%3e%3c/linearGradient%3e%3cfilter%20id='water-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='4'%20stdDeviation='8'%20flood-color='%2338bdf8'%20flood-opacity='0.3'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23water-bg)'%20/%3e%3cg%20filter='url(%23water-glow)'%3e%3cpath%20d='M32%2076c12-10%2024-15%2032-15s20%205%2032%2015'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='8'%20stroke-linecap='round'%20/%3e%3cpath%20d='M28%2092c14-12%2030-18%2040-18s26%206%2040%2018'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='6'%20stroke-linecap='round'%20opacity='0.7'%20/%3e%3cpath%20d='M40%2060c10-8%2018-12%2024-12s14%204%2024%2012'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='4'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M64%2030c-12%2020-18%2032-18%2042%200%2011%208%2020%2018%2020s18-9%2018-20c0-10-6-22-18-42z'%20fill='url(%23water-drop)'%20stroke='%23e0f2fe'%20stroke-width='2'%20/%3e%3c/g%3e%3ccircle%20cx='94'%20cy='34'%20r='6'%20fill='%23f8fafc'%20opacity='0.45'%20/%3e%3c/svg%3e",Ge={[q.Plains]:{baseColor:"#d8b869",icon:hn},[q.Forest]:{baseColor:"#237a55",icon:pn},[q.Hills]:{baseColor:"#b57c57",icon:mn},[q.Lake]:{baseColor:"#3185d5",icon:gn}},Oe=new Map;function yn(e){let t=Oe.get(e);if(t||(t=new Image,t.decoding="async",t.src=e,Oe.set(e,t)),t.complete&&t.naturalWidth>0&&t.naturalHeight>0)return t}const Ye="rgba(56, 189, 248, 0.85)",Be="rgba(56, 189, 248, 0.45)";let W=null,U=null;function wn(){if(W&&U)return{stroke:W,glow:U};if(typeof window<"u"){const e=getComputedStyle(document.documentElement),t=e.getPropertyValue("--tile-highlight-ring").trim(),n=e.getPropertyValue("--tile-highlight-glow").trim();W=t||Ye,U=n||Be}else W=Ye,U=Be;return{stroke:W,glow:U}}function vn(e){const t=e.replace("#",""),n=Number.parseInt(t,16),o=n>>16&255,i=n>>8&255,s=n&255;return[o,i,s]}function Fe([e,t,n],[o,i,s],a){const r=Math.min(1,Math.max(0,a)),c=(l,d)=>Math.round(l+(d-l)*r);return`rgb(${c(e,o)}, ${c(t,i)}, ${c(n,s)})`}function ze([e,t,n],o){return`rgba(${e}, ${t}, ${n}, ${o})`}class bn{constructor(t){this.mapRef=t}get hexSize(){return this.mapRef.hexSize}getOrigin(){return $({q:this.mapRef.minQ,r:this.mapRef.minR},this.hexSize)}draw(t,n,o){const{width:i,height:s}=it(this.hexSize),a=this.getOrigin();for(const[r,c]of this.mapRef.tiles){const[l,d]=r.split(",").map(Number),{x:f,y:h}=$({q:l,r:d},this.hexSize),v=f-a.x,u=h-a.y;if(t.save(),c.isFogged&&(t.globalAlpha*=.4),this.drawTerrain(t,c.terrain,v,u,i,s),c.building){const E=n[`building-${c.building}`]??n.placeholder;t.drawImage(E,v,u,i,s)}const g=o&&l===o.q&&d===o.r;this.strokeHex(t,v+this.hexSize,u+this.hexSize,this.hexSize,!!g),t.restore()}}drawToCanvas(t,n,o){const i=t.getContext("2d");if(!i)throw new Error("Canvas 2D context not available");this.draw(i,n,o)}drawTerrain(t,n,o,i,s,a){const r=Ge[n]??Ge[q.Plains],c=vn(r.baseColor),l=this.hexSize,d=o+l,f=i+l;t.save(),this.hexPath(t,o+this.hexSize,i+this.hexSize,l),t.clip();const h=t.createRadialGradient(d,f,l*.2,d,f,l*1.05);h.addColorStop(0,Fe(c,[255,255,255],.3)),h.addColorStop(.7,r.baseColor),h.addColorStop(1,Fe(c,[12,18,28],.4)),t.fillStyle=h,t.shadowColor=ze(c,.35),t.shadowBlur=l*.9,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillRect(o-l*.1,i-l*.1,s+l*.2,a+l*.2),t.globalCompositeOperation="lighter";const v=t.createRadialGradient(d,f,l*.85,d,f,l*1.18);v.addColorStop(0,"rgba(255, 255, 255, 0)"),v.addColorStop(1,ze(c,.18)),t.fillStyle=v,t.fillRect(o-l*.1,i-l*.1,s+l*.2,a+l*.2),t.globalCompositeOperation="source-over",t.restore();const u=yn(r.icon);if(u){const g=Math.min(s,a)*.62,E=d-g/2,S=f-g/2;t.save(),t.globalAlpha*=.92,t.drawImage(u,E,S,g,g),t.restore()}}strokeHex(t,n,o,i,s=!1){const{stroke:a,glow:r}=wn();this.hexPath(t,n,o,i),t.save(),t.lineJoin="round",t.lineCap="round",s?(t.shadowColor=r,t.shadowBlur=i*.65,t.lineWidth=Math.max(2,i*.08),t.strokeStyle=a,t.stroke()):(t.lineWidth=Math.max(1,i*.05),t.strokeStyle="rgba(12, 18, 28, 0.55)",t.stroke()),t.restore()}hexPath(t,n,o,i){t.beginPath();for(let s=0;s<6;s++){const a=Math.PI/180*(60*s-30),r=n+i*Math.cos(a),c=o+i*Math.sin(a);s===0?t.moveTo(r,c):t.lineTo(r,c)}t.closePath()}}function xn(e,t,n,o,i,s){const a=window.devicePixelRatio||1,r=e.canvas.width,c=e.canvas.height;e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,r,c);const l=r/a,d=c/a;e.scale(a,a),e.translate(l/2,d/2),e.scale(b.zoom,b.zoom);const f=t.getOrigin();e.translate(-(b.x-f.x),-(b.y-f.y)),t.draw(e,n,i??void 0);const h=s?.saunojas;h&&Array.isArray(h.units)&&h.units.length>0&&h.draw(e,h.units,{originX:f.x,originY:f.y,hexRadius:t.hexSize}),Sn(e,t,n,o,f),e.restore()}function Sn(e,t,n,o,i){const{width:s,height:a}=it(t.hexSize);for(const r of o){const{x:c,y:l}=$(r.coord,t.hexSize),d=c-i.x,f=l-i.y,h=n[`unit-${r.type}`]??n.placeholder,v=r.getMaxHealth();e.save(),r.stats.health/v<.5&&(e.filter="saturate(0)"),e.drawImage(h,d,f,s,a),an()&&r.faction==="player"&&(e.strokeStyle="rgba(255,255,255,0.5)",e.lineWidth=2,e.strokeRect(d,f,s,a)),e.restore()}}const Xe="/assets/units/saunoja.svg";let F=null,j=null;function we(e){return!!(e&&e.complete&&e.naturalWidth>0&&e.naturalHeight>0)}function Cn(){if(we(F))return Promise.resolve(F);if(j)return j;if(typeof Image>"u")return Promise.reject(new Error("Image constructor is not available in this environment."));const e=new Image;return e.decoding="async",F=e,j=new Promise((t,n)=>{const o=()=>{e.onload=null,e.onerror=null},i=()=>{o(),t(e)};e.onload=i,e.onerror=()=>{o(),F=null,j=null,n(new Error(`Failed to load saunoja icon from ${Xe}`))},e.src=Xe,we(e)&&i()}),j}function En(e,t,{originX:n=0,originY:o=0,hexRadius:i=oe}={}){if(!e||!Array.isArray(t)||t.length===0)return;const s=we(F)?F:null;if(!s)return;const a=Number.isFinite(i)&&i>0?i:oe,r=a*.98,c=[...t].sort((l,d)=>l.coord.r!==d.coord.r?l.coord.r-d.coord.r:l.coord.q!==d.coord.q?l.coord.q-d.coord.q:l.id.localeCompare(d.id));for(const l of c){const{x:d,y:f}=$(l.coord,a),h=d-n,v=f-o,u=h+a,g=v+a;e.save(),K(e,u,g,r),e.clip();const E=a*2.15/Math.max(s.naturalWidth,s.naturalHeight||1),S=s.naturalWidth*E,k=s.naturalHeight*E,N=u-S/2,le=g-k*.72;e.save(),e.filter="grayscale(100%) contrast(112%)",e.globalAlpha*=.96,e.drawImage(s,N,le,S,k),e.restore(),e.save(),e.globalCompositeOperation="multiply";const _=e.createRadialGradient(u,g+r*.38,r*.2,u,g+r*.38,r*1.05);_.addColorStop(0,"rgba(15, 23, 42, 0.55)"),_.addColorStop(1,"rgba(15, 23, 42, 0)"),e.fillStyle=_,e.fillRect(u-r,g-r,r*2,r*2),e.restore(),e.save(),e.globalCompositeOperation="soft-light";const p=e.createLinearGradient(u,g-r,u,g+r);p.addColorStop(0,"rgba(255, 232, 210, 0.18)"),p.addColorStop(.52,"rgba(255, 183, 124, 0.32)"),p.addColorStop(1,"rgba(212, 97, 54, 0.5)"),e.fillStyle=p,e.fillRect(u-r,g-r,r*2,r*2),e.restore(),e.save(),e.globalCompositeOperation="screen",e.globalAlpha=.75;const y=e.createRadialGradient(u,g-r*.68,r*.1,u,g,r*1.12);y.addColorStop(0,"rgba(255, 255, 255, 0.85)"),y.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=y,e.fillRect(u-r,g-r,r*2,r*2),e.restore(),e.restore(),nn(e,{centerX:u,centerY:g-a*.18,radius:a*.94,intensity:l.steam});const T=a*.42,V=g+a*.34;tn(e,{centerX:u,centerY:V,hp:l.hp,maxHp:l.maxHp,radius:T})}}const fe="/autobattles4xfinsauna/",H={gold:`${fe}assets/ui/gold.svg`,resource:`${fe}assets/ui/resource.svg`,sound:`${fe}assets/ui/sound.svg`};let st,D,z=null,I=[];const rt="autobattles:saunojas";function at(){try{return globalThis.localStorage??null}catch{return null}}function kn(){const e=at();if(!e)return[];try{const t=e.getItem(rt);if(!t)return[];const n=JSON.parse(t);if(!Array.isArray(n))return[];const o=[];for(const i of n){if(!i||typeof i!="object")continue;const s=i,a=s.id;if(typeof a!="string"||a.length===0)continue;const r=s.coord,c=r&&typeof r=="object"&&typeof r.q=="number"&&Number.isFinite(r.q)&&typeof r.r=="number"&&Number.isFinite(r.r)?{q:r.q,r:r.r}:void 0;o.push(nt({id:a,name:typeof s.name=="string"?s.name:void 0,coord:c,maxHp:typeof s.maxHp=="number"?s.maxHp:void 0,hp:typeof s.hp=="number"?s.hp:void 0,steam:typeof s.steam=="number"?s.steam:void 0,selected:!!s.selected}))}return o}catch(t){return console.warn("Failed to load Saunoja units from storage",t),[]}}function ve(){const e=at();if(e)try{const t=I.map(n=>({id:n.id,name:n.name,coord:{q:n.coord.q,r:n.coord.r},maxHp:n.maxHp,hp:n.hp,steam:n.steam,selected:n.selected}));e.setItem(rt,JSON.stringify(t))}catch(t){console.warn("Failed to persist Saunoja units",t)}}function Mn(e,t){st=e,D=t,D.classList.add("resource-bar"),D.setAttribute("role","status"),D.setAttribute("aria-live","polite"),D.replaceChildren();const n=document.createElement("img");n.src=H.resource,n.alt="Resources",n.decoding="async",n.classList.add("resource-icon");const o=document.createElement("span");o.textContent="Resources",o.classList.add("resource-label"),z=document.createElement("span"),z.textContent="0",z.classList.add("resource-value"),D.append(n,o,z),Me(L.getResource(G.GOLD))}const An={images:{placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=","building-farm":gt,"building-barracks":yt,"building-city":wt,"building-mine":vt,"unit-soldier":bt,"unit-archer":xt,"unit-raider":St,"icon-gold":H.gold,"icon-resource":H.resource,"icon-sound":H.sound}};let be;const P=new Yt(10,10,32),Pn=new bn(P);P.forEachTile(e=>e.setFogged(!0));It();const L=new Ht(1e3);L.load(P);const Tn=2,In=new Gt(1e3,()=>{L.tick(),L.save();for(const e of O)!e.isDead()&&e.faction==="player"&&P.revealAround(e.coord,Tn);R()}),O=[],ae=on({q:Math.floor(P.width/2),r:Math.floor(P.height/2)});P.revealAround(ae.pos,3);I=kn();if(I.length===0)I.push(nt({id:"saunoja-1",coord:ae.pos,selected:!0})),ve();else{let e=!1,t=!1;for(const n of I)n.selected&&(e?(n.selected=!1,t=!0):e=!0);t&&ve()}const Rn=sn(ae),Ln=rn(L,{saunakunnia:H.resource,sisu:H.resource,gold:H.gold,sound:H.sound}),{log:lt,addEvent:Kn}=cn(L);m.on("sisuPulse",()=>ln(L,O));m.on("sisuPulseStart",()=>tt("sisu"));L.addResource(G.GOLD,200);let ie=null;const he=I.find(e=>e.selected);he&&(ie={q:he.coord.q,r:he.coord.r});function Dn(e,t){return!e||!t?e===t:e.q===t.q&&e.r===t.r}function pe(e){return Dn(ie,e)?!1:(ie=e?{q:e.q,r:e.r}:null,!0)}function me(e){let t=!1;for(const n of I)e&&n===e||n.selected&&(n.selected=!1,t=!0);return t}function ct(e){const t=kt(e.x-P.hexSize,e.y-P.hexSize,P.hexSize),n=I.find(i=>i.coord.q===t.q&&i.coord.r===t.r);let o=!1;if(!n)me()&&(o=!0),pe(null)&&(o=!0);else{const i=!n.selected;n.selected!==i&&(n.selected=i,o=!0),i?(me(n)&&(o=!0),pe(n.coord)&&(o=!0)):(me()&&(o=!0),pe(null)&&(o=!0))}o&&(ve(),R())}function R(){const e=st.getContext("2d");!e||!be||xn(e,Pn,be.images,O,ie,{saunojas:{units:I,draw:En}})}const dt=({resource:e,total:t,amount:n})=>{Me(t);const o=n>0?"+":"";lt(`${e}: ${o}${n}`)};m.on("resourceChanged",dt);const ut=({policy:e})=>{lt(`Policy applied: ${e}`)};m.on("policyApplied",ut);const ft=({unitId:e})=>{const t=O.findIndex(n=>n.id===e);t!==-1&&(O.splice(t,1),R())};m.on("unitDied",ft);function xe(){m.off("resourceChanged",dt),m.off("policyApplied",ut),m.off("unitDied",ft)}async function qn(){Cn().catch(i=>{console.warn("Unable to preload Saunoja icon",i)});const{assets:e,failures:t}=await Rt(An);be=e,t.length&&(console.warn("Failed to load assets",t),dn(t)),Me(L.getResource(G.GOLD)),R();let n=performance.now();function o(i){const s=i-n;n=i,In.tick(s),ae.update(s/1e3,O,a=>{O.push(a),R()}),Rn(),Ln(s),R(),requestAnimationFrame(o)}requestAnimationFrame(o)}function Me(e){z?z.textContent=String(e):D&&(D.textContent=`Resources: ${e}`)}const Hn=.5,Gn=3.5,On=.0015,Yn=10,Bn=250,Se=[];let x=null,Ce=!1,w=null;const C={active:!1,pointerId:null,lastX:0,lastY:0};function Fn(e){return Math.min(Gn,Math.max(Hn,e))}function X(e){Se.push(e)}function Y(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}function zn(e){const t=window.devicePixelRatio||1,n=Math.max(window.innerWidth,1),o=Math.max(window.innerHeight,1);e.style.width=`${n}px`,e.style.height=`${o}px`,e.width=Math.round(n*t),e.height=Math.round(o*t);const i=e.getContext("2d");i&&i.setTransform(1,0,0,1,0,0),R()}function Ee(e,t,n,o,i){const s=e.getBoundingClientRect(),a=t-s.left,r=n-s.top,c=s.width/2,l=s.height/2;return{x:i.x+(a-c)/o,y:i.y+(r-l)/o}}function ht(e,t,n,o=b.zoom,i=b){return Ee(e,t,n,o,i)}function pt(e,t,n,o){const i=Fn(o);if(i===b.zoom)return;const s={x:b.x,y:b.y},a=Ee(e,t,n,b.zoom,s),r=Ee(e,t,n,i,s);b.x+=a.x-r.x,b.y+=a.y-r.y,b.zoom=i,R()}function Ae(e,t){e===0&&t===0||(b.x-=e/b.zoom,b.y-=t/b.zoom,R())}function $e(e){if(!x)return;e.preventDefault();const t=Math.exp(-e.deltaY*On),n=b.zoom*t;pt(x,e.clientX,e.clientY,n)}function Ne(e){x&&(e.pointerType!=="mouse"||e.button!==0||(C.active=!0,C.pointerId=e.pointerId,C.lastX=e.clientX,C.lastY=e.clientY,x.setPointerCapture?.(e.pointerId),x.style.cursor="grabbing"))}function _e(e){if(!x||!C.active||C.pointerId!==e.pointerId)return;const t=e.clientX-C.lastX,n=e.clientY-C.lastY;C.lastX=e.clientX,C.lastY=e.clientY,Ae(t,n)}function B(e){x&&(!C.active||C.pointerId!==e.pointerId||(C.active=!1,C.pointerId=null,x.releasePointerCapture?.(e.pointerId),x.style.cursor=""))}function Xn(e){return!x||e.mode!=="pan"||e.startX==null||e.startY==null||e.moved&&Math.hypot((e.lastX??e.startX)-e.startX,(e.lastY??e.startY)-e.startY)>Yn?!1:Y()-e.startTime<=Bn}function $n(e){if(!x||e.startX==null||e.startY==null)return;const t=ht(x,e.startX,e.startY);ct(t)}function Nn(e){if(!w)return;const t=e.clientX-(w.lastX??e.clientX),n=e.clientY-(w.lastY??e.clientY);Math.hypot(t,n)>1&&(w.moved=!0),w.lastX=e.clientX,w.lastY=e.clientY,Ae(t,n)}function _n(e,t){if(!x)return;const n=(e.clientX+t.clientX)/2,o=(e.clientY+t.clientY)/2,i=Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY);if(w?.lastDistance){const s=i/w.lastDistance,a=b.zoom*s;pt(x,n,o,a)}if(w?.lastCenter){const s=n-w.lastCenter.x,a=o-w.lastCenter.y;Ae(s,a)}w?(w.mode="pinch",w.lastCenter={x:n,y:o},w.lastDistance=i,w.moved=!0):w={mode:"pinch",lastCenter:{x:n,y:o},lastDistance:i,startTime:Y(),moved:!0}}function We(e){if(x){if(e.touches.length===1){const t=e.touches[0];w={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:Y(),moved:!1}}else if(e.touches.length>=2){const[t,n]=[e.touches[0],e.touches[1]];w={mode:"pinch",lastCenter:{x:(t.clientX+n.clientX)/2,y:(t.clientY+n.clientY)/2},lastDistance:Math.hypot(t.clientX-n.clientX,t.clientY-n.clientY),startTime:Y(),moved:!1}}}}function Ue(e){if(!(!x||!w)&&e.touches.length!==0)if(e.preventDefault(),e.touches.length===1){const t=e.touches[0];if(w.mode!=="pan"){const n=w.mode==="pinch";w={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:Y(),moved:n}}Nn(t)}else{const[t,n]=[e.touches[0],e.touches[1]];_n(t,n)}}function Z(e){if(!(!x||!w)){if(e.touches.length===0){Xn(w)&&$n(w),w=null;return}if(e.touches.length===1){const t=e.touches[0],n=w.mode==="pinch";w={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:Y(),moved:n}}else if(e.touches.length>=2){const[t,n]=[e.touches[0],e.touches[1]];w={mode:"pinch",lastCenter:{x:(t.clientX+n.clientX)/2,y:(t.clientY+n.clientY)/2},lastDistance:Math.hypot(t.clientX-n.clientX,t.clientY-n.clientY),startTime:Y(),moved:!0}}}}function je(e){if(!x)return;const t=ht(x,e.clientX,e.clientY);ct(t)}function Wn(e){e.addEventListener("click",je),X(()=>e.removeEventListener("click",je)),e.addEventListener("wheel",$e,{passive:!1}),X(()=>e.removeEventListener("wheel",$e)),e.addEventListener("pointerdown",Ne),e.addEventListener("pointermove",_e),e.addEventListener("pointerup",B),e.addEventListener("pointercancel",B),e.addEventListener("pointerleave",B),X(()=>{e.removeEventListener("pointerdown",Ne),e.removeEventListener("pointermove",_e),e.removeEventListener("pointerup",B),e.removeEventListener("pointercancel",B),e.removeEventListener("pointerleave",B)}),e.addEventListener("touchstart",We,{passive:!1}),e.addEventListener("touchmove",Ue,{passive:!1}),e.addEventListener("touchend",Z),e.addEventListener("touchcancel",Z),X(()=>{e.removeEventListener("touchstart",We),e.removeEventListener("touchmove",Ue),e.removeEventListener("touchend",Z),e.removeEventListener("touchcancel",Z)})}function Un(){for(;Se.length;){const e=Se.pop();try{e?.()}catch(t){console.error("Error during cleanup",t)}}}function jn(){Un(),C.active=!1,C.pointerId=null,x&&(x.style.cursor=""),w=null,x=null,Ce=!1,xe()}function Qn(){const e=document.getElementById("game-canvas"),t=document.getElementById("resource-bar");if(!e||!t)return;Ce&&jn(),x=e,Ce=!0,Mn(e,t),Wn(e);const n=()=>zn(e);window.addEventListener("resize",n),X(()=>window.removeEventListener("resize",n)),window.addEventListener("beforeunload",xe),X(()=>window.removeEventListener("beforeunload",xe)),n(),import.meta.vitest||qn()}import.meta.vitest||Qn();export{G as R,_t as U,tt as p};
