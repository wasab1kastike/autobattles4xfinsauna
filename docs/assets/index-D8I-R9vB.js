(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const xe="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3c/svg%3e",be="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23216e24'%20/%3e%3crect%20x='29'%20y='34'%20width='6'%20height='20'%20fill='%238b4513'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='16'%20fill='%232e8b57'%20/%3e%3c/svg%3e",ke="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23d2b48c'%20/%3e%3cpolygon%20points='0,64%2020,32%2040,64'%20fill='%23c2a070'%20/%3e%3cpolygon%20points='24,64%2044,28%2064,64'%20fill='%23b09060'%20/%3e%3c/svg%3e",Ee="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%2366b3ff'%20/%3e%3ccircle%20cx='32'%20cy='32'%20r='20'%20fill='%231e90ff'%20/%3e%3c/svg%3e",Ce="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3cpolygon%20points='16,48%2032,16%2048,48'%20fill='%23d2691e'%20/%3e%3crect%20x='24'%20y='32'%20width='16'%20height='16'%20fill='%23f4a460'%20/%3e%3c/svg%3e",Se="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23c0c0c0'%20/%3e%3crect%20x='8'%20y='24'%20width='48'%20height='24'%20fill='%23808080'%20/%3e%3crect%20x='24'%20y='16'%20width='16'%20height='8'%20fill='%23606060'%20/%3e%3c/svg%3e",Me="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23e0e0e0'%20/%3e%3crect%20x='10'%20y='22'%20width='12'%20height='30'%20fill='%23a9a9a9'%20/%3e%3crect%20x='26'%20y='14'%20width='12'%20height='38'%20fill='%23808080'%20/%3e%3crect%20x='42'%20y='26'%20width='12'%20height='26'%20fill='%23a9a9a9'%20/%3e%3c/svg%3e",Pe="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b4513'%20/%3e%3cpolygon%20points='32,10%2042,22%2022,22'%20fill='%23555'%20/%3e%3crect%20x='30'%20y='22'%20width='4'%20height='32'%20fill='%23ccc'%20/%3e%3c/svg%3e",Ae="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%234682b4'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='12'%20fill='%23fff'%20/%3e%3crect%20x='28'%20y='36'%20width='8'%20height='16'%20fill='%23fff'%20/%3e%3c/svg%3e",Re="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23556b2f'%20/%3e%3cline%20x1='16'%20y1='16'%20x2='48'%20y2='48'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cpolygon%20points='48,48%2044,36%2036,44'%20fill='%23fff'%20/%3e%3c/svg%3e",Ie="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b0000'%20/%3e%3cline%20x1='18'%20y1='18'%20x2='46'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cline%20x1='46'%20y1='18'%20x2='18'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3c/svg%3e";class Te{listeners=new Map;on(e,t){const n=this.listeners.get(e)??[];n.push(t),this.listeners.set(e,n)}off(e,t){const n=this.listeners.get(e);if(!n)return;const s=n.indexOf(t);s!==-1&&(n.splice(s,1),n.length===0?this.listeners.delete(e):this.listeners.set(e,n))}emit(e,t){const n=this.listeners.get(e);if(n)for(const s of n)s(t)}}const h=new Te;class j{type="farm";cost=50;foodPerTick=1}class oe{type="barracks";cost=100;trainingCapacity=1}const re=Math.sqrt(3),qe=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function q(i,e){return{x:e*re*(i.q+i.r/2),y:e*(3/2)*i.r}}function De(i,e,t){const n=(re/3*i-.3333333333333333*e)/t,s=2/3*e/t;return Be({q:n,r:s})}function K(i){return qe.map(e=>({q:i.q+e.q,r:i.r+e.r}))}function Be(i){let e=i.q,t=i.r,n=-e-t,s=Math.round(e),o=Math.round(n),r=Math.round(t);const a=Math.abs(s-e),l=Math.abs(o-n),c=Math.abs(r-t);return a>l&&a>c?s=-o-r:l>c?o=-s-r:r=-s-o,{q:s,r}}const O=new Set;let $=32;function Le(i){return`${i.q},${i.r}`}function _(i,e){$=e,O.add(Le(i))}function $e(i){if(O.size===0)return{center:{x:0,y:0},zoom:1};const e=$*Math.sqrt(3),t=$*2;let n=1/0,s=1/0,o=-1/0,r=-1/0;for(const y of O){const[w,C]=y.split(",").map(Number),{x:B,y:A}=q({q:w,r:C},$);n=Math.min(n,B),s=Math.min(s,A),o=Math.max(o,B+e),r=Math.max(r,A+t)}const a=o-n,l=r-s,c=96,d={x:n+a/2,y:s+l/2},p=i.width/(a+c*2),u=i.height/(l+c*2),g=Math.min(p,u);return{center:d,zoom:g}}const R={x:0,y:0,zoom:1};function Fe(i,e=300){const t=R.x,n=R.y,s=R.zoom,o=typeof performance<"u"?performance.now():Date.now(),r=a=>{const l=Math.min((a-o)/e,1);R.x=t+(i.center.x-t)*l,R.y=n+(i.center.y-n)*l,R.zoom=s+(i.zoom-s)*l,l<1&&(typeof requestAnimationFrame<"u"?requestAnimationFrame(r):setTimeout(()=>r(typeof performance<"u"?performance.now():Date.now()),16))};typeof requestAnimationFrame<"u"?requestAnimationFrame(r):setTimeout(()=>r(typeof performance<"u"?performance.now():Date.now()),0)}function Oe(){O.clear()}async function ze(i){const e={},t={},n=[],s=Object.entries(i.images??{}).map(([r,a])=>new Promise(l=>{const c=new Image;c.onload=()=>{e[r]=c,l()},c.onerror=()=>{const d=`Failed to load image: ${a}`;console.error(d),n.push(d),l()},c.src=a})),o=Object.entries(i.sounds??{}).map(([r,a])=>new Promise(l=>{const c=new Audio;c.oncanplaythrough=()=>{t[r]=c,l()},c.onerror=()=>{const d=`Failed to load sound: ${a}`;console.error(d),n.push(d),l()},c.src=a,c.load()}));return await Promise.all([...s,...o]),{assets:{images:e,sounds:t},failures:n}}function He(i){const e=localStorage.getItem(i);if(e)try{return JSON.parse(e)}catch(t){console.warn(`Failed to parse data for "${i}", clearing`,t),localStorage.removeItem(i);return}}function Q(i){return`${i.q},${i.r}`}const ae={farm:()=>new j,barracks:()=>new oe};function Ne(i){return ae[i]?.()}var P=(i=>(i.GOLD="gold",i))(P||{});const Ge={gold:1};class Ue{constructor(e,t="gameState"){this.tickInterval=e,this.storageKey=t}resources={gold:0};passiveGeneration={...Ge};lastSaved=Date.now();buildings={};buildingPlacements=new Map;policies=new Set;nightWorkSpeedMultiplier=1;tick(){Object.keys(this.passiveGeneration).forEach(e=>{this.addResource(e,this.passiveGeneration[e])})}save(){this.lastSaved=Date.now();const e={};this.buildingPlacements.forEach((n,s)=>{e[s]=n.type});const t={resources:this.resources,lastSaved:this.lastSaved,buildings:this.buildings,buildingPlacements:e};localStorage.setItem(this.storageKey,JSON.stringify(t))}load(e){const t=He(this.storageKey);if(!t){this.lastSaved=Date.now();return}this.resources={...this.resources,...t.resources};const n={};Object.entries(t.buildings??{}).forEach(([r,a])=>{ae[r]&&(n[r]=a)}),this.buildings=n,this.buildingPlacements.clear(),t.buildingPlacements&&Object.entries(t.buildingPlacements).forEach(([r,a])=>{const l=Ne(a);if(!l)return;this.buildingPlacements.set(r,l);const[c,d]=r.split(",").map(Number);if(e){const p=e.ensureTile(c,d);p.placeBuilding(l.type),p.reveal(),_({q:c,r:d},e.hexSize)}h.emit("buildingPlaced",{building:l,coord:{q:c,r:d},state:this})}),this.lastSaved=t.lastSaved??Date.now();const s=Date.now()-this.lastSaved,o=Math.floor(s/this.tickInterval);Object.keys(this.passiveGeneration).forEach(r=>{this.resources[r]+=o*this.passiveGeneration[r]})}getResource(e){return this.resources[e]}canAfford(e,t="gold"){return this.resources[t]>=e}spend(e,t="gold"){return this.canAfford(e,t)?(this.resources[t]-=e,h.emit("resourceChanged",{resource:t,amount:-e,total:this.resources[t]}),!0):!1}addResource(e,t){this.resources[e]+=t,h.emit("resourceChanged",{resource:e,amount:t,total:this.resources[e]})}modifyPassiveGeneration(e,t){this.passiveGeneration[e]=(this.passiveGeneration[e]??0)+t}construct(e,t,n="gold"){return this.spend(t,n)?(this.buildings[e]=(this.buildings[e]??0)+1,!0):!1}placeBuilding(e,t,n,s="gold"){const o=n.getTile(t.q,t.r);return!o||o.building||!this.construct(e.type,e.cost,s)?!1:(this.buildingPlacements.set(Q(t),e),o.placeBuilding(e.type),h.emit("buildingPlaced",{building:e,coord:t,state:this}),!0)}getBuildingAt(e){return this.buildingPlacements.get(Q(e))}removeBuilding(e,t){const n=Q(e),s=this.buildingPlacements.get(n);return s?(this.buildingPlacements.delete(n),t.getTile(e.q,e.r)?.placeBuilding(null),this.buildings[s.type]!==void 0&&(this.buildings[s.type]-=1,this.buildings[s.type]<=0&&delete this.buildings[s.type]),h.emit("buildingRemoved",{building:s,coord:e,state:this}),!0):!1}upgrade(e,t,n="gold"){return this.construct(`upgrade:${e}`,t,n)}applyPolicy(e,t,n="gold"){return this.spend(t,n)?(this.policies.add(e),h.emit("policyApplied",{policy:e,state:this}),!0):!1}hasPolicy(e){return this.policies.has(e)}}class Qe{constructor(e,t){this.baseInterval=e,this.onTick=t}timer=null;speed=1;lastTick=0;accumulator=0;start(){this.stop(),this.lastTick=Date.now();const e=this.baseInterval/this.speed;this.timer=setInterval(()=>{const t=Date.now(),n=t-this.lastTick;this.lastTick=t,this.onTick(n)},e)}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null)}setSpeed(e){if(e<=0)throw new Error("Speed multiplier must be positive");this.speed=e,this.timer!==null&&this.start()}getSpeed(){return this.speed}getBaseInterval(){return this.baseInterval}tick(e){for(this.accumulator+=e*this.speed;this.accumulator>=this.baseInterval;)this.accumulator-=this.baseInterval,this.onTick(this.baseInterval)}}var z=(i=>(i[i.Plains=0]="Plains",i[i.Forest=1]="Forest",i[i.Hills=2]="Hills",i[i.Lake=3]="Lake",i))(z||{});function We(i,e,t){let n=i*374761393+e*668265263+t*0x14057b7ef7678100;return n=(n^n>>13)*1274126177,n^=n>>16,(n>>>0)/4294967295}function Z(i,e,t=0){const n=We(i,e,t);return n<.1?3:n<.3?1:n<.5?2:0}class ee{constructor(e=z.Plains,t=null,n=!0){this.terrain=e,this.building=t,this.isFogged=n}reveal(){this.isFogged=!1}placeBuilding(e){this.building=e}setFogged(e){this.isFogged=e}}class Ke{constructor(e=10,t=10,n=32,s=0){this.hexSize=n,this.seed=s,this.minQ=0,this.minR=0,this.maxQ=e-1,this.maxR=t-1;for(let o=this.minR;o<=this.maxR;o++)for(let r=this.minQ;r<=this.maxQ;r++)this.tiles.set(this.key(r,o),new ee(Z(r,o,s)))}tiles=new Map;minQ;maxQ;minR;maxR;get width(){return this.maxQ-this.minQ+1}get height(){return this.maxR-this.minR+1}key(e,t){return`${e},${t}`}ensureTile(e,t){const n=this.key(e,t);let s=this.tiles.get(n);return s||(s=new ee(Z(e,t,this.seed)),this.tiles.set(n,s),this.minQ=Math.min(this.minQ,e),this.maxQ=Math.max(this.maxQ,e),this.minR=Math.min(this.minR,t),this.maxR=Math.max(this.maxR,t),s.isFogged||_({q:e,r:t},this.hexSize)),s}getTile(e,t){return this.ensureTile(e,t)}forEachTile(e){for(let t=this.minR;t<=this.maxR;t++)for(let n=this.minQ;n<=this.maxQ;n++){const s=this.ensureTile(n,t);e(s,{q:n,r:t})}}getNeighbors(e,t){return K({q:e,r:t}).map(n=>this.ensureTile(n.q,n.r))}revealAround(e,t){for(let o=-t;o<=t;o++){const r=Math.max(-t,-o-t),a=Math.min(t,-o+t);for(let l=r;l<=a;l++){const c={q:e.q+o,r:e.r+l};this.ensureTile(c.q,c.r).reveal(),_(c,this.hexSize)}}const n=typeof window<"u"?{width:window.innerWidth,height:window.innerHeight}:{width:0,height:0},s=$e(n);Fe(s,300)}draw(e,t,n){const s=this.hexSize*Math.sqrt(3),o=this.hexSize*2,r=q({q:this.minQ,r:this.minR},this.hexSize);for(const[a,l]of this.tiles){const[c,d]=a.split(",").map(Number),{x:p,y:u}=q({q:c,r:d},this.hexSize),g=p-r.x,y=u-r.y;if(e.save(),l.isFogged&&(e.globalAlpha*=.4),this.drawTerrain(e,t,l.terrain,g,y),l.building){const C=t[`building-${l.building}`]??t.placeholder;e.drawImage(C,g,y,s,o)}const w=n&&c===n.q&&d===n.r;this.strokeHex(e,g+this.hexSize,y+this.hexSize,this.hexSize,!!w),e.restore()}}drawToCanvas(e,t,n){const s=e.getContext("2d");if(!s)throw new Error("Canvas 2D context not available");this.draw(s,t,n)}hexPath(e,t,n,s){e.beginPath();for(let o=0;o<6;o++){const r=Math.PI/180*(60*o-30),a=t+s*Math.cos(r),l=n+s*Math.sin(r);o===0?e.moveTo(a,l):e.lineTo(a,l)}e.closePath()}drawTerrain(e,t,n,s,o){const r=this.hexSize*Math.sqrt(3),a=this.hexSize*2,l=`terrain-${z[n].toLowerCase()}`,c=t[l]??t.placeholder;e.drawImage(c,s,o,r,a)}strokeHex(e,t,n,s,o=!1){this.hexPath(e,t,n,s),e.strokeStyle=o?"#ff0000":"#000000",e.stroke()}}const le=({policy:i,state:e})=>{i==="eco"&&(e.modifyPassiveGeneration(P.GOLD,1),h.off("policyApplied",le))},ce=({policy:i,state:e})=>{i==="temperance"&&(e.nightWorkSpeedMultiplier*=1.05,h.off("policyApplied",ce))};h.on("policyApplied",le);h.on("policyApplied",ce);const _e="modulepreload",je=function(i){return"/autobattles4xfinsauna/"+i},te={},Ye=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){let l=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=r?.nonce||r?.getAttribute("nonce");s=l(t.map(c=>{if(c=je(c),c in te)return;te[c]=!0;const d=c.endsWith(".css"),p=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${p}`))return;const u=document.createElement("link");if(u.rel=d?"stylesheet":_e,d||(u.as="script"),u.crossOrigin="",u.href=c,a&&u.setAttribute("nonce",a),document.head.appendChild(u),d)return new Promise((g,y)=>{u.addEventListener("load",g),u.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return s.then(r=>{for(const a of r||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})},Xe=({building:i,coord:e,state:t})=>{i instanceof j?t.modifyPassiveGeneration(P.GOLD,i.foodPerTick):i instanceof oe&&Ye(async()=>{const{spawnUnit:n}=await import("./UnitFactory-ci6BroZ2.js");return{spawnUnit:n}},[]).then(({spawnUnit:n})=>{n(t,"soldier",`barracks-${e.q}-${e.r}`,e,"player")})},Ve=({building:i,state:e})=>{i instanceof j&&e.modifyPassiveGeneration(P.GOLD,-i.foodPerTick)};h.on("buildingPlaced",Xe);h.on("buildingRemoved",Ve);function k(i){return`${i.q},${i.r}`}function Je(i){const[e,t]=i.split(",").map(Number);return{q:e,r:t}}function ne(i,e){const t=-i.q-i.r,n=-e.q-e.r;return Math.max(Math.abs(i.q-e.q),Math.abs(i.r-e.r),Math.abs(t-n))}class Ze{constructor(e,t,n,s,o=[]){this.id=e,this.coord=t,this.faction=n,this.stats=s,this.priorityFactions=o,this.maxHealth=s.health}alive=!0;listeners={};maxHealth;healMarkerElapsed=0;onDeath(e){(this.listeners.death??=[]).push(e)}emitDeath(){for(const e of this.listeners.death??[])e()}isDead(){return!this.alive}getMaxHealth(){return this.maxHealth}distanceTo(e){return ne(this.coord,e)}attack(e){this.distanceTo(e.coord)<=this.stats.attackRange&&e.takeDamage(this.stats.attackDamage,this)}update(e,t){if(!(this.isDead()||!t))if(ne(this.coord,t.pos)<=t.auraRadius){const n=this.stats.health;this.stats.health=Math.min(this.stats.health+t.regenPerSec*e,this.maxHealth),this.stats.health>n&&(this.healMarkerElapsed+=e,this.healMarkerElapsed>=1&&(this.healMarkerElapsed=0,this.spawnHealMarker()))}else this.healMarkerElapsed=0}spawnHealMarker(){if(typeof document>"u")return;const e=document.getElementById("game-canvas");if(!e)return;const{x:t,y:n}=q(this.coord,32),s=document.createElement("div");s.textContent="+",s.className="heal-marker",s.style.position="absolute";const o=e.getBoundingClientRect();s.style.left=`${o.left+t}px`,s.style.top=`${o.top+n}px`,s.style.pointerEvents="none",document.body.appendChild(s),setTimeout(()=>s.remove(),1e3)}takeDamage(e,t){this.stats.health-=e,h.emit("unitDamaged",{attackerId:t?.id,targetId:this.id,amount:e,remainingHealth:this.stats.health}),this.stats.health<=0&&this.alive&&(this.stats.health=0,this.alive=!1,h.emit("unitDied",{unitId:this.id,attackerId:t?.id}),this.emitDeath())}moveTowards(e,t,n){const s=this.findPath(e,t,n);if(s.length<2)return[];let o=0;for(let a=1;a<s.length;a++){const l=k(s[a]);if(n.has(l))break;o=a}if(o===0)return[];const r=Math.min(this.stats.movementRange,o);return s.slice(0,r+1)}findPath(e,t,n){const s=this.coord,o=k(s),r=k(e),a=[s],l=new Map;for(l.set(o,null);a.length>0;){const p=a.shift(),u=k(p);if(u===r)break;for(const g of K(p)){const y=k(g);y!==r&&!this.isPassable(g,t,n)||l.has(y)||(a.push(g),l.set(y,u))}}if(!l.has(r))return[s];const c=[];let d=r;for(;d;)c.push(Je(d)),d=l.get(d)??null;return c.reverse()}seekNearestEnemy(e,t,n){const s=new Map;for(const a of e)s.set(k(a.coord),a);const o=[this.coord],r=new Set([k(this.coord)]);for(;o.length>0;){const a=o.shift(),l=k(a),c=s.get(l);if(c)return c;for(const d of K(a)){const p=k(d),u=s.get(p);if(u)return u;this.isPassable(d,t,n)&&(r.has(p)||(r.add(p),o.push(d)))}}return null}isPassable(e,t,n){const s=t.getTile(e.q,e.r);return!s||n&&n.has(k(e))?!1:s.terrain!==z.Lake}}const et={health:12,attackDamage:4,attackRange:1,movementRange:2};class tt extends Ze{constructor(e,t,n){super(e,t,n,{...et})}}let x=null;const T={};function de(){if(x||typeof window>"u")return x;const i=window.AudioContext||window.webkitAudioContext;if(!i)return console.warn("Web Audio API not supported"),null;try{x=new i}catch(e){return console.warn("Unable to create AudioContext",e),null}if(T.click=nt(),T.spawn=it(),T.error=st(),T.sisu=ot(),x.state==="suspended"){const e=()=>{x?.resume()};window.addEventListener("pointerdown",e,{once:!0})}return x}function H(i,e){const t=x,n=t.createBuffer(1,i,t.sampleRate),s=n.getChannelData(0);for(let o=0;o<i;o++){const r=o/t.sampleRate;s[o]=e(r)}return n}function nt(){return H(Math.floor(x.sampleRate*.05),e=>Math.sin(2*Math.PI*1e3*e)*Math.exp(-40*e))}function it(){return H(Math.floor(x.sampleRate*.2),e=>(Math.sin(2*Math.PI*440*e)+Math.sin(2*Math.PI*660*e))*.5*Math.exp(-6*e))}function st(){return H(Math.floor(x.sampleRate*.3),e=>Math.sin(2*Math.PI*110*e)*Math.exp(-8*e))}function ot(){return H(Math.floor(x.sampleRate*.5),e=>Math.sin(2*Math.PI*880*e)*Math.exp(-2*e))}let N=!1;typeof localStorage<"u"&&(N=localStorage.getItem("sfx-muted")==="true");function ie(){return N}function rt(i){N=i,typeof localStorage<"u"&&localStorage.setItem("sfx-muted",i?"true":"false")}function he(i){if(N)return;const e=de();if(!e)return;const t=T[i];if(!t)return;e.state==="suspended"&&e.resume();const n=e.createBufferSource();n.buffer=t,n.connect(e.destination),n.start()}typeof document<"u"&&document.addEventListener("click",i=>{i.target instanceof HTMLButtonElement&&he("click")});de();function at(i){return{id:"sauna",pos:i,spawnCooldown:30,timer:30,auraRadius:2,regenPerSec:1,rallyToFront:!1,update(e,t,n){if(this.timer-=e,this.timer>0)return;const s=[];for(let o=-2;o<=2;o++){const r=Math.max(-2,-o-2),a=Math.min(2,-o+2);for(let l=r;l<=a;l++){const c=Math.max(Math.abs(o),Math.abs(l),Math.abs(-o-l));if(c===0||c>2)continue;const d={q:this.pos.q+o,r:this.pos.r+l};t.some(u=>!u.isDead()&&u.coord.q===d.q&&u.coord.r===d.r)||s.push(d)}}if(s.length>0){const o=s[Math.floor(Math.random()*s.length)],r=`raider${t.length+1}`,a=new tt(r,o,"player");n(a)}this.timer=this.spawnCooldown}}}function lt(i){const e=document.getElementById("ui-overlay");if(!e)return()=>{};const t=document.createElement("button");t.textContent="Sauna ♨️",e.appendChild(t);const n=document.createElement("div");n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.background="rgba(0,0,0,0.7)",n.style.color="#fff",n.style.padding="8px",n.style.display="none",n.style.minWidth="120px";const s=document.createElement("div");s.style.height="8px",s.style.background="#555";const o=document.createElement("div");o.style.height="100%",o.style.background="#0f0",o.style.width="0%",s.appendChild(o),n.appendChild(s);const r=document.createElement("label"),a=document.createElement("input");return a.type="checkbox",a.checked=i.rallyToFront,a.addEventListener("change",()=>{i.rallyToFront=a.checked}),r.appendChild(a),r.appendChild(document.createTextNode(" Rally to Front")),n.appendChild(r),e.appendChild(n),t.addEventListener("click",()=>{n.style.display=n.style.display==="none"?"block":"none"}),()=>{const l=1-i.timer/i.spawnCooldown;o.style.width=`${Math.max(0,Math.min(l,1))*100}%`,a.checked=i.rallyToFront}}function L(i){const e=document.createElement("div");e.style.position="relative",e.style.marginRight="8px";const t=document.createElement("span");t.textContent=i+": ",e.appendChild(t);const n=document.createElement("span");n.textContent="0",e.appendChild(n);const s=document.createElement("span");return s.style.position="absolute",s.style.right="0",s.style.top="-10px",s.style.opacity="0",s.style.transition="opacity 0.5s",e.appendChild(s),{container:e,value:n,delta:s}}function ct(i){const e=document.getElementById("ui-overlay");if(!e)return()=>{};const t=document.createElement("div");t.id="topbar",t.style.display="flex",t.style.alignItems="center",e.appendChild(t);const n=L("Saunakunnia"),s=L("SISU🔥");s.container.style.display="none";const o=L("Gold"),r=L("Time");r.delta.style.display="none",t.appendChild(n.container),t.appendChild(s.container),t.appendChild(o.container),t.appendChild(r.container);const a=document.createElement("button");a.textContent="SISU",a.addEventListener("click",()=>{h.emit("sisuPulse",{})}),t.appendChild(a);const l=document.createElement("button");function c(){l.textContent=ie()?"Unmute":"Mute"}l.addEventListener("click",()=>{rt(!ie()),c()}),c(),t.appendChild(l),h.on("sisuPulseStart",({remaining:u})=>{a.disabled=!0,s.container.style.display="block",s.value.textContent=String(u)}),h.on("sisuPulseTick",({remaining:u})=>{s.value.textContent=String(u)}),h.on("sisuPulseEnd",()=>{s.container.style.display="none"}),h.on("sisuCooldownEnd",()=>{a.disabled=!1}),o.value.textContent=String(i.getResource(P.GOLD));const d={saunakunnia:n,sisu:s,gold:o};h.on("resourceChanged",({resource:u,amount:g,total:y})=>{const w=d[u];if(!w)return;w.value.textContent=String(y);const C=g>0?"+":"";w.delta.textContent=`${C}${g}`,w.delta.style.opacity="1",setTimeout(()=>{w.delta.style.opacity="0"},1e3)});let p=0;return u=>{p+=u;const g=Math.floor(p/1e3),y=Math.floor(g/60),w=g%60;r.value.textContent=`${y}:${w.toString().padStart(2,"0")}`}}let F=!1,W=!1;function dt(){return F}function ht(i,e){if(F||W)return;F=!0,W=!0;let t=10;h.emit("sisuPulseStart",{remaining:t});const n=[];for(const o of e)o.faction!=="player"||o.isDead()||(n.push({unit:o,move:o.stats.movementRange,attack:o.stats.attackDamage}),o.stats.movementRange*=1.2,o.stats.attackDamage*=1.2,o.fearless=!0);const s=setInterval(()=>{if(t-=1,t>0){h.emit("sisuPulseTick",{remaining:t});return}clearInterval(s),F=!1;for(const o of n)o.unit.stats.movementRange=o.move,o.unit.stats.attackDamage=o.attack,delete o.unit.fearless;h.emit("sisuPulseEnd",{}),setTimeout(()=>{W=!1,h.emit("sisuCooldownEnd",{})},12e4)},1e3)}function ut(i){const e=document.getElementById("ui-overlay");if(!e)return{log:()=>{},addEvent:()=>{}};const t=document.createElement("div");t.id="right-panel",t.style.position="absolute",t.style.top="0",t.style.right="0",t.style.width="240px",t.style.height="100%",t.style.display="flex",t.style.flexDirection="column",t.style.background="rgba(0,0,0,0.5)",t.style.color="#fff",e.appendChild(t);const n=document.createElement("div");n.style.display="flex",t.appendChild(n);const s=document.createElement("div");s.style.flex="1",s.style.overflowY="auto",t.appendChild(s);const o=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div");a.id="event-log",a.style.display="flex",a.style.flexDirection="column";const l={Policies:o,Events:r,Log:a};function c(f){for(const[m,S]of Object.entries(l))S.style.display=m===f?"block":"none";for(const m of n.children){const S=m;S.disabled=S.textContent===f}}for(const f of Object.keys(l)){const m=document.createElement("button");m.textContent=f,m.addEventListener("click",()=>c(f)),n.appendChild(m),s.appendChild(l[f])}const d=[{id:"eco",name:"Eco Policy",description:"Increase gold income by 1",cost:15,prerequisite:()=>!0},{id:"temperance",name:"Temperance",description:"+5% work speed at night",cost:25,prerequisite:()=>!0}],p={};function u(){o.innerHTML="";for(const f of d){const m=document.createElement("button");m.textContent=`${f.name} (${f.cost}g)`,m.title=f.description,m.disabled=!f.prerequisite(i)||i.hasPolicy(f.id),m.addEventListener("click",()=>{i.applyPolicy(f.id,f.cost)&&g()}),o.appendChild(m),o.appendChild(document.createElement("br")),p[f.id]=m}}function g(){for(const f of d){const m=p[f.id];m&&(m.disabled=!f.prerequisite(i)||i.hasPolicy(f.id))}}u(),h.on("resourceChanged",g),h.on("policyApplied",g);const y=[];function w(){r.innerHTML="";for(const f of y){const m=document.createElement("div"),S=document.createElement("h4");S.textContent=f.headline;const V=document.createElement("p");V.textContent=f.body;const U=document.createElement("button");U.textContent=f.buttonText??"Acknowledge",U.addEventListener("click",()=>{const J=y.findIndex(ve=>ve.id===f.id);J!==-1&&(y.splice(J,1),w())}),m.appendChild(S),m.appendChild(V),m.appendChild(U),r.appendChild(m)}}function C(f){y.push(f),w()}const B=100,A=[];let G=!1;function ye(){for(const f of A){const m=document.createElement("div");m.textContent=f,a.appendChild(m)}for(;a.childElementCount>B;)a.removeChild(a.firstChild);a.scrollTop=a.scrollHeight,A.length=0,G=!1}function we(f){A.push(f),G||(G=!0,(typeof requestAnimationFrame=="function"?requestAnimationFrame:m=>setTimeout(m,16))(ye))}return c("Policies"),{log:we,addEvent:C}}function ft(i){const e=document.getElementById("ui-overlay");if(!e)return;const t=document.createElement("div");t.id="error-overlay",t.style.position="absolute",t.style.inset="0",t.style.background="rgba(0, 0, 0, 0.75)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.pointerEvents="auto",t.style.zIndex="1000";const n=document.createElement("div");n.className="card",n.style.background="rgba(20, 20, 20, 0.9)",n.style.color="white",n.style.maxWidth="80%",n.style.textAlign="center",n.style.padding="var(--gap-lg)";const s=document.createElement("h2");s.textContent="Asset load errors",n.appendChild(s);const o=document.createElement("ul");o.style.textAlign="left",o.style.margin="var(--gap-md) 0";for(const a of i){const l=document.createElement("li");l.textContent=a,o.appendChild(l)}n.appendChild(o);const r=document.createElement("button");r.textContent="Reload",r.className="btn",r.addEventListener("click",()=>{location.reload()}),n.appendChild(r),t.appendChild(n),e.appendChild(t)}let b,Y;function se(){const i=window.devicePixelRatio||1;b.style.width=`${window.innerWidth}px`,b.style.height=`${window.innerHeight}px`,b.width=window.innerWidth*i,b.height=window.innerHeight*i;const e=b.getContext("2d");e&&(e.setTransform(1,0,0,1,0,0),e.scale(i,i)),I()}function mt(){const i=document.getElementById("game-canvas"),e=document.getElementById("resource-bar");!i||!e||(b=i,Y=e,window.addEventListener("resize",se),b.addEventListener("click",t=>{const n=b.getBoundingClientRect(),s=t.clientX-n.left-v.hexSize,o=t.clientY-n.top-v.hexSize;fe=De(s,o,v.hexSize),I()}),se(),import.meta.vitest||bt())}const pt={images:{placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=","terrain-plains":xe,"terrain-forest":be,"terrain-hills":ke,"terrain-lake":Ee,"building-farm":Ce,"building-barracks":Se,"building-city":Me,"building-mine":Pe,"unit-soldier":Ae,"unit-archer":Re,"unit-raider":Ie}};let D;const v=new Ke(10,10,32);v.forEachTile(i=>i.setFogged(!0));Oe();const E=new Ue(1e3);E.load(v);const gt=2,yt=new Qe(1e3,()=>{E.tick(),E.save();for(const i of M)!i.isDead()&&i.faction==="player"&&v.revealAround(i.coord,gt);I()}),M=[],X=at({q:Math.floor(v.width/2),r:Math.floor(v.height/2)});v.revealAround(X.pos,3);const wt=lt(X),vt=ct(E),{log:ue,addEvent:kt}=ut(E);h.on("sisuPulse",()=>ht(E,M));h.on("sisuPulseStart",()=>he("sisu"));E.addResource(P.GOLD,200);let fe=null;function I(){const i=b.getContext("2d");if(!i||!D)return;const e=window.devicePixelRatio||1;i.clearRect(0,0,b.width/e,b.height/e),v.draw(i,D.images,fe??void 0),xt(i)}function xt(i){const e=v.hexSize*Math.sqrt(3),t=v.hexSize*2;for(const n of M){const{x:s,y:o}=q(n.coord,v.hexSize),r=D.images[`unit-${n.type}`]??D.images.placeholder,a=n.getMaxHealth();n.stats.health/a<.5&&(i.filter="saturate(0)"),i.drawImage(r,s,o,e,t),i.filter="none",dt()&&n.faction==="player"&&(i.strokeStyle="rgba(255,255,255,0.5)",i.lineWidth=2,i.strokeRect(s,o,e,t))}}const me=({resource:i,total:e,amount:t})=>{Y.textContent=`Resources: ${e}`;const n=t>0?"+":"";ue(`${i}: ${n}${t}`)};h.on("resourceChanged",me);const pe=({policy:i})=>{ue(`Policy applied: ${i}`)};h.on("policyApplied",pe);const ge=({unitId:i})=>{const e=M.findIndex(t=>t.id===i);e!==-1&&(M.splice(e,1),I())};h.on("unitDied",ge);window.addEventListener("beforeunload",()=>{h.off("resourceChanged",me),h.off("policyApplied",pe),h.off("unitDied",ge)});async function bt(){const{assets:i,failures:e}=await ze(pt);D=i,e.length&&(console.warn("Failed to load assets",e),ft(e)),Y.textContent=`Resources: ${E.getResource(P.GOLD)}`,I();let t=performance.now();function n(s){const o=s-t;t=s,yt.tick(o),X.update(o/1e3,M,r=>{M.push(r),I()}),wt(),vt(o),requestAnimationFrame(n)}requestAnimationFrame(n)}window.addEventListener("DOMContentLoaded",mt);export{P as R,Ze as U,he as p};
