(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();class ye{listeners=new Map;on(e,t){const n=this.listeners.get(e)??[];n.push(t),this.listeners.set(e,n)}off(e,t){const n=this.listeners.get(e);if(!n)return;const i=n.indexOf(t);i!==-1&&(n.splice(i,1),n.length===0?this.listeners.delete(e):this.listeners.set(e,n))}emit(e,t){const n=this.listeners.get(e);if(n)for(const i of n)i(t)}}const u=new ye;class V{type="farm";cost=50;foodPerTick=1}class se{type="barracks";cost=100;trainingCapacity=1}function K(s){return`${s.q},${s.r}`}const ve={farm:()=>new V,barracks:()=>new se};function be(s){return ve[s]?.()}var k=(s=>(s.GOLD="gold",s))(k||{});const we={gold:1};class xe{constructor(e,t="gameState"){this.tickInterval=e,this.storageKey=t}resources={gold:0};passiveGeneration={...we};lastSaved=Date.now();buildings={};buildingPlacements=new Map;policies=new Set;nightWorkSpeedMultiplier=1;tick(){Object.keys(this.passiveGeneration).forEach(e=>{this.addResource(e,this.passiveGeneration[e])})}save(){this.lastSaved=Date.now();const e={};this.buildingPlacements.forEach((n,i)=>{e[i]=n.type});const t={resources:this.resources,lastSaved:this.lastSaved,buildings:this.buildings,buildingPlacements:e};localStorage.setItem(this.storageKey,JSON.stringify(t))}load(e){const t=localStorage.getItem(this.storageKey);if(!t){this.lastSaved=Date.now();return}try{const n=JSON.parse(t);this.resources={...this.resources,...n.resources},this.buildings={...n.buildings??{}},this.buildingPlacements.clear(),n.buildingPlacements&&Object.entries(n.buildingPlacements).forEach(([r,a])=>{const c=be(a);if(!c)return;this.buildingPlacements.set(r,c);const[l,d]=r.split(",").map(Number);e&&e.getTile(l,d)?.placeBuilding(c.type),u.emit("buildingPlaced",{building:c,coord:{q:l,r:d},state:this})}),this.lastSaved=n.lastSaved??Date.now();const i=Date.now()-this.lastSaved,o=Math.floor(i/this.tickInterval);Object.keys(this.passiveGeneration).forEach(r=>{this.resources[r]+=o*this.passiveGeneration[r]})}catch{this.lastSaved=Date.now()}}getResource(e){return this.resources[e]}canAfford(e,t="gold"){return this.resources[t]>=e}spend(e,t="gold"){return this.canAfford(e,t)?(this.resources[t]-=e,u.emit("resourceChanged",{resource:t,amount:-e,total:this.resources[t]}),!0):!1}addResource(e,t){this.resources[e]+=t,u.emit("resourceChanged",{resource:e,amount:t,total:this.resources[e]})}modifyPassiveGeneration(e,t){this.passiveGeneration[e]=(this.passiveGeneration[e]??0)+t}construct(e,t,n="gold"){return this.spend(t,n)?(this.buildings[e]=(this.buildings[e]??0)+1,!0):!1}placeBuilding(e,t,n,i="gold"){const o=n.getTile(t.q,t.r);return!o||o.building||!this.construct(e.type,e.cost,i)?!1:(this.buildingPlacements.set(K(t),e),o.placeBuilding(e.type),u.emit("buildingPlaced",{building:e,coord:t,state:this}),!0)}getBuildingAt(e){return this.buildingPlacements.get(K(e))}removeBuilding(e,t){const n=K(e),i=this.buildingPlacements.get(n);return i?(this.buildingPlacements.delete(n),t.getTile(e.q,e.r)?.placeBuilding(null),this.buildings[i.type]!==void 0&&(this.buildings[i.type]-=1,this.buildings[i.type]<=0&&delete this.buildings[i.type]),u.emit("buildingRemoved",{building:i,coord:e,state:this}),!0):!1}upgrade(e,t,n="gold"){return this.construct(`upgrade:${e}`,t,n)}applyPolicy(e,t,n="gold"){return this.spend(t,n)?(this.policies.add(e),u.emit("policyApplied",{policy:e,state:this}),!0):!1}hasPolicy(e){return this.policies.has(e)}}class Se{constructor(e,t){this.baseInterval=e,this.onTick=t}timer=null;speed=1;lastTick=0;accumulator=0;start(){this.stop(),this.lastTick=Date.now();const e=this.baseInterval/this.speed;this.timer=setInterval(()=>{const t=Date.now(),n=t-this.lastTick;this.lastTick=t,this.onTick(n)},e)}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null)}setSpeed(e){if(e<=0)throw new Error("Speed multiplier must be positive");this.speed=e,this.timer!==null&&this.start()}getSpeed(){return this.speed}getBaseInterval(){return this.baseInterval}tick(e){for(this.accumulator+=e*this.speed;this.accumulator>=this.baseInterval;)this.accumulator-=this.baseInterval,this.onTick(this.baseInterval)}}const ie=Math.sqrt(3),ke=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function z(s,e){return{x:e*ie*(s.q+s.r/2),y:e*(3/2)*s.r}}function Ee(s,e,t){const n=(ie/3*s-.3333333333333333*e)/t,i=2/3*e/t;return Ce({q:n,r:i})}function j(s){return ke.map(e=>({q:s.q+e.q,r:s.r+e.r}))}function Ce(s){let e=s.q,t=s.r,n=-e-t,i=Math.round(e),o=Math.round(n),r=Math.round(t);const a=Math.abs(i-e),c=Math.abs(o-n),l=Math.abs(r-t);return a>c&&a>l?i=-o-r:c>l?o=-i-r:r=-i-o,{q:i,r}}var G=(s=>(s[s.Plains=0]="Plains",s[s.Forest=1]="Forest",s[s.Hills=2]="Hills",s[s.Lake=3]="Lake",s))(G||{});function Me(s,e,t){let n=s*374761393+e*668265263+t*0x14057b7ef7678100;return n=(n^n>>13)*1274126177,n^=n>>16,(n>>>0)/4294967295}function Ae(s,e,t=0){const n=Me(s,e,t);return n<.1?3:n<.3?1:n<.5?2:0}function Pe(s,e,t=0){const n=[];for(let i=0;i<e;i++){const o=[];for(let r=0;r<s;r++)o.push(Ae(r,i,t));n.push(o)}return n}class Te{constructor(e=G.Plains,t=null,n=!0){this.terrain=e,this.building=t,this.isFogged=n}reveal(){this.isFogged=!1}placeBuilding(e){this.building=e}setFogged(e){this.isFogged=e}}const $=new Set;let O=32;function qe(s){return`${s.q},${s.r}`}function Ie(s,e){O=e,$.add(qe(s))}function Re(s){if($.size===0)return{center:{x:0,y:0},zoom:1};const e=O*Math.sqrt(3),t=O*2;let n=1/0,i=1/0,o=-1/0,r=-1/0;for(const y of $){const[w,T]=y.split(",").map(Number),{x:D,y:M}=z({q:w,r:T},O);n=Math.min(n,D),i=Math.min(i,M),o=Math.max(o,D+e),r=Math.max(r,M+t)}const a=o-n,c=r-i,l=96,d={x:n+a/2,y:i+c/2},p=s.width/(a+l*2),h=s.height/(c+l*2),g=Math.min(p,h);return{center:d,zoom:g}}const A={x:0,y:0,zoom:1};function De(s,e=300){const t=A.x,n=A.y,i=A.zoom,o=typeof performance<"u"?performance.now():Date.now(),r=a=>{const c=Math.min((a-o)/e,1);A.x=t+(s.center.x-t)*c,A.y=n+(s.center.y-n)*c,A.zoom=i+(s.zoom-i)*c,c<1&&(typeof requestAnimationFrame<"u"?requestAnimationFrame(r):setTimeout(()=>r(typeof performance<"u"?performance.now():Date.now()),16))};typeof requestAnimationFrame<"u"?requestAnimationFrame(r):setTimeout(()=>r(typeof performance<"u"?performance.now():Date.now()),0)}function Le(){$.clear()}class Oe{constructor(e=10,t=10,n=32,i=0){this.width=e,this.height=t,this.hexSize=n,this.tiles=[];const o=Pe(e,t,i);for(let r=0;r<t;r++){const a=[];for(let c=0;c<e;c++)a.push(new Te(o[r][c]));this.tiles.push(a)}}tiles;getTile(e,t){return this.tiles[t]?.[e]}forEachTile(e){for(let t=0;t<this.height;t++)for(let n=0;n<this.width;n++)e(this.tiles[t][n],{q:n,r:t})}getNeighbors(e,t){return j({q:e,r:t}).map(n=>this.getTile(n.q,n.r)).filter(n=>!!n)}revealAround(e,t){for(let o=-t;o<=t;o++){const r=Math.max(-t,-o-t),a=Math.min(t,-o+t);for(let c=r;c<=a;c++){const l={q:e.q+o,r:e.r+c},d=this.getTile(l.q,l.r);d&&(d.reveal(),Ie(l,this.hexSize))}}const n=typeof window<"u"?{width:window.innerWidth,height:window.innerHeight}:{width:0,height:0},i=Re(n);De(i,300)}draw(e,t,n){const i=this.hexSize*Math.sqrt(3),o=this.hexSize*2;this.forEachTile((r,a)=>{const{x:c,y:l}=z(a,this.hexSize);if(e.save(),r.isFogged&&(e.globalAlpha*=.4),this.drawTerrain(e,t,r.terrain,c,l),r.building){const p=t[`building-${r.building}`]??t.placeholder;e.drawImage(p,c,l,i,o)}const d=n&&a.q===n.q&&a.r===n.r;this.strokeHex(e,c+this.hexSize,l+this.hexSize,this.hexSize,!!d),e.restore()})}drawToCanvas(e,t,n){const i=e.getContext("2d");if(!i)throw new Error("Canvas 2D context not available");this.draw(i,t,n)}hexPath(e,t,n,i){e.beginPath();for(let o=0;o<6;o++){const r=Math.PI/180*(60*o-30),a=t+i*Math.cos(r),c=n+i*Math.sin(r);o===0?e.moveTo(a,c):e.lineTo(a,c)}e.closePath()}drawTerrain(e,t,n,i,o){const r=this.hexSize*Math.sqrt(3),a=this.hexSize*2,c=`terrain-${G[n].toLowerCase()}`,l=t[c]??t.placeholder;e.drawImage(l,i,o,r,a)}strokeHex(e,t,n,i,o=!1){this.hexPath(e,t,n,i),e.strokeStyle=o?"#ff0000":"#000000",e.stroke()}}const oe=({policy:s,state:e})=>{s==="eco"&&(e.modifyPassiveGeneration(k.GOLD,1),u.off("policyApplied",oe))},re=({policy:s,state:e})=>{s==="temperance"&&(e.nightWorkSpeedMultiplier*=1.05,u.off("policyApplied",re))};u.on("policyApplied",oe);u.on("policyApplied",re);const Be="modulepreload",$e=function(s){return"/autobattles4xfinsauna/"+s},ee={},Fe=function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){let c=function(l){return Promise.all(l.map(d=>Promise.resolve(d).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=r?.nonce||r?.getAttribute("nonce");i=c(t.map(l=>{if(l=$e(l),l in ee)return;ee[l]=!0;const d=l.endsWith(".css"),p=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${p}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":Be,d||(h.as="script"),h.crossOrigin="",h.href=l,a&&h.setAttribute("nonce",a),document.head.appendChild(h),d)return new Promise((g,y)=>{h.addEventListener("load",g),h.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return i.then(r=>{for(const a of r||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})},ze=({building:s,coord:e,state:t})=>{s instanceof V?t.modifyPassiveGeneration(k.GOLD,s.foodPerTick):s instanceof se&&Fe(async()=>{const{spawnUnit:n}=await Promise.resolve().then(()=>nt);return{spawnUnit:n}},void 0).then(({spawnUnit:n})=>{n(t,"soldier",`barracks-${e.q}-${e.r}`,e,"player")})},Ge=({building:s,state:e})=>{s instanceof V&&e.modifyPassiveGeneration(k.GOLD,-s.foodPerTick)};u.on("buildingPlaced",ze);u.on("buildingRemoved",Ge);function S(s){return`${s.q},${s.r}`}function He(s){const[e,t]=s.split(",").map(Number);return{q:e,r:t}}function te(s,e){const t=-s.q-s.r,n=-e.q-e.r;return Math.max(Math.abs(s.q-e.q),Math.abs(s.r-e.r),Math.abs(t-n))}class X{constructor(e,t,n,i,o=[]){this.id=e,this.coord=t,this.faction=n,this.stats=i,this.priorityFactions=o,this.maxHealth=i.health}alive=!0;listeners={};maxHealth;healMarkerElapsed=0;onDeath(e){(this.listeners.death??=[]).push(e)}emitDeath(){for(const e of this.listeners.death??[])e()}isDead(){return!this.alive}distanceTo(e){return te(this.coord,e)}attack(e){this.distanceTo(e.coord)<=this.stats.attackRange&&e.takeDamage(this.stats.attackDamage,this)}update(e,t){if(!(this.isDead()||!t))if(te(this.coord,t.pos)<=t.auraRadius){const n=this.stats.health;this.stats.health=Math.min(this.stats.health+t.regenPerSec*e,this.maxHealth),this.stats.health>n&&(this.healMarkerElapsed+=e,this.healMarkerElapsed>=1&&(this.healMarkerElapsed=0,this.spawnHealMarker()))}else this.healMarkerElapsed=0}spawnHealMarker(){if(typeof document>"u")return;const e=document.getElementById("game-canvas");if(!e)return;const{x:t,y:n}=z(this.coord,32),i=document.createElement("div");i.textContent="+",i.className="heal-marker",i.style.position="absolute";const o=e.getBoundingClientRect();i.style.left=`${o.left+t}px`,i.style.top=`${o.top+n}px`,i.style.pointerEvents="none",document.body.appendChild(i),setTimeout(()=>i.remove(),1e3)}takeDamage(e,t){this.stats.health-=e,u.emit("unitDamaged",{attackerId:t?.id,targetId:this.id,amount:e,remainingHealth:this.stats.health}),this.stats.health<=0&&this.alive&&(this.stats.health=0,this.alive=!1,u.emit("unitDied",{unitId:this.id,attackerId:t?.id}),this.emitDeath())}moveTowards(e,t,n){const i=this.findPath(e,t,n);if(i.length<2)return[];let o=0;for(let a=1;a<i.length;a++){const c=S(i[a]);if(n.has(c))break;o=a}if(o===0)return[];const r=Math.min(this.stats.movementRange,o);return i.slice(0,r+1)}findPath(e,t,n){const i=this.coord,o=S(i),r=S(e),a=[i],c=new Map;for(c.set(o,null);a.length>0;){const p=a.shift(),h=S(p);if(h===r)break;for(const g of j(p)){const y=S(g);y!==r&&!this.isPassable(g,t,n)||c.has(y)||(a.push(g),c.set(y,h))}}if(!c.has(r))return[i];const l=[];let d=r;for(;d;)l.push(He(d)),d=c.get(d)??null;return l.reverse()}seekNearestEnemy(e,t,n){const i=new Map;for(const a of e)i.set(S(a.coord),a);const o=[this.coord],r=new Set([S(this.coord)]);for(;o.length>0;){const a=o.shift(),c=S(a),l=i.get(c);if(l)return l;for(const d of j(a)){const p=S(d),h=i.get(p);if(h)return h;this.isPassable(d,t,n)&&(r.has(p)||(r.add(p),o.push(d)))}}return null}isPassable(e,t,n){const i=t.getTile(e.q,e.r);return!i||n&&n.has(S(e))?!1:i.terrain!==G.Lake}}const Ne={health:20,attackDamage:5,attackRange:1,movementRange:2},_e=50;class Ue extends X{constructor(e,t,n){super(e,t,n,{...Ne})}}const Ke={health:15,attackDamage:3,attackRange:3,movementRange:2},We=75;class je extends X{constructor(e,t,n){super(e,t,n,{...Ke})}}const Ye={health:12,attackDamage:4,attackRange:1,movementRange:2};class Ve extends X{constructor(e,t,n){super(e,t,n,{...Ye})}}let b=null;const q={};function ae(){if(b||typeof window>"u")return;const s=window.AudioContext||window.webkitAudioContext;s&&(b=new s,q.click=Xe(),q.spawn=Qe(),q.error=Je(),q.sisu=Ze())}function H(s,e){const t=b,n=t.createBuffer(1,s,t.sampleRate),i=n.getChannelData(0);for(let o=0;o<s;o++){const r=o/t.sampleRate;i[o]=e(r)}return n}function Xe(){return H(Math.floor(b.sampleRate*.05),e=>Math.sin(2*Math.PI*1e3*e)*Math.exp(-40*e))}function Qe(){return H(Math.floor(b.sampleRate*.2),e=>(Math.sin(2*Math.PI*440*e)+Math.sin(2*Math.PI*660*e))*.5*Math.exp(-6*e))}function Je(){return H(Math.floor(b.sampleRate*.3),e=>Math.sin(2*Math.PI*110*e)*Math.exp(-8*e))}function Ze(){return H(Math.floor(b.sampleRate*.5),e=>Math.sin(2*Math.PI*880*e)*Math.exp(-2*e))}let N=!1;typeof localStorage<"u"&&(N=localStorage.getItem("sfx-muted")==="true");function ne(){return N}function et(s){N=s,typeof localStorage<"u"&&localStorage.setItem("sfx-muted",s?"true":"false")}function F(s){if(N||(b||ae(),!b))return;const e=q[s];if(!e)return;b.state==="suspended"&&b.resume();const t=b.createBufferSource();t.buffer=e,t.connect(b.destination),t.start()}typeof document<"u"&&document.addEventListener("click",s=>{s.target instanceof HTMLButtonElement&&F("click")});ae();const tt={soldier:_e,archer:We};function ce(s,e,t,n,i){const o=tt[e];if(!s.canAfford(o,k.GOLD))return F("error"),null;s.addResource(k.GOLD,-o);let r=null;switch(e){case"soldier":r=new Ue(t,n,i);break;case"archer":r=new je(t,n,i);break;default:r=null}return r&&F("spawn"),r}const nt=Object.freeze(Object.defineProperty({__proto__:null,spawnUnit:ce},Symbol.toStringTag,{value:"Module"}));class st{constructor(e){this.redraw=e}animations=[];animate(e,t,n=250,i){if(t.length<2)return;const o=n*(t.length-1);this.animations.push({unit:e,path:t,startTime:performance.now(),duration:o,onComplete:i}),this.animations.length===1&&requestAnimationFrame(this.step)}step=e=>{if(this.animations.length===0)return;let t=!1;this.animations=this.animations.filter(n=>{const i=e-n.startTime,o=n.path.length-1,r=Math.min(i/n.duration,1),a=r*o,c=Math.floor(a),l=a-c,d=n.path[c],p=n.path[c+1]??d;return n.unit.coord={q:d.q+(p.q-d.q)*l,r:d.r+(p.r-d.r)*l},t=!0,r>=1?(n.unit.coord=n.path[n.path.length-1],n.onComplete?.(),!1):!0}),t&&this.redraw(),this.animations.length>0&&requestAnimationFrame(this.step)}}async function it(s){const e={},t={},n=[],i=Object.entries(s.images??{}).map(([r,a])=>new Promise(c=>{const l=new Image;l.onload=()=>{e[r]=l,c()},l.onerror=()=>{const d=`Failed to load image: ${a}`;console.error(d),n.push(d),c()},l.src=a})),o=Object.entries(s.sounds??{}).map(([r,a])=>new Promise(c=>{const l=new Audio;l.oncanplaythrough=()=>{t[r]=l,c()},l.onerror=()=>{const d=`Failed to load sound: ${a}`;console.error(d),n.push(d),c()},l.src=a,l.load()}));return await Promise.all([...i,...o]),{assets:{images:e,sounds:t},failures:n}}function ot(s){return{id:"sauna",pos:s,spawnCooldown:30,timer:30,auraRadius:2,regenPerSec:1,rallyToFront:!1,update(e,t,n){if(this.timer-=e,this.timer>0)return;const i=[];for(let o=-2;o<=2;o++){const r=Math.max(-2,-o-2),a=Math.min(2,-o+2);for(let c=r;c<=a;c++){const l=Math.max(Math.abs(o),Math.abs(c),Math.abs(-o-c));if(l===0||l>2)continue;const d={q:this.pos.q+o,r:this.pos.r+c};t.some(h=>!h.isDead()&&h.coord.q===d.q&&h.coord.r===d.r)||i.push(d)}}if(i.length>0){const o=i[Math.floor(Math.random()*i.length)],r=`raider${t.length+1}`,a=new Ve(r,o,"player");n(a)}this.timer=this.spawnCooldown}}}function rt(s){const e=document.getElementById("ui-overlay");if(!e)return()=>{};const t=document.createElement("button");t.textContent="Sauna ♨️",e.appendChild(t);const n=document.createElement("div");n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.background="rgba(0,0,0,0.7)",n.style.color="#fff",n.style.padding="8px",n.style.display="none",n.style.minWidth="120px";const i=document.createElement("div");i.style.height="8px",i.style.background="#555";const o=document.createElement("div");o.style.height="100%",o.style.background="#0f0",o.style.width="0%",i.appendChild(o),n.appendChild(i);const r=document.createElement("label"),a=document.createElement("input");return a.type="checkbox",a.checked=s.rallyToFront,a.addEventListener("change",()=>{s.rallyToFront=a.checked}),r.appendChild(a),r.appendChild(document.createTextNode(" Rally to Front")),n.appendChild(r),e.appendChild(n),t.addEventListener("click",()=>{n.style.display=n.style.display==="none"?"block":"none"}),()=>{const c=1-s.timer/s.spawnCooldown;o.style.width=`${Math.max(0,Math.min(c,1))*100}%`,a.checked=s.rallyToFront}}function L(s){const e=document.createElement("div");e.style.position="relative",e.style.marginRight="8px";const t=document.createElement("span");t.textContent=s+": ",e.appendChild(t);const n=document.createElement("span");n.textContent="0",e.appendChild(n);const i=document.createElement("span");return i.style.position="absolute",i.style.right="0",i.style.top="-10px",i.style.opacity="0",i.style.transition="opacity 0.5s",e.appendChild(i),{container:e,value:n,delta:i}}function at(s){const e=document.getElementById("ui-overlay");if(!e)return()=>{};const t=document.createElement("div");t.id="topbar",t.style.display="flex",t.style.alignItems="center",e.appendChild(t);const n=L("Saunakunnia"),i=L("SISU🔥");i.container.style.display="none";const o=L("Gold"),r=L("Time");r.delta.style.display="none",t.appendChild(n.container),t.appendChild(i.container),t.appendChild(o.container),t.appendChild(r.container);const a=document.createElement("button");a.textContent="SISU",a.addEventListener("click",()=>{u.emit("sisuPulse",{})}),t.appendChild(a);const c=document.createElement("button");function l(){c.textContent=ne()?"Unmute":"Mute"}c.addEventListener("click",()=>{et(!ne()),l()}),l(),t.appendChild(c),u.on("sisuPulseStart",({remaining:h})=>{a.disabled=!0,i.container.style.display="block",i.value.textContent=String(h)}),u.on("sisuPulseTick",({remaining:h})=>{i.value.textContent=String(h)}),u.on("sisuPulseEnd",()=>{i.container.style.display="none"}),u.on("sisuCooldownEnd",()=>{a.disabled=!1}),o.value.textContent=String(s.getResource(k.GOLD));const d={saunakunnia:n,sisu:i,gold:o};u.on("resourceChanged",({resource:h,amount:g,total:y})=>{const w=d[h];if(!w)return;w.value.textContent=String(y);const T=g>0?"+":"";w.delta.textContent=`${T}${g}`,w.delta.style.opacity="1",setTimeout(()=>{w.delta.style.opacity="0"},1e3)});let p=0;return h=>{p+=h;const g=Math.floor(p/1e3),y=Math.floor(g/60),w=g%60;r.value.textContent=`${y}:${w.toString().padStart(2,"0")}`}}let B=!1,W=!1;function ct(){return B}function lt(s,e){if(B||W)return;B=!0,W=!0;let t=10;u.emit("sisuPulseStart",{remaining:t});const n=[];for(const o of e)o.faction!=="player"||o.isDead()||(n.push({unit:o,move:o.stats.movementRange,attack:o.stats.attackDamage}),o.stats.movementRange*=1.2,o.stats.attackDamage*=1.2,o.fearless=!0);const i=setInterval(()=>{if(t-=1,t>0){u.emit("sisuPulseTick",{remaining:t});return}clearInterval(i),B=!1;for(const o of n)o.unit.stats.movementRange=o.move,o.unit.stats.attackDamage=o.attack,delete o.unit.fearless;u.emit("sisuPulseEnd",{}),setTimeout(()=>{W=!1,u.emit("sisuCooldownEnd",{})},12e4)},1e3)}function dt(s){const e=document.getElementById("ui-overlay");if(!e)return{log:()=>{},addEvent:()=>{}};const t=document.createElement("div");t.id="right-panel",t.style.position="absolute",t.style.top="0",t.style.right="0",t.style.width="240px",t.style.height="100%",t.style.display="flex",t.style.flexDirection="column",t.style.background="rgba(0,0,0,0.5)",t.style.color="#fff",e.appendChild(t);const n=document.createElement("div");n.style.display="flex",t.appendChild(n);const i=document.createElement("div");i.style.flex="1",i.style.overflowY="auto",t.appendChild(i);const o=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div");a.id="event-log",a.style.display="flex",a.style.flexDirection="column";const c={Policies:o,Events:r,Log:a};function l(f){for(const[m,C]of Object.entries(c))C.style.display=m===f?"block":"none";for(const m of n.children){const C=m;C.disabled=C.textContent===f}}for(const f of Object.keys(c)){const m=document.createElement("button");m.textContent=f,m.addEventListener("click",()=>l(f)),n.appendChild(m),i.appendChild(c[f])}const d=[{id:"eco",name:"Eco Policy",description:"Increase gold income by 1",cost:15,prerequisite:()=>!0},{id:"temperance",name:"Temperance",description:"+5% work speed at night",cost:25,prerequisite:()=>!0}],p={};function h(){o.innerHTML="";for(const f of d){const m=document.createElement("button");m.textContent=`${f.name} (${f.cost}g)`,m.title=f.description,m.disabled=!f.prerequisite(s)||s.hasPolicy(f.id),m.addEventListener("click",()=>{s.applyPolicy(f.id,f.cost)&&g()}),o.appendChild(m),o.appendChild(document.createElement("br")),p[f.id]=m}}function g(){for(const f of d){const m=p[f.id];m&&(m.disabled=!f.prerequisite(s)||s.hasPolicy(f.id))}}h(),u.on("resourceChanged",g),u.on("policyApplied",g);const y=[];function w(){r.innerHTML="";for(const f of y){const m=document.createElement("div"),C=document.createElement("h4");C.textContent=f.headline;const J=document.createElement("p");J.textContent=f.body;const U=document.createElement("button");U.textContent=f.buttonText??"Acknowledge",U.addEventListener("click",()=>{const Z=y.findIndex(ge=>ge.id===f.id);Z!==-1&&(y.splice(Z,1),w())}),m.appendChild(C),m.appendChild(J),m.appendChild(U),r.appendChild(m)}}function T(f){y.push(f),w()}const D=100,M=[];let _=!1;function pe(){for(const f of M){const m=document.createElement("div");m.textContent=f,a.appendChild(m)}for(;a.childElementCount>D;)a.removeChild(a.firstChild);a.scrollTop=a.scrollHeight,M.length=0,_=!1}function me(f){M.push(f),_||(_=!0,(typeof requestAnimationFrame=="function"?requestAnimationFrame:m=>setTimeout(m,16))(pe))}return l("Policies"),{log:me,addEvent:T}}const I=document.getElementById("game-canvas"),le=document.getElementById("resource-bar"),ut={images:{placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=","terrain-plains":"/assets/sprites/plains.svg","terrain-forest":"/assets/sprites/forest.svg","terrain-hills":"/assets/sprites/hills.svg","terrain-lake":"/assets/sprites/lake.svg","building-farm":"/assets/sprites/farm.svg","building-barracks":"/assets/sprites/barracks.svg","building-city":"/assets/sprites/city.svg","building-mine":"/assets/sprites/mine.svg","unit-soldier":"/assets/sprites/soldier.svg","unit-archer":"/assets/sprites/archer.svg","unit-raider":"/assets/sprites/raider.svg"}};let R;const v=new Oe(10,10,32);v.forEachTile(s=>s.setFogged(!0));Le();const E=new xe(1e3);E.load(v);const ht=2,ft=new Se(1e3,()=>{E.tick(),E.save();for(const s of x)!s.isDead()&&s.faction==="player"&&v.revealAround(s.coord,ht);P()}),pt=new st(P),x=[],Q=ot({q:Math.floor(v.width/2),r:Math.floor(v.height/2)});v.revealAround(Q.pos,3);const mt=rt(Q),gt=at(E),{log:de,addEvent:wt}=dt(E);u.on("sisuPulse",()=>lt(E,x));u.on("sisuPulseStart",()=>F("sisu"));function yt(s,e){const t=`u${x.length+1}`,n=ce(E,s,t,e,"player");n&&x.push(n)}E.addResource(k.GOLD,200);yt("soldier",{q:2,r:2});let Y=null;function P(){const s=I.getContext("2d");!s||!R||(s.clearRect(0,0,I.width,I.height),v.draw(s,R.images,Y??void 0),vt(s))}function vt(s){const e=v.hexSize*Math.sqrt(3),t=v.hexSize*2;for(const n of x){const{x:i,y:o}=z(n.coord,v.hexSize),r=R.images[`unit-${n.type}`]??R.images.placeholder,a=n.maxHealth??n.stats.health;n.stats.health/a<.5&&(s.filter="saturate(0)"),s.drawImage(r,i,o,e,t),s.filter="none",ct()&&n.faction==="player"&&(s.strokeStyle="rgba(255,255,255,0.5)",s.lineWidth=2,s.strokeRect(i,o,e,t))}}I.addEventListener("click",s=>{const e=I.getBoundingClientRect(),t=s.clientX-e.left-v.hexSize,n=s.clientY-e.top-v.hexSize;Y=Ee(t,n,v.hexSize);const i=x[0];if(i){const o=new Set;for(const a of x)a!==i&&!a.isDead()&&o.add(`${a.coord.q},${a.coord.r}`);const r=i.moveTowards(Y,v,o);r.length>0&&pt.animate(i,r)}P()});const ue=({resource:s,total:e,amount:t})=>{le.textContent=`Resources: ${e}`;const n=t>0?"+":"";de(`${s}: ${n}${t}`)};u.on("resourceChanged",ue);const he=({policy:s})=>{de(`Policy applied: ${s}`)};u.on("policyApplied",he);const fe=({unitId:s})=>{const e=x.findIndex(t=>t.id===s);e!==-1&&(x.splice(e,1),P())};u.on("unitDied",fe);window.addEventListener("beforeunload",()=>{u.off("resourceChanged",ue),u.off("policyApplied",he),u.off("unitDied",fe)});async function bt(){const{assets:s,failures:e}=await it(ut);R=s,e.length&&console.warn("Failed to load assets",e),le.textContent=`Resources: ${E.getResource(k.GOLD)}`,P();let t=performance.now();function n(i){const o=i-t;t=i,ft.tick(o),Q.update(o/1e3,x,r=>{x.push(r),P()}),mt(),gt(o),requestAnimationFrame(n)}requestAnimationFrame(n)}import.meta.vitest||bt();
