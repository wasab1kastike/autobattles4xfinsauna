(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const Ct="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3cpolygon%20points='16,48%2032,16%2048,48'%20fill='%23d2691e'%20/%3e%3crect%20x='24'%20y='32'%20width='16'%20height='16'%20fill='%23f4a460'%20/%3e%3c/svg%3e",Et="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23c0c0c0'%20/%3e%3crect%20x='8'%20y='24'%20width='48'%20height='24'%20fill='%23808080'%20/%3e%3crect%20x='24'%20y='16'%20width='16'%20height='8'%20fill='%23606060'%20/%3e%3c/svg%3e",xt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23e0e0e0'%20/%3e%3crect%20x='10'%20y='22'%20width='12'%20height='30'%20fill='%23a9a9a9'%20/%3e%3crect%20x='26'%20y='14'%20width='12'%20height='38'%20fill='%23808080'%20/%3e%3crect%20x='42'%20y='26'%20width='12'%20height='26'%20fill='%23a9a9a9'%20/%3e%3c/svg%3e",kt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b4513'%20/%3e%3cpolygon%20points='32,10%2042,22%2022,22'%20fill='%23555'%20/%3e%3crect%20x='30'%20y='22'%20width='4'%20height='32'%20fill='%23ccc'%20/%3e%3c/svg%3e",Mt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%234682b4'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='12'%20fill='%23fff'%20/%3e%3crect%20x='28'%20y='36'%20width='8'%20height='16'%20fill='%23fff'%20/%3e%3c/svg%3e",At="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23556b2f'%20/%3e%3cline%20x1='16'%20y1='16'%20x2='48'%20y2='48'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cpolygon%20points='48,48%2044,36%2036,44'%20fill='%23fff'%20/%3e%3c/svg%3e",Pt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b0000'%20/%3e%3cline%20x1='18'%20y1='18'%20x2='46'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cline%20x1='46'%20y1='18'%20x2='18'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3c/svg%3e";class Tt{listeners=new Map;on(t,n){const o=this.listeners.get(t)??[];o.push(n),this.listeners.set(t,o)}off(t,n){const o=this.listeners.get(t);if(!o)return;const s=o.indexOf(n);s!==-1&&(o.splice(s,1),o.length===0?this.listeners.delete(t):this.listeners.set(t,o))}emit(t,n){const o=this.listeners.get(t);if(o)for(const s of o)s(n)}}const y=new Tt;class Te{type="farm";cost=50;foodPerTick=1}class tt{type="barracks";cost=100;trainingCapacity=1}const nt=Math.sqrt(3),It=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function Y(e,t){return{x:t*nt*(e.q+e.r/2),y:t*(3/2)*e.r}}function Lt(e,t,n){const o=(nt/3*e-.3333333333333333*t)/n,s=2/3*t/n;return Rt({q:o,r:s})}function Se(e){return It.map(t=>({q:e.q+t.q,r:e.r+t.r}))}function Rt(e){let t=e.q,n=e.r,o=-t-n,s=Math.round(t),i=Math.round(o),r=Math.round(n);const a=Math.abs(s-t),c=Math.abs(i-o),l=Math.abs(r-n);return a>c&&a>l?s=-i-r:c>l?i=-s-r:r=-s-i,{q:s,r}}const re=new Set;let se=32;function Dt(e){return`${e.q},${e.r}`}function Ce(e,t){se=t,re.add(Dt(e))}function qt(e){if(re.size===0)return{center:{x:0,y:0},zoom:1};const t=se*Math.sqrt(3),n=se*2;let o=1/0,s=1/0,i=-1/0,r=-1/0;for(const h of re){const[g,x]=h.split(",").map(Number),{x:C,y:k}=Y({q:g,r:x},se);o=Math.min(o,C),s=Math.min(s,k),i=Math.max(i,C+t),r=Math.max(r,k+n)}const a=i-o,c=r-s,l=96,d={x:o+a/2,y:s+c/2},u=e.width/(a+l*2),f=e.height/(c+l*2),m=Math.min(u,f);return{center:d,zoom:m}}const v={x:0,y:0,zoom:1};function Ht(e,t=300){const n=v.x,o=v.y,s=v.zoom,i=typeof performance<"u"?performance.now():Date.now(),r=a=>{const c=Math.min((a-i)/t,1);v.x=n+(e.center.x-n)*c,v.y=o+(e.center.y-o)*c,v.zoom=s+(e.zoom-s)*c,c<1&&(typeof requestAnimationFrame<"u"?requestAnimationFrame(r):setTimeout(()=>r(typeof performance<"u"?performance.now():Date.now()),16))};typeof requestAnimationFrame<"u"?requestAnimationFrame(r):setTimeout(()=>r(typeof performance<"u"?performance.now():Date.now()),0)}function Ot(){re.clear()}async function Bt(e){const t={},n={},o=[],s=Object.entries(e.images??{}).map(([r,a])=>new Promise(c=>{const l=new Image;l.onload=()=>{t[r]=l,c()},l.onerror=()=>{const d=`Failed to load image: ${a}`;console.error(d),o.push(d),c()},l.src=a})),i=Object.entries(e.sounds??{}).map(([r,a])=>new Promise(c=>{const l=new Audio;l.oncanplaythrough=()=>{n[r]=l,c()},l.onerror=()=>{const d=`Failed to load sound: ${a}`;console.error(d),o.push(d),c()},l.src=a,l.load()}));return await Promise.all([...s,...i]),{assets:{images:t,sounds:n},failures:o}}function Gt(e){const t=localStorage.getItem(e);if(t)try{return JSON.parse(t)}catch(n){console.warn(`Failed to parse data for "${e}", clearing`,n),localStorage.removeItem(e);return}}function me(e){return`${e.q},${e.r}`}const ot={farm:()=>new Te,barracks:()=>new tt};function _t(e){return ot[e]?.()}var B=(e=>(e.GOLD="gold",e))(B||{});const $t={gold:1};class Ft{constructor(t,n="gameState"){this.tickInterval=t,this.storageKey=n}resources={gold:0};passiveGeneration={...$t};lastSaved=Date.now();buildings={};buildingPlacements=new Map;policies=new Set;nightWorkSpeedMultiplier=1;tick(){Object.keys(this.passiveGeneration).forEach(t=>{this.addResource(t,this.passiveGeneration[t])})}save(){this.lastSaved=Date.now();const t={};this.buildingPlacements.forEach((o,s)=>{t[s]=o.type});const n={resources:this.resources,lastSaved:this.lastSaved,buildings:this.buildings,buildingPlacements:t};localStorage.setItem(this.storageKey,JSON.stringify(n))}load(t){const n=Gt(this.storageKey);if(!n){this.lastSaved=Date.now();return}this.resources={...this.resources,...n.resources};const o={};Object.entries(n.buildings??{}).forEach(([r,a])=>{ot[r]&&(o[r]=a)}),this.buildings=o,this.buildingPlacements.clear(),n.buildingPlacements&&Object.entries(n.buildingPlacements).forEach(([r,a])=>{const c=_t(a);if(!c)return;this.buildingPlacements.set(r,c);const[l,d]=r.split(",").map(Number);if(t){const u=t.ensureTile(l,d);u.placeBuilding(c.type),u.reveal(),Ce({q:l,r:d},t.hexSize)}y.emit("buildingPlaced",{building:c,coord:{q:l,r:d},state:this})}),this.lastSaved=n.lastSaved??Date.now();const s=Date.now()-this.lastSaved,i=Math.floor(s/this.tickInterval);Object.keys(this.passiveGeneration).forEach(r=>{this.resources[r]+=i*this.passiveGeneration[r]})}getResource(t){return this.resources[t]}canAfford(t,n="gold"){return this.resources[n]>=t}spend(t,n="gold"){return this.canAfford(t,n)?(this.resources[n]-=t,y.emit("resourceChanged",{resource:n,amount:-t,total:this.resources[n]}),!0):!1}addResource(t,n){this.resources[t]+=n,y.emit("resourceChanged",{resource:t,amount:n,total:this.resources[t]})}modifyPassiveGeneration(t,n){this.passiveGeneration[t]=(this.passiveGeneration[t]??0)+n}construct(t,n,o="gold"){return this.spend(n,o)?(this.buildings[t]=(this.buildings[t]??0)+1,!0):!1}placeBuilding(t,n,o,s="gold"){const i=o.getTile(n.q,n.r);return!i||i.building||!this.construct(t.type,t.cost,s)?!1:(this.buildingPlacements.set(me(n),t),i.placeBuilding(t.type),y.emit("buildingPlaced",{building:t,coord:n,state:this}),!0)}getBuildingAt(t){return this.buildingPlacements.get(me(t))}removeBuilding(t,n){const o=me(t),s=this.buildingPlacements.get(o);return s?(this.buildingPlacements.delete(o),n.getTile(t.q,t.r)?.placeBuilding(null),this.buildings[s.type]!==void 0&&(this.buildings[s.type]-=1,this.buildings[s.type]<=0&&delete this.buildings[s.type]),y.emit("buildingRemoved",{building:s,coord:t,state:this}),!0):!1}upgrade(t,n,o="gold"){return this.construct(`upgrade:${t}`,n,o)}applyPolicy(t,n,o="gold"){return this.spend(n,o)?(this.policies.add(t),y.emit("policyApplied",{policy:t,state:this}),!0):!1}hasPolicy(t){return this.policies.has(t)}}class Nt{constructor(t,n){this.baseInterval=t,this.onTick=n}timer=null;speed=1;lastTick=0;accumulator=0;start(){this.stop(),this.lastTick=Date.now();const t=this.baseInterval/this.speed;this.timer=setInterval(()=>{const n=Date.now(),o=n-this.lastTick;this.lastTick=n,this.onTick(o)},t)}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null)}setSpeed(t){if(t<=0)throw new Error("Speed multiplier must be positive");this.speed=t,this.timer!==null&&this.start()}getSpeed(){return this.speed}getBaseInterval(){return this.baseInterval}tick(t){for(this.accumulator+=t*this.speed;this.accumulator>=this.baseInterval;)this.accumulator-=this.baseInterval,this.onTick(this.baseInterval)}}var H=(e=>(e[e.Plains=0]="Plains",e[e.Forest=1]="Forest",e[e.Hills=2]="Hills",e[e.Lake=3]="Lake",e))(H||{});function zt(e,t,n){let o=e*374761393+t*668265263+n*0x14057b7ef7678100;return o=(o^o>>13)*1274126177,o^=o>>16,(o>>>0)/4294967295}function De(e,t,n=0){const o=zt(e,t,n);return o<.1?3:o<.3?1:o<.5?2:0}class qe{constructor(t=H.Plains,n=null,o=!0){this.terrain=t,this.building=n,this.isFogged=o}reveal(){this.isFogged=!1}placeBuilding(t){this.building=t}setFogged(t){this.isFogged=t}}class Yt{constructor(t=10,n=10,o=32,s=0){this.hexSize=o,this.seed=s,this.minQ=0,this.minR=0,this.maxQ=t-1,this.maxR=n-1;for(let i=this.minR;i<=this.maxR;i++)for(let r=this.minQ;r<=this.maxQ;r++)this.tiles.set(this.key(r,i),new qe(De(r,i,s)))}tiles=new Map;minQ;maxQ;minR;maxR;get width(){return this.maxQ-this.minQ+1}get height(){return this.maxR-this.minR+1}key(t,n){return`${t},${n}`}ensureTile(t,n){const o=this.key(t,n);let s=this.tiles.get(o);return s||(s=new qe(De(t,n,this.seed)),this.tiles.set(o,s),this.minQ=Math.min(this.minQ,t),this.maxQ=Math.max(this.maxQ,t),this.minR=Math.min(this.minR,n),this.maxR=Math.max(this.maxR,n),s.isFogged||Ce({q:t,r:n},this.hexSize)),s}getTile(t,n){return this.ensureTile(t,n)}forEachTile(t){for(let n=this.minR;n<=this.maxR;n++)for(let o=this.minQ;o<=this.maxQ;o++){const s=this.ensureTile(o,n);t(s,{q:o,r:n})}}getNeighbors(t,n){return Se({q:t,r:n}).map(o=>this.ensureTile(o.q,o.r))}revealAround(t,n){for(let i=-n;i<=n;i++){const r=Math.max(-n,-i-n),a=Math.min(n,-i+n);for(let c=r;c<=a;c++){const l={q:t.q+i,r:t.r+c};this.ensureTile(l.q,l.r).reveal(),Ce(l,this.hexSize)}}const o=typeof window<"u"?{width:window.innerWidth,height:window.innerHeight}:{width:0,height:0},s=qt(o);Ht(s,300)}}const st=({policy:e,state:t})=>{e==="eco"&&(t.modifyPassiveGeneration(B.GOLD,1),y.off("policyApplied",st))},it=({policy:e,state:t})=>{e==="temperance"&&(t.nightWorkSpeedMultiplier*=1.05,y.off("policyApplied",it))};y.on("policyApplied",st);y.on("policyApplied",it);const Xt="modulepreload",Ut=function(e){return"/autobattles4xfinsauna/"+e},He={},Wt=function(t,n,o){let s=Promise.resolve();if(n&&n.length>0){let c=function(l){return Promise.all(l.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=r?.nonce||r?.getAttribute("nonce");s=c(n.map(l=>{if(l=Ut(l),l in He)return;He[l]=!0;const d=l.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":Xt,d||(f.as="script"),f.crossOrigin="",f.href=l,a&&f.setAttribute("nonce",a),document.head.appendChild(f),d)return new Promise((m,h)=>{f.addEventListener("load",m),f.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return s.then(r=>{for(const a of r||[])a.status==="rejected"&&i(a.reason);return t().catch(i)})},jt=({building:e,coord:t,state:n})=>{e instanceof Te?n.modifyPassiveGeneration(B.GOLD,e.foodPerTick):e instanceof tt&&Wt(async()=>{const{spawnUnit:o}=await import("./UnitFactory-DrevlHgb.js");return{spawnUnit:o}},[]).then(({spawnUnit:o})=>{o(n,"soldier",`barracks-${t.q}-${t.r}`,t,"player")})},Qt=({building:e,state:t})=>{e instanceof Te&&t.modifyPassiveGeneration(B.GOLD,-e.foodPerTick)};y.on("buildingPlaced",jt);y.on("buildingRemoved",Qt);function P(e){return`${e.q},${e.r}`}function Kt(e){const[t,n]=e.split(",").map(Number);return{q:t,r:n}}function Oe(e,t){const n=-e.q-e.r,o=-t.q-t.r;return Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r),Math.abs(n-o))}class Vt{constructor(t,n,o,s,i=[]){this.id=t,this.coord=n,this.faction=o,this.stats=s,this.priorityFactions=i,this.maxHealth=s.health}alive=!0;listeners={};maxHealth;healMarkerElapsed=0;onDeath(t){(this.listeners.death??=[]).push(t)}emitDeath(){for(const t of this.listeners.death??[])t()}isDead(){return!this.alive}getMaxHealth(){return this.maxHealth}distanceTo(t){return Oe(this.coord,t)}attack(t){this.distanceTo(t.coord)<=this.stats.attackRange&&t.takeDamage(this.stats.attackDamage,this)}update(t,n){if(!(this.isDead()||!n))if(Oe(this.coord,n.pos)<=n.auraRadius){const o=this.stats.health;this.stats.health=Math.min(this.stats.health+n.regenPerSec*t,this.maxHealth),this.stats.health>o&&(this.healMarkerElapsed+=t,this.healMarkerElapsed>=1&&(this.healMarkerElapsed=0,this.spawnHealMarker()))}else this.healMarkerElapsed=0}spawnHealMarker(){if(typeof document>"u")return;const t=document.getElementById("game-canvas");if(!t)return;const{x:n,y:o}=Y(this.coord,32),s=document.createElement("div");s.textContent="+",s.className="heal-marker",s.style.position="absolute";const i=t.getBoundingClientRect();s.style.left=`${i.left+n}px`,s.style.top=`${i.top+o}px`,s.style.pointerEvents="none",document.body.appendChild(s),setTimeout(()=>s.remove(),1e3)}takeDamage(t,n){this.stats.health-=t,y.emit("unitDamaged",{attackerId:n?.id,targetId:this.id,amount:t,remainingHealth:this.stats.health}),this.stats.health<=0&&this.alive&&(this.stats.health=0,this.alive=!1,y.emit("unitDied",{unitId:this.id,attackerId:n?.id}),this.emitDeath())}moveTowards(t,n,o){const s=this.findPath(t,n,o);if(s.length<2)return[];let i=0;for(let a=1;a<s.length;a++){const c=P(s[a]);if(o.has(c))break;i=a}if(i===0)return[];const r=Math.min(this.stats.movementRange,i);return s.slice(0,r+1)}findPath(t,n,o){const s=this.coord,i=P(s),r=P(t),a=[s],c=new Map;for(c.set(i,null);a.length>0;){const u=a.shift(),f=P(u);if(f===r)break;for(const m of Se(u)){const h=P(m);h!==r&&!this.isPassable(m,n,o)||c.has(h)||(a.push(m),c.set(h,f))}}if(!c.has(r))return[s];const l=[];let d=r;for(;d;)l.push(Kt(d)),d=c.get(d)??null;return l.reverse()}seekNearestEnemy(t,n,o){const s=new Map;for(const a of t)s.set(P(a.coord),a);const i=[this.coord],r=new Set([P(this.coord)]);for(;i.length>0;){const a=i.shift(),c=P(a),l=s.get(c);if(l)return l;for(const d of Se(a)){const u=P(d),f=s.get(u);if(f)return f;this.isPassable(d,n,o)&&(r.has(u)||(r.add(u),i.push(d)))}}return null}isPassable(t,n,o){const s=n.getTile(t.q,t.r);return!s||o&&o.has(P(t))?!1:s.terrain!==H.Lake}}const Jt={health:12,attackDamage:4,attackRange:1,movementRange:2};class Zt extends Vt{constructor(t,n,o){super(t,n,o,{...Jt})}}let M=null;const J={};function rt(){if(M||typeof window>"u")return M;const e=window.AudioContext||window.webkitAudioContext;if(!e)return console.warn("Web Audio API not supported"),null;try{M=new e}catch(t){return console.warn("Unable to create AudioContext",t),null}if(J.click=en(),J.spawn=tn(),J.error=nn(),J.sisu=on(),M.state==="suspended"){const t=()=>{M?.resume()};window.addEventListener("pointerdown",t,{once:!0})}return M}function de(e,t){const n=M,o=n.createBuffer(1,e,n.sampleRate),s=o.getChannelData(0);for(let i=0;i<e;i++){const r=i/n.sampleRate;s[i]=t(r)}return o}function en(){return de(Math.floor(M.sampleRate*.05),t=>Math.sin(2*Math.PI*1e3*t)*Math.exp(-40*t))}function tn(){return de(Math.floor(M.sampleRate*.2),t=>(Math.sin(2*Math.PI*440*t)+Math.sin(2*Math.PI*660*t))*.5*Math.exp(-6*t))}function nn(){return de(Math.floor(M.sampleRate*.3),t=>Math.sin(2*Math.PI*110*t)*Math.exp(-8*t))}function on(){return de(Math.floor(M.sampleRate*.5),t=>Math.sin(2*Math.PI*880*t)*Math.exp(-2*t))}let ue=!1;typeof localStorage<"u"&&(ue=localStorage.getItem("sfx-muted")==="true");function Be(){return ue}function sn(e){ue=e,typeof localStorage<"u"&&localStorage.setItem("sfx-muted",e?"true":"false")}function at(e){if(ue)return;const t=rt();if(!t)return;const n=J[e];if(!n)return;t.state==="suspended"&&t.resume();const o=t.createBufferSource();o.buffer=n,o.connect(t.destination),o.start()}typeof document<"u"&&document.addEventListener("click",e=>{e.target instanceof HTMLButtonElement&&at("click")});rt();const rn={q:0,r:0},an="Saunoja",Ge=18,_e=0;function $e(e,t,n){return Math.min(Math.max(e,t),n)}function lt(e){const{id:t,name:n=an,coord:o=rn,maxHp:s=Ge,hp:i=s,steam:r=0,lastHitAt:a=_e,selected:c=!1}=e,l=Number.isFinite(s)?Math.max(1,s):Ge,d=Number.isFinite(i)?i:l,u=$e(d,0,l),f=Number.isFinite(r)?r:0,m=$e(f,0,1),h=Number.isFinite(a)?a:_e,g=Math.max(0,h);return{id:t,name:n,coord:{q:o.q,r:o.r},maxHp:l,hp:u,steam:m,lastHitAt:g,selected:c}}const X=32;function Z(e,t,n,o){e.beginPath();for(let s=0;s<6;s++){const i=Math.PI/3*s,r=t+o*Math.cos(i),a=n+o*Math.sin(i);s===0?e.moveTo(r,a):e.lineTo(r,a)}e.closePath()}function Ie(e,t,n){return Math.min(Math.max(e,t),n)}function ln(e,{centerX:t,centerY:n,hp:o,maxHp:s,radius:i=X*.55}){const r=Number.isFinite(s)?Math.max(1,s):1,a=Number.isFinite(o)?o:r,c=Ie(a/r,0,1);if(e.save(),Z(e,t,n,i),e.fillStyle="rgba(7, 11, 18, 0.72)",e.fill(),e.restore(),c>0){e.save(),Z(e,t,n,i),e.clip();const l=e.createLinearGradient(t,n+i,t,n-i);l.addColorStop(0,"rgba(46, 160, 98, 0.35)"),l.addColorStop(1,"rgba(218, 255, 239, 0.95)"),e.fillStyle=l;const d=i*2*c,u=n+i-d;e.fillRect(t-i,u,i*2,d),e.restore()}e.save(),Z(e,t,n,i),e.lineWidth=Math.max(1,i*.12),e.strokeStyle="rgba(255, 255, 255, 0.28)",e.stroke(),e.restore()}function cn(e,{centerX:t,centerY:n,radius:o=X,progress:s=0}){const i=Ie(s,0,1);if(i<=0)return;const r=Number.isFinite(o)&&o>0?o:X;e.save(),e.globalCompositeOperation="lighter",e.globalAlpha=i;const a=e.createRadialGradient(t,n,Math.max(1,r*.1),t,n,r);a.addColorStop(0,"rgba(255, 255, 255, 0.92)"),a.addColorStop(.45,"rgba(255, 255, 255, 0.68)"),a.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=a,e.beginPath(),e.arc(t,n,r,0,Math.PI*2),e.fill(),e.restore()}function dn(e,{centerX:t,centerY:n,radius:o=X*.85,intensity:s=1}){const i=Ie(s,0,1);if(i<=0)return;e.save(),Z(e,t,n,o),e.clip();const r=e.createLinearGradient(t,n+o,t,n-o);r.addColorStop(0,"rgba(255, 255, 255, 0)"),r.addColorStop(.55,`rgba(255, 255, 255, ${.12*i})`),r.addColorStop(1,`rgba(255, 255, 255, ${.35*i})`),e.globalCompositeOperation="lighter",e.fillStyle=r,e.fillRect(t-o,n-o,o*2,o*2),e.restore(),e.save(),e.globalCompositeOperation="lighter",e.lineCap="round",e.strokeStyle=`rgba(255, 255, 255, ${.25*i})`,e.lineWidth=Math.max(1,o*.08);const a=o*.75,c=o*.35;for(let l=0;l<3;l++){const d=n-o*.5+l*c;e.beginPath(),e.moveTo(t-a,d),e.bezierCurveTo(t-a*.4,d-o*.4,t+a*.4,d+o*.2,t+a,d-o*.45),e.stroke()}e.restore()}function un(e){return{id:"sauna",pos:e,spawnCooldown:30,timer:30,auraRadius:2,regenPerSec:1,rallyToFront:!1,update(t,n,o){if(this.timer-=t,this.timer>0)return;const s=[];for(let i=-2;i<=2;i++){const r=Math.max(-2,-i-2),a=Math.min(2,-i+2);for(let c=r;c<=a;c++){const l=Math.max(Math.abs(i),Math.abs(c),Math.abs(-i-c));if(l===0||l>2)continue;const d={q:this.pos.q+i,r:this.pos.r+c};n.some(f=>!f.isDead()&&f.coord.q===d.q&&f.coord.r===d.r)||s.push(d)}}if(s.length>0){const i=s[Math.floor(Math.random()*s.length)],r=`raider${n.length+1}`,a=new Zt(r,i,"player");o(a)}this.timer=this.spawnCooldown}}}function fn(e){const t=document.getElementById("ui-overlay");if(!t)return()=>{};const n=document.createElement("button");n.textContent="Sauna â™¨ï¸",t.appendChild(n);const o=document.createElement("div");o.style.position="absolute",o.style.left="0",o.style.top="0",o.style.background="rgba(0,0,0,0.7)",o.style.color="#fff",o.style.padding="8px",o.style.display="none",o.style.minWidth="120px";const s=document.createElement("div");s.style.height="8px",s.style.background="#555";const i=document.createElement("div");i.style.height="100%",i.style.background="#0f0",i.style.width="0%",s.appendChild(i),o.appendChild(s);const r=document.createElement("label"),a=document.createElement("input");return a.type="checkbox",a.checked=e.rallyToFront,a.addEventListener("change",()=>{e.rallyToFront=a.checked}),r.appendChild(a),r.appendChild(document.createTextNode(" Rally to Front")),o.appendChild(r),t.appendChild(o),n.addEventListener("click",()=>{o.style.display=o.style.display==="none"?"block":"none"}),()=>{const c=1-e.timer/e.spawnCooldown;i.style.width=`${Math.max(0,Math.min(c,1))*100}%`,a.checked=e.rallyToFront}}function te(e,t){const n=document.createElement("div");if(n.classList.add("topbar-badge"),t){const a=document.createElement("img");a.src=t,a.alt=e,a.decoding="async",a.classList.add("topbar-badge-icon"),n.appendChild(a)}const o=document.createElement("div");o.classList.add("badge-text");const s=document.createElement("span");s.textContent=e,s.classList.add("badge-label"),o.appendChild(s);const i=document.createElement("span");i.textContent="0",i.classList.add("badge-value"),o.appendChild(i);const r=document.createElement("span");return r.classList.add("badge-delta"),r.style.opacity="0",r.style.transform="translateY(-6px)",r.style.transition="opacity 0.5s ease, transform 0.5s ease",n.append(o,r),{container:n,value:i,delta:r}}function hn(e,t={}){const n=document.getElementById("ui-overlay");if(!n)return()=>{};const o=document.createElement("div");o.id="topbar",n.appendChild(o);const s=te("Saunakunnia",t.saunakunnia);s.container.classList.add("badge-sauna");const i=te("SISUðŸ”¥",t.sisu);i.container.classList.add("badge-sisu"),i.container.style.display="none";const r=te("Gold",t.gold);r.container.classList.add("badge-gold");const a=te("Time");a.container.classList.add("badge-time"),a.delta.style.display="none",o.appendChild(s.container),o.appendChild(i.container),o.appendChild(r.container),o.appendChild(a.container);const c=document.createElement("button");c.type="button",c.textContent="SISU",c.classList.add("topbar-button","sisu-button"),c.addEventListener("click",()=>{y.emit("sisuPulse",{})}),o.appendChild(c);const l=document.createElement("button");l.type="button",l.title="Toggle sound",l.classList.add("topbar-button","sound-button");const d=document.createElement("span");if(d.textContent="Sound",t.sound){const h=document.createElement("img");h.src=t.sound,h.alt="",h.decoding="async",h.setAttribute("aria-hidden","true"),l.appendChild(h)}l.appendChild(d);function u(){const h=Be();d.textContent=h?"Muted":"Sound",l.setAttribute("aria-pressed",h?"true":"false"),l.classList.toggle("is-muted",h)}l.addEventListener("click",()=>{sn(!Be()),u()}),u(),o.appendChild(l),y.on("sisuPulseStart",({remaining:h})=>{c.disabled=!0,i.container.style.display="block",i.value.textContent=String(h)}),y.on("sisuPulseTick",({remaining:h})=>{i.value.textContent=String(h)}),y.on("sisuPulseEnd",()=>{i.container.style.display="none"}),y.on("sisuCooldownEnd",()=>{c.disabled=!1}),r.value.textContent=String(e.getResource(B.GOLD));const f={saunakunnia:s,sisu:i,gold:r};y.on("resourceChanged",({resource:h,amount:g,total:x})=>{const C=f[h];if(!C)return;C.value.textContent=String(x);const k=g>0?"+":"";C.delta.textContent=`${k}${g}`,C.delta.style.opacity="1",C.delta.style.transform="translateY(0)",setTimeout(()=>{C.delta.style.opacity="0",C.delta.style.transform="translateY(-6px)"},1e3)});let m=0;return h=>{m+=h;const g=Math.floor(m/1e3),x=Math.floor(g/60),C=g%60;a.value.textContent=`${x}:${C.toString().padStart(2,"0")}`}}let ie=!1,ge=!1;function pn(){return ie}function mn(e,t){if(ie||ge)return;ie=!0,ge=!0;let n=10;y.emit("sisuPulseStart",{remaining:n});const o=[];for(const i of t)i.faction!=="player"||i.isDead()||(o.push({unit:i,move:i.stats.movementRange,attack:i.stats.attackDamage}),i.stats.movementRange*=1.2,i.stats.attackDamage*=1.2,i.fearless=!0);const s=setInterval(()=>{if(n-=1,n>0){y.emit("sisuPulseTick",{remaining:n});return}clearInterval(s),ie=!1;for(const i of o)i.unit.stats.movementRange=i.move,i.unit.stats.attackDamage=i.attack,delete i.unit.fearless;y.emit("sisuPulseEnd",{}),setTimeout(()=>{ge=!1,y.emit("sisuCooldownEnd",{})},12e4)},1e3)}function gn(e){const t=document.getElementById("ui-overlay");if(!t)return{log:()=>{},addEvent:()=>{}};const n=document.createElement("div");n.id="right-panel",n.style.position="absolute",n.style.top="0",n.style.right="0",n.style.width="240px",n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.background="rgba(0,0,0,0.5)",n.style.color="#fff",t.appendChild(n);const o=document.createElement("div");o.style.display="flex",n.appendChild(o);const s=document.createElement("div");s.style.flex="1",s.style.overflowY="auto",n.appendChild(s);const i=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div");a.id="event-log",a.style.display="flex",a.style.flexDirection="column";const c={Policies:i,Events:r,Log:a};function l(p){for(const[w,D]of Object.entries(c))D.style.display=w===p?"block":"none";for(const w of o.children){const D=w;D.disabled=D.textContent===p}}for(const p of Object.keys(c)){const w=document.createElement("button");w.textContent=p,w.addEventListener("click",()=>l(p)),o.appendChild(w),s.appendChild(c[p])}const d=[{id:"eco",name:"Eco Policy",description:"Increase gold income by 1",cost:15,prerequisite:()=>!0},{id:"temperance",name:"Temperance",description:"+5% work speed at night",cost:25,prerequisite:()=>!0}],u={};function f(){i.innerHTML="";for(const p of d){const w=document.createElement("button");w.textContent=`${p.name} (${p.cost}g)`,w.title=p.description,w.disabled=!p.prerequisite(e)||e.hasPolicy(p.id),w.addEventListener("click",()=>{e.applyPolicy(p.id,p.cost)&&m()}),i.appendChild(w),i.appendChild(document.createElement("br")),u[p.id]=w}}function m(){for(const p of d){const w=u[p.id];w&&(w.disabled=!p.prerequisite(e)||e.hasPolicy(p.id))}}f(),y.on("resourceChanged",m),y.on("policyApplied",m);const h=[];function g(){r.innerHTML="";for(const p of h){const w=document.createElement("div"),D=document.createElement("h4");D.textContent=p.headline;const j=document.createElement("p");j.textContent=p.body;const $=document.createElement("button");$.textContent=p.buttonText??"Acknowledge",$.addEventListener("click",()=>{const ee=h.findIndex(pe=>pe.id===p.id);ee!==-1&&(h.splice(ee,1),g())}),w.appendChild(D),w.appendChild(j),w.appendChild($),r.appendChild(w)}}function x(p){h.push(p),g()}const C=100,k=[];let U=!1;function he(){for(const p of k){const w=document.createElement("div");w.textContent=p,a.appendChild(w)}for(;a.childElementCount>C;)a.removeChild(a.firstChild);a.scrollTop=a.scrollHeight,k.length=0,U=!1}function W(p){k.push(p),U||(U=!0,(typeof requestAnimationFrame=="function"?requestAnimationFrame:w=>setTimeout(w,16))(he))}return l("Policies"),{log:W,addEvent:x}}const yn=Math.sqrt(3),wn=2;function ct(e){return{width:e*yn,height:e*wn}}const bn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3ePlains%20Tile%3c/title%3e%3cdesc%20id='desc'%3eRolling%20plains%20with%20sunrise%20gradients%20and%20glowing%20grasses.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='plains-bg'%20cx='50%25'%20cy='50%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23111827'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='plains-field'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='0%25'%3e%3cstop%20offset='0%25'%20stop-color='%23facc15'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23eab308'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='plains-haze'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23fde68a'%20stop-opacity='0.8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23f59e0b'%20stop-opacity='0.2'%20/%3e%3c/linearGradient%3e%3cfilter%20id='plains-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='5'%20stdDeviation='6'%20flood-color='%23facc15'%20flood-opacity='0.35'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23plains-bg)'%20/%3e%3cg%20filter='url(%23plains-glow)'%3e%3cpath%20d='M16%2088c20-18%2036-22%2048-22s28%204%2048%2022'%20fill='url(%23plains-field)'%20stroke='%23fef9c3'%20stroke-width='2'%20stroke-linecap='round'%20/%3e%3cpath%20d='M24%20102c16-14%2032-18%2040-18s24%204%2040%2018'%20fill='none'%20stroke='%23fde68a'%20stroke-width='5'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M32%2070c12-10%2024-14%2032-14s20%204%2032%2014'%20fill='url(%23plains-haze)'%20opacity='0.7'%20/%3e%3cpath%20d='M52%2078l4%2012m8-12l4%2012m8-12l4%2012'%20stroke='%23fef3c7'%20stroke-width='3'%20stroke-linecap='round'%20opacity='0.8'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='36'%20r='8'%20fill='%23fef08a'%20opacity='0.7'%20/%3e%3c/svg%3e",vn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eForest%20Tile%3c/title%3e%3cdesc%20id='desc'%3eStylised%20evergreen%20trees%20glowing%20against%20a%20deep%20night%20backdrop.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='forest-bg'%20cx='50%25'%20cy='40%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230b1120'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='forest-leaf'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%234ade80'%20/%3e%3cstop%20offset='100%25'%20stop-color='%2315803d'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='forest-trunk'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23a855f7'%20/%3e%3cstop%20offset='100%25'%20stop-color='%237c3aed'%20/%3e%3c/linearGradient%3e%3cfilter%20id='forest-glow'%20x='-40%25'%20y='-40%25'%20width='180%25'%20height='180%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%234ade80'%20flood-opacity='0.25'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23forest-bg)'%20/%3e%3cg%20filter='url(%23forest-glow)'%20stroke='%23bbf7d0'%20stroke-width='2'%3e%3cpath%20fill='url(%23forest-leaf)'%20d='M64%2026L32%2080h18l-12%2022h28l-10-22h16l-10%2022h28l-12-22h18z'%20/%3e%3crect%20x='58'%20y='74'%20width='12'%20height='18'%20rx='3'%20fill='url(%23forest-trunk)'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20stroke-opacity='0.5'%20d='M44%2086c6-4%2012-6%2020-6s14%202%2020%206'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='40'%20r='6'%20fill='%23fef3c7'%20opacity='0.6'%20/%3e%3ccircle%20cx='88'%20cy='32'%20r='4'%20fill='%23fef3c7'%20opacity='0.4'%20/%3e%3c/svg%3e",Sn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eMountain%20Tile%3c/title%3e%3cdesc%20id='desc'%3eJagged%20alpine%20peaks%20with%20luminous%20snowcaps.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='mountain-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%23111827'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='mountain-rock'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2364748b'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23334155'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='mountain-snow'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23f8fafc'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23cbd5f5'%20/%3e%3c/linearGradient%3e%3cfilter%20id='mountain-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%23f8fafc'%20flood-opacity='0.2'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23mountain-bg)'%20/%3e%3cg%20filter='url(%23mountain-glow)'%20stroke='%23cbd5f5'%20stroke-width='2'%20stroke-linejoin='round'%3e%3cpath%20fill='url(%23mountain-rock)'%20d='M24%20100l32-52%2014%2022%2012-18%2022%2048z'%20/%3e%3cpath%20fill='url(%23mountain-snow)'%20d='M56%2048l14%2022%2012-18%2010%2022H48z'%20opacity='0.85'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20opacity='0.6'%20d='M32%2094c10-6%2020-9%2032-9s22%203%2032%209'%20/%3e%3c/g%3e%3ccircle%20cx='92'%20cy='32'%20r='6'%20fill='%23f1f5f9'%20opacity='0.5'%20/%3e%3c/svg%3e",Cn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eWater%20Tile%3c/title%3e%3cdesc%20id='desc'%3eGlowing%20waves%20surrounding%20a%20crystalline%20droplet.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='water-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230b1120'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='water-wave'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2338bdf8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230ea5e9'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='water-drop'%20x1='50%25'%20y1='0%25'%20x2='50%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23e0f2fe'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230284c7'%20/%3e%3c/linearGradient%3e%3cfilter%20id='water-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='4'%20stdDeviation='8'%20flood-color='%2338bdf8'%20flood-opacity='0.3'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23water-bg)'%20/%3e%3cg%20filter='url(%23water-glow)'%3e%3cpath%20d='M32%2076c12-10%2024-15%2032-15s20%205%2032%2015'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='8'%20stroke-linecap='round'%20/%3e%3cpath%20d='M28%2092c14-12%2030-18%2040-18s26%206%2040%2018'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='6'%20stroke-linecap='round'%20opacity='0.7'%20/%3e%3cpath%20d='M40%2060c10-8%2018-12%2024-12s14%204%2024%2012'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='4'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M64%2030c-12%2020-18%2032-18%2042%200%2011%208%2020%2018%2020s18-9%2018-20c0-10-6-22-18-42z'%20fill='url(%23water-drop)'%20stroke='%23e0f2fe'%20stroke-width='2'%20/%3e%3c/g%3e%3ccircle%20cx='94'%20cy='34'%20r='6'%20fill='%23f8fafc'%20opacity='0.45'%20/%3e%3c/svg%3e",Fe={[H.Plains]:{baseColor:"#d8b869",icon:bn},[H.Forest]:{baseColor:"#237a55",icon:vn},[H.Hills]:{baseColor:"#b57c57",icon:Sn},[H.Lake]:{baseColor:"#3185d5",icon:Cn}},Ne=new Map;function En(e){let t=Ne.get(e);if(t||(t=new Image,t.decoding="async",t.src=e,Ne.set(e,t)),t.complete&&t.naturalWidth>0&&t.naturalHeight>0)return t}const ze="rgba(56, 189, 248, 0.85)",Ye="rgba(56, 189, 248, 0.45)";let Q=null,K=null;function xn(){if(Q&&K)return{stroke:Q,glow:K};if(typeof window<"u"){const e=getComputedStyle(document.documentElement),t=e.getPropertyValue("--tile-highlight-ring").trim(),n=e.getPropertyValue("--tile-highlight-glow").trim();Q=t||ze,K=n||Ye}else Q=ze,K=Ye;return{stroke:Q,glow:K}}function kn(e){const t=e.replace("#",""),n=Number.parseInt(t,16),o=n>>16&255,s=n>>8&255,i=n&255;return[o,s,i]}function Xe([e,t,n],[o,s,i],r){const a=Math.min(1,Math.max(0,r)),c=(l,d)=>Math.round(l+(d-l)*a);return`rgb(${c(e,o)}, ${c(t,s)}, ${c(n,i)})`}function Ue([e,t,n],o){return`rgba(${e}, ${t}, ${n}, ${o})`}class Mn{constructor(t){this.mapRef=t}get hexSize(){return this.mapRef.hexSize}getOrigin(){return Y({q:this.mapRef.minQ,r:this.mapRef.minR},this.hexSize)}draw(t,n,o){const{width:s,height:i}=ct(this.hexSize),r=this.getOrigin();for(const[a,c]of this.mapRef.tiles){const[l,d]=a.split(",").map(Number),{x:u,y:f}=Y({q:l,r:d},this.hexSize),m=u-r.x,h=f-r.y;if(t.save(),c.isFogged&&(t.globalAlpha*=.4),this.drawTerrain(t,c.terrain,m,h,s,i),c.building){const x=n[`building-${c.building}`]??n.placeholder;t.drawImage(x,m,h,s,i)}const g=o&&l===o.q&&d===o.r;this.strokeHex(t,m+this.hexSize,h+this.hexSize,this.hexSize,!!g),t.restore()}}drawToCanvas(t,n,o){const s=t.getContext("2d");if(!s)throw new Error("Canvas 2D context not available");this.draw(s,n,o)}drawTerrain(t,n,o,s,i,r){const a=Fe[n]??Fe[H.Plains],c=kn(a.baseColor),l=this.hexSize,d=o+l,u=s+l;t.save(),this.hexPath(t,o+this.hexSize,s+this.hexSize,l),t.clip();const f=t.createRadialGradient(d,u,l*.2,d,u,l*1.05);f.addColorStop(0,Xe(c,[255,255,255],.3)),f.addColorStop(.7,a.baseColor),f.addColorStop(1,Xe(c,[12,18,28],.4)),t.fillStyle=f,t.shadowColor=Ue(c,.35),t.shadowBlur=l*.9,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillRect(o-l*.1,s-l*.1,i+l*.2,r+l*.2),t.globalCompositeOperation="lighter";const m=t.createRadialGradient(d,u,l*.85,d,u,l*1.18);m.addColorStop(0,"rgba(255, 255, 255, 0)"),m.addColorStop(1,Ue(c,.18)),t.fillStyle=m,t.fillRect(o-l*.1,s-l*.1,i+l*.2,r+l*.2),t.globalCompositeOperation="source-over",t.restore();const h=En(a.icon);if(h){const g=Math.min(i,r)*.62,x=d-g/2,C=u-g/2;t.save(),t.globalAlpha*=.92,t.drawImage(h,x,C,g,g),t.restore()}}strokeHex(t,n,o,s,i=!1){const{stroke:r,glow:a}=xn();this.hexPath(t,n,o,s),t.save(),t.lineJoin="round",t.lineCap="round",i?(t.shadowColor=a,t.shadowBlur=s*.65,t.lineWidth=Math.max(2,s*.08),t.strokeStyle=r,t.stroke()):(t.lineWidth=Math.max(1,s*.05),t.strokeStyle="rgba(12, 18, 28, 0.55)",t.stroke()),t.restore()}hexPath(t,n,o,s){t.beginPath();for(let i=0;i<6;i++){const r=Math.PI/180*(60*i-30),a=n+s*Math.cos(r),c=o+s*Math.sin(r);i===0?t.moveTo(a,c):t.lineTo(a,c)}t.closePath()}}function An(e,t,n,o,s,i){const r=window.devicePixelRatio||1,a=e.canvas.width,c=e.canvas.height;e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,a,c);const l=a/r,d=c/r;e.scale(r,r),e.translate(l/2,d/2),e.scale(v.zoom,v.zoom);const u=t.getOrigin();e.translate(-(v.x-u.x),-(v.y-u.y)),t.draw(e,n,s??void 0);const f=i?.saunojas;f&&Array.isArray(f.units)&&f.units.length>0&&f.draw(e,f.units,{originX:u.x,originY:u.y,hexRadius:t.hexSize}),Pn(e,t,n,o,u),e.restore()}function Pn(e,t,n,o,s){const{width:i,height:r}=ct(t.hexSize);for(const a of o){const{x:c,y:l}=Y(a.coord,t.hexSize),d=c-s.x,u=l-s.y,f=n[`unit-${a.type}`]??n.placeholder,m=a.getMaxHealth();e.save(),a.stats.health/m<.5&&(e.filter="saturate(0)"),e.drawImage(f,d,u,i,r),pn()&&a.faction==="player"&&(e.strokeStyle="rgba(255,255,255,0.5)",e.lineWidth=2,e.strokeRect(d,u,i,r)),e.restore()}}function Tn(){const e="/autobattles4xfinsauna/";return`${e.endsWith("/")?e:`${e}/`}${"assets/units/saunoja.svg".replace(/^\/+/,"")}`}const We=Tn();let N=null,V=null;function Ee(e){return!!(e&&e.complete&&e.naturalWidth>0&&e.naturalHeight>0)}function In(){if(Ee(N))return Promise.resolve(N);if(V)return V;if(typeof Image>"u")return Promise.reject(new Error("Image constructor is not available in this environment."));const e=new Image;return e.decoding="async",N=e,V=new Promise((t,n)=>{const o=()=>{e.onload=null,e.onerror=null},s=()=>{o(),t(e)};e.onload=s,e.onerror=()=>{o(),N=null,V=null,n(new Error(`Failed to load saunoja icon from ${We}`))},e.src=We,Ee(e)&&s()}),V}function Ln(e,t,{originX:n=0,originY:o=0,hexRadius:s=X}={}){if(!e||!Array.isArray(t)||t.length===0)return;const i=Ee(N)?N:null;if(!i)return;const r=Number.isFinite(s)&&s>0?s:X,a=r*.98,c=[...t].sort((l,d)=>l.coord.r!==d.coord.r?l.coord.r-d.coord.r:l.coord.q!==d.coord.q?l.coord.q-d.coord.q:l.id.localeCompare(d.id));for(const l of c){const{x:d,y:u}=Y(l.coord,r),f=d-n,m=u-o,h=f+r,g=m+r;e.save(),Z(e,h,g,a),e.clip();const x=r*2.15/Math.max(i.naturalWidth,i.naturalHeight||1),C=i.naturalWidth*x,k=i.naturalHeight*x,U=h-C/2,he=g-k*.72;e.save(),e.filter="grayscale(100%) contrast(112%)",e.globalAlpha*=.96,e.drawImage(i,U,he,C,k),e.restore(),e.save(),e.globalCompositeOperation="multiply";const W=e.createRadialGradient(h,g+a*.38,a*.2,h,g+a*.38,a*1.05);W.addColorStop(0,"rgba(15, 23, 42, 0.55)"),W.addColorStop(1,"rgba(15, 23, 42, 0)"),e.fillStyle=W,e.fillRect(h-a,g-a,a*2,a*2),e.restore(),e.save(),e.globalCompositeOperation="soft-light";const p=e.createLinearGradient(h,g-a,h,g+a);p.addColorStop(0,"rgba(255, 232, 210, 0.18)"),p.addColorStop(.52,"rgba(255, 183, 124, 0.32)"),p.addColorStop(1,"rgba(212, 97, 54, 0.5)"),e.fillStyle=p,e.fillRect(h-a,g-a,a*2,a*2),e.restore(),e.save(),e.globalCompositeOperation="screen",e.globalAlpha=.75;const w=e.createRadialGradient(h,g-a*.68,a*.1,h,g,a*1.12);w.addColorStop(0,"rgba(255, 255, 255, 0.85)"),w.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=w,e.fillRect(h-a,g-a,a*2,a*2),e.restore();const j=performance.now()-l.lastHitAt,$=120;if(j<$){const St=1-j/$;cn(e,{centerX:h,centerY:g,radius:a,progress:St})}e.restore(),dn(e,{centerX:h,centerY:g-r*.18,radius:r*.94,intensity:l.steam});const ee=r*.42,pe=g+r*.34;ln(e,{centerX:h,centerY:pe,hp:l.hp,maxHp:l.maxHp,radius:ee})}}const ye="/autobattles4xfinsauna/",O={gold:`${ye}assets/ui/gold.svg`,resource:`${ye}assets/ui/resource.svg`,sound:`${ye}assets/ui/sound.svg`};let dt,q,z=null,I=[];const ut="autobattles:saunojas";function ft(){try{return globalThis.localStorage??null}catch{return null}}function Rn(){const e=ft();if(!e)return[];try{const t=e.getItem(ut);if(!t)return[];const n=JSON.parse(t);if(!Array.isArray(n))return[];const o=[];for(const s of n){if(!s||typeof s!="object")continue;const i=s,r=i.id;if(typeof r!="string"||r.length===0)continue;const a=i.coord,c=a&&typeof a=="object"&&typeof a.q=="number"&&Number.isFinite(a.q)&&typeof a.r=="number"&&Number.isFinite(a.r)?{q:a.q,r:a.r}:void 0;o.push(lt({id:r,name:typeof i.name=="string"?i.name:void 0,coord:c,maxHp:typeof i.maxHp=="number"?i.maxHp:void 0,hp:typeof i.hp=="number"?i.hp:void 0,steam:typeof i.steam=="number"?i.steam:void 0,selected:!!i.selected}))}return o}catch(t){return console.warn("Failed to load Saunoja units from storage",t),[]}}function xe(){const e=ft();if(e)try{const t=I.map(n=>({id:n.id,name:n.name,coord:{q:n.coord.q,r:n.coord.r},maxHp:n.maxHp,hp:n.hp,steam:n.steam,selected:n.selected}));e.setItem(ut,JSON.stringify(t))}catch(t){console.warn("Failed to persist Saunoja units",t)}}function Dn(e,t){dt=e,q=t,q.classList.add("resource-bar"),q.setAttribute("role","status"),q.setAttribute("aria-live","polite"),q.replaceChildren();const n=document.createElement("img");n.src=O.resource,n.alt="Resources",n.decoding="async",n.classList.add("resource-icon");const o=document.createElement("span");o.textContent="Resources",o.classList.add("resource-label"),z=document.createElement("span"),z.textContent="0",z.classList.add("resource-value"),q.append(n,o,z),Le(R.getResource(B.GOLD))}const qn={images:{placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=","building-farm":Ct,"building-barracks":Et,"building-city":xt,"building-mine":kt,"unit-soldier":Mt,"unit-archer":At,"unit-raider":Pt,"icon-gold":O.gold,"icon-resource":O.resource,"icon-sound":O.sound}};let ae=null;function Hn(e){ae=e}const T=new Yt(10,10,32),On=new Mn(T);T.forEachTile(e=>e.setFogged(!0));Ot();const R=new Ft(1e3);R.load(T);const Bn=2,Gn=new Nt(1e3,()=>{R.tick(),R.save();for(const e of G)!e.isDead()&&e.faction==="player"&&T.revealAround(e.coord,Bn);L()}),G=[],fe=un({q:Math.floor(T.width/2),r:Math.floor(T.height/2)});T.revealAround(fe.pos,3);I=Rn();if(I.length===0)I.push(lt({id:"saunoja-1",coord:fe.pos,selected:!0})),xe();else{let e=!1,t=!1;for(const n of I)n.selected&&(e?(n.selected=!1,t=!0):e=!0);t&&xe()}const _n=fn(fe),$n=hn(R,{saunakunnia:O.resource,sisu:O.resource,gold:O.gold,sound:O.sound}),{log:ht,addEvent:fo}=gn(R);y.on("sisuPulse",()=>mn(R,G));y.on("sisuPulseStart",()=>at("sisu"));R.addResource(B.GOLD,200);let le=null;const we=I.find(e=>e.selected);we&&(le={q:we.coord.q,r:we.coord.r});function Fn(e,t){return!e||!t?e===t:e.q===t.q&&e.r===t.r}function be(e){return Fn(le,e)?!1:(le=e?{q:e.q,r:e.r}:null,!0)}function ve(e){let t=!1;for(const n of I)e&&n===e||n.selected&&(n.selected=!1,t=!0);return t}function pt(e){const t=Lt(e.x-T.hexSize,e.y-T.hexSize,T.hexSize),n=I.find(s=>s.coord.q===t.q&&s.coord.r===t.r);let o=!1;if(!n)ve()&&(o=!0),be(null)&&(o=!0);else{const s=!n.selected;n.selected!==s&&(n.selected=s,o=!0),s?(ve(n)&&(o=!0),be(n.coord)&&(o=!0)):(ve()&&(o=!0),be(null)&&(o=!0))}o&&(xe(),L())}function L(){const e=dt.getContext("2d");!e||!ae||An(e,On,ae.images,G,le,{saunojas:{units:I,draw:Ln}})}const mt=({resource:e,total:t,amount:n})=>{Le(t);const o=n>0?"+":"";ht(`${e}: ${o}${n}`)};y.on("resourceChanged",mt);const gt=({policy:e})=>{ht(`Policy applied: ${e}`)};y.on("policyApplied",gt);const yt=({unitId:e})=>{const t=G.findIndex(n=>n.id===e);t!==-1&&(G.splice(t,1),L())};y.on("unitDied",yt);function ke(){y.off("resourceChanged",mt),y.off("policyApplied",gt),y.off("unitDied",yt)}function Nn(){if(!ae){console.error("Cannot start game without loaded assets.");return}Le(R.getResource(B.GOLD)),L();let e=performance.now();function t(n){const o=n-e;e=n,Gn.tick(o),fe.update(o/1e3,G,s=>{G.push(s),L()}),_n(),$n(o),L(),requestAnimationFrame(t)}requestAnimationFrame(t)}function Le(e){z?z.textContent=String(e):q&&(q.textContent=`Resources: ${e}`)}async function zn(e){const t=Object.entries(e),n=await Promise.allSettled(t.map(([r,a])=>a.load().then(c=>({key:r,descriptor:a,value:c})))),o={},s=[],i=[];return n.forEach((r,a)=>{const[c,l]=t[a],d=l.label??String(c);if(r.status==="fulfilled"){const{value:f}=r.value;if(o[c]=f.value,f.warnings?.length)for(const m of f.warnings)s.push(d?`${d}: ${m}`:m);if(f.errors?.length)for(const m of f.errors)i.push(d?`${d}: ${m}`:m);return}const u=Yn(r.reason);i.push(d?`${d}: ${u}`:u)}),{resources:o,warnings:s,errors:i}}function Yn(e){if(e instanceof Error)return e.message;if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}const Xn=.5,Un=3.5,Wn=.0015,jn=10,Qn=250;function Kn(){if(typeof document>"u")return;const e=document.querySelector("[data-build-commit]");if(!e)return;const t="8bb582f".trim(),n=t.length>0&&t!=="unknown",o=n?`#${t}`:"DEV BUILD";e.textContent=o,e.dataset.state=n?"commit":"dev";const s=e.closest("#build-id");if(s){const i=n?`Build commit ${t}`:"Development build";s.setAttribute("aria-label",i),s.title=n?`Autobattles build ${t}`:"Unversioned development build",s.dataset.buildState=n?"release":"development"}}Kn();const Me=[];let ce=0,S=null,Ae=!1,b=null;const E={active:!1,pointerId:null,lastX:0,lastY:0};function Vn(e){return Math.min(Un,Math.max(Xn,e))}function A(e){Me.push(e)}function _(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}function Jn(e){const t=window.devicePixelRatio||1,n=Math.max(window.innerWidth,1),o=Math.max(window.innerHeight,1);e.style.width=`${n}px`,e.style.height=`${o}px`,e.width=Math.round(n*t),e.height=Math.round(o*t);const s=e.getContext("2d");s&&s.setTransform(1,0,0,1,0,0),L()}function Pe(e,t,n,o,s){const i=e.getBoundingClientRect(),r=t-i.left,a=n-i.top,c=i.width/2,l=i.height/2;return{x:s.x+(r-c)/o,y:s.y+(a-l)/o}}function wt(e,t,n,o=v.zoom,s=v){return Pe(e,t,n,o,s)}function bt(e,t,n,o){const s=Vn(o);if(s===v.zoom)return;const i={x:v.x,y:v.y},r=Pe(e,t,n,v.zoom,i),a=Pe(e,t,n,s,i);v.x+=r.x-a.x,v.y+=r.y-a.y,v.zoom=s,L()}function Re(e,t){e===0&&t===0||(v.x-=e/v.zoom,v.y-=t/v.zoom,L())}function je(e){if(!S)return;e.preventDefault();const t=Math.exp(-e.deltaY*Wn),n=v.zoom*t;bt(S,e.clientX,e.clientY,n)}function Qe(e){S&&(e.pointerType!=="mouse"||e.button!==0||(E.active=!0,E.pointerId=e.pointerId,E.lastX=e.clientX,E.lastY=e.clientY,S.setPointerCapture?.(e.pointerId),S.style.cursor="grabbing"))}function Ke(e){if(!S||!E.active||E.pointerId!==e.pointerId)return;const t=e.clientX-E.lastX,n=e.clientY-E.lastY;E.lastX=e.clientX,E.lastY=e.clientY,Re(t,n)}function F(e){S&&(!E.active||E.pointerId!==e.pointerId||(E.active=!1,E.pointerId=null,S.releasePointerCapture?.(e.pointerId),S.style.cursor=""))}function Zn(e){return!S||e.mode!=="pan"||e.startX==null||e.startY==null||e.moved&&Math.hypot((e.lastX??e.startX)-e.startX,(e.lastY??e.startY)-e.startY)>jn?!1:_()-e.startTime<=Qn}function eo(e){if(!S||e.startX==null||e.startY==null)return;const t=wt(S,e.startX,e.startY);pt(t)}function to(e){if(!b)return;const t=e.clientX-(b.lastX??e.clientX),n=e.clientY-(b.lastY??e.clientY);Math.hypot(t,n)>1&&(b.moved=!0),b.lastX=e.clientX,b.lastY=e.clientY,Re(t,n)}function no(e,t){if(!S)return;const n=(e.clientX+t.clientX)/2,o=(e.clientY+t.clientY)/2,s=Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY);if(b?.lastDistance){const i=s/b.lastDistance,r=v.zoom*i;bt(S,n,o,r)}if(b?.lastCenter){const i=n-b.lastCenter.x,r=o-b.lastCenter.y;Re(i,r)}b?(b.mode="pinch",b.lastCenter={x:n,y:o},b.lastDistance=s,b.moved=!0):b={mode:"pinch",lastCenter:{x:n,y:o},lastDistance:s,startTime:_(),moved:!0}}function Ve(e){if(S){if(e.touches.length===1){const t=e.touches[0];b={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:_(),moved:!1}}else if(e.touches.length>=2){const[t,n]=[e.touches[0],e.touches[1]];b={mode:"pinch",lastCenter:{x:(t.clientX+n.clientX)/2,y:(t.clientY+n.clientY)/2},lastDistance:Math.hypot(t.clientX-n.clientX,t.clientY-n.clientY),startTime:_(),moved:!1}}}}function Je(e){if(!(!S||!b)&&e.touches.length!==0)if(e.preventDefault(),e.touches.length===1){const t=e.touches[0];if(b.mode!=="pan"){const n=b.mode==="pinch";b={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:_(),moved:n}}to(t)}else{const[t,n]=[e.touches[0],e.touches[1]];no(t,n)}}function ne(e){if(!(!S||!b)){if(e.touches.length===0){Zn(b)&&eo(b),b=null;return}if(e.touches.length===1){const t=e.touches[0],n=b.mode==="pinch";b={mode:"pan",lastX:t.clientX,lastY:t.clientY,startX:t.clientX,startY:t.clientY,startTime:_(),moved:n}}else if(e.touches.length>=2){const[t,n]=[e.touches[0],e.touches[1]];b={mode:"pinch",lastCenter:{x:(t.clientX+n.clientX)/2,y:(t.clientY+n.clientY)/2},lastDistance:Math.hypot(t.clientX-n.clientX,t.clientY-n.clientY),startTime:_(),moved:!0}}}}function Ze(e){if(!S)return;const t=wt(S,e.clientX,e.clientY);pt(t)}function oo(e){e.addEventListener("click",Ze),A(()=>e.removeEventListener("click",Ze)),e.addEventListener("wheel",je,{passive:!1}),A(()=>e.removeEventListener("wheel",je)),e.addEventListener("pointerdown",Qe),e.addEventListener("pointermove",Ke),e.addEventListener("pointerup",F),e.addEventListener("pointercancel",F),e.addEventListener("pointerleave",F),A(()=>{e.removeEventListener("pointerdown",Qe),e.removeEventListener("pointermove",Ke),e.removeEventListener("pointerup",F),e.removeEventListener("pointercancel",F),e.removeEventListener("pointerleave",F)}),e.addEventListener("touchstart",Ve,{passive:!1}),e.addEventListener("touchmove",Je,{passive:!1}),e.addEventListener("touchend",ne),e.addEventListener("touchcancel",ne),A(()=>{e.removeEventListener("touchstart",Ve),e.removeEventListener("touchmove",Je),e.removeEventListener("touchend",ne),e.removeEventListener("touchcancel",ne)})}function so(){for(;Me.length;){const e=Me.pop();try{e?.()}catch(t){console.error("Error during cleanup",t)}}}function io(){ce+=1,so(),E.active=!1,E.pointerId=null,S&&(S.style.cursor=""),b=null,S=null,Ae=!1,ro(),ke()}function ro(){document.querySelectorAll(".hud-loader").forEach(e=>{e.remove()}),document.querySelectorAll(".hud-banner-stack").forEach(e=>{e.remove()})}function ao(e="Heating the sauna stonesâ€¦"){const t=document.getElementById("ui-overlay");if(!t)return{update:()=>{},clear:()=>{},dispose:()=>{}};const n=document.createElement("div");n.className="hud-loader",n.setAttribute("role","status"),n.setAttribute("aria-live","polite");const o=document.createElement("div");o.className="hud-loader__card";const s=document.createElement("div");s.className="hud-loader__spinner",s.setAttribute("aria-hidden","true");const i=document.createElement("p");i.className="hud-loader__message",i.textContent=e,o.append(s,i),n.append(o),t.append(n);let r=!1;return{update(a){i.textContent=a},clear(){r||vt(n,"hud-loader--hidden",()=>{r=!0,n.remove()})},dispose(){r||(r=!0,n.remove())}}}function oe(e,t){const n=lo();if(!n)return null;const o=document.createElement("section");o.className=`hud-banner hud-banner--${e}`,o.setAttribute("role",e==="error"?"alert":"status"),o.setAttribute("aria-live",e==="error"?"assertive":"polite");const s=document.createElement("header");s.className="hud-banner__header";const i=document.createElement("p");i.className="hud-banner__title",i.textContent=t.title??(e==="error"?"Attention required":e==="warning"?"Heads up":"Status update"),s.append(i);const r=document.createElement("ul");r.className="hud-banner__list";for(const d of t.messages){const u=document.createElement("li");u.textContent=d,r.append(u)}if(o.append(s),t.messages.length&&o.append(r),t.actions?.length){const d=document.createElement("div");d.className="hud-banner__actions";for(const u of t.actions){const f=document.createElement("button");f.type="button",f.className=u.variant==="secondary"?"hud-banner__button hud-banner__button--secondary":"hud-banner__button",f.textContent=u.label,f.addEventListener("click",()=>{u.onClick()}),d.append(f)}o.append(d)}let a,c=!1;const l=()=>{c||(c=!0,a&&window.clearTimeout(a),vt(o,"hud-banner--hide",()=>{o.remove(),n.hasChildNodes()||n.remove()}))};if(t.dismissible!==!1){const d=document.createElement("button");d.type="button",d.className="hud-banner__close",d.setAttribute("aria-label","Dismiss notification"),d.textContent="Ã—",d.addEventListener("click",()=>{l()}),s.append(d)}return n.append(o),t.autoCloseMs&&t.autoCloseMs>0&&(a=window.setTimeout(()=>l(),t.autoCloseMs)),{element:o,dismiss:l}}function lo(){const e=document.getElementById("ui-overlay");if(!e)return null;let t=e.querySelector(".hud-banner-stack");return t||(t=document.createElement("div"),t.className="hud-banner-stack",e.append(t)),t}function vt(e,t,n){let o=!1;const s=()=>{o||(o=!0,e.removeEventListener("transitionend",s),n())};e.addEventListener("transitionend",s),requestAnimationFrame(()=>{e.classList.add(t)}),window.setTimeout(s,400)}function et(e){if(e instanceof Error&&e.message)return e.message;if(typeof e=="string"&&e.trim().length>0)return e;try{return JSON.stringify(e)}catch{return String(e)}}async function co(e){const t=ao("Heating the sauna stonesâ€¦");A(()=>t.dispose());try{const{resources:n,warnings:o,errors:s}=await zn({assets:{label:"Core assets",load:async()=>{const r=await Bt(qn);return{value:r.assets,errors:r.failures}}},saunojaIcon:{label:"Saunoja icon",load:async()=>{try{return{value:await In()}}catch(r){return{value:null,warnings:[`Unable to preload Saunoja icon (${et(r)})`]}}}}});if(e!==ce){t.dispose();return}t.update("Polishing sauna ambienceâ€¦"),t.clear();const i=n.assets;if(!i){const r=s.length?[...s]:["Critical assets were unavailable. Please refresh to try again."];console.error("Critical assets failed to load",r);const a=oe("error",{title:"Unable to start the sauna battle",messages:r,actions:[{label:"Reload",onClick:()=>window.location.reload(),variant:"primary"}],dismissible:!1});a&&A(()=>a.dismiss());return}if(s.length){console.error("Resource loader errors",s);const r=oe("error",{title:"Some resources failed to load",messages:s,actions:[{label:"Reload",onClick:()=>window.location.reload(),variant:"primary"}]});r&&A(()=>r.dismiss())}if(o.length){console.warn("Resource loader warnings",o);const r=oe("warning",{title:"Heads up",messages:o,autoCloseMs:12e3});r&&A(()=>r.dismiss())}Hn(i),Nn()}catch(n){if(e!==ce){t.dispose();return}console.error("Failed to initialize resources",n),t.clear();const o=oe("error",{title:"Failed to initialize",messages:[et(n)],actions:[{label:"Reload",onClick:()=>window.location.reload(),variant:"primary"}]});o&&A(()=>o.dismiss())}}function uo(){const e=document.getElementById("game-canvas"),t=document.getElementById("resource-bar");if(!e||!t)return;Ae&&io();const n=++ce;S=e,Ae=!0,Dn(e,t),oo(e);const o=()=>Jn(e);window.addEventListener("resize",o),A(()=>window.removeEventListener("resize",o)),window.addEventListener("beforeunload",ke),A(()=>window.removeEventListener("beforeunload",ke)),o(),import.meta.vitest||co(n)}import.meta.vitest||uo();export{B as R,Vt as U,at as p};
