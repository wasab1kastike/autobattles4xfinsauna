(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const ft="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23a4d67a'%20/%3e%3cpolygon%20points='16,48%2032,16%2048,48'%20fill='%23d2691e'%20/%3e%3crect%20x='24'%20y='32'%20width='16'%20height='16'%20fill='%23f4a460'%20/%3e%3c/svg%3e",pt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23c0c0c0'%20/%3e%3crect%20x='8'%20y='24'%20width='48'%20height='24'%20fill='%23808080'%20/%3e%3crect%20x='24'%20y='16'%20width='16'%20height='8'%20fill='%23606060'%20/%3e%3c/svg%3e",mt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23e0e0e0'%20/%3e%3crect%20x='10'%20y='22'%20width='12'%20height='30'%20fill='%23a9a9a9'%20/%3e%3crect%20x='26'%20y='14'%20width='12'%20height='38'%20fill='%23808080'%20/%3e%3crect%20x='42'%20y='26'%20width='12'%20height='26'%20fill='%23a9a9a9'%20/%3e%3c/svg%3e",gt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b4513'%20/%3e%3cpolygon%20points='32,10%2042,22%2022,22'%20fill='%23555'%20/%3e%3crect%20x='30'%20y='22'%20width='4'%20height='32'%20fill='%23ccc'%20/%3e%3c/svg%3e",yt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%234682b4'%20/%3e%3ccircle%20cx='32'%20cy='24'%20r='12'%20fill='%23fff'%20/%3e%3crect%20x='28'%20y='36'%20width='8'%20height='16'%20fill='%23fff'%20/%3e%3c/svg%3e",wt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%23556b2f'%20/%3e%3cline%20x1='16'%20y1='16'%20x2='48'%20y2='48'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cpolygon%20points='48,48%2044,36%2036,44'%20fill='%23fff'%20/%3e%3c/svg%3e",bt="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3e%3crect%20width='64'%20height='64'%20fill='%238b0000'%20/%3e%3cline%20x1='18'%20y1='18'%20x2='46'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3cline%20x1='46'%20y1='18'%20x2='18'%20y2='46'%20stroke='%23fff'%20stroke-width='4'%20/%3e%3c/svg%3e";class vt{listeners=new Map;on(e,n){const o=this.listeners.get(e)??[];o.push(n),this.listeners.set(e,o)}off(e,n){const o=this.listeners.get(e);if(!o)return;const s=o.indexOf(n);s!==-1&&(o.splice(s,1),o.length===0?this.listeners.delete(e):this.listeners.set(e,o))}emit(e,n){const o=this.listeners.get(e);if(o)for(const s of o)s(n)}}const m=new vt;class xe{type="farm";cost=50;foodPerTick=1}class Ue{type="barracks";cost=100;trainingCapacity=1}const je=Math.sqrt(3),xt=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function $(t,e){return{x:e*je*(t.q+t.r/2),y:e*(3/2)*t.r}}function St(t,e,n){const o=(je/3*t-.3333333333333333*e)/n,s=2/3*e/n;return Ct({q:o,r:s})}function fe(t){return xt.map(e=>({q:t.q+e.q,r:t.r+e.r}))}function Ct(t){let e=t.q,n=t.r,o=-e-n,s=Math.round(e),i=Math.round(o),a=Math.round(n);const r=Math.abs(s-e),c=Math.abs(i-o),l=Math.abs(a-n);return r>c&&r>l?s=-i-a:c>l?i=-s-a:a=-s-i,{q:s,r:a}}const ne=new Set;let ee=32;function Et(t){return`${t.q},${t.r}`}function pe(t,e){ee=e,ne.add(Et(t))}function kt(t){if(ne.size===0)return{center:{x:0,y:0},zoom:1};const e=ee*Math.sqrt(3),n=ee*2;let o=1/0,s=1/0,i=-1/0,a=-1/0;for(const u of ne){const[g,E]=u.split(",").map(Number),{x:S,y:k}=$({q:g,r:E},ee);o=Math.min(o,S),s=Math.min(s,k),i=Math.max(i,S+e),a=Math.max(a,k+n)}const r=i-o,c=a-s,l=96,d={x:o+r/2,y:s+c/2},h=t.width/(r+l*2),f=t.height/(c+l*2),b=Math.min(h,f);return{center:d,zoom:b}}const v={x:0,y:0,zoom:1};function Mt(t,e=300){const n=v.x,o=v.y,s=v.zoom,i=typeof performance<"u"?performance.now():Date.now(),a=r=>{const c=Math.min((r-i)/e,1);v.x=n+(t.center.x-n)*c,v.y=o+(t.center.y-o)*c,v.zoom=s+(t.zoom-s)*c,c<1&&(typeof requestAnimationFrame<"u"?requestAnimationFrame(a):setTimeout(()=>a(typeof performance<"u"?performance.now():Date.now()),16))};typeof requestAnimationFrame<"u"?requestAnimationFrame(a):setTimeout(()=>a(typeof performance<"u"?performance.now():Date.now()),0)}function At(){ne.clear()}async function Pt(t){const e={},n={},o=[],s=Object.entries(t.images??{}).map(([a,r])=>new Promise(c=>{const l=new Image;l.onload=()=>{e[a]=l,c()},l.onerror=()=>{const d=`Failed to load image: ${r}`;console.error(d),o.push(d),c()},l.src=r})),i=Object.entries(t.sounds??{}).map(([a,r])=>new Promise(c=>{const l=new Audio;l.oncanplaythrough=()=>{n[a]=l,c()},l.onerror=()=>{const d=`Failed to load sound: ${r}`;console.error(d),o.push(d),c()},l.src=r,l.load()}));return await Promise.all([...s,...i]),{assets:{images:e,sounds:n},failures:o}}function Tt(t){const e=localStorage.getItem(t);if(e)try{return JSON.parse(e)}catch(n){console.warn(`Failed to parse data for "${t}", clearing`,n),localStorage.removeItem(t);return}}function ce(t){return`${t.q},${t.r}`}const Qe={farm:()=>new xe,barracks:()=>new Ue};function It(t){return Qe[t]?.()}var G=(t=>(t.GOLD="gold",t))(G||{});const Rt={gold:1};class Lt{constructor(e,n="gameState"){this.tickInterval=e,this.storageKey=n}resources={gold:0};passiveGeneration={...Rt};lastSaved=Date.now();buildings={};buildingPlacements=new Map;policies=new Set;nightWorkSpeedMultiplier=1;tick(){Object.keys(this.passiveGeneration).forEach(e=>{this.addResource(e,this.passiveGeneration[e])})}save(){this.lastSaved=Date.now();const e={};this.buildingPlacements.forEach((o,s)=>{e[s]=o.type});const n={resources:this.resources,lastSaved:this.lastSaved,buildings:this.buildings,buildingPlacements:e};localStorage.setItem(this.storageKey,JSON.stringify(n))}load(e){const n=Tt(this.storageKey);if(!n){this.lastSaved=Date.now();return}this.resources={...this.resources,...n.resources};const o={};Object.entries(n.buildings??{}).forEach(([a,r])=>{Qe[a]&&(o[a]=r)}),this.buildings=o,this.buildingPlacements.clear(),n.buildingPlacements&&Object.entries(n.buildingPlacements).forEach(([a,r])=>{const c=It(r);if(!c)return;this.buildingPlacements.set(a,c);const[l,d]=a.split(",").map(Number);if(e){const h=e.ensureTile(l,d);h.placeBuilding(c.type),h.reveal(),pe({q:l,r:d},e.hexSize)}m.emit("buildingPlaced",{building:c,coord:{q:l,r:d},state:this})}),this.lastSaved=n.lastSaved??Date.now();const s=Date.now()-this.lastSaved,i=Math.floor(s/this.tickInterval);Object.keys(this.passiveGeneration).forEach(a=>{this.resources[a]+=i*this.passiveGeneration[a]})}getResource(e){return this.resources[e]}canAfford(e,n="gold"){return this.resources[n]>=e}spend(e,n="gold"){return this.canAfford(e,n)?(this.resources[n]-=e,m.emit("resourceChanged",{resource:n,amount:-e,total:this.resources[n]}),!0):!1}addResource(e,n){this.resources[e]+=n,m.emit("resourceChanged",{resource:e,amount:n,total:this.resources[e]})}modifyPassiveGeneration(e,n){this.passiveGeneration[e]=(this.passiveGeneration[e]??0)+n}construct(e,n,o="gold"){return this.spend(n,o)?(this.buildings[e]=(this.buildings[e]??0)+1,!0):!1}placeBuilding(e,n,o,s="gold"){const i=o.getTile(n.q,n.r);return!i||i.building||!this.construct(e.type,e.cost,s)?!1:(this.buildingPlacements.set(ce(n),e),i.placeBuilding(e.type),m.emit("buildingPlaced",{building:e,coord:n,state:this}),!0)}getBuildingAt(e){return this.buildingPlacements.get(ce(e))}removeBuilding(e,n){const o=ce(e),s=this.buildingPlacements.get(o);return s?(this.buildingPlacements.delete(o),n.getTile(e.q,e.r)?.placeBuilding(null),this.buildings[s.type]!==void 0&&(this.buildings[s.type]-=1,this.buildings[s.type]<=0&&delete this.buildings[s.type]),m.emit("buildingRemoved",{building:s,coord:e,state:this}),!0):!1}upgrade(e,n,o="gold"){return this.construct(`upgrade:${e}`,n,o)}applyPolicy(e,n,o="gold"){return this.spend(n,o)?(this.policies.add(e),m.emit("policyApplied",{policy:e,state:this}),!0):!1}hasPolicy(e){return this.policies.has(e)}}class Dt{constructor(e,n){this.baseInterval=e,this.onTick=n}timer=null;speed=1;lastTick=0;accumulator=0;start(){this.stop(),this.lastTick=Date.now();const e=this.baseInterval/this.speed;this.timer=setInterval(()=>{const n=Date.now(),o=n-this.lastTick;this.lastTick=n,this.onTick(o)},e)}stop(){this.timer!==null&&(clearInterval(this.timer),this.timer=null)}setSpeed(e){if(e<=0)throw new Error("Speed multiplier must be positive");this.speed=e,this.timer!==null&&this.start()}getSpeed(){return this.speed}getBaseInterval(){return this.baseInterval}tick(e){for(this.accumulator+=e*this.speed;this.accumulator>=this.baseInterval;)this.accumulator-=this.baseInterval,this.onTick(this.baseInterval)}}var D=(t=>(t[t.Plains=0]="Plains",t[t.Forest=1]="Forest",t[t.Hills=2]="Hills",t[t.Lake=3]="Lake",t))(D||{});function qt(t,e,n){let o=t*374761393+e*668265263+n*0x14057b7ef7678100;return o=(o^o>>13)*1274126177,o^=o>>16,(o>>>0)/4294967295}function Me(t,e,n=0){const o=qt(t,e,n);return o<.1?3:o<.3?1:o<.5?2:0}class Ae{constructor(e=D.Plains,n=null,o=!0){this.terrain=e,this.building=n,this.isFogged=o}reveal(){this.isFogged=!1}placeBuilding(e){this.building=e}setFogged(e){this.isFogged=e}}class Ht{constructor(e=10,n=10,o=32,s=0){this.hexSize=o,this.seed=s,this.minQ=0,this.minR=0,this.maxQ=e-1,this.maxR=n-1;for(let i=this.minR;i<=this.maxR;i++)for(let a=this.minQ;a<=this.maxQ;a++)this.tiles.set(this.key(a,i),new Ae(Me(a,i,s)))}tiles=new Map;minQ;maxQ;minR;maxR;get width(){return this.maxQ-this.minQ+1}get height(){return this.maxR-this.minR+1}key(e,n){return`${e},${n}`}ensureTile(e,n){const o=this.key(e,n);let s=this.tiles.get(o);return s||(s=new Ae(Me(e,n,this.seed)),this.tiles.set(o,s),this.minQ=Math.min(this.minQ,e),this.maxQ=Math.max(this.maxQ,e),this.minR=Math.min(this.minR,n),this.maxR=Math.max(this.maxR,n),s.isFogged||pe({q:e,r:n},this.hexSize)),s}getTile(e,n){return this.ensureTile(e,n)}forEachTile(e){for(let n=this.minR;n<=this.maxR;n++)for(let o=this.minQ;o<=this.maxQ;o++){const s=this.ensureTile(o,n);e(s,{q:o,r:n})}}getNeighbors(e,n){return fe({q:e,r:n}).map(o=>this.ensureTile(o.q,o.r))}revealAround(e,n){for(let i=-n;i<=n;i++){const a=Math.max(-n,-i-n),r=Math.min(n,-i+n);for(let c=a;c<=r;c++){const l={q:e.q+i,r:e.r+c};this.ensureTile(l.q,l.r).reveal(),pe(l,this.hexSize)}}const o=typeof window<"u"?{width:window.innerWidth,height:window.innerHeight}:{width:0,height:0},s=kt(o);Mt(s,300)}}const Ke=({policy:t,state:e})=>{t==="eco"&&(e.modifyPassiveGeneration(G.GOLD,1),m.off("policyApplied",Ke))},Ve=({policy:t,state:e})=>{t==="temperance"&&(e.nightWorkSpeedMultiplier*=1.05,m.off("policyApplied",Ve))};m.on("policyApplied",Ke);m.on("policyApplied",Ve);const Gt="modulepreload",Ot=function(t){return"/autobattles4xfinsauna/"+t},Pe={},Yt=function(e,n,o){let s=Promise.resolve();if(n&&n.length>0){let c=function(l){return Promise.all(l.map(d=>Promise.resolve(d).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");s=c(n.map(l=>{if(l=Ot(l),l in Pe)return;Pe[l]=!0;const d=l.endsWith(".css"),h=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":Gt,d||(f.as="script"),f.crossOrigin="",f.href=l,r&&f.setAttribute("nonce",r),document.head.appendChild(f),d)return new Promise((b,u)=>{f.addEventListener("load",b),f.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return s.then(a=>{for(const r of a||[])r.status==="rejected"&&i(r.reason);return e().catch(i)})},Bt=({building:t,coord:e,state:n})=>{t instanceof xe?n.modifyPassiveGeneration(G.GOLD,t.foodPerTick):t instanceof Ue&&Yt(async()=>{const{spawnUnit:o}=await import("./UnitFactory-CWW5vLui.js");return{spawnUnit:o}},[]).then(({spawnUnit:o})=>{o(n,"soldier",`barracks-${e.q}-${e.r}`,e,"player")})},Ft=({building:t,state:e})=>{t instanceof xe&&e.modifyPassiveGeneration(G.GOLD,-t.foodPerTick)};m.on("buildingPlaced",Bt);m.on("buildingRemoved",Ft);function A(t){return`${t.q},${t.r}`}function zt(t){const[e,n]=t.split(",").map(Number);return{q:e,r:n}}function Te(t,e){const n=-t.q-t.r,o=-e.q-e.r;return Math.max(Math.abs(t.q-e.q),Math.abs(t.r-e.r),Math.abs(n-o))}class Xt{constructor(e,n,o,s,i=[]){this.id=e,this.coord=n,this.faction=o,this.stats=s,this.priorityFactions=i,this.maxHealth=s.health}alive=!0;listeners={};maxHealth;healMarkerElapsed=0;onDeath(e){(this.listeners.death??=[]).push(e)}emitDeath(){for(const e of this.listeners.death??[])e()}isDead(){return!this.alive}getMaxHealth(){return this.maxHealth}distanceTo(e){return Te(this.coord,e)}attack(e){this.distanceTo(e.coord)<=this.stats.attackRange&&e.takeDamage(this.stats.attackDamage,this)}update(e,n){if(!(this.isDead()||!n))if(Te(this.coord,n.pos)<=n.auraRadius){const o=this.stats.health;this.stats.health=Math.min(this.stats.health+n.regenPerSec*e,this.maxHealth),this.stats.health>o&&(this.healMarkerElapsed+=e,this.healMarkerElapsed>=1&&(this.healMarkerElapsed=0,this.spawnHealMarker()))}else this.healMarkerElapsed=0}spawnHealMarker(){if(typeof document>"u")return;const e=document.getElementById("game-canvas");if(!e)return;const{x:n,y:o}=$(this.coord,32),s=document.createElement("div");s.textContent="+",s.className="heal-marker",s.style.position="absolute";const i=e.getBoundingClientRect();s.style.left=`${i.left+n}px`,s.style.top=`${i.top+o}px`,s.style.pointerEvents="none",document.body.appendChild(s),setTimeout(()=>s.remove(),1e3)}takeDamage(e,n){this.stats.health-=e,m.emit("unitDamaged",{attackerId:n?.id,targetId:this.id,amount:e,remainingHealth:this.stats.health}),this.stats.health<=0&&this.alive&&(this.stats.health=0,this.alive=!1,m.emit("unitDied",{unitId:this.id,attackerId:n?.id}),this.emitDeath())}moveTowards(e,n,o){const s=this.findPath(e,n,o);if(s.length<2)return[];let i=0;for(let r=1;r<s.length;r++){const c=A(s[r]);if(o.has(c))break;i=r}if(i===0)return[];const a=Math.min(this.stats.movementRange,i);return s.slice(0,a+1)}findPath(e,n,o){const s=this.coord,i=A(s),a=A(e),r=[s],c=new Map;for(c.set(i,null);r.length>0;){const h=r.shift(),f=A(h);if(f===a)break;for(const b of fe(h)){const u=A(b);u!==a&&!this.isPassable(b,n,o)||c.has(u)||(r.push(b),c.set(u,f))}}if(!c.has(a))return[s];const l=[];let d=a;for(;d;)l.push(zt(d)),d=c.get(d)??null;return l.reverse()}seekNearestEnemy(e,n,o){const s=new Map;for(const r of e)s.set(A(r.coord),r);const i=[this.coord],a=new Set([A(this.coord)]);for(;i.length>0;){const r=i.shift(),c=A(r),l=s.get(c);if(l)return l;for(const d of fe(r)){const h=A(d),f=s.get(h);if(f)return f;this.isPassable(d,n,o)&&(a.has(h)||(a.add(h),i.push(d)))}}return null}isPassable(e,n,o){const s=n.getTile(e.q,e.r);return!s||o&&o.has(A(e))?!1:s.terrain!==D.Lake}}const $t={health:12,attackDamage:4,attackRange:1,movementRange:2};class Nt extends Xt{constructor(e,n,o){super(e,n,o,{...$t})}}let M=null;const Q={};function Je(){if(M||typeof window>"u")return M;const t=window.AudioContext||window.webkitAudioContext;if(!t)return console.warn("Web Audio API not supported"),null;try{M=new t}catch(e){return console.warn("Unable to create AudioContext",e),null}if(Q.click=_t(),Q.spawn=Wt(),Q.error=Ut(),Q.sisu=jt(),M.state==="suspended"){const e=()=>{M?.resume()};window.addEventListener("pointerdown",e,{once:!0})}return M}function ie(t,e){const n=M,o=n.createBuffer(1,t,n.sampleRate),s=o.getChannelData(0);for(let i=0;i<t;i++){const a=i/n.sampleRate;s[i]=e(a)}return o}function _t(){return ie(Math.floor(M.sampleRate*.05),e=>Math.sin(2*Math.PI*1e3*e)*Math.exp(-40*e))}function Wt(){return ie(Math.floor(M.sampleRate*.2),e=>(Math.sin(2*Math.PI*440*e)+Math.sin(2*Math.PI*660*e))*.5*Math.exp(-6*e))}function Ut(){return ie(Math.floor(M.sampleRate*.3),e=>Math.sin(2*Math.PI*110*e)*Math.exp(-8*e))}function jt(){return ie(Math.floor(M.sampleRate*.5),e=>Math.sin(2*Math.PI*880*e)*Math.exp(-2*e))}let se=!1;typeof localStorage<"u"&&(se=localStorage.getItem("sfx-muted")==="true");function Ie(){return se}function Qt(t){se=t,typeof localStorage<"u"&&localStorage.setItem("sfx-muted",t?"true":"false")}function Ze(t){if(se)return;const e=Je();if(!e)return;const n=Q[t];if(!n)return;e.state==="suspended"&&e.resume();const o=e.createBufferSource();o.buffer=n,o.connect(e.destination),o.start()}typeof document<"u"&&document.addEventListener("click",t=>{t.target instanceof HTMLButtonElement&&Ze("click")});Je();const Kt={q:0,r:0},Vt="Saunoja",Re=18;function Le(t,e,n){return Math.min(Math.max(t,e),n)}function et(t){const{id:e,name:n=Vt,coord:o=Kt,maxHp:s=Re,hp:i=s,steam:a=0,selected:r=!1}=t,c=Number.isFinite(s)?Math.max(1,s):Re,l=Number.isFinite(i)?i:c,d=Le(l,0,c),h=Number.isFinite(a)?a:0,f=Le(h,0,1);return{id:e,name:n,coord:{q:o.q,r:o.r},maxHp:c,hp:d,steam:f,selected:r}}const oe=32;function K(t,e,n,o){t.beginPath();for(let s=0;s<6;s++){const i=Math.PI/3*s,a=e+o*Math.cos(i),r=n+o*Math.sin(i);s===0?t.moveTo(a,r):t.lineTo(a,r)}t.closePath()}function tt(t,e,n){return Math.min(Math.max(t,e),n)}function Jt(t,{centerX:e,centerY:n,hp:o,maxHp:s,radius:i=oe*.55}){const a=Number.isFinite(s)?Math.max(1,s):1,r=Number.isFinite(o)?o:a,c=tt(r/a,0,1);if(t.save(),K(t,e,n,i),t.fillStyle="rgba(7, 11, 18, 0.72)",t.fill(),t.restore(),c>0){t.save(),K(t,e,n,i),t.clip();const l=t.createLinearGradient(e,n+i,e,n-i);l.addColorStop(0,"rgba(46, 160, 98, 0.35)"),l.addColorStop(1,"rgba(218, 255, 239, 0.95)"),t.fillStyle=l;const d=i*2*c,h=n+i-d;t.fillRect(e-i,h,i*2,d),t.restore()}t.save(),K(t,e,n,i),t.lineWidth=Math.max(1,i*.12),t.strokeStyle="rgba(255, 255, 255, 0.28)",t.stroke(),t.restore()}function Zt(t,{centerX:e,centerY:n,radius:o=oe*.85,intensity:s=1}){const i=tt(s,0,1);if(i<=0)return;t.save(),K(t,e,n,o),t.clip();const a=t.createLinearGradient(e,n+o,e,n-o);a.addColorStop(0,"rgba(255, 255, 255, 0)"),a.addColorStop(.55,`rgba(255, 255, 255, ${.12*i})`),a.addColorStop(1,`rgba(255, 255, 255, ${.35*i})`),t.globalCompositeOperation="lighter",t.fillStyle=a,t.fillRect(e-o,n-o,o*2,o*2),t.restore(),t.save(),t.globalCompositeOperation="lighter",t.lineCap="round",t.strokeStyle=`rgba(255, 255, 255, ${.25*i})`,t.lineWidth=Math.max(1,o*.08);const r=o*.75,c=o*.35;for(let l=0;l<3;l++){const d=n-o*.5+l*c;t.beginPath(),t.moveTo(e-r,d),t.bezierCurveTo(e-r*.4,d-o*.4,e+r*.4,d+o*.2,e+r,d-o*.45),t.stroke()}t.restore()}function en(t){return{id:"sauna",pos:t,spawnCooldown:30,timer:30,auraRadius:2,regenPerSec:1,rallyToFront:!1,update(e,n,o){if(this.timer-=e,this.timer>0)return;const s=[];for(let i=-2;i<=2;i++){const a=Math.max(-2,-i-2),r=Math.min(2,-i+2);for(let c=a;c<=r;c++){const l=Math.max(Math.abs(i),Math.abs(c),Math.abs(-i-c));if(l===0||l>2)continue;const d={q:this.pos.q+i,r:this.pos.r+c};n.some(f=>!f.isDead()&&f.coord.q===d.q&&f.coord.r===d.r)||s.push(d)}}if(s.length>0){const i=s[Math.floor(Math.random()*s.length)],a=`raider${n.length+1}`,r=new Nt(a,i,"player");o(r)}this.timer=this.spawnCooldown}}}function tn(t){const e=document.getElementById("ui-overlay");if(!e)return()=>{};const n=document.createElement("button");n.textContent="Sauna ♨️",e.appendChild(n);const o=document.createElement("div");o.style.position="absolute",o.style.left="0",o.style.top="0",o.style.background="rgba(0,0,0,0.7)",o.style.color="#fff",o.style.padding="8px",o.style.display="none",o.style.minWidth="120px";const s=document.createElement("div");s.style.height="8px",s.style.background="#555";const i=document.createElement("div");i.style.height="100%",i.style.background="#0f0",i.style.width="0%",s.appendChild(i),o.appendChild(s);const a=document.createElement("label"),r=document.createElement("input");return r.type="checkbox",r.checked=t.rallyToFront,r.addEventListener("change",()=>{t.rallyToFront=r.checked}),a.appendChild(r),a.appendChild(document.createTextNode(" Rally to Front")),o.appendChild(a),e.appendChild(o),n.addEventListener("click",()=>{o.style.display=o.style.display==="none"?"block":"none"}),()=>{const c=1-t.timer/t.spawnCooldown;i.style.width=`${Math.max(0,Math.min(c,1))*100}%`,r.checked=t.rallyToFront}}function J(t,e){const n=document.createElement("div");if(n.classList.add("topbar-badge"),e){const r=document.createElement("img");r.src=e,r.alt=t,r.decoding="async",r.classList.add("topbar-badge-icon"),n.appendChild(r)}const o=document.createElement("div");o.classList.add("badge-text");const s=document.createElement("span");s.textContent=t,s.classList.add("badge-label"),o.appendChild(s);const i=document.createElement("span");i.textContent="0",i.classList.add("badge-value"),o.appendChild(i);const a=document.createElement("span");return a.classList.add("badge-delta"),a.style.opacity="0",a.style.transform="translateY(-6px)",a.style.transition="opacity 0.5s ease, transform 0.5s ease",n.append(o,a),{container:n,value:i,delta:a}}function nn(t,e={}){const n=document.getElementById("ui-overlay");if(!n)return()=>{};const o=document.createElement("div");o.id="topbar",n.appendChild(o);const s=J("Saunakunnia",e.saunakunnia);s.container.classList.add("badge-sauna");const i=J("SISU🔥",e.sisu);i.container.classList.add("badge-sisu"),i.container.style.display="none";const a=J("Gold",e.gold);a.container.classList.add("badge-gold");const r=J("Time");r.container.classList.add("badge-time"),r.delta.style.display="none",o.appendChild(s.container),o.appendChild(i.container),o.appendChild(a.container),o.appendChild(r.container);const c=document.createElement("button");c.type="button",c.textContent="SISU",c.classList.add("topbar-button","sisu-button"),c.addEventListener("click",()=>{m.emit("sisuPulse",{})}),o.appendChild(c);const l=document.createElement("button");l.type="button",l.title="Toggle sound",l.classList.add("topbar-button","sound-button");const d=document.createElement("span");if(d.textContent="Sound",e.sound){const u=document.createElement("img");u.src=e.sound,u.alt="",u.decoding="async",u.setAttribute("aria-hidden","true"),l.appendChild(u)}l.appendChild(d);function h(){const u=Ie();d.textContent=u?"Muted":"Sound",l.setAttribute("aria-pressed",u?"true":"false"),l.classList.toggle("is-muted",u)}l.addEventListener("click",()=>{Qt(!Ie()),h()}),h(),o.appendChild(l),m.on("sisuPulseStart",({remaining:u})=>{c.disabled=!0,i.container.style.display="block",i.value.textContent=String(u)}),m.on("sisuPulseTick",({remaining:u})=>{i.value.textContent=String(u)}),m.on("sisuPulseEnd",()=>{i.container.style.display="none"}),m.on("sisuCooldownEnd",()=>{c.disabled=!1}),a.value.textContent=String(t.getResource(G.GOLD));const f={saunakunnia:s,sisu:i,gold:a};m.on("resourceChanged",({resource:u,amount:g,total:E})=>{const S=f[u];if(!S)return;S.value.textContent=String(E);const k=g>0?"+":"";S.delta.textContent=`${k}${g}`,S.delta.style.opacity="1",S.delta.style.transform="translateY(0)",setTimeout(()=>{S.delta.style.opacity="0",S.delta.style.transform="translateY(-6px)"},1e3)});let b=0;return u=>{b+=u;const g=Math.floor(b/1e3),E=Math.floor(g/60),S=g%60;r.value.textContent=`${E}:${S.toString().padStart(2,"0")}`}}let te=!1,de=!1;function on(){return te}function sn(t,e){if(te||de)return;te=!0,de=!0;let n=10;m.emit("sisuPulseStart",{remaining:n});const o=[];for(const i of e)i.faction!=="player"||i.isDead()||(o.push({unit:i,move:i.stats.movementRange,attack:i.stats.attackDamage}),i.stats.movementRange*=1.2,i.stats.attackDamage*=1.2,i.fearless=!0);const s=setInterval(()=>{if(n-=1,n>0){m.emit("sisuPulseTick",{remaining:n});return}clearInterval(s),te=!1;for(const i of o)i.unit.stats.movementRange=i.move,i.unit.stats.attackDamage=i.attack,delete i.unit.fearless;m.emit("sisuPulseEnd",{}),setTimeout(()=>{de=!1,m.emit("sisuCooldownEnd",{})},12e4)},1e3)}function rn(t){const e=document.getElementById("ui-overlay");if(!e)return{log:()=>{},addEvent:()=>{}};const n=document.createElement("div");n.id="right-panel",n.style.position="absolute",n.style.top="0",n.style.right="0",n.style.width="240px",n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.background="rgba(0,0,0,0.5)",n.style.color="#fff",e.appendChild(n);const o=document.createElement("div");o.style.display="flex",n.appendChild(o);const s=document.createElement("div");s.style.flex="1",s.style.overflowY="auto",n.appendChild(s);const i=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div");r.id="event-log",r.style.display="flex",r.style.flexDirection="column";const c={Policies:i,Events:a,Log:r};function l(p){for(const[y,T]of Object.entries(c))T.style.display=y===p?"block":"none";for(const y of o.children){const T=y;T.disabled=T.textContent===p}}for(const p of Object.keys(c)){const y=document.createElement("button");y.textContent=p,y.addEventListener("click",()=>l(p)),o.appendChild(y),s.appendChild(c[p])}const d=[{id:"eco",name:"Eco Policy",description:"Increase gold income by 1",cost:15,prerequisite:()=>!0},{id:"temperance",name:"Temperance",description:"+5% work speed at night",cost:25,prerequisite:()=>!0}],h={};function f(){i.innerHTML="";for(const p of d){const y=document.createElement("button");y.textContent=`${p.name} (${p.cost}g)`,y.title=p.description,y.disabled=!p.prerequisite(t)||t.hasPolicy(p.id),y.addEventListener("click",()=>{t.applyPolicy(p.id,p.cost)&&b()}),i.appendChild(y),i.appendChild(document.createElement("br")),h[p.id]=y}}function b(){for(const p of d){const y=h[p.id];y&&(y.disabled=!p.prerequisite(t)||t.hasPolicy(p.id))}}f(),m.on("resourceChanged",b),m.on("policyApplied",b);const u=[];function g(){a.innerHTML="";for(const p of u){const y=document.createElement("div"),T=document.createElement("h4");T.textContent=p.headline;const V=document.createElement("p");V.textContent=p.body;const le=document.createElement("button");le.textContent=p.buttonText??"Acknowledge",le.addEventListener("click",()=>{const ke=u.findIndex(ht=>ht.id===p.id);ke!==-1&&(u.splice(ke,1),g())}),y.appendChild(T),y.appendChild(V),y.appendChild(le),a.appendChild(y)}}function E(p){u.push(p),g()}const S=100,k=[];let N=!1;function ae(){for(const p of k){const y=document.createElement("div");y.textContent=p,r.appendChild(y)}for(;r.childElementCount>S;)r.removeChild(r.firstChild);r.scrollTop=r.scrollHeight,k.length=0,N=!1}function _(p){k.push(p),N||(N=!0,(typeof requestAnimationFrame=="function"?requestAnimationFrame:y=>setTimeout(y,16))(ae))}return l("Policies"),{log:_,addEvent:E}}function an(t){const e=document.getElementById("ui-overlay");if(!e)return;const n=document.createElement("div");n.id="error-overlay",n.style.position="absolute",n.style.inset="0",n.style.background="rgba(0, 0, 0, 0.75)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.pointerEvents="auto",n.style.zIndex="1000";const o=document.createElement("div");o.className="card",o.style.background="rgba(20, 20, 20, 0.9)",o.style.color="white",o.style.maxWidth="80%",o.style.textAlign="center",o.style.padding="var(--gap-lg)";const s=document.createElement("h2");s.textContent="Asset load errors",o.appendChild(s);const i=document.createElement("ul");i.style.textAlign="left",i.style.margin="var(--gap-md) 0";for(const r of t){const c=document.createElement("li");c.textContent=r,i.appendChild(c)}o.appendChild(i);const a=document.createElement("button");a.textContent="Reload",a.className="btn",a.addEventListener("click",()=>{location.reload()}),o.appendChild(a),n.appendChild(o),e.appendChild(n)}const ln=Math.sqrt(3),cn=2;function nt(t){return{width:t*ln,height:t*cn}}const dn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3ePlains%20Tile%3c/title%3e%3cdesc%20id='desc'%3eRolling%20plains%20with%20sunrise%20gradients%20and%20glowing%20grasses.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='plains-bg'%20cx='50%25'%20cy='50%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23111827'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='plains-field'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='0%25'%3e%3cstop%20offset='0%25'%20stop-color='%23facc15'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23eab308'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='plains-haze'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23fde68a'%20stop-opacity='0.8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23f59e0b'%20stop-opacity='0.2'%20/%3e%3c/linearGradient%3e%3cfilter%20id='plains-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='5'%20stdDeviation='6'%20flood-color='%23facc15'%20flood-opacity='0.35'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23plains-bg)'%20/%3e%3cg%20filter='url(%23plains-glow)'%3e%3cpath%20d='M16%2088c20-18%2036-22%2048-22s28%204%2048%2022'%20fill='url(%23plains-field)'%20stroke='%23fef9c3'%20stroke-width='2'%20stroke-linecap='round'%20/%3e%3cpath%20d='M24%20102c16-14%2032-18%2040-18s24%204%2040%2018'%20fill='none'%20stroke='%23fde68a'%20stroke-width='5'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M32%2070c12-10%2024-14%2032-14s20%204%2032%2014'%20fill='url(%23plains-haze)'%20opacity='0.7'%20/%3e%3cpath%20d='M52%2078l4%2012m8-12l4%2012m8-12l4%2012'%20stroke='%23fef3c7'%20stroke-width='3'%20stroke-linecap='round'%20opacity='0.8'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='36'%20r='8'%20fill='%23fef08a'%20opacity='0.7'%20/%3e%3c/svg%3e",un="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eForest%20Tile%3c/title%3e%3cdesc%20id='desc'%3eStylised%20evergreen%20trees%20glowing%20against%20a%20deep%20night%20backdrop.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='forest-bg'%20cx='50%25'%20cy='40%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230f172a'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230b1120'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='forest-leaf'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%234ade80'%20/%3e%3cstop%20offset='100%25'%20stop-color='%2315803d'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='forest-trunk'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23a855f7'%20/%3e%3cstop%20offset='100%25'%20stop-color='%237c3aed'%20/%3e%3c/linearGradient%3e%3cfilter%20id='forest-glow'%20x='-40%25'%20y='-40%25'%20width='180%25'%20height='180%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%234ade80'%20flood-opacity='0.25'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23forest-bg)'%20/%3e%3cg%20filter='url(%23forest-glow)'%20stroke='%23bbf7d0'%20stroke-width='2'%3e%3cpath%20fill='url(%23forest-leaf)'%20d='M64%2026L32%2080h18l-12%2022h28l-10-22h16l-10%2022h28l-12-22h18z'%20/%3e%3crect%20x='58'%20y='74'%20width='12'%20height='18'%20rx='3'%20fill='url(%23forest-trunk)'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20stroke-opacity='0.5'%20d='M44%2086c6-4%2012-6%2020-6s14%202%2020%206'%20/%3e%3c/g%3e%3ccircle%20cx='40'%20cy='40'%20r='6'%20fill='%23fef3c7'%20opacity='0.6'%20/%3e%3ccircle%20cx='88'%20cy='32'%20r='4'%20fill='%23fef3c7'%20opacity='0.4'%20/%3e%3c/svg%3e",hn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eMountain%20Tile%3c/title%3e%3cdesc%20id='desc'%3eJagged%20alpine%20peaks%20with%20luminous%20snowcaps.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='mountain-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%23111827'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='mountain-rock'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2364748b'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23334155'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='mountain-snow'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23f8fafc'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23cbd5f5'%20/%3e%3c/linearGradient%3e%3cfilter%20id='mountain-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='6'%20stdDeviation='6'%20flood-color='%23f8fafc'%20flood-opacity='0.2'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23mountain-bg)'%20/%3e%3cg%20filter='url(%23mountain-glow)'%20stroke='%23cbd5f5'%20stroke-width='2'%20stroke-linejoin='round'%3e%3cpath%20fill='url(%23mountain-rock)'%20d='M24%20100l32-52%2014%2022%2012-18%2022%2048z'%20/%3e%3cpath%20fill='url(%23mountain-snow)'%20d='M56%2048l14%2022%2012-18%2010%2022H48z'%20opacity='0.85'%20/%3e%3cpath%20fill='none'%20stroke-linecap='round'%20opacity='0.6'%20d='M32%2094c10-6%2020-9%2032-9s22%203%2032%209'%20/%3e%3c/g%3e%3ccircle%20cx='92'%20cy='32'%20r='6'%20fill='%23f1f5f9'%20opacity='0.5'%20/%3e%3c/svg%3e",fn="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20128%20128'%20role='img'%20aria-labelledby='title%20desc'%3e%3ctitle%20id='title'%3eWater%20Tile%3c/title%3e%3cdesc%20id='desc'%3eGlowing%20waves%20surrounding%20a%20crystalline%20droplet.%3c/desc%3e%3cdefs%3e%3cradialGradient%20id='water-bg'%20cx='50%25'%20cy='45%25'%20r='75%25'%3e%3cstop%20offset='0%25'%20stop-color='%230b1120'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23020617'%20/%3e%3c/radialGradient%3e%3clinearGradient%20id='water-wave'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2338bdf8'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230ea5e9'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='water-drop'%20x1='50%25'%20y1='0%25'%20x2='50%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23e0f2fe'%20/%3e%3cstop%20offset='100%25'%20stop-color='%230284c7'%20/%3e%3c/linearGradient%3e%3cfilter%20id='water-glow'%20x='-30%25'%20y='-30%25'%20width='160%25'%20height='160%25'%3e%3cfeDropShadow%20dx='0'%20dy='4'%20stdDeviation='8'%20flood-color='%2338bdf8'%20flood-opacity='0.3'%20/%3e%3c/filter%3e%3c/defs%3e%3crect%20x='8'%20y='8'%20width='112'%20height='112'%20rx='24'%20fill='url(%23water-bg)'%20/%3e%3cg%20filter='url(%23water-glow)'%3e%3cpath%20d='M32%2076c12-10%2024-15%2032-15s20%205%2032%2015'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='8'%20stroke-linecap='round'%20/%3e%3cpath%20d='M28%2092c14-12%2030-18%2040-18s26%206%2040%2018'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='6'%20stroke-linecap='round'%20opacity='0.7'%20/%3e%3cpath%20d='M40%2060c10-8%2018-12%2024-12s14%204%2024%2012'%20fill='none'%20stroke='url(%23water-wave)'%20stroke-width='4'%20stroke-linecap='round'%20opacity='0.5'%20/%3e%3cpath%20d='M64%2030c-12%2020-18%2032-18%2042%200%2011%208%2020%2018%2020s18-9%2018-20c0-10-6-22-18-42z'%20fill='url(%23water-drop)'%20stroke='%23e0f2fe'%20stroke-width='2'%20/%3e%3c/g%3e%3ccircle%20cx='94'%20cy='34'%20r='6'%20fill='%23f8fafc'%20opacity='0.45'%20/%3e%3c/svg%3e",De={[D.Plains]:{baseColor:"#d8b869",icon:dn},[D.Forest]:{baseColor:"#237a55",icon:un},[D.Hills]:{baseColor:"#b57c57",icon:hn},[D.Lake]:{baseColor:"#3185d5",icon:fn}},qe=new Map;function pn(t){let e=qe.get(t);if(e||(e=new Image,e.decoding="async",e.src=t,qe.set(t,e)),e.complete&&e.naturalWidth>0&&e.naturalHeight>0)return e}const He="rgba(56, 189, 248, 0.85)",Ge="rgba(56, 189, 248, 0.45)";let W=null,U=null;function mn(){if(W&&U)return{stroke:W,glow:U};if(typeof window<"u"){const t=getComputedStyle(document.documentElement),e=t.getPropertyValue("--tile-highlight-ring").trim(),n=t.getPropertyValue("--tile-highlight-glow").trim();W=e||He,U=n||Ge}else W=He,U=Ge;return{stroke:W,glow:U}}function gn(t){const e=t.replace("#",""),n=Number.parseInt(e,16),o=n>>16&255,s=n>>8&255,i=n&255;return[o,s,i]}function Oe([t,e,n],[o,s,i],a){const r=Math.min(1,Math.max(0,a)),c=(l,d)=>Math.round(l+(d-l)*r);return`rgb(${c(t,o)}, ${c(e,s)}, ${c(n,i)})`}function Ye([t,e,n],o){return`rgba(${t}, ${e}, ${n}, ${o})`}class yn{constructor(e){this.mapRef=e}get hexSize(){return this.mapRef.hexSize}getOrigin(){return $({q:this.mapRef.minQ,r:this.mapRef.minR},this.hexSize)}draw(e,n,o){const{width:s,height:i}=nt(this.hexSize),a=this.getOrigin();for(const[r,c]of this.mapRef.tiles){const[l,d]=r.split(",").map(Number),{x:h,y:f}=$({q:l,r:d},this.hexSize),b=h-a.x,u=f-a.y;if(e.save(),c.isFogged&&(e.globalAlpha*=.4),this.drawTerrain(e,c.terrain,b,u,s,i),c.building){const E=n[`building-${c.building}`]??n.placeholder;e.drawImage(E,b,u,s,i)}const g=o&&l===o.q&&d===o.r;this.strokeHex(e,b+this.hexSize,u+this.hexSize,this.hexSize,!!g),e.restore()}}drawToCanvas(e,n,o){const s=e.getContext("2d");if(!s)throw new Error("Canvas 2D context not available");this.draw(s,n,o)}drawTerrain(e,n,o,s,i,a){const r=De[n]??De[D.Plains],c=gn(r.baseColor),l=this.hexSize,d=o+l,h=s+l;e.save(),this.hexPath(e,o+this.hexSize,s+this.hexSize,l),e.clip();const f=e.createRadialGradient(d,h,l*.2,d,h,l*1.05);f.addColorStop(0,Oe(c,[255,255,255],.3)),f.addColorStop(.7,r.baseColor),f.addColorStop(1,Oe(c,[12,18,28],.4)),e.fillStyle=f,e.shadowColor=Ye(c,.35),e.shadowBlur=l*.9,e.shadowOffsetX=0,e.shadowOffsetY=0,e.fillRect(o-l*.1,s-l*.1,i+l*.2,a+l*.2),e.globalCompositeOperation="lighter";const b=e.createRadialGradient(d,h,l*.85,d,h,l*1.18);b.addColorStop(0,"rgba(255, 255, 255, 0)"),b.addColorStop(1,Ye(c,.18)),e.fillStyle=b,e.fillRect(o-l*.1,s-l*.1,i+l*.2,a+l*.2),e.globalCompositeOperation="source-over",e.restore();const u=pn(r.icon);if(u){const g=Math.min(i,a)*.62,E=d-g/2,S=h-g/2;e.save(),e.globalAlpha*=.92,e.drawImage(u,E,S,g,g),e.restore()}}strokeHex(e,n,o,s,i=!1){const{stroke:a,glow:r}=mn();this.hexPath(e,n,o,s),e.save(),e.lineJoin="round",e.lineCap="round",i?(e.shadowColor=r,e.shadowBlur=s*.65,e.lineWidth=Math.max(2,s*.08),e.strokeStyle=a,e.stroke()):(e.lineWidth=Math.max(1,s*.05),e.strokeStyle="rgba(12, 18, 28, 0.55)",e.stroke()),e.restore()}hexPath(e,n,o,s){e.beginPath();for(let i=0;i<6;i++){const a=Math.PI/180*(60*i-30),r=n+s*Math.cos(a),c=o+s*Math.sin(a);i===0?e.moveTo(r,c):e.lineTo(r,c)}e.closePath()}}function wn(t,e,n,o,s,i){const a=window.devicePixelRatio||1,r=t.canvas.width,c=t.canvas.height;t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,r,c);const l=r/a,d=c/a;t.scale(a,a),t.translate(l/2,d/2),t.scale(v.zoom,v.zoom);const h=e.getOrigin();t.translate(-(v.x-h.x),-(v.y-h.y)),e.draw(t,n,s??void 0);const f=i?.saunojas;f&&Array.isArray(f.units)&&f.units.length>0&&f.draw(t,f.units,{originX:h.x,originY:h.y,hexRadius:e.hexSize}),bn(t,e,n,o,h),t.restore()}function bn(t,e,n,o,s){const{width:i,height:a}=nt(e.hexSize);for(const r of o){const{x:c,y:l}=$(r.coord,e.hexSize),d=c-s.x,h=l-s.y,f=n[`unit-${r.type}`]??n.placeholder,b=r.getMaxHealth();t.save(),r.stats.health/b<.5&&(t.filter="saturate(0)"),t.drawImage(f,d,h,i,a),on()&&r.faction==="player"&&(t.strokeStyle="rgba(255,255,255,0.5)",t.lineWidth=2,t.strokeRect(d,h,i,a)),t.restore()}}const Be="/assets/units/saunoja.svg";let F=null,j=null;function me(t){return!!(t&&t.complete&&t.naturalWidth>0&&t.naturalHeight>0)}function vn(){if(me(F))return Promise.resolve(F);if(j)return j;if(typeof Image>"u")return Promise.reject(new Error("Image constructor is not available in this environment."));const t=new Image;return t.decoding="async",F=t,j=new Promise((e,n)=>{const o=()=>{t.onload=null,t.onerror=null},s=()=>{o(),e(t)};t.onload=s,t.onerror=()=>{o(),F=null,j=null,n(new Error(`Failed to load saunoja icon from ${Be}`))},t.src=Be,me(t)&&s()}),j}function xn(t,e,{originX:n=0,originY:o=0,hexRadius:s=oe}={}){if(!t||!Array.isArray(e)||e.length===0)return;const i=me(F)?F:null;if(!i)return;const a=Number.isFinite(s)&&s>0?s:oe,r=a*.98,c=[...e].sort((l,d)=>l.coord.r!==d.coord.r?l.coord.r-d.coord.r:l.coord.q!==d.coord.q?l.coord.q-d.coord.q:l.id.localeCompare(d.id));for(const l of c){const{x:d,y:h}=$(l.coord,a),f=d-n,b=h-o,u=f+a,g=b+a;t.save(),K(t,u,g,r),t.clip();const E=a*2.15/Math.max(i.naturalWidth,i.naturalHeight||1),S=i.naturalWidth*E,k=i.naturalHeight*E,N=u-S/2,ae=g-k*.72;t.save(),t.filter="grayscale(100%) contrast(112%)",t.globalAlpha*=.96,t.drawImage(i,N,ae,S,k),t.restore(),t.save(),t.globalCompositeOperation="multiply";const _=t.createRadialGradient(u,g+r*.38,r*.2,u,g+r*.38,r*1.05);_.addColorStop(0,"rgba(15, 23, 42, 0.55)"),_.addColorStop(1,"rgba(15, 23, 42, 0)"),t.fillStyle=_,t.fillRect(u-r,g-r,r*2,r*2),t.restore(),t.save(),t.globalCompositeOperation="soft-light";const p=t.createLinearGradient(u,g-r,u,g+r);p.addColorStop(0,"rgba(255, 232, 210, 0.18)"),p.addColorStop(.52,"rgba(255, 183, 124, 0.32)"),p.addColorStop(1,"rgba(212, 97, 54, 0.5)"),t.fillStyle=p,t.fillRect(u-r,g-r,r*2,r*2),t.restore(),t.save(),t.globalCompositeOperation="screen",t.globalAlpha=.75;const y=t.createRadialGradient(u,g-r*.68,r*.1,u,g,r*1.12);y.addColorStop(0,"rgba(255, 255, 255, 0.85)"),y.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=y,t.fillRect(u-r,g-r,r*2,r*2),t.restore(),t.restore(),Zt(t,{centerX:u,centerY:g-a*.18,radius:a*.94,intensity:l.steam});const T=a*.42,V=g+a*.34;Jt(t,{centerX:u,centerY:V,hp:l.hp,maxHp:l.maxHp,radius:T})}}const ue="/autobattles4xfinsauna/",q={gold:`${ue}assets/ui/gold.svg`,resource:`${ue}assets/ui/resource.svg`,sound:`${ue}assets/ui/sound.svg`};let ot,L,z=null,H=[];const it="autobattles:saunojas";function st(){try{return globalThis.localStorage??null}catch{return null}}function Sn(){const t=st();if(!t)return[];try{const e=t.getItem(it);if(!e)return[];const n=JSON.parse(e);if(!Array.isArray(n))return[];const o=[];for(const s of n){if(!s||typeof s!="object")continue;const i=s,a=i.id;if(typeof a!="string"||a.length===0)continue;const r=i.coord,c=r&&typeof r=="object"&&typeof r.q=="number"&&Number.isFinite(r.q)&&typeof r.r=="number"&&Number.isFinite(r.r)?{q:r.q,r:r.r}:void 0;o.push(et({id:a,name:typeof i.name=="string"?i.name:void 0,coord:c,maxHp:typeof i.maxHp=="number"?i.maxHp:void 0,hp:typeof i.hp=="number"?i.hp:void 0,steam:typeof i.steam=="number"?i.steam:void 0,selected:!!i.selected}))}return o}catch(e){return console.warn("Failed to load Saunoja units from storage",e),[]}}function ge(){const t=st();if(t)try{const e=H.map(n=>({id:n.id,name:n.name,coord:{q:n.coord.q,r:n.coord.r},maxHp:n.maxHp,hp:n.hp,steam:n.steam,selected:n.selected}));t.setItem(it,JSON.stringify(e))}catch(e){console.warn("Failed to persist Saunoja units",e)}}function Cn(t,e){ot=t,L=e,L.classList.add("resource-bar"),L.setAttribute("role","status"),L.setAttribute("aria-live","polite"),L.replaceChildren();const n=document.createElement("img");n.src=q.resource,n.alt="Resources",n.decoding="async",n.classList.add("resource-icon");const o=document.createElement("span");o.textContent="Resources",o.classList.add("resource-label"),z=document.createElement("span"),z.textContent="0",z.classList.add("resource-value"),L.append(n,o,z),Ce(R.getResource(G.GOLD))}function rt(t,e){const n=St(t-P.hexSize,e-P.hexSize,P.hexSize);Se=n;let o=!1;for(const s of H){const i=s.coord.q===n.q&&s.coord.r===n.r;s.selected!==i&&(s.selected=i,o=!0)}o&&ge(),I()}const En={images:{placeholder:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=","building-farm":ft,"building-barracks":pt,"building-city":mt,"building-mine":gt,"unit-soldier":yt,"unit-archer":wt,"unit-raider":bt,"icon-gold":q.gold,"icon-resource":q.resource,"icon-sound":q.sound}};let ye;const P=new Ht(10,10,32),kn=new yn(P);P.forEachTile(t=>t.setFogged(!0));At();const R=new Lt(1e3);R.load(P);const Mn=2,An=new Dt(1e3,()=>{R.tick(),R.save();for(const t of O)!t.isDead()&&t.faction==="player"&&P.revealAround(t.coord,Mn);I()}),O=[],re=en({q:Math.floor(P.width/2),r:Math.floor(P.height/2)});P.revealAround(re.pos,3);H=Sn();if(H.length===0)H.push(et({id:"saunoja-1",coord:re.pos,selected:!0})),ge();else{let t=!1,e=!1;for(const n of H)n.selected&&(t?(n.selected=!1,e=!0):t=!0);e&&ge()}const Pn=tn(re),Tn=nn(R,{saunakunnia:q.resource,sisu:q.resource,gold:q.gold,sound:q.sound}),{log:at,addEvent:Wn}=rn(R);m.on("sisuPulse",()=>sn(R,O));m.on("sisuPulseStart",()=>Ze("sisu"));R.addResource(G.GOLD,200);let Se=null;const he=H.find(t=>t.selected);he&&(Se={q:he.coord.q,r:he.coord.r});function I(){const t=ot.getContext("2d");!t||!ye||wn(t,kn,ye.images,O,Se,{saunojas:{units:H,draw:xn}})}const lt=({resource:t,total:e,amount:n})=>{Ce(e);const o=n>0?"+":"";at(`${t}: ${o}${n}`)};m.on("resourceChanged",lt);const ct=({policy:t})=>{at(`Policy applied: ${t}`)};m.on("policyApplied",ct);const dt=({unitId:t})=>{const e=O.findIndex(n=>n.id===t);e!==-1&&(O.splice(e,1),I())};m.on("unitDied",dt);function we(){m.off("resourceChanged",lt),m.off("policyApplied",ct),m.off("unitDied",dt)}async function In(){vn().catch(s=>{console.warn("Unable to preload Saunoja icon",s)});const{assets:t,failures:e}=await Pt(En);ye=t,e.length&&(console.warn("Failed to load assets",e),an(e)),Ce(R.getResource(G.GOLD)),I();let n=performance.now();function o(s){const i=s-n;n=s,An.tick(i),re.update(i/1e3,O,a=>{O.push(a),I()}),Pn(),Tn(i),I(),requestAnimationFrame(o)}requestAnimationFrame(o)}function Ce(t){z?z.textContent=String(t):L&&(L.textContent=`Resources: ${t}`)}const Rn=.5,Ln=3.5,Dn=.0015,qn=10,Hn=250,be=[];let x=null,ve=!1,w=null;const C={active:!1,pointerId:null,lastX:0,lastY:0};function Gn(t){return Math.min(Ln,Math.max(Rn,t))}function X(t){be.push(t)}function Y(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}function On(t){const e=window.devicePixelRatio||1,n=Math.max(window.innerWidth,1),o=Math.max(window.innerHeight,1);t.style.width=`${n}px`,t.style.height=`${o}px`,t.width=Math.round(n*e),t.height=Math.round(o*e);const s=t.getContext("2d");s&&s.setTransform(1,0,0,1,0,0),I()}function Fe(t,e,n,o,s){const i=t.getBoundingClientRect(),a=e-i.left,r=n-i.top,c=i.width/2,l=i.height/2;return{x:s.x+(a-c)/o,y:s.y+(r-l)/o}}function ut(t,e,n,o){const s=Gn(o);if(s===v.zoom)return;const i={x:v.x,y:v.y},a=Fe(t,e,n,v.zoom,i),r=Fe(t,e,n,s,i);v.x+=a.x-r.x,v.y+=a.y-r.y,v.zoom=s,I()}function Ee(t,e){t===0&&e===0||(v.x-=t/v.zoom,v.y-=e/v.zoom,I())}function ze(t){if(!x)return;t.preventDefault();const e=Math.exp(-t.deltaY*Dn),n=v.zoom*e;ut(x,t.clientX,t.clientY,n)}function Xe(t){x&&(t.pointerType!=="mouse"||t.button!==0||(C.active=!0,C.pointerId=t.pointerId,C.lastX=t.clientX,C.lastY=t.clientY,x.setPointerCapture?.(t.pointerId),x.style.cursor="grabbing"))}function $e(t){if(!x||!C.active||C.pointerId!==t.pointerId)return;const e=t.clientX-C.lastX,n=t.clientY-C.lastY;C.lastX=t.clientX,C.lastY=t.clientY,Ee(e,n)}function B(t){x&&(!C.active||C.pointerId!==t.pointerId||(C.active=!1,C.pointerId=null,x.releasePointerCapture?.(t.pointerId),x.style.cursor=""))}function Yn(t){return!x||t.mode!=="pan"||t.startX==null||t.startY==null||t.moved&&Math.hypot((t.lastX??t.startX)-t.startX,(t.lastY??t.startY)-t.startY)>qn?!1:Y()-t.startTime<=Hn}function Bn(t){if(!x||t.startX==null||t.startY==null)return;const e=x.getBoundingClientRect(),n=t.startX-e.left,o=t.startY-e.top;rt(n,o)}function Fn(t){if(!w)return;const e=t.clientX-(w.lastX??t.clientX),n=t.clientY-(w.lastY??t.clientY);Math.hypot(e,n)>1&&(w.moved=!0),w.lastX=t.clientX,w.lastY=t.clientY,Ee(e,n)}function zn(t,e){if(!x)return;const n=(t.clientX+e.clientX)/2,o=(t.clientY+e.clientY)/2,s=Math.hypot(t.clientX-e.clientX,t.clientY-e.clientY);if(w?.lastDistance){const i=s/w.lastDistance,a=v.zoom*i;ut(x,n,o,a)}if(w?.lastCenter){const i=n-w.lastCenter.x,a=o-w.lastCenter.y;Ee(i,a)}w?(w.mode="pinch",w.lastCenter={x:n,y:o},w.lastDistance=s,w.moved=!0):w={mode:"pinch",lastCenter:{x:n,y:o},lastDistance:s,startTime:Y(),moved:!0}}function Ne(t){if(x){if(t.touches.length===1){const e=t.touches[0];w={mode:"pan",lastX:e.clientX,lastY:e.clientY,startX:e.clientX,startY:e.clientY,startTime:Y(),moved:!1}}else if(t.touches.length>=2){const[e,n]=[t.touches[0],t.touches[1]];w={mode:"pinch",lastCenter:{x:(e.clientX+n.clientX)/2,y:(e.clientY+n.clientY)/2},lastDistance:Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY),startTime:Y(),moved:!1}}}}function _e(t){if(!(!x||!w)&&t.touches.length!==0)if(t.preventDefault(),t.touches.length===1){const e=t.touches[0];if(w.mode!=="pan"){const n=w.mode==="pinch";w={mode:"pan",lastX:e.clientX,lastY:e.clientY,startX:e.clientX,startY:e.clientY,startTime:Y(),moved:n}}Fn(e)}else{const[e,n]=[t.touches[0],t.touches[1]];zn(e,n)}}function Z(t){if(!(!x||!w)){if(t.touches.length===0){Yn(w)&&Bn(w),w=null;return}if(t.touches.length===1){const e=t.touches[0],n=w.mode==="pinch";w={mode:"pan",lastX:e.clientX,lastY:e.clientY,startX:e.clientX,startY:e.clientY,startTime:Y(),moved:n}}else if(t.touches.length>=2){const[e,n]=[t.touches[0],t.touches[1]];w={mode:"pinch",lastCenter:{x:(e.clientX+n.clientX)/2,y:(e.clientY+n.clientY)/2},lastDistance:Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY),startTime:Y(),moved:!0}}}}function We(t){if(!x)return;const e=x.getBoundingClientRect();rt(t.clientX-e.left,t.clientY-e.top)}function Xn(t){t.addEventListener("click",We),X(()=>t.removeEventListener("click",We)),t.addEventListener("wheel",ze,{passive:!1}),X(()=>t.removeEventListener("wheel",ze)),t.addEventListener("pointerdown",Xe),t.addEventListener("pointermove",$e),t.addEventListener("pointerup",B),t.addEventListener("pointercancel",B),t.addEventListener("pointerleave",B),X(()=>{t.removeEventListener("pointerdown",Xe),t.removeEventListener("pointermove",$e),t.removeEventListener("pointerup",B),t.removeEventListener("pointercancel",B),t.removeEventListener("pointerleave",B)}),t.addEventListener("touchstart",Ne,{passive:!1}),t.addEventListener("touchmove",_e,{passive:!1}),t.addEventListener("touchend",Z),t.addEventListener("touchcancel",Z),X(()=>{t.removeEventListener("touchstart",Ne),t.removeEventListener("touchmove",_e),t.removeEventListener("touchend",Z),t.removeEventListener("touchcancel",Z)})}function $n(){for(;be.length;){const t=be.pop();try{t?.()}catch(e){console.error("Error during cleanup",e)}}}function Nn(){$n(),C.active=!1,C.pointerId=null,x&&(x.style.cursor=""),w=null,x=null,ve=!1,we()}function _n(){const t=document.getElementById("game-canvas"),e=document.getElementById("resource-bar");if(!t||!e)return;ve&&Nn(),x=t,ve=!0,Cn(t,e),Xn(t);const n=()=>On(t);window.addEventListener("resize",n),X(()=>window.removeEventListener("resize",n)),window.addEventListener("beforeunload",we),X(()=>window.removeEventListener("beforeunload",we)),n(),import.meta.vitest||In()}import.meta.vitest||_n();export{G as R,Xt as U,Ze as p};
